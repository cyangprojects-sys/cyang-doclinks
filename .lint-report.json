[{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\cloudflare\\cron-scan\\src\\index.ts","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":12,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":16,"endColumn":3}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface Env {\n  TARGET_SCAN_URL: string;\n  TARGET_NIGHTLY_URL: string;\n  TARGET_KEY_ROTATION_URL: string;\n  TARGET_WEBHOOKS_URL: string;\n  TARGET_AGGREGATE_URL: string;\n  TARGET_RETENTION_URL: string;\n  TARGET_BILLING_SYNC_URL: string;\n  CRON_SECRET: string; // stored as a Cloudflare secret\n}\n\nexport default {\n  async scheduled(event: ScheduledEvent, env: Env, ctx: ExecutionContext) {\n    ctx.waitUntil(runScheduled(event, env));\n  },\n};\n\nasync function runScheduled(event: ScheduledEvent, env: Env) {\n  const cron = String(event.cron || \"\").trim();\n  const jobs: Array<{ name: string; url: string; method: \"GET\" | \"POST\" }> = [];\n\n  // every 5 minutes\n  if (cron === \"*/5 * * * *\") {\n    jobs.push({ name: \"webhooks\", url: env.TARGET_WEBHOOKS_URL, method: \"GET\" });\n  }\n  // every minute\n  if (cron === \"* * * * *\") {\n    jobs.push({ name: \"scan\", url: env.TARGET_SCAN_URL, method: \"GET\" });\n  }\n  // every 30 minutes\n  if (cron === \"*/30 * * * *\") {\n    jobs.push({ name: \"aggregate\", url: env.TARGET_AGGREGATE_URL, method: \"GET\" });\n  }\n  // hourly at minute 5\n  if (cron === \"5 * * * *\") {\n    jobs.push({ name: \"nightly\", url: env.TARGET_NIGHTLY_URL, method: \"GET\" });\n  }\n  // hourly at minute 25\n  if (cron === \"25 * * * *\") {\n    jobs.push({ name: \"billing-sync\", url: env.TARGET_BILLING_SYNC_URL, method: \"GET\" });\n  }\n  // daily at 02:17 UTC\n  if (cron === \"17 2 * * *\") {\n    jobs.push({ name: \"retention\", url: env.TARGET_RETENTION_URL, method: \"GET\" });\n  }\n  // every 15 minutes\n  if (cron === \"*/15 * * * *\") {\n    jobs.push({ name: \"key-rotation\", url: env.TARGET_KEY_ROTATION_URL, method: \"GET\" });\n  }\n\n  for (const job of jobs) {\n    await trigger(job.name, job.url, job.method, env);\n  }\n}\n\nasync function trigger(name: string, url: string, method: \"GET\" | \"POST\", env: Env) {\n  const res = await fetch(url, {\n    method,\n    headers: {\n      \"User-Agent\": \"cloudflare-cron/cyang-doclinks\",\n      \"Authorization\": `Bearer ${env.CRON_SECRET}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: method === \"GET\" ? undefined : JSON.stringify({\n      source: \"cloudflare-cron\",\n      ts: new Date().toISOString(),\n    }),\n  });\n\n  const text = await res.text().catch(() => \"\");\n  if (!res.ok) {\n    console.log(`Cron trigger failed (${name}):`, res.status, text.slice(0, 800));\n    throw new Error(`Cron trigger failed (${name}): ${res.status}`);\n  }\n  console.log(`Cron trigger ok (${name}):`, res.status, text.slice(0, 800));\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\instrumentation-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\instrumentation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\scripts\\audit-admin-route-guards.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\scripts\\list-aliases.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\scripts\\run-lhci.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\sentry.edge.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\sentry.server.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\about\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\acceptable-use\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\abuse\\AbuseActionsClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[188,191],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[188,191],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[780,783],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[780,783],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[975,978],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[975,978],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":46,"column":7,"nodeType":"JSXOpeningElement","endLine":51,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\n\ntype Props = {\n  reportId: string;\n  token: string | null;\n  docId: string | null;\n  currentStatus: string;\n};\n\nasync function post(body: any) {\n  const res = await fetch(\"/api/admin/abuse\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(body),\n  });\n  const data = await res.json().catch(() => ({}));\n  if (!res.ok || !data?.ok) {\n    throw new Error(data?.error || data?.message || \"Request failed\");\n  }\n  return data;\n}\n\nexport default function AbuseActionsClient({ reportId, token, docId }: Props) {\n  const [busy, setBusy] = useState(false);\n  const [reason, setReason] = useState(\"\");\n  const [err, setErr] = useState<string | null>(null);\n\n  async function run(action: any) {\n    setBusy(true);\n    setErr(null);\n    try {\n      await post({ ...action, reportId, reason: reason || null });\n      // simplest refresh\n      window.location.reload();\n    } catch (e: any) {\n      setErr(e?.message || \"Failed\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <div className=\"min-w-[260px]\">\n      <input\n        value={reason}\n        onChange={(e) => setReason(e.target.value)}\n        placeholder=\"Reason (optional)\"\n        className=\"w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-xs text-white placeholder:text-white/30 outline-none focus:border-white/20\"\n      />\n\n      {err ? (\n        <div className=\"mt-2 rounded-xl border border-red-900/40 bg-red-950/30 px-3 py-2 text-xs text-red-200\">\n          {err}\n        </div>\n      ) : null}\n\n      <div className=\"mt-2 flex flex-wrap gap-2\">\n        {docId ? (\n          <>\n            <button\n              disabled={busy}\n              onClick={() => run({ action: \"disable_doc\", docId })}\n              className=\"rounded-xl bg-white px-3 py-1.5 text-xs font-medium text-black hover:bg-white/90 disabled:opacity-50\"\n            >\n              Disable doc\n            </button>\n            <button\n              disabled={busy}\n              onClick={() => run({ action: \"quarantine_doc\", docId })}\n              className=\"rounded-xl bg-white/10 px-3 py-1.5 text-xs text-white hover:bg-white/15 disabled:opacity-50\"\n            >\n              Quarantine\n            </button>\n            <button\n              disabled={busy}\n              onClick={() => {\n                const confirm = window.prompt(`Type exactly: OVERRIDE ${docId}`);\n                if (!confirm) return;\n                run({ action: \"override_quarantine\", docId, ttlMinutes: 30, confirm });\n              }}\n              className=\"rounded-xl bg-amber-500/20 px-3 py-1.5 text-xs text-amber-100 hover:bg-amber-500/25 disabled:opacity-50\"\n            >\n              Override 30m\n            </button>\n            <button\n              disabled={busy}\n              onClick={() => {\n                const confirm = window.prompt(`Type exactly: REVOKE_OVERRIDE ${docId}`);\n                if (!confirm) return;\n                run({ action: \"revoke_override\", docId, confirm });\n              }}\n              className=\"rounded-xl bg-amber-500/10 px-3 py-1.5 text-xs text-amber-100 hover:bg-amber-500/20 disabled:opacity-50\"\n            >\n              Revoke override\n            </button>\n          </>\n        ) : null}\n\n        {token ? (\n          <button\n            disabled={busy}\n            onClick={() => run({ action: \"revoke_share\", token })}\n            className=\"rounded-xl bg-white/10 px-3 py-1.5 text-xs text-white hover:bg-white/15 disabled:opacity-50\"\n          >\n            Revoke share\n          </button>\n        ) : null}\n\n        <button\n          disabled={busy}\n          onClick={() => run({ action: \"close_report\", reportId, notes: reason || null })}\n          className=\"rounded-xl bg-white/10 px-3 py-1.5 text-xs text-white hover:bg-white/15 disabled:opacity-50\"\n        >\n          Close\n        </button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\abuse\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\api-keys\\CreateApiKeyForm.tsx","messages":[{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":17,"column":11,"nodeType":"JSXOpeningElement","endLine":17,"endColumn":58},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":18,"column":11,"nodeType":"JSXOpeningElement","endLine":23,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1548,1551],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1548,1551],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/(owner)/api-keys/CreateApiKeyForm.tsx\n\"use client\";\n\nimport { useState, useTransition } from \"react\";\nimport { createApiKeyAction } from \"../../actions\";\n\nexport default function CreateApiKeyForm() {\n  const [name, setName] = useState(\"\");\n  const [pending, start] = useTransition();\n  const [err, setErr] = useState<string | null>(null);\n  const [createdKey, setCreatedKey] = useState<string | null>(null);\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex flex-col gap-2 sm:flex-row sm:items-end\">\n        <div className=\"flex-1\">\n          <label className=\"block text-sm text-white/75\">Key name</label>\n          <input\n            value={name}\n            onChange={(e) => setName(e.target.value)}\n            placeholder=\"e.g. CI deploy bot\"\n            className=\"mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none\"\n          />\n        </div>\n\n        <button\n          type=\"button\"\n          onClick={() =>\n            start(async () => {\n              setErr(null);\n              setCreatedKey(null);\n              try {\n                const fd = new FormData();\n                fd.set(\"name\", name);\n                const res = await createApiKeyAction(fd);\n                if (!res?.ok) {\n                  setErr(\"Failed to create key.\");\n                  return;\n                }\n                setName(\"\");\n                setCreatedKey(res.apiKey || null);\n              } catch (e: any) {\n                setErr(e?.message || \"Failed to create key.\");\n              }\n            })\n          }\n          disabled={pending || !name.trim()}\n          className=\"btn-base btn-primary rounded-xl px-4 py-2 text-sm font-medium disabled:opacity-50\"\n        >\n          {pending ? \"Creating...\" : \"Create API key\"}\n        </button>\n      </div>\n\n      {err ? <div className=\"text-sm text-red-200\">{err}</div> : null}\n\n      {createdKey ? (\n        <div className=\"glass-card rounded-xl border-emerald-500/25 p-3\">\n          <div className=\"text-sm text-emerald-100\">Your new API key (shown once):</div>\n          <div className=\"mt-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between\">\n            <code className=\"break-all rounded-lg bg-black/30 p-2 text-xs text-emerald-50\">{createdKey}</code>\n            <button\n              type=\"button\"\n              className=\"btn-base btn-secondary rounded-lg px-3 py-2 text-xs\"\n              onClick={async () => {\n                try {\n                  await navigator.clipboard.writeText(createdKey);\n                } catch {\n                  // no-op\n                }\n              }}\n            >\n              Copy\n            </button>\n          </div>\n        </div>\n      ) : null}\n    </div>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\api-keys\\RevokeApiKeyButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\api-keys\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\audit\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1217,1220],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1217,1220],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1247,1250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1247,1250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1275,1278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1275,1278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2254,2257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2254,2257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3831,3834],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3831,3834],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4131,4134],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4131,4134],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/audit/page.tsx\nimport { redirect } from \"next/navigation\";\nimport { sql } from \"@/lib/db\";\nimport { unstable_noStore as noStore } from \"next/cache\";\nimport { getAuthedUser } from \"@/lib/authz\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\n\nasync function columnExists(table: string, column: string): Promise<boolean> {\n  try {\n    const rows = (await sql`\n      select 1\n      from information_schema.columns\n      where table_schema = 'public'\n        and table_name = ${table}\n        and column_name = ${column}\n      limit 1\n    `) as unknown as Array<{ \"?column?\": number }>;\n    return rows.length > 0;\n  } catch {\n    return false;\n  }\n}\n\nexport default async function AuditPage() {\n  noStore();\n\n  const u = await getAuthedUser();\n  if (!u) redirect(\"/api/auth/signin\");\n  const canSeeAll = u.role === \"owner\" || u.role === \"admin\";\n  const hasOrgId = await columnExists(\"docs\", \"org_id\");\n  const orgDocScope = hasOrgId && u.orgId ? sql`where d.org_id = ${u.orgId}::uuid` : sql``;\n  // Security: audit logs are admin/owner only. Viewers should not access this page.\n  if (!canSeeAll) redirect(\"/admin/dashboard\");\n\n  let auditRows: any[] = [];\n  let accessRows: any[] = [];\n  let viewRows: any[] = [];\n  let accessError: string | null = null;\n\n  try {\n    auditRows = await (canSeeAll\n      ? sql`\n        select *\n        from public.doc_audit a\n        where a.doc_id in (\n          select d.id\n          from public.docs d\n          ${orgDocScope}\n        )\n        order by a.created_at desc\n        limit 50\n      `\n      : sql`\n        select *\n        from public.doc_audit a\n        where a.doc_id in (\n          select d.id\n          from public.docs d\n          where d.owner_id = ${u.id}::uuid\n          ${hasOrgId && u.orgId ? sql`and d.org_id = ${u.orgId}::uuid` : sql``}\n        )\n        order by a.created_at desc\n        limit 50\n      `);\n  } catch { }\n\n  try {\n    // Be tolerant of schema drift. Some environments may not have `accessed_at`.\n    // We fetch a larger window and sort in JS using the first timestamp-like column we find.\n    const raw = (await sql`\n      select *\n      from public.doc_access_log\n      limit 200\n    `) as unknown as any[];\n\n    // Tenant scope for admins/owners in multi-tenant mode.\n    let allowedDocIds: Set<string> | null = null;\n    if (canSeeAll && hasOrgId && u.orgId) {\n      try {\n        const ids = (await sql`\n          select id::text as id\n          from public.docs\n          where org_id = ${u.orgId}::uuid\n          limit 5000\n        `) as unknown as Array<{ id: string }>;\n        allowedDocIds = new Set((ids || []).map((x) => x.id));\n      } catch {\n        allowedDocIds = null;\n      }\n    }\n\n    const filtered = canSeeAll\n      ? (allowedDocIds ? raw.filter((r) => allowedDocIds!.has(String(r?.doc_id || r?.docId || '').trim())) : raw)\n      : raw.filter((r) => {\n        const docId = String(r?.doc_id || r?.docId || \"\").trim();\n        return !!docId;\n      });\n\n    // If viewer, do a cheap allowlist query of owned doc_ids.\n    let owned: Set<string> | null = null;\n    if (!canSeeAll) {\n      const ids = (await sql`\n        select id::text as id\n        from public.docs\n        where owner_id = ${u.id}::uuid\n      `) as unknown as Array<{ id: string }>;\n      owned = new Set(ids.map((x) => x.id));\n    }\n\n    const scoped = canSeeAll\n      ? raw\n      : filtered.filter((r) => owned?.has(String(r?.doc_id || r?.docId || \"\")));\n\n    const preferredCols = [\"accessed_at\", \"accessedAt\", \"created_at\", \"createdAt\", \"ts\", \"timestamp\"];\n    const cols = scoped?.[0] ? Object.keys(scoped[0]) : [];\n    const tsCol = preferredCols.find((c) => cols.includes(c)) ?? null;\n\n    if (!tsCol) {\n      accessRows = scoped.slice(0, 50);\n    } else {\n      const toTime = (v: any) => {\n        if (!v) return 0;\n        const d = new Date(v);\n        const t = d.getTime();\n        return Number.isNaN(t) ? 0 : t;\n      };\n      accessRows = scoped\n        .slice()\n        .sort((a, b) => toTime(b?.[tsCol]) - toTime(a?.[tsCol]))\n        .slice(0, 50);\n    }\n  } catch (err: any) {\n    accessError = err.message;\n  }\n\n  try {\n    viewRows = await (canSeeAll\n      ? sql`\n        select *\n        from public.doc_views\n        order by viewed_at desc\n        limit 50\n      `\n      : sql`\n        select *\n        from public.doc_views v\n        where v.doc_id in (select d.id from public.docs d where d.owner_id = ${u.id}::uuid)\n        order by v.viewed_at desc\n        limit 50\n      `);\n  } catch { }\n\n  return (\n    <div className=\"mx-auto max-w-7xl p-6 text-white\">\n      <div className=\"mb-8 flex items-center justify-between gap-3\">\n        <h1 className=\"text-2xl font-semibold\">Audit Logs</h1>\n        <div className=\"flex flex-wrap items-center justify-end gap-2\">\n          <a\n            href=\"/api/admin/audit/export?type=audit\"\n            className=\"rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-900\"\n          >\n            Export Audit CSV\n          </a>\n          <a\n            href=\"/api/admin/audit/export?type=access\"\n            className=\"rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-900\"\n          >\n            Export Access CSV\n          </a>\n          <a\n            href=\"/api/admin/audit/export?type=views\"\n            className=\"rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-900\"\n          >\n            Export Views CSV\n          </a>\n        </div>\n\n      </div>\n\n      <div className=\"space-y-10\">\n\n        {/* ================= AUDIT EVENTS ================= */}\n        <section className=\"space-y-4\">\n          <h2 className=\"text-lg font-medium\">Audit Events</h2>\n\n          <div className=\"overflow-x-auto rounded-xl border border-neutral-800\">\n            <table className=\"min-w-[1200px] text-sm\">\n              <thead className=\"bg-neutral-900 text-neutral-400\">\n                <tr>\n                  {auditRows[0] &&\n                    Object.keys(auditRows[0]).map((key) => (\n                      <th key={key} className=\"px-4 py-3 text-left\">\n                        {key}\n                      </th>\n                    ))}\n                </tr>\n              </thead>\n              <tbody>\n                {auditRows.map((row, i) => (\n                  <tr\n                    key={i}\n                    className=\"border-t border-neutral-800 hover:bg-neutral-900\"\n                  >\n                    {Object.values(row).map((val, j) => (\n                      <td key={j} className=\"px-4 py-3 whitespace-nowrap\">\n                        {String(val)}\n                      </td>\n                    ))}\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* ================= ACCESS LOGS ================= */}\n        <section className=\"space-y-4\">\n          <h2 className=\"text-lg font-medium\">Access Logs</h2>\n\n          {accessError && (\n            <div className=\"text-yellow-400 text-sm\">\n              Access logs query failed.<br />\n              <span className=\"text-neutral-500\">{accessError}</span>\n            </div>\n          )}\n\n          <div className=\"overflow-x-auto rounded-xl border border-neutral-800\">\n            <table className=\"min-w-[1200px] text-sm\">\n              <thead className=\"bg-neutral-900 text-neutral-400\">\n                <tr>\n                  {accessRows[0] &&\n                    Object.keys(accessRows[0]).map((key) => (\n                      <th key={key} className=\"px-4 py-3 text-left\">\n                        {key}\n                      </th>\n                    ))}\n                </tr>\n              </thead>\n              <tbody>\n                {accessRows.map((row, i) => (\n                  <tr\n                    key={i}\n                    className=\"border-t border-neutral-800 hover:bg-neutral-900\"\n                  >\n                    {Object.values(row).map((val, j) => (\n                      <td key={j} className=\"px-4 py-3 whitespace-nowrap\">\n                        {String(val)}\n                      </td>\n                    ))}\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* ================= VIEWS ================= */}\n        <section className=\"space-y-4\">\n          <h2 className=\"text-lg font-medium\">Views</h2>\n\n          <div className=\"overflow-x-auto rounded-xl border border-neutral-800\">\n            <table className=\"min-w-[1200px] text-sm\">\n              <thead className=\"bg-neutral-900 text-neutral-400\">\n                <tr>\n                  {viewRows[0] &&\n                    Object.keys(viewRows[0]).map((key) => (\n                      <th key={key} className=\"px-4 py-3 text-left\">\n                        {key}\n                      </th>\n                    ))}\n                </tr>\n              </thead>\n              <tbody>\n                {viewRows.map((row, i) => (\n                  <tr\n                    key={i}\n                    className=\"border-t border-neutral-800 hover:bg-neutral-900\"\n                  >\n                    {Object.values(row).map((val, j) => (\n                      <td key={j} className=\"px-4 py-3 whitespace-nowrap\">\n                        {String(val)}\n                      </td>\n                    ))}\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\billing\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\billing\\page.tsx","messages":[{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must have accessible text.","line":31,"column":5,"nodeType":"JSXOpeningElement","endLine":31,"endColumn":116},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":36,"column":7,"nodeType":"JSXOpeningElement","endLine":41,"endColumn":9},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":252,"column":13,"nodeType":"JSXOpeningElement","endLine":252,"endColumn":63},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":253,"column":13,"nodeType":"JSXOpeningElement","endLine":260,"endColumn":15},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":261,"column":13,"nodeType":"JSXOpeningElement","endLine":261,"endColumn":63},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":262,"column":13,"nodeType":"JSXOpeningElement","endLine":267,"endColumn":15},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":279,"column":13,"nodeType":"JSXOpeningElement","endLine":279,"endColumn":63},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":280,"column":13,"nodeType":"JSXOpeningElement","endLine":285,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect } from \"next/navigation\";\nimport { unstable_noStore as noStore } from \"next/cache\";\nimport Link from \"next/link\";\n\nimport { getAuthedUser } from \"@/lib/authz\";\nimport { getBillingFlags } from \"@/lib/settings\";\nimport { getPlanForUser, getStorageBytesForOwner } from \"@/lib/monetization\";\nimport { getActiveViewLimitOverride } from \"@/lib/viewLimitOverride\";\nimport { classifyBillingEntitlement, getBillingSnapshotForUser } from \"@/lib/billingSubscription\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction Card({ children }: { children: React.ReactNode }) {\n  return <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">{children}</div>;\n}\n\nfunction ToggleRow({\n  name,\n  title,\n  description,\n  defaultChecked,\n}: {\n  name: string;\n  title: string;\n  description: string;\n  defaultChecked: boolean;\n}) {\n  return (\n    <label className=\"flex items-start justify-between gap-4 rounded-lg border border-neutral-800 bg-black/30 p-3\">\n      <div>\n        <div className=\"text-sm font-medium text-white\">{title}</div>\n        <div className=\"mt-1 text-xs text-neutral-400\">{description}</div>\n      </div>\n      <input\n        type=\"checkbox\"\n        name={name}\n        defaultChecked={defaultChecked}\n        className=\"mt-1 h-4 w-4 rounded border-neutral-700 bg-neutral-950\"\n      />\n    </label>\n  );\n}\n\nexport default async function BillingSettingsPage({\n  searchParams,\n}: {\n  searchParams?: { saved?: string; error?: string; checkout?: string };\n}) {\n  noStore();\n\n  const u = await getAuthedUser();\n  if (!u) redirect(\"/api/auth/signin\");\n  if (u.role !== \"owner\") redirect(\"/admin/dashboard\");\n\n  const res = await getBillingFlags();\n  const flags = res.flags;\n  const plan = await getPlanForUser(u.id);\n  const usedStorage = await getStorageBytesForOwner(u.id);\n  const activeViewOverride = await getActiveViewLimitOverride(u.id);\n  const billingSnapshot = await getBillingSnapshotForUser(u.id);\n  const entitlement = classifyBillingEntitlement(billingSnapshot.subscription);\n  const storagePct =\n    plan.maxStorageBytes && plan.maxStorageBytes > 0\n      ? Math.min(100, Math.max(0, Math.round((usedStorage / plan.maxStorageBytes) * 100)))\n      : null;\n  const storageWarn = storagePct != null && storagePct >= 80;\n\n  const saved = searchParams?.saved === \"1\";\n  const error = searchParams?.error ? decodeURIComponent(searchParams.error) : null;\n\n  return (\n    <div className=\"mx-auto max-w-3xl p-6 text-white\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-semibold\">Billing & Monetization</h1>\n        <p className=\"mt-2 text-sm text-neutral-300\">\n          Owner-only runtime flags backed by <span className=\"font-mono text-xs\">public.app_settings</span>.\n          These toggle enforcement and UI visibility without a redeploy.\n        </p>\n      </div>\n\n      {(saved || error) && (\n        <div\n          className={[\n            \"mb-4 rounded-lg border p-3 text-sm\",\n            error ? \"border-red-900/60 bg-red-950/40 text-red-200\" : \"border-emerald-900/60 bg-emerald-950/30 text-emerald-200\",\n          ].join(\" \")}\n        >\n          {error ? `Failed to save: ${error}` : \"Saved.\"}\n        </div>\n      )}\n\n      {(searchParams?.checkout === \"success\" || searchParams?.checkout === \"canceled\") && (\n        <div\n          className={[\n            \"mb-4 rounded-lg border p-3 text-sm\",\n            searchParams?.checkout === \"success\"\n              ? \"border-emerald-900/60 bg-emerald-950/30 text-emerald-200\"\n              : \"border-amber-900/60 bg-amber-950/30 text-amber-200\",\n          ].join(\" \")}\n        >\n          {searchParams?.checkout === \"success\"\n            ? \"Checkout completed. Subscription status will update shortly.\"\n            : \"Checkout was canceled.\"}\n        </div>\n      )}\n\n      <Card>\n        <div className=\"text-sm font-medium text-white\">Current subscription state</div>\n        <div className=\"mt-2 text-xs text-neutral-400\">\n          Effective plan: <span className=\"font-semibold text-white\">{plan.name}</span>\n        </div>\n        {plan.id === \"free\" ? (\n          <div className=\"mt-1 text-xs text-amber-300\">\n            Free tier uses fixed share expiration windows and does not allow custom expiration.\n          </div>\n        ) : null}\n        <div className=\"mt-2 text-xs text-neutral-400\">\n          Entitlement state: <span className=\"font-semibold text-white\">{entitlement}</span>\n        </div>\n        {billingSnapshot.subscription ? (\n          <div className=\"mt-3 rounded-lg border border-neutral-800 bg-black/30 p-3 text-xs text-neutral-200\">\n            <div>Status: <span className=\"font-semibold\">{billingSnapshot.subscription.status}</span></div>\n            <div>Plan ID: <span className=\"font-mono\">{billingSnapshot.subscription.planId}</span></div>\n            <div>\n              Current period end:{\" \"}\n              {billingSnapshot.subscription.currentPeriodEnd\n                ? new Date(billingSnapshot.subscription.currentPeriodEnd).toLocaleString()\n                : \"—\"}\n            </div>\n            <div>\n              Grace until:{\" \"}\n              {billingSnapshot.subscription.graceUntil\n                ? new Date(billingSnapshot.subscription.graceUntil).toLocaleString()\n                : \"—\"}\n            </div>\n            <div>\n              Cancel at period end: {billingSnapshot.subscription.cancelAtPeriodEnd ? \"Yes\" : \"No\"}\n            </div>\n            <div className=\"text-neutral-400\">\n              Subscription: {billingSnapshot.subscription.stripeSubscriptionId}\n            </div>\n            <div className=\"text-neutral-400\">\n              Customer: {billingSnapshot.subscription.stripeCustomerId || \"—\"}\n            </div>\n          </div>\n        ) : (\n          <div className=\"mt-2 text-xs text-neutral-400\">\n            No Stripe subscription record yet.\n          </div>\n        )}\n      </Card>\n\n      <Card>\n        <div className=\"text-sm font-medium text-white\">Stripe billing</div>\n        <div className=\"mt-1 text-xs text-neutral-400\">\n          Use checkout to start Pro, and customer portal to manage payment method/cancellation.\n        </div>\n        <div className=\"mt-3 flex flex-wrap gap-2\">\n          <Link\n            href=\"/admin/billing/stripe\"\n            className=\"inline-flex items-center rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90 hover:bg-white/10\"\n          >\n            Open Stripe Billing Page\n          </Link>\n          <form action=\"/api/admin/billing/checkout\" method=\"post\">\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center rounded-md border border-sky-500/40 bg-sky-500/20 px-3 py-2 text-sm text-sky-100 hover:bg-sky-500/30\"\n            >\n              Upgrade via Stripe Checkout\n            </button>\n          </form>\n          <form action=\"/api/admin/billing/portal\" method=\"post\">\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90 hover:bg-white/10\"\n            >\n              Open Stripe Customer Portal\n            </button>\n          </form>\n        </div>\n      </Card>\n\n      <Card>\n        <div className=\"text-sm font-medium text-white\">Recent Stripe webhook events</div>\n        {billingSnapshot.events.length ? (\n          <div className=\"mt-3 overflow-x-auto rounded-lg border border-neutral-800\">\n            <table className=\"min-w-full text-left text-xs\">\n              <thead className=\"bg-black/40 text-neutral-400\">\n                <tr>\n                  <th className=\"px-3 py-2\">Received</th>\n                  <th className=\"px-3 py-2\">Type</th>\n                  <th className=\"px-3 py-2\">Status</th>\n                  <th className=\"px-3 py-2\">Message</th>\n                </tr>\n              </thead>\n              <tbody>\n                {billingSnapshot.events.map((e) => (\n                  <tr key={e.eventId} className=\"border-t border-neutral-800\">\n                    <td className=\"px-3 py-2 whitespace-nowrap text-neutral-300\">{new Date(e.receivedAt).toLocaleString()}</td>\n                    <td className=\"px-3 py-2 font-mono text-neutral-200\">{e.eventType}</td>\n                    <td className=\"px-3 py-2 text-neutral-200\">{e.status}</td>\n                    <td className=\"px-3 py-2 text-neutral-400\">{e.message || \"—\"}</td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        ) : (\n          <div className=\"mt-2 text-xs text-neutral-400\">No webhook events recorded yet.</div>\n        )}\n      </Card>\n\n      <Card>\n        <div className=\"text-sm font-medium text-white\">Storage usage</div>\n        <div className=\"mt-1 text-xs text-neutral-400\">\n          Plan cap: {plan.maxStorageBytes == null ? \"Unlimited\" : `${(plan.maxStorageBytes / (1024 * 1024)).toFixed(0)} MB`}\n        </div>\n        <div className=\"mt-2 text-sm text-neutral-200\">\n          Used: {(usedStorage / (1024 * 1024)).toFixed(1)} MB\n          {storagePct != null ? ` (${storagePct}%)` : \"\"}\n        </div>\n        {storageWarn ? (\n          <div className=\"mt-3 rounded-lg border border-amber-900/50 bg-amber-950/30 px-3 py-2 text-sm text-amber-200\">\n            Warning: storage usage is at {storagePct}% of your plan limit.\n          </div>\n        ) : null}\n      </Card>\n\n      <Card>\n        <div className=\"text-sm font-medium text-white\">View limit override</div>\n        <div className=\"mt-1 text-xs text-neutral-400\">\n          Temporarily bypass monthly view cap for this owner account.\n        </div>\n        <div className=\"mt-2 text-sm text-neutral-200\">\n          Status:{\" \"}\n          {activeViewOverride ? (\n            <span className=\"text-amber-200\">\n              Active until {new Date(activeViewOverride.expiresAt).toLocaleString()}\n            </span>\n          ) : (\n            <span className=\"text-neutral-400\">Inactive</span>\n          )}\n        </div>\n\n        <div className=\"mt-3 grid gap-3 md:grid-cols-2\">\n          <form action=\"/api/admin/billing/view-override\" method=\"post\" className=\"space-y-2 rounded-lg border border-neutral-800 bg-black/30 p-3\">\n            <input type=\"hidden\" name=\"action\" value=\"set\" />\n            <input type=\"hidden\" name=\"ownerId\" value={u.id} />\n            <label className=\"block text-xs text-neutral-400\">Hours</label>\n            <input\n              type=\"number\"\n              name=\"hours\"\n              min={1}\n              max={720}\n              defaultValue={24}\n              className=\"w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-2 text-sm text-white\"\n            />\n            <label className=\"block text-xs text-neutral-400\">Reason (required in ops)</label>\n            <input\n              type=\"text\"\n              name=\"reason\"\n              placeholder=\"Incident response / temporary support\"\n              className=\"w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-2 text-sm text-white\"\n            />\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90 hover:bg-white/10\"\n            >\n              Enable override\n            </button>\n          </form>\n\n          <form action=\"/api/admin/billing/view-override\" method=\"post\" className=\"space-y-2 rounded-lg border border-neutral-800 bg-black/30 p-3\">\n            <input type=\"hidden\" name=\"action\" value=\"clear\" />\n            <input type=\"hidden\" name=\"ownerId\" value={u.id} />\n            <label className=\"block text-xs text-neutral-400\">Reason</label>\n            <input\n              type=\"text\"\n              name=\"reason\"\n              placeholder=\"Override no longer needed\"\n              className=\"w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-2 text-sm text-white\"\n            />\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center rounded-md border border-red-700/40 bg-red-950/30 px-3 py-2 text-sm text-red-200 hover:bg-red-950/40\"\n            >\n              Disable override\n            </button>\n          </form>\n        </div>\n      </Card>\n\n      <Card>\n        <form action=\"/api/admin/billing\" method=\"post\" className=\"space-y-3\">\n          <ToggleRow\n            name=\"enforcePlanLimits\"\n            title=\"Enforce plan limits\"\n            description=\"Hard-enforce Free plan: 100MB storage, 100 views/month, 3 active shares, 10MB max file, 30-day auto-delete, and basic audit log. Turn OFF only for testing.\" \n            defaultChecked={flags.enforcePlanLimits}\n          />\n\n          <ToggleRow\n            name=\"proPlanEnabled\"\n            title=\"Enable Pro unlimited\"\n            description=\"When OFF, users with plan_id='pro' are treated as Free for limits. Flip ON only when you’re ready to sell/enable Pro.\" \n            defaultChecked={flags.proPlanEnabled}\n          />\n\n          <ToggleRow\n            name=\"pricingUiEnabled\"\n            title=\"Show pricing / upgrade UI\"\n            description=\"Controls whether the product surfaces upgrade prompts and pricing-related UI copy. Keep OFF while pricing is hidden.\" \n            defaultChecked={flags.pricingUiEnabled}\n          />\n\n          <div className=\"pt-2\">\n            <button\n              type=\"submit\"\n              className=\"inline-flex items-center rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm text-white/90 hover:bg-white/10\"\n            >\n              Save settings\n            </button>\n          </div>\n\n          {!res.ok && (\n            <div className=\"pt-2 text-xs text-neutral-400\">\n              Note: DB read failed (using env/defaults). Error: <span className=\"font-mono\">{res.error}</span>\n            </div>\n          )}\n        </form>\n      </Card>\n\n      <div className=\"mt-4 text-xs text-neutral-500\">\n        Tip: If you ever lock yourself out of this page, you can still override behavior using env vars:\n        <span className=\"ml-1 font-mono\">ENFORCE_PLAN_LIMITS</span>, <span className=\"font-mono\">PRO_PLAN_ENABLED</span>, <span className=\"font-mono\">PRICING_UI_ENABLED</span>.\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\billing\\stripe\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3928,3931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3928,3931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4037,4040],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4037,4040],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":125,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":125,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4333,4336],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4333,4336],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Link from \"next/link\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { sql } from \"@/lib/db\";\nimport { ensureStripeCustomer, stripeApi } from \"@/lib/stripeClient\";\nimport { classifyBillingEntitlement, getBillingSnapshotForUser } from \"@/lib/billingSubscription\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction statusClass(status: string): string {\n  const s = String(status || \"\").toLowerCase();\n  if (s === \"active\") return \"border-emerald-500/40 bg-emerald-500/20 text-emerald-100\";\n  if (s === \"grace\") return \"border-amber-500/40 bg-amber-500/20 text-amber-100\";\n  if (s === \"downgraded\" || s === \"at_risk\") return \"border-red-500/40 bg-red-500/20 text-red-100\";\n  return \"border-white/20 bg-white/10 text-white/80\";\n}\n\nfunction entitlementGuidance(entitlement: string): { title: string; body: string; tone: string } {\n  const e = String(entitlement || \"\").toLowerCase();\n  if (e === \"active\") {\n    return {\n      title: \"Subscription healthy\",\n      body: \"Billing is active. Plan limits should enforce as Pro entitlement.\",\n      tone: \"border-emerald-900/60 bg-emerald-950/30 text-emerald-200\",\n    };\n  }\n  if (e === \"grace\") {\n    return {\n      title: \"In grace period\",\n      body: \"Payment failed recently. Update payment method in Stripe Portal before grace expires to avoid downgrade.\",\n      tone: \"border-amber-900/60 bg-amber-950/30 text-amber-200\",\n    };\n  }\n  if (e === \"at_risk\") {\n    return {\n      title: \"At risk of downgrade\",\n      body: \"Subscription is incomplete/unpaid. Resolve checkout or billing failure immediately.\",\n      tone: \"border-red-900/60 bg-red-950/30 text-red-200\",\n    };\n  }\n  if (e === \"downgraded\") {\n    return {\n      title: \"Downgraded\",\n      body: \"Entitlement is no longer active. Account limits now follow Free-tier enforcement.\",\n      tone: \"border-red-900/60 bg-red-950/30 text-red-200\",\n    };\n  }\n  return {\n    title: \"No active subscription\",\n    body: \"Start checkout to provision Stripe subscription and unlock paid entitlement.\",\n    tone: \"border-white/20 bg-white/5 text-white/80\",\n  };\n}\n\nasync function readExistingCustomerId(userId: string): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select stripe_customer_id::text as stripe_customer_id\n      from public.users\n      where id = ${userId}::uuid\n      limit 1\n    `) as unknown as Array<{ stripe_customer_id: string | null }>;\n    return rows?.[0]?.stripe_customer_id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function persistCustomerId(userId: string, customerId: string): Promise<void> {\n  try {\n    await sql`\n      update public.users\n      set stripe_customer_id = ${customerId}\n      where id = ${userId}::uuid\n    `;\n  } catch {\n    // optional column in older schemas\n  }\n}\n\nfunction fmtMoney(amountCents: number, currency: string): string {\n  const n = Number.isFinite(amountCents) ? amountCents : 0;\n  const c = (currency || \"USD\").toUpperCase();\n  try {\n    return new Intl.NumberFormat(undefined, { style: \"currency\", currency: c }).format(n / 100);\n  } catch {\n    return `${(n / 100).toFixed(2)} ${c}`;\n  }\n}\n\nexport default async function StripeBillingPage(props: {\n  searchParams?: Promise<Record<string, string | string[] | undefined>>;\n}) {\n  const sp = (await props.searchParams) || {};\n  const sync = Array.isArray(sp.sync) ? sp.sync[0] : sp.sync;\n  const error = Array.isArray(sp.error) ? sp.error[0] : sp.error;\n\n  const u = await requirePermission(\"billing.manage\");\n\n  let customerId: string | null = null;\n  let stripeConfigError: string | null = null;\n  try {\n    const existingCustomerId = await readExistingCustomerId(u.id);\n    customerId = await ensureStripeCustomer({\n      userId: u.id,\n      email: u.email,\n      existingCustomerId,\n    });\n    if (customerId !== existingCustomerId) {\n      await persistCustomerId(u.id, customerId);\n    }\n  } catch (e: any) {\n    stripeConfigError = String(e?.message || e || \"Stripe configuration error\");\n  }\n\n  let invoices: any[] = [];\n  let invoicesError: string | null = null;\n  if (customerId) {\n    try {\n      const data = await stripeApi(`invoices?customer=${encodeURIComponent(customerId)}&limit=25`, {\n        method: \"GET\",\n      });\n      invoices = Array.isArray(data?.data) ? data.data : [];\n    } catch (e: any) {\n      invoicesError = String(e?.message || e || \"Failed to load invoices\");\n    }\n  }\n\n  const snapshot = await getBillingSnapshotForUser(u.id);\n  const entitlement = classifyBillingEntitlement(snapshot.subscription);\n  const guidance = entitlementGuidance(entitlement);\n\n  return (\n    <div className=\"mx-auto max-w-5xl p-6 text-white\">\n      <div className=\"flex items-center justify-between gap-3\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\">Stripe Billing</h1>\n          <p className=\"mt-1 text-sm text-neutral-400\">Subscription state, invoice history, and Stripe-managed actions.</p>\n        </div>\n        <Link href=\"/admin/billing\" className=\"rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm hover:bg-white/10\">\n          Back to Billing Settings\n        </Link>\n      </div>\n\n      {sync === \"ok\" ? (\n        <div className=\"mt-3 rounded-lg border border-emerald-900/60 bg-emerald-950/30 px-3 py-2 text-sm text-emerald-200\">\n          Billing sync completed.\n        </div>\n      ) : null}\n      {error ? (\n        <div className=\"mt-3 rounded-lg border border-red-900/60 bg-red-950/30 px-3 py-2 text-sm text-red-200\">\n          {decodeURIComponent(String(error))}\n        </div>\n      ) : null}\n      {stripeConfigError ? (\n        <div className=\"mt-3 rounded-lg border border-red-900/60 bg-red-950/30 px-3 py-2 text-sm text-red-200\">\n          Stripe is not configured for this environment: {stripeConfigError}\n        </div>\n      ) : null}\n      <div className={`mt-3 rounded-lg border px-3 py-2 text-sm ${guidance.tone}`}>\n        <div className=\"font-medium\">{guidance.title}</div>\n        <div className=\"mt-1 text-xs opacity-90\">{guidance.body}</div>\n      </div>\n\n      <div className=\"mt-4 grid gap-4 md:grid-cols-2\">\n        <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\n          <div className=\"text-sm font-medium\">Customer</div>\n          <div className=\"mt-2 text-xs text-neutral-400\">Stripe customer id</div>\n          <div className=\"mt-1 font-mono text-sm text-neutral-200\">{customerId || \"-\"}</div>\n          <div className=\"mt-3 flex gap-2\">\n            <form action=\"/api/admin/billing/checkout\" method=\"post\">\n              <button\n                type=\"submit\"\n                disabled={!customerId}\n                className=\"rounded-md border border-sky-500/40 bg-sky-500/20 px-3 py-2 text-sm text-sky-100 hover:bg-sky-500/30 disabled:cursor-not-allowed disabled:opacity-60\"\n              >\n                Start Checkout\n              </button>\n            </form>\n            <form action=\"/api/admin/billing/portal\" method=\"post\">\n              <button\n                type=\"submit\"\n                disabled={!customerId}\n                className=\"rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60\"\n              >\n                Open Portal\n              </button>\n            </form>\n            <form action=\"/api/admin/billing/sync\" method=\"post\">\n              <button\n                type=\"submit\"\n                disabled={!customerId}\n                className=\"rounded-md border border-white/15 bg-white/5 px-3 py-2 text-sm hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60\"\n              >\n                Run Sync Now\n              </button>\n            </form>\n          </div>\n        </div>\n\n        <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\n          <div className=\"text-sm font-medium\">Subscription</div>\n          <div className=\"mt-2\">\n            <span className={`inline-flex rounded-full border px-2.5 py-1 text-xs font-semibold uppercase tracking-wide ${statusClass(entitlement)}`}>\n              {entitlement}\n            </span>\n          </div>\n          {snapshot.subscription ? (\n            <div className=\"mt-2 space-y-1 text-sm text-neutral-200\">\n              <div>Status: <span className=\"font-semibold\">{snapshot.subscription.status}</span></div>\n              <div>Plan: <span className=\"font-mono\">{snapshot.subscription.planId}</span></div>\n              <div>\n                Current period end:{\" \"}\n                {snapshot.subscription.currentPeriodEnd\n                  ? new Date(snapshot.subscription.currentPeriodEnd).toLocaleString()\n                  : \"-\"}\n              </div>\n              <div>\n                Grace until:{\" \"}\n                {snapshot.subscription.graceUntil\n                  ? new Date(snapshot.subscription.graceUntil).toLocaleString()\n                  : \"-\"}\n              </div>\n            </div>\n          ) : (\n            <div className=\"mt-2 text-sm text-neutral-400\">No subscription record yet.</div>\n          )}\n        </div>\n      </div>\n\n      <div className=\"mt-4 rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\n        <div className=\"text-sm font-medium\">Invoices</div>\n        {invoicesError ? (\n          <div className=\"mt-2 rounded-md border border-red-900/50 bg-red-950/30 px-3 py-2 text-sm text-red-200\">\n            {invoicesError}\n          </div>\n        ) : invoices.length ? (\n          <div className=\"mt-3 overflow-x-auto rounded-lg border border-neutral-800\">\n            <table className=\"min-w-full text-left text-xs\">\n              <thead className=\"bg-black/40 text-neutral-400\">\n                <tr>\n                  <th className=\"px-3 py-2\">Date</th>\n                  <th className=\"px-3 py-2\">Invoice</th>\n                  <th className=\"px-3 py-2\">Status</th>\n                  <th className=\"px-3 py-2\">Due</th>\n                  <th className=\"px-3 py-2\">Paid</th>\n                  <th className=\"px-3 py-2\">Links</th>\n                </tr>\n              </thead>\n              <tbody>\n                {invoices.map((inv, idx) => (\n                  <tr key={String(inv?.id || `${inv?.number || \"row\"}-${idx}`)} className=\"border-t border-neutral-800\">\n                    <td className=\"px-3 py-2 text-neutral-300\">\n                      {inv?.created ? new Date(Number(inv.created) * 1000).toLocaleString() : \"-\"}\n                    </td>\n                    <td className=\"px-3 py-2 font-mono text-neutral-200\">{String(inv?.number || inv?.id || \"-\")}</td>\n                    <td className=\"px-3 py-2 text-neutral-200\">{String(inv?.status || \"-\")}</td>\n                    <td className=\"px-3 py-2 text-neutral-200\">{fmtMoney(Number(inv?.amount_due || 0), String(inv?.currency || \"USD\"))}</td>\n                    <td className=\"px-3 py-2 text-neutral-200\">{fmtMoney(Number(inv?.amount_paid || 0), String(inv?.currency || \"USD\"))}</td>\n                    <td className=\"px-3 py-2\">\n                      <div className=\"flex gap-2\">\n                        {inv?.hosted_invoice_url ? (\n                          <a className=\"text-sky-300 hover:underline\" href={String(inv.hosted_invoice_url)} target=\"_blank\" rel=\"noreferrer\">\n                            Hosted\n                          </a>\n                        ) : null}\n                        {inv?.invoice_pdf ? (\n                          <a className=\"text-sky-300 hover:underline\" href={String(inv.invoice_pdf)} target=\"_blank\" rel=\"noreferrer\">\n                            PDF\n                          </a>\n                        ) : null}\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        ) : (\n          <div className=\"mt-2 text-sm text-neutral-400\">No invoices found yet.</div>\n        )}\n      </div>\n    </div>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\db-debug\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":41,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1233,1236],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1233,1236],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1509,1512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1509,1512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2431,2434],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2431,2434],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/db-debug/page.tsx\r\nimport Link from \"next/link\";\r\nimport { redirect } from \"next/navigation\";\r\nimport { unstable_noStore as noStore } from \"next/cache\";\r\nimport { sql } from \"@/lib/db\";\r\nimport { requireRole } from \"@/lib/authz\";\r\n\r\nexport const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\nexport const revalidate = 0;\r\n\r\ntype TableRow = { table_name: string };\r\n\r\nexport default async function DbDebugPage() {\r\n  noStore();\r\n\r\n  try {\r\n    await requireRole(\"admin\");\r\n  } catch {\r\n    redirect(\"/api/auth/signin\");\r\n  }\r\n\r\n  let dbUser: string = \"unknown\";\r\n  let dbName: string | null = null;\r\n  let dbSchema: string | null = null;\r\n  let tables: TableRow[] = [];\r\n  let accessLogRegclass: string | null = null;\r\n  let accessLogColumns: string[] = [];\r\n  let accessLogCount: number | null = null;\r\n  let accessLogError: string | null = null;\r\n\r\n  try {\r\n    const r = (await sql`select current_user, current_database() as db, current_schema() as schema`) as unknown as Array<{\r\n      current_user: string;\r\n      db: string;\r\n      schema: string;\r\n    }>;\r\n    dbUser = r?.[0]?.current_user ?? \"unknown\";\r\n    dbName = r?.[0]?.db ?? null;\r\n    dbSchema = r?.[0]?.schema ?? null;\r\n  } catch (e: any) {\r\n    dbUser = `error: ${e?.message ?? String(e)}`;\r\n  }\r\n\r\n  try {\r\n    tables = (await sql`\r\n      select table_name\r\n      from information_schema.tables\r\n      where table_schema = 'public'\r\n      order by table_name\r\n    `) as unknown as TableRow[];\r\n  } catch (e: any) {\r\n    tables = [{ table_name: `error: ${e?.message ?? String(e)}` }];\r\n  }\r\n\r\n  try {\r\n    const r = (await sql`select to_regclass('public.doc_access_log')::text as reg`) as unknown as Array<{ reg: string | null }>;\r\n    accessLogRegclass = r?.[0]?.reg ?? null;\r\n  } catch {\r\n    accessLogRegclass = null;\r\n  }\r\n\r\n  if (accessLogRegclass) {\r\n    try {\r\n      const cols = (await sql`\r\n        select column_name\r\n        from information_schema.columns\r\n        where table_schema = 'public' and table_name = 'doc_access_log'\r\n        order by ordinal_position\r\n      `) as unknown as Array<{ column_name: string }>;\r\n      accessLogColumns = cols.map((c) => c.column_name);\r\n    } catch {\r\n      accessLogColumns = [];\r\n    }\r\n\r\n    try {\r\n      const c = (await sql`select count(*)::int as n from public.doc_access_log`) as unknown as Array<{ n: number }>;\r\n      accessLogCount = c?.[0]?.n ?? 0;\r\n    } catch (e: any) {\r\n      accessLogError = e?.message ?? String(e);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"mx-auto max-w-6xl p-6 text-white\">\r\n      <div className=\"mb-6 flex items-center justify-between gap-3\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-semibold\">DB Debug</h1>\r\n          <p className=\"text-sm text-neutral-400\">Verifies what tables/columns exist in production.</p>\r\n        </div>\r\n        <Link\r\n          href=\"/admin/dashboard\"\r\n          className=\"rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-900\"\r\n        >\r\n          ← Back to dashboard\r\n        </Link>\r\n      </div>\r\n\r\n      <div className=\"space-y-6\">\r\n        <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\r\n          <div className=\"text-sm text-neutral-400\">Connection</div>\r\n          <div className=\"mt-2 grid gap-2 text-sm\">\r\n            <div>\r\n              <span className=\"text-neutral-500\">current_user:</span> {dbUser}\r\n            </div>\r\n            <div>\r\n              <span className=\"text-neutral-500\">database:</span> {dbName ?? \"—\"}\r\n            </div>\r\n            <div>\r\n              <span className=\"text-neutral-500\">schema:</span> {dbSchema ?? \"—\"}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\r\n          <div className=\"mb-3 text-sm text-neutral-400\">public tables</div>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"min-w-[420px] text-sm\">\r\n              <thead className=\"text-left text-neutral-400\">\r\n                <tr className=\"border-b border-neutral-800\">\r\n                  <th className=\"py-2 pr-4\">table_name</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {tables.map((t, i) => (\r\n                  <tr key={i} className=\"border-b border-neutral-900\">\r\n                    <td className=\"py-2 pr-4\">{t.table_name}</td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\r\n          <div className=\"mb-2 text-sm text-neutral-400\">public.doc_access_log</div>\r\n          {!accessLogRegclass ? (\r\n            <div className=\"text-sm text-yellow-400\">Not found (to_regclass returned null).</div>\r\n          ) : (\r\n            <div className=\"space-y-3 text-sm\">\r\n              <div>\r\n                <span className=\"text-neutral-500\">regclass:</span> {accessLogRegclass}\r\n              </div>\r\n              <div>\r\n                <span className=\"text-neutral-500\">row count:</span> {accessLogCount ?? \"—\"}\r\n              </div>\r\n              {accessLogError && (\r\n                <div className=\"text-red-400\">\r\n                  <span className=\"text-neutral-500\">error:</span> {accessLogError}\r\n                </div>\r\n              )}\r\n              <div>\r\n                <div className=\"text-neutral-500\">columns:</div>\r\n                <div className=\"mt-1 overflow-x-auto rounded-lg border border-neutral-800 bg-black p-2\">\r\n                  <code className=\"whitespace-pre text-xs text-neutral-300\">\r\n                    {accessLogColumns.length ? accessLogColumns.join(\", \") : \"(none returned)\"}\r\n                  </code>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\debug\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[406,409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[406,409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[425,428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[425,428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[444,447],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[444,447],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[567,570],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[567,570],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":90,"column":9,"nodeType":"JSXOpeningElement","endLine":95,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport Link from \"next/link\";\nimport { cookies, headers } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { requireRole } from \"@/lib/authz\";\n\ntype DebugResponse =\n  | {\n    ok: true;\n    now: string;\n    tables: Record<string, boolean>;\n    env: Record<string, boolean>;\n    alias?: string;\n    alias_row?: any;\n    doc_row?: any;\n    r2_head?: any;\n    notes?: string[];\n  }\n  | { ok: false; error: string; message?: string };\n\nfunction Row({ k, v }: { k: string; v: any }) {\n  return (\n    <div className=\"flex items-start justify-between gap-3 border-b border-white/10 py-2\">\n      <div className=\"text-sm text-white/70\">{k}</div>\n      <pre className=\"max-w-[70%] overflow-auto rounded bg-black/40 p-2 text-xs text-white/90\">\n        {typeof v === \"string\" ? v : JSON.stringify(v, null, 2)}\n      </pre>\n    </div>\n  );\n}\n\nasync function getOrigin() {\n  const h = await headers();\n  const proto = h.get(\"x-forwarded-proto\") ?? \"https\";\n  const host = h.get(\"x-forwarded-host\") ?? h.get(\"host\") ?? \"www.cyang.io\";\n  return `${proto}://${host}`;\n}\n\nexport default async function AdminDebugPage({\n  searchParams,\n}: {\n  searchParams: Promise<{ alias?: string }>;\n}) {\n  try {\n    await requireRole(\"admin\");\n  } catch {\n    redirect(\"/api/auth/signin\");\n  }\n\n  const sp = await searchParams;\n  const alias = (sp.alias || \"\").trim();\n\n  let data: DebugResponse | null = null;\n\n  if (alias) {\n    const origin = await getOrigin();\n    const url = new URL(\"/api/admin/debug\", origin);\n    url.searchParams.set(\"alias\", alias);\n\n    const cookieHeader = (await cookies()).toString();\n\n    const res = await fetch(url.toString(), {\n      cache: \"no-store\",\n      headers: {\n        cookie: cookieHeader,\n        accept: \"application/json\",\n      },\n    });\n\n    data = (await res.json().catch(() => null)) as DebugResponse | null;\n  }\n\n  return (\n    <div className=\"mx-auto max-w-3xl p-6 text-white\">\n      <div className=\"flex items-center justify-between gap-4\">\n        <h1 className=\"text-xl font-semibold\">Admin Debug</h1>\n        <Link className=\"text-sm text-white/70 hover:text-white\" href=\"/admin\">\n          Back to Admin\n        </Link>\n      </div>\n\n      <p className=\"mt-2 text-sm text-white/70\">\n        This page helps diagnose why a magic link alias or serve redirect is returning 404. It runs on the server and\n        calls a protected API route (owner-only).\n      </p>\n\n      <form className=\"mt-6 flex gap-2\" action=\"/admin/debug\" method=\"get\">\n        <input\n          name=\"alias\"\n          defaultValue={alias}\n          placeholder=\"alias (e.g. the-mom-test-en-2)\"\n          className=\"w-full rounded border border-white/10 bg-black/30 px-3 py-2 text-sm text-white outline-none placeholder:text-white/40\"\n        />\n        <button className=\"rounded bg-white px-4 py-2 text-sm font-medium text-black hover:bg-white/90\">\n          Check\n        </button>\n      </form>\n\n      {!alias ? (\n        <div className=\"mt-6 rounded-lg border border-white/10 bg-black/30 p-4 text-sm text-white/70\">\n          Enter an alias above and click <b>Check</b>.\n        </div>\n      ) : !data ? (\n        <div className=\"mt-6 rounded-lg border border-white/10 bg-black/30 p-4 text-sm text-white/70\">Loading…</div>\n      ) : !data.ok ? (\n        <div className=\"mt-6 rounded-lg border border-red-500/40 bg-red-500/10 p-4 text-sm\">\n          <div className=\"font-semibold text-red-200\">Error: {data.error}</div>\n          {data.message ? <div className=\"mt-1 text-red-200/80\">{data.message}</div> : null}\n        </div>\n      ) : (\n        <div className=\"mt-6 space-y-6\">\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">Summary</div>\n            <div className=\"mt-2 text-sm text-white/70\">\n              Alias: <span className=\"text-white\">{data.alias}</span>\n            </div>\n            <div className=\"mt-1 text-sm text-white/70\">\n              Checked at: <span className=\"text-white\">{data.now}</span>\n            </div>\n            {data.notes?.length ? (\n              <ul className=\"mt-3 list-disc space-y-1 pl-5 text-sm text-white/80\">\n                {data.notes.map((n, i) => (\n                  <li key={i}>{n}</li>\n                ))}\n              </ul>\n            ) : null}\n          </div>\n\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">Tables detected</div>\n            <div className=\"mt-3\">\n              {Object.entries(data.tables).map(([k, v]) => (\n                <Row key={k} k={k} v={v} />\n              ))}\n            </div>\n          </div>\n\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">Env vars present (boolean only)</div>\n            <div className=\"mt-3\">\n              {Object.entries(data.env).map(([k, v]) => (\n                <Row key={k} k={k} v={v} />\n              ))}\n            </div>\n          </div>\n\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">Alias row</div>\n            <div className=\"mt-3\">\n              <Row k=\"public.doc_aliases row\" v={data.alias_row ?? null} />\n            </div>\n          </div>\n\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">Document row</div>\n            <div className=\"mt-3\">\n              <Row k=\"doc row\" v={data.doc_row ?? null} />\n            </div>\n          </div>\n\n          <div className=\"rounded-lg border border-white/10 bg-black/30 p-4\">\n            <div className=\"text-sm font-semibold\">R2 HEAD (best-effort)</div>\n            <div className=\"mt-3\">\n              <Row k=\"head\" v={data.r2_head ?? null} />\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\dmca\\DmcaActionsClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[157,160],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[157,160],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[718,721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[718,721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[899,902],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[899,902],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useState } from \"react\";\n\ntype Props = {\n  noticeId: string;\n  docId: string | null;\n  status: string;\n};\n\nasync function post(body: any) {\n  const res = await fetch(\"/api/admin/dmca\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(body),\n  });\n  const data = await res.json().catch(() => ({}));\n  if (!res.ok || !data?.ok) {\n    throw new Error(data?.error || data?.message || \"Request failed\");\n  }\n  return data;\n}\n\nexport default function DmcaActionsClient({ noticeId, docId, status }: Props) {\n  const [busy, setBusy] = useState<string | null>(null);\n  const [msg, setMsg] = useState<string | null>(null);\n\n  async function act(action: any, label: string) {\n    if (busy) return;\n    setBusy(label);\n    setMsg(null);\n    try {\n      await post(action);\n      setMsg(\"Done. Refresh to see updates.\");\n    } catch (e: any) {\n      setMsg(String(e?.message || e));\n    } finally {\n      setBusy(null);\n    }\n  }\n\n  return (\n    <div className=\"flex flex-wrap items-center gap-2\">\n      <button\n        className=\"rounded-md bg-white/10 px-3 py-1.5 text-sm text-white hover:bg-white/15 disabled:opacity-50\"\n        disabled={!!busy}\n        onClick={() => act({ action: \"set_status\", noticeId, status: \"reviewing\" }, \"reviewing\")}\n      >\n        Mark reviewing\n      </button>\n\n      <button\n        className=\"rounded-md bg-white/10 px-3 py-1.5 text-sm text-white hover:bg-white/15 disabled:opacity-50\"\n        disabled={!!busy}\n        onClick={() => act({ action: \"set_status\", noticeId, status: \"accepted\" }, \"accepted\")}\n      >\n        Accept\n      </button>\n\n      <button\n        className=\"rounded-md bg-white/10 px-3 py-1.5 text-sm text-white hover:bg-white/15 disabled:opacity-50\"\n        disabled={!!busy}\n        onClick={() => act({ action: \"set_status\", noticeId, status: \"rejected\" }, \"rejected\")}\n      >\n        Reject\n      </button>\n\n      <button\n        className=\"rounded-md bg-red-500/20 px-3 py-1.5 text-sm text-red-200 hover:bg-red-500/25 disabled:opacity-50\"\n        disabled={!!busy || !docId}\n        onClick={() => {\n          if (!docId) return;\n          const confirm = window.prompt(`Type exactly: TAKEDOWN ${docId}`);\n          if (!confirm) return;\n          act({ action: \"takedown_doc\", noticeId, docId, reason: \"dmca:takedown\", confirm }, \"takedown\");\n        }}\n      >\n        Disable (takedown)\n      </button>\n\n      <button\n        className=\"rounded-md bg-emerald-500/15 px-3 py-1.5 text-sm text-emerald-200 hover:bg-emerald-500/20 disabled:opacity-50\"\n        disabled={!!busy || !docId}\n        onClick={() => {\n          if (!docId) return;\n          const confirm = window.prompt(`Type exactly: RESTORE ${docId}`);\n          if (!confirm) return;\n          act({ action: \"restore_doc\", noticeId, docId, reason: \"dmca:restored\", confirm }, \"restore\");\n        }}\n      >\n        Restore\n      </button>\n\n      {msg ? <span className=\"text-xs text-white/60\">{msg}</span> : null}\n      <span className=\"text-xs text-white/40\">Status: {status}</span>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\dmca\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[469,472],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[469,472],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/auth\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nexport default async function OwnerAdminLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const session = await getServerSession(authOptions);\n  if (!session?.user) redirect(\"/signin\");\n\n  // Hard gate all (owner) routes.\n  const role = (session.user as any)?.role as string | undefined;\n  const isOwner = role === \"owner\";\n  if (!isOwner) redirect(\"/admin/dashboard\");\n\n  // IMPORTANT: Do NOT render AdminTopNav here.\n  // /admin/layout.tsx already renders the shared header.\n  // Rendering it again causes a duplicated header.\n  return <>{children}</>;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\security\\KeyManagementPanel.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":242,"column":11,"nodeType":"JSXOpeningElement","endLine":248,"endColumn":13},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":288,"column":13,"nodeType":"JSXOpeningElement","endLine":295,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useState } from \"react\";\n\ntype MasterKeyRow = { id: string; active: boolean; revoked: boolean };\ntype MasterKeyChange = {\n  id: string;\n  created_at: string;\n  changed_by_user_id: string | null;\n  previous_key_id: string | null;\n  new_key_id: string;\n  reason: string | null;\n  rollback_of_change_id: string | null;\n};\ntype RotationJob = {\n  id: string;\n  created_at: string;\n  started_at: string | null;\n  finished_at: string | null;\n  from_key_id: string;\n  to_key_id: string;\n  status: \"queued\" | \"running\" | \"completed\" | \"failed\" | \"canceled\";\n  scanned_count: number;\n  rotated_count: number;\n  failed_count: number;\n  max_batch: number;\n  last_error: string | null;\n};\ntype KeysOk = {\n  ok: true;\n  configured: boolean;\n  active_key_id: string | null;\n  db_active_key_id: string | null;\n  revoked_active: boolean;\n  keys: MasterKeyRow[];\n  changes: MasterKeyChange[];\n  jobs: RotationJob[];\n  job_summary: { queued: number; running: number; failed: number };\n};\ntype KeysErr = { ok: false; error: string; message?: string };\ntype KeysResponse = KeysOk | KeysErr;\n\nfunction pillClass(active: boolean, revoked: boolean): string {\n  if (revoked) return \"border-red-400/20 bg-red-400/10 text-red-200\";\n  if (active) return \"border-emerald-400/20 bg-emerald-400/10 text-emerald-200\";\n  return \"border-white/10 bg-white/5 text-white/70\";\n}\n\nfunction statusClass(status: RotationJob[\"status\"]): string {\n  if (status === \"completed\") return \"border-emerald-500/30 bg-emerald-500/10 text-emerald-200\";\n  if (status === \"running\") return \"border-blue-500/30 bg-blue-500/10 text-blue-200\";\n  if (status === \"failed\") return \"border-red-500/30 bg-red-500/10 text-red-200\";\n  return \"border-white/15 bg-white/5 text-white/70\";\n}\n\nexport default function KeyManagementPanel() {\n  const [data, setData] = useState<KeysResponse | null>(null);\n  const [busy, setBusy] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const keys = useMemo(() => (data && data.ok ? data.keys : []), [data]);\n  const activeId = data && data.ok ? data.active_key_id : null;\n  const changes = data && data.ok ? data.changes : [];\n  const jobs = data && data.ok ? data.jobs : [];\n  const jobSummary = data && data.ok ? data.job_summary : { queued: 0, running: 0, failed: 0 };\n\n  const [activateKey, setActivateKey] = useState<string>(\"\");\n  const [activateReason, setActivateReason] = useState<string>(\"\");\n  const [fromKey, setFromKey] = useState<string>(\"\");\n  const [toKey, setToKey] = useState<string>(\"\");\n  const [limit, setLimit] = useState<number>(250);\n\n  async function refresh() {\n    setError(null);\n    const r = await fetch(\"/api/admin/security/keys\", { method: \"GET\" });\n    const j = (await r.json().catch(() => null)) as KeysResponse | null;\n    if (!j) {\n      setError(\"Failed to load keys.\");\n      return;\n    }\n    setData(j);\n    if (!r.ok || !j.ok) setError(j.ok ? \"Failed to load keys.\" : (j.error || \"Failed to load keys.\"));\n  }\n\n  useEffect(() => {\n    void refresh();\n  }, []);\n\n  async function onActivate() {\n    if (!activateKey) {\n      setError(\"Select a key to activate.\");\n      return;\n    }\n    if (!confirm(`Switch active key to \"${activateKey}\"?`)) return;\n    setBusy(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/security/activate\", {\n        method: \"POST\",\n        headers: { \"content-type\": \"application/json\" },\n        body: JSON.stringify({ key_id: activateKey, reason: activateReason || undefined }),\n      });\n      const j = (await r.json().catch(() => null)) as { ok?: boolean; error?: string } | null;\n      if (!r.ok || !j?.ok) throw new Error(j?.error || \"Activate failed.\");\n      await refresh();\n    } catch (e: unknown) {\n      setError(e instanceof Error ? e.message : \"Activate failed.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  async function onRevoke(id: string) {\n    if (!confirm(`Revoke key \"${id}\"? This blocks decrypts for docs still on this key.`)) return;\n    setBusy(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/security/revoke\", {\n        method: \"POST\",\n        headers: { \"content-type\": \"application/json\" },\n        body: JSON.stringify({ key_id: id }),\n      });\n      const j = (await r.json().catch(() => null)) as { ok?: boolean; error?: string } | null;\n      if (!r.ok || !j?.ok) throw new Error(j?.error || \"Revoke failed.\");\n      await refresh();\n    } catch (e: unknown) {\n      setError(e instanceof Error ? e.message : \"Revoke failed.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  async function onEnqueueRotation() {\n    if (!fromKey || !toKey) {\n      setError(\"Select FROM and TO keys.\");\n      return;\n    }\n    if (fromKey === toKey) {\n      setError(\"FROM and TO keys must differ.\");\n      return;\n    }\n    setBusy(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/security/rotate\", {\n        method: \"POST\",\n        headers: { \"content-type\": \"application/json\" },\n        body: JSON.stringify({\n          from_key_id: fromKey,\n          to_key_id: toKey,\n          limit,\n          async_job: true,\n        }),\n      });\n      const j = (await r.json().catch(() => null)) as { ok?: boolean; error?: string } | null;\n      if (!r.ok || !j?.ok) throw new Error(j?.error || \"Failed to enqueue rotation job.\");\n      await refresh();\n    } catch (e: unknown) {\n      setError(e instanceof Error ? e.message : \"Failed to enqueue rotation job.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  async function onRollback(changeId: string, previousKeyId: string | null) {\n    if (!previousKeyId) return;\n    if (!confirm(`Rollback key change to restore \"${previousKeyId}\"?`)) return;\n    setBusy(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/security/rollback\", {\n        method: \"POST\",\n        headers: { \"content-type\": \"application/json\" },\n        body: JSON.stringify({ change_id: changeId }),\n      });\n      const j = (await r.json().catch(() => null)) as { ok?: boolean; error?: string } | null;\n      if (!r.ok || !j?.ok) throw new Error(j?.error || \"Rollback failed.\");\n      await refresh();\n    } catch (e: unknown) {\n      setError(e instanceof Error ? e.message : \"Rollback failed.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <section className=\"rounded-xl border border-white/10 bg-white/5 p-4\">\n      <div className=\"flex flex-wrap items-start justify-between gap-3\">\n        <div>\n          <h2 className=\"text-sm font-semibold\">Master key operations</h2>\n          <p className=\"mt-1 text-xs text-white/50\">\n            Active key switching, async rewrap jobs, and rollback history.\n          </p>\n        </div>\n        <button\n          onClick={() => void refresh()}\n          disabled={busy}\n          className=\"rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 disabled:opacity-50\"\n        >\n          Refresh\n        </button>\n      </div>\n\n      <div className=\"mt-3 flex flex-wrap gap-2\">\n        {keys.length ? (\n          keys.map((k) => (\n            <div key={k.id} className={`inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs ${pillClass(k.active, k.revoked)}`}>\n              <span className=\"font-mono\">{k.id}</span>\n              {k.active ? <span className=\"text-[10px]\">ACTIVE</span> : null}\n              {k.revoked ? <span className=\"text-[10px]\">REVOKED</span> : null}\n              <button\n                disabled={busy || k.revoked}\n                onClick={() => void onRevoke(k.id)}\n                className=\"rounded-full border border-white/10 bg-black/20 px-2 py-0.5 text-[10px] font-semibold hover:bg-black/30 disabled:opacity-50\"\n                title=\"Revoke key\"\n              >\n                Revoke\n              </button>\n            </div>\n          ))\n        ) : (\n          <div className=\"text-sm text-white/60\">No keys detected. Configure DOC_MASTER_KEYS.</div>\n        )}\n      </div>\n\n      <div className=\"mt-4 grid gap-3 lg:grid-cols-3\">\n        <div className=\"rounded-lg border border-white/10 bg-black/30 p-3\">\n          <div className=\"text-xs font-semibold text-white/80\">Active key switch</div>\n          <div className=\"mt-1 text-[11px] text-white/60\">Current: {activeId || \"none\"}</div>\n          <select\n            value={activateKey}\n            onChange={(e) => setActivateKey(e.target.value)}\n            className=\"mt-2 w-full rounded-lg border border-white/10 bg-black/40 px-2 py-2 text-xs outline-none focus:border-white/20\"\n          >\n            <option value=\"\">Select key...</option>\n            {keys.filter((k) => !k.revoked).map((k) => (\n              <option key={k.id} value={k.id}>\n                {k.id}\n              </option>\n            ))}\n          </select>\n          <input\n            type=\"text\"\n            value={activateReason}\n            onChange={(e) => setActivateReason(e.target.value)}\n            placeholder=\"Reason (optional)\"\n            className=\"mt-2 w-full rounded-lg border border-white/10 bg-black/40 px-2 py-2 text-xs outline-none focus:border-white/20\"\n          />\n          <button\n            onClick={() => void onActivate()}\n            disabled={busy || !activateKey}\n            className=\"mt-2 w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 disabled:opacity-50\"\n          >\n            Set Active Key\n          </button>\n        </div>\n\n        <div className=\"rounded-lg border border-white/10 bg-black/30 p-3 lg:col-span-2\">\n          <div className=\"text-xs font-semibold text-white/80\">Re-encryption job queue</div>\n          <p className=\"mt-1 text-[11px] text-white/55\">\n            Jobs are processed by Cloudflare-triggered cron calling `/api/cron/key-rotation`.\n          </p>\n          <div className=\"mt-2 grid gap-2 md:grid-cols-3\">\n            <select\n              value={fromKey}\n              onChange={(e) => setFromKey(e.target.value)}\n              className=\"rounded-lg border border-white/10 bg-black/40 px-2 py-2 text-xs outline-none focus:border-white/20\"\n            >\n              <option value=\"\">FROM key...</option>\n              {keys.map((k) => (\n                <option key={k.id} value={k.id}>\n                  {k.id}\n                </option>\n              ))}\n            </select>\n            <select\n              value={toKey}\n              onChange={(e) => setToKey(e.target.value)}\n              className=\"rounded-lg border border-white/10 bg-black/40 px-2 py-2 text-xs outline-none focus:border-white/20\"\n            >\n              <option value=\"\">TO key...</option>\n              {keys.filter((k) => !k.revoked).map((k) => (\n                <option key={k.id} value={k.id}>\n                  {k.id}\n                </option>\n              ))}\n            </select>\n            <input\n              type=\"number\"\n              min={1}\n              max={2000}\n              value={limit}\n              onChange={(e) => setLimit(Number(e.target.value || 250))}\n              className=\"rounded-lg border border-white/10 bg-black/40 px-2 py-2 text-xs outline-none focus:border-white/20\"\n            />\n          </div>\n          <div className=\"mt-2 flex items-center gap-2 text-xs text-white/60\">\n            <span>Queued: {jobSummary.queued}</span>\n            <span>Running: {jobSummary.running}</span>\n            <span>Failed: {jobSummary.failed}</span>\n          </div>\n          <button\n            onClick={() => void onEnqueueRotation()}\n            disabled={busy || !fromKey || !toKey}\n            className=\"mt-2 rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-xs font-semibold hover:bg-white/10 disabled:opacity-50\"\n          >\n            Enqueue Rotation Job\n          </button>\n        </div>\n      </div>\n\n      <div className=\"mt-4 grid gap-3 lg:grid-cols-2\">\n        <div className=\"rounded-lg border border-white/10 bg-black/30 p-3\">\n          <div className=\"text-xs font-semibold text-white/80\">Recent key changes</div>\n          <div className=\"mt-2 space-y-2\">\n            {changes.length ? (\n              changes.map((c) => (\n                <div key={c.id} className=\"rounded-lg border border-white/10 bg-black/20 p-2 text-xs\">\n                  <div className=\"font-mono text-white/70\">{c.created_at}</div>\n                  <div className=\"mt-1 text-white/80\">{c.previous_key_id || \"none\"} → {c.new_key_id}</div>\n                  <div className=\"text-white/50\">{c.reason || \"no reason\"}</div>\n                  <button\n                    onClick={() => void onRollback(c.id, c.previous_key_id)}\n                    disabled={busy || !c.previous_key_id}\n                    className=\"mt-1 rounded border border-white/15 bg-white/5 px-2 py-1 text-[11px] font-semibold hover:bg-white/10 disabled:opacity-40\"\n                  >\n                    Rollback\n                  </button>\n                </div>\n              ))\n            ) : (\n              <div className=\"text-xs text-white/60\">No key change history available.</div>\n            )}\n          </div>\n        </div>\n\n        <div className=\"rounded-lg border border-white/10 bg-black/30 p-3\">\n          <div className=\"text-xs font-semibold text-white/80\">Rotation jobs</div>\n          <div className=\"mt-2 space-y-2\">\n            {jobs.length ? (\n              jobs.map((j) => (\n                <div key={j.id} className=\"rounded-lg border border-white/10 bg-black/20 p-2 text-xs\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"font-mono text-white/70\">{j.id.slice(0, 8)}</div>\n                    <span className={`rounded-md border px-2 py-0.5 text-[10px] ${statusClass(j.status)}`}>{j.status}</span>\n                  </div>\n                  <div className=\"mt-1 text-white/80\">{j.from_key_id} → {j.to_key_id}</div>\n                  <div className=\"text-white/55\">\n                    scanned {j.scanned_count}, rotated {j.rotated_count}, failed {j.failed_count}\n                  </div>\n                  {j.last_error ? <div className=\"mt-1 text-red-300\">{j.last_error}</div> : null}\n                </div>\n              ))\n            ) : (\n              <div className=\"text-xs text-white/60\">No jobs yet.</div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {error ? <div className=\"mt-3 text-sm text-red-300\">{error}</div> : null}\n    </section>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\security\\page.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":281,"column":13,"nodeType":"JSXOpeningElement","endLine":281,"endColumn":119},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":285,"column":13,"nodeType":"JSXOpeningElement","endLine":285,"endColumn":117},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":289,"column":13,"nodeType":"JSXOpeningElement","endLine":289,"endColumn":117},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":293,"column":13,"nodeType":"JSXOpeningElement","endLine":293,"endColumn":119},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":481,"column":17,"nodeType":"JSXOpeningElement","endLine":481,"endColumn":156},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":493,"column":17,"nodeType":"JSXOpeningElement","endLine":493,"endColumn":194},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":514,"column":23,"nodeType":"JSXOpeningElement","endLine":514,"endColumn":49},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":527,"column":23,"nodeType":"JSXOpeningElement","endLine":527,"endColumn":49},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":558,"column":23,"nodeType":"JSXOpeningElement","endLine":558,"endColumn":49},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":610,"column":25,"nodeType":"JSXOpeningElement","endLine":610,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\nimport KeyManagementPanel from \"./KeyManagementPanel\";\nimport { RBAC_PERMISSIONS, listRolePermissionOverrides, permissionsTableExists } from \"@/lib/rbac\";\nimport type { Role } from \"@/lib/authz\";\nimport { requireRole } from \"@/lib/authz\";\nimport { listOrgMemberships, listPendingOrgInvites, orgMembershipTablesReady } from \"@/lib/orgMembership\";\nimport { getSecurityFreezeSettings } from \"@/lib/settings\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nfunction fmt(n: number) {\n  try {\n    return Intl.NumberFormat().format(n);\n  } catch {\n    return String(n);\n  }\n}\n\nexport default async function SecurityTelemetryPage(props: {\n  searchParams?: Promise<Record<string, string | string[] | undefined>>;\n}) {\n  const sp = (await props.searchParams) || {};\n  const saved = (Array.isArray(sp.saved) ? sp.saved[0] : sp.saved) || \"\";\n  const error = (Array.isArray(sp.error) ? sp.error[0] : sp.error) || \"\";\n  const requeuedRaw = (Array.isArray(sp.requeued) ? sp.requeued[0] : sp.requeued) || \"0\";\n  const requeuedCount = Number.isFinite(Number(requeuedRaw)) ? Number(requeuedRaw) : 0;\n  const inviteUrl = (Array.isArray(sp.invite_url) ? sp.invite_url[0] : sp.invite_url) || \"\";\n  const currentUser = await requireRole(\"owner\");\n  const freezeSettingsRes = await getSecurityFreezeSettings();\n  const freeze = freezeSettingsRes.settings;\n  let orgFreezeSupported = false;\n  let orgIsFrozen = false;\n  if (currentUser.orgId) {\n    try {\n      const rows = (await sql`\n        select\n          coalesce(disabled, false) as disabled,\n          coalesce(is_active, true) as is_active\n        from public.organizations\n        where id = ${currentUser.orgId}::uuid\n        limit 1\n      `) as unknown as Array<{ disabled: boolean; is_active: boolean }>;\n      if (rows?.length) {\n        orgFreezeSupported = true;\n        orgIsFrozen = Boolean(rows[0].disabled) || !Boolean(rows[0].is_active);\n      }\n    } catch {\n      try {\n        const rows = (await sql`\n          select disabled\n          from public.organizations\n          where id = ${currentUser.orgId}::uuid\n          limit 1\n        `) as unknown as Array<{ disabled: boolean }>;\n        if (rows?.length) {\n          orgFreezeSupported = true;\n          orgIsFrozen = Boolean(rows[0].disabled);\n        }\n      } catch {\n        try {\n          const rows = (await sql`\n            select is_active\n            from public.organizations\n            where id = ${currentUser.orgId}::uuid\n            limit 1\n          `) as unknown as Array<{ is_active: boolean }>;\n          if (rows?.length) {\n            orgFreezeSupported = true;\n            orgIsFrozen = !Boolean(rows[0].is_active);\n          }\n        } catch {\n          orgFreezeSupported = false;\n        }\n      }\n    }\n  }\n\n  // Recent security events\n  const events = (await sql`\n    select\n      id::text as id,\n      created_at::text as created_at,\n      type::text as type,\n      severity::text as severity,\n      scope::text as scope,\n      message::text as message,\n      ip_hash::text as ip_hash,\n      actor_user_id::text as actor_user_id,\n      doc_id::text as doc_id\n    from public.security_events\n    order by created_at desc\n    limit 100\n  `) as unknown as Array<{\n    id: string;\n    created_at: string;\n    type: string;\n    severity: string;\n    scope: string | null;\n    message: string | null;\n    ip_hash: string | null;\n    actor_user_id: string | null;\n    doc_id: string | null;\n  }>;\n\n  // Top IPs by rate-limit events (last 24h)\n  const topIps = (await sql`\n    select\n      ip_hash::text as ip_hash,\n      count(*)::int as hits,\n      max(created_at)::text as last_seen\n    from public.security_events\n    where created_at > now() - interval '24 hours'\n      and type in ('rate_limit','upload_throttle')\n      and ip_hash is not null\n    group by ip_hash\n    order by hits desc\n    limit 12\n  `) as unknown as Array<{ ip_hash: string; hits: number; last_seen: string }>;\n\n  // Decrypt logs (last 24h)\n  const decrypts = (await sql`\n    select\n      count(*)::int as total,\n      count(distinct doc_id)::int as docs\n    from public.doc_decrypt_log\n    where created_at > now() - interval '24 hours'\n  `) as unknown as Array<{ total: number; docs: number }>;\n\n  const decryptTotal = Number(decrypts?.[0]?.total ?? 0);\n  const decryptDocs = Number(decrypts?.[0]?.docs ?? 0);\n\n  let scanQueueSummary = {\n    queued: 0,\n    running: 0,\n    error: 0,\n    deadLetter: 0,\n  };\n  let deadLetters: Array<{\n    id: string;\n    created_at: string;\n    finished_at: string | null;\n    doc_id: string;\n    attempts: number;\n    last_error: string | null;\n    r2_key: string | null;\n  }> = [];\n\n  const roles: Role[] = [\"viewer\", \"admin\", \"owner\"];\n  const membershipTableReady = await orgMembershipTablesReady();\n  const orgMembers = membershipTableReady && currentUser.orgId ? await listOrgMemberships(currentUser.orgId) : [];\n  const orgInvites = membershipTableReady && currentUser.orgId ? await listPendingOrgInvites(currentUser.orgId) : [];\n  const rbacTableReady = await permissionsTableExists();\n  const rbacOverrides = rbacTableReady ? await listRolePermissionOverrides() : [];\n  const rbacMap = new Map<string, boolean>();\n  for (const row of rbacOverrides) {\n    rbacMap.set(`${row.permission}:${row.role}`, Boolean(row.allowed));\n  }\n\n  try {\n    const queueRows = (await sql`\n      select\n        sum(case when status = 'queued' then 1 else 0 end)::int as queued,\n        sum(case when status = 'running' then 1 else 0 end)::int as running,\n        sum(case when status = 'error' then 1 else 0 end)::int as error,\n        sum(case when status = 'dead_letter' then 1 else 0 end)::int as dead_letter\n      from public.malware_scan_jobs\n    `) as unknown as Array<{ queued: number; running: number; error: number; dead_letter: number }>;\n\n    scanQueueSummary = {\n      queued: Number(queueRows?.[0]?.queued ?? 0),\n      running: Number(queueRows?.[0]?.running ?? 0),\n      error: Number(queueRows?.[0]?.error ?? 0),\n      deadLetter: Number(queueRows?.[0]?.dead_letter ?? 0),\n    };\n\n    deadLetters = (await sql`\n      select\n        id::text as id,\n        created_at::text as created_at,\n        finished_at::text as finished_at,\n        doc_id::text as doc_id,\n        attempts::int as attempts,\n        last_error::text as last_error,\n        r2_key::text as r2_key\n      from public.malware_scan_jobs\n      where status = 'dead_letter'\n      order by finished_at desc nulls last, created_at desc\n      limit 25\n    `) as unknown as Array<{\n      id: string;\n      created_at: string;\n      finished_at: string | null;\n      doc_id: string;\n      attempts: number;\n      last_error: string | null;\n      r2_key: string | null;\n    }>;\n  } catch {\n    // optional table in some environments\n  }\n\n  return (\n    <div>\n      <div className=\"flex flex-wrap items-end justify-between gap-3\">\n        <div>\n          <h1 className=\"text-2xl font-semibold tracking-tight\">Security</h1>\n          <p className=\"mt-1 text-sm text-white/60\">\n            Rate limiting, anomaly signals, and decrypt audit telemetry.\n          </p>\n        </div>\n\n        <div className=\"flex flex-wrap items-center gap-2\">\n          <div className=\"rounded-lg border border-white/10 bg-white/5 px-3 py-2\">\n            <div className=\"text-xs text-white/60\">Decrypts (24h)</div>\n            <div className=\"mt-1 text-sm font-semibold\">{fmt(decryptTotal)}</div>\n            <div className=\"text-xs text-white/50\">Docs: {fmt(decryptDocs)}</div>\n          </div>\n          <div className=\"rounded-lg border border-white/10 bg-white/5 px-3 py-2\">\n            <div className=\"text-xs text-white/60\">Scan queue</div>\n            <div className=\"mt-1 text-sm font-semibold\">\n              Q {fmt(scanQueueSummary.queued)} | R {fmt(scanQueueSummary.running)} | E {fmt(scanQueueSummary.error)}\n            </div>\n            <div className=\"text-xs text-red-300\">Dead-letter: {fmt(scanQueueSummary.deadLetter)}</div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"mt-6\">\n        <KeyManagementPanel />\n      </div>\n\n      {saved === \"rbac\" ? (\n        <div className=\"mt-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200\">\n          RBAC override updated.\n        </div>\n      ) : null}\n      {error ? (\n        <div className=\"mt-4 rounded-lg border border-red-500/30 bg-red-500/10 px-3 py-2 text-xs text-red-200\">\n          RBAC update failed: {error}\n        </div>\n      ) : null}\n      {saved === \"org_invite\" && inviteUrl ? (\n        <div className=\"mt-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200\">\n          Invite created: <span className=\"font-mono break-all\">{inviteUrl}</span>\n        </div>\n      ) : null}\n      {saved === \"freeze\" ? (\n        <div className=\"mt-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200\">\n          Emergency freeze controls updated.\n        </div>\n      ) : null}\n      {saved === \"tenant_frozen\" ? (\n        <div className=\"mt-4 rounded-lg border border-amber-500/30 bg-amber-500/10 px-3 py-2 text-xs text-amber-200\">\n          Tenant emergency freeze enabled.\n        </div>\n      ) : null}\n      {saved === \"tenant_unfrozen\" ? (\n        <div className=\"mt-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200\">\n          Tenant emergency freeze disabled.\n        </div>\n      ) : null}\n      {saved === \"scan_requeued\" ? (\n        <div className=\"mt-4 rounded-lg border border-emerald-500/30 bg-emerald-500/10 px-3 py-2 text-xs text-emerald-200\">\n          Requeued {fmt(requeuedCount)} pending scan job(s).\n        </div>\n      ) : null}\n\n      <div className=\"mt-4 rounded-xl border border-red-500/30 bg-red-500/10 p-4\">\n        <h2 className=\"text-sm font-semibold text-red-100\">Incident kill-switch controls</h2>\n        <p className=\"mt-1 text-xs text-red-200/80\">\n          Immediate runtime freeze controls for serve paths. Use minimum scope first (share or alias) before global freeze.\n        </p>\n        <p className=\"mt-1 text-xs text-red-200/70\">\n          Runbook: <span className=\"font-mono\">docs/incident-response-runbook.md</span>\n        </p>\n\n        <form action=\"/api/admin/security/freeze\" method=\"post\" className=\"mt-3 grid gap-2 sm:grid-cols-2\">\n          <label className=\"flex items-center justify-between gap-3 rounded-lg border border-red-500/30 bg-black/30 px-3 py-2 text-xs text-red-100\">\n            <span>Global serve freeze</span>\n            <input type=\"checkbox\" name=\"globalServeDisabled\" value=\"1\" defaultChecked={freeze.globalServeDisabled} />\n          </label>\n          <label className=\"flex items-center justify-between gap-3 rounded-lg border border-red-500/30 bg-black/30 px-3 py-2 text-xs text-red-100\">\n            <span>Share route freeze</span>\n            <input type=\"checkbox\" name=\"shareServeDisabled\" value=\"1\" defaultChecked={freeze.shareServeDisabled} />\n          </label>\n          <label className=\"flex items-center justify-between gap-3 rounded-lg border border-red-500/30 bg-black/30 px-3 py-2 text-xs text-red-100\">\n            <span>Alias route freeze</span>\n            <input type=\"checkbox\" name=\"aliasServeDisabled\" value=\"1\" defaultChecked={freeze.aliasServeDisabled} />\n          </label>\n          <label className=\"flex items-center justify-between gap-3 rounded-lg border border-red-500/30 bg-black/30 px-3 py-2 text-xs text-red-100\">\n            <span>Ticket route freeze</span>\n            <input type=\"checkbox\" name=\"ticketServeDisabled\" value=\"1\" defaultChecked={freeze.ticketServeDisabled} />\n          </label>\n          <div className=\"sm:col-span-2\">\n            <button\n              type=\"submit\"\n              className=\"rounded border border-red-400/40 bg-red-500/20 px-3 py-1.5 text-xs text-red-100 hover:bg-red-500/30\"\n            >\n              Save kill-switch state\n            </button>\n          </div>\n        </form>\n      </div>\n\n      <div className=\"mt-4 rounded-xl border border-amber-500/30 bg-amber-500/10 p-4\">\n        <h2 className=\"text-sm font-semibold text-amber-100\">Tenant emergency freeze</h2>\n        <p className=\"mt-1 text-xs text-amber-200/80\">\n          Freeze only your organization during an incident. This is lower blast-radius than global freeze.\n        </p>\n        {!orgFreezeSupported ? (\n          <div className=\"mt-2 rounded-lg border border-amber-500/30 bg-black/30 px-3 py-2 text-xs text-amber-200\">\n            Organization freeze flags are not available in this schema.\n          </div>\n        ) : (\n          <form action=\"/api/admin/security/tenant-freeze\" method=\"post\" className=\"mt-3 flex items-center gap-3\">\n            <span\n              className={[\n                \"inline-flex items-center rounded-md border px-2 py-1 text-xs\",\n                orgIsFrozen\n                  ? \"border-red-500/40 bg-red-500/20 text-red-100\"\n                  : \"border-emerald-500/40 bg-emerald-500/20 text-emerald-100\",\n              ].join(\" \")}\n            >\n              {orgIsFrozen ? \"Frozen\" : \"Active\"}\n            </span>\n            <input type=\"hidden\" name=\"freeze\" value={orgIsFrozen ? \"0\" : \"1\"} />\n            <button\n              type=\"submit\"\n              className={[\n                \"rounded border px-3 py-1.5 text-xs\",\n                orgIsFrozen\n                  ? \"border-emerald-400/40 bg-emerald-500/20 text-emerald-100 hover:bg-emerald-500/30\"\n                  : \"border-amber-400/40 bg-amber-500/20 text-amber-100 hover:bg-amber-500/30\",\n              ].join(\" \")}\n            >\n              {orgIsFrozen ? \"Unfreeze tenant\" : \"Freeze tenant\"}\n            </button>\n          </form>\n        )}\n      </div>\n\n      <div className=\"mt-6 grid gap-4 lg:grid-cols-3\">\n        <section className=\"rounded-xl border border-white/10 bg-white/5 p-4 lg:col-span-1\">\n          <h2 className=\"text-sm font-semibold\">Top abusive IP hashes (24h)</h2>\n          <p className=\"mt-1 text-xs text-white/50\">\n            Privacy-safe hashes derived from VIEW_SALT.\n          </p>\n          <div className=\"mt-3 space-y-2\">\n            {topIps.length ? (\n              topIps.map((r) => (\n                <div\n                  key={r.ip_hash}\n                  className=\"flex items-center justify-between rounded-lg border border-white/10 bg-black/30 px-3 py-2\"\n                >\n                  <div className=\"min-w-0\">\n                    <div className=\"truncate font-mono text-xs text-white/80\">{r.ip_hash}</div>\n                    <div className=\"mt-0.5 text-[11px] text-white/40\">Last: {r.last_seen}</div>\n                  </div>\n                  <div className=\"ml-3 text-sm font-semibold\">{fmt(Number(r.hits))}</div>\n                </div>\n              ))\n            ) : (\n              <div className=\"text-sm text-white/60\">No events in the last 24 hours.</div>\n            )}\n          </div>\n        </section>\n\n        <section className=\"rounded-xl border border-white/10 bg-white/5 p-4 lg:col-span-2\">\n          <h2 className=\"text-sm font-semibold\">Recent security events</h2>\n          <p className=\"mt-1 text-xs text-white/50\">\n            These events are best-effort signals (rate limits, spikes, decrypts). Use them as a starting point.\n          </p>\n\n          <div className=\"mt-3 overflow-hidden rounded-lg border border-white/10\">\n            <table className=\"w-full text-left text-sm\">\n              <thead className=\"bg-black/30 text-xs text-white/60\">\n                <tr>\n                  <th className=\"px-3 py-2\">Time</th>\n                  <th className=\"px-3 py-2\">Type</th>\n                  <th className=\"px-3 py-2\">Severity</th>\n                  <th className=\"px-3 py-2\">Scope</th>\n                  <th className=\"px-3 py-2\">Message</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-white/10\">\n                {events.map((e) => (\n                  <tr key={e.id} className=\"bg-black/10\">\n                    <td className=\"px-3 py-2 whitespace-nowrap text-xs text-white/60\">{e.created_at}</td>\n                    <td className=\"px-3 py-2 font-mono text-xs text-white/80\">{e.type}</td>\n                    <td className=\"px-3 py-2\">\n                      <span\n                        className={[\n                          \"inline-flex items-center rounded-md border px-2 py-0.5 text-xs\",\n                          e.severity === \"high\"\n                            ? \"border-red-500/30 bg-red-500/10 text-red-200\"\n                            : e.severity === \"medium\"\n                              ? \"border-yellow-500/30 bg-yellow-500/10 text-yellow-200\"\n                              : \"border-emerald-500/30 bg-emerald-500/10 text-emerald-200\",\n                        ].join(\" \")}\n                      >\n                        {e.severity}\n                      </span>\n                    </td>\n                    <td className=\"px-3 py-2 font-mono text-xs text-white/70\">{e.scope || \"—\"}</td>\n                    <td className=\"px-3 py-2 text-xs text-white/70\">{e.message || \"—\"}</td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </section>\n      </div>\n\n      <div className=\"mt-4 rounded-xl border border-white/10 bg-white/5 p-4\">\n        <div className=\"flex items-start justify-between gap-3\">\n          <h2 className=\"text-sm font-semibold\">Scan dead-letter queue</h2>\n          <form action=\"/api/admin/security/requeue-scans\" method=\"post\">\n            <button\n              type=\"submit\"\n              className=\"rounded border border-amber-400/40 bg-amber-500/20 px-3 py-1.5 text-xs text-amber-100 hover:bg-amber-500/30\"\n            >\n              Requeue pending scans\n            </button>\n          </form>\n        </div>\n        <p className=\"mt-1 text-xs text-white/50\">\n          Jobs here exceeded retry limits and require manual investigation or requeue.\n        </p>\n\n        <div className=\"mt-3 overflow-hidden rounded-lg border border-white/10\">\n          <table className=\"w-full text-left text-sm\">\n            <thead className=\"bg-black/30 text-xs text-white/60\">\n              <tr>\n                <th className=\"px-3 py-2\">Finished</th>\n                <th className=\"px-3 py-2\">Doc</th>\n                <th className=\"px-3 py-2\">Attempts</th>\n                <th className=\"px-3 py-2\">Object key</th>\n                <th className=\"px-3 py-2\">Error</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-white/10\">\n              {deadLetters.length ? (\n                deadLetters.map((d) => (\n                  <tr key={d.id} className=\"bg-black/10\">\n                    <td className=\"px-3 py-2 whitespace-nowrap text-xs text-white/60\">{d.finished_at || d.created_at}</td>\n                    <td className=\"px-3 py-2 font-mono text-xs text-white/80\">{d.doc_id}</td>\n                    <td className=\"px-3 py-2 text-xs text-white/80\">{fmt(d.attempts)}</td>\n                    <td className=\"px-3 py-2 font-mono text-xs text-white/60\">{d.r2_key || \"-\"}</td>\n                    <td className=\"px-3 py-2 text-xs text-red-200\">{d.last_error || \"-\"}</td>\n                  </tr>\n                ))\n              ) : (\n                <tr className=\"bg-black/10\">\n                  <td className=\"px-3 py-3 text-xs text-white/60\" colSpan={5}>\n                    No dead-letter scan jobs.\n                  </td>\n                </tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      <div className=\"mt-4 rounded-xl border border-white/10 bg-white/5 p-4\">\n        <h2 className=\"text-sm font-semibold\">Organization Membership</h2>\n        <p className=\"mt-1 text-xs text-white/50\">\n          Invite-only access model for your tenant. Domain allowlists are supplemental, not primary access control.\n        </p>\n\n        {!membershipTableReady ? (\n          <div className=\"mt-3 rounded-lg border border-amber-500/30 bg-amber-500/10 px-3 py-2 text-xs text-amber-200\">\n            Membership tables not found. Run <span className=\"font-mono\">scripts/sql/org_membership_invites.sql</span>.\n          </div>\n        ) : (\n          <>\n            <form action=\"/api/admin/security/org-access\" method=\"post\" className=\"mt-3 flex flex-wrap items-end gap-2 rounded-lg border border-white/10 bg-black/20 p-3\">\n              <input type=\"hidden\" name=\"action\" value=\"invite\" />\n              <label className=\"text-xs text-white/70\">\n                Email\n                <input name=\"email\" type=\"email\" required className=\"mt-1 block rounded border border-white/15 bg-black/40 px-2 py-1 text-xs text-white\" />\n              </label>\n              <label className=\"text-xs text-white/70\">\n                Role\n                <select name=\"role\" defaultValue=\"viewer\" className=\"mt-1 block rounded border border-white/15 bg-black/40 px-2 py-1 text-xs text-white\">\n                  <option value=\"viewer\">viewer</option>\n                  <option value=\"admin\">admin</option>\n                  <option value=\"owner\">owner</option>\n                </select>\n              </label>\n              <label className=\"text-xs text-white/70\">\n                Expires (days)\n                <input name=\"expires_days\" type=\"number\" min={1} max={90} defaultValue={7} className=\"mt-1 block w-24 rounded border border-white/15 bg-black/40 px-2 py-1 text-xs text-white\" />\n              </label>\n              <button type=\"submit\" className=\"rounded border border-white/15 bg-white/10 px-3 py-1.5 text-xs hover:bg-white/15\">\n                Create Invite\n              </button>\n            </form>\n\n            <div className=\"mt-3 overflow-x-auto\">\n              <table className=\"w-full min-w-[760px] text-left text-sm\">\n                <thead className=\"bg-black/30 text-xs text-white/60\">\n                  <tr>\n                    <th className=\"px-3 py-2\">Member</th>\n                    <th className=\"px-3 py-2\">Role</th>\n                    <th className=\"px-3 py-2\">Joined</th>\n                    <th className=\"px-3 py-2\">Action</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-white/10\">\n                  {orgMembers.map((m) => (\n                    <tr key={m.user_id} className=\"bg-black/10\">\n                      <td className=\"px-3 py-2 font-mono text-xs text-white/80\">{m.email}</td>\n                      <td className=\"px-3 py-2\">\n                        <form action=\"/api/admin/security/org-access\" method=\"post\" className=\"flex items-center gap-2\">\n                          <input type=\"hidden\" name=\"action\" value=\"set_member_role\" />\n                          <input type=\"hidden\" name=\"user_id\" value={m.user_id} />\n                          <select name=\"role\" defaultValue={m.role} className=\"rounded border border-white/15 bg-black/40 px-2 py-1 text-xs text-white\">\n                            <option value=\"viewer\">viewer</option>\n                            <option value=\"admin\">admin</option>\n                            <option value=\"owner\">owner</option>\n                          </select>\n                          <button type=\"submit\" className=\"rounded border border-white/15 bg-white/5 px-2 py-1 text-xs hover:bg-white/10\">Save</button>\n                        </form>\n                      </td>\n                      <td className=\"px-3 py-2 text-xs text-white/60\">{m.joined_at}</td>\n                      <td className=\"px-3 py-2\">\n                        <form action=\"/api/admin/security/org-access\" method=\"post\">\n                          <input type=\"hidden\" name=\"action\" value=\"remove_member\" />\n                          <input type=\"hidden\" name=\"user_id\" value={m.user_id} />\n                          <button type=\"submit\" className=\"rounded border border-red-500/30 bg-red-500/10 px-2 py-1 text-xs text-red-200 hover:bg-red-500/20\">\n                            Remove\n                          </button>\n                        </form>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n\n            <div className=\"mt-3 overflow-x-auto\">\n              <table className=\"w-full min-w-[760px] text-left text-sm\">\n                <thead className=\"bg-black/30 text-xs text-white/60\">\n                  <tr>\n                    <th className=\"px-3 py-2\">Pending invite</th>\n                    <th className=\"px-3 py-2\">Role</th>\n                    <th className=\"px-3 py-2\">Expires</th>\n                    <th className=\"px-3 py-2\">Action</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-white/10\">\n                  {orgInvites.length ? orgInvites.map((i) => (\n                    <tr key={i.id} className=\"bg-black/10\">\n                      <td className=\"px-3 py-2 font-mono text-xs text-white/80\">{i.email}</td>\n                      <td className=\"px-3 py-2 text-xs text-white/70\">{i.role}</td>\n                      <td className=\"px-3 py-2 text-xs text-white/60\">{i.expires_at}</td>\n                      <td className=\"px-3 py-2\">\n                        <form action=\"/api/admin/security/org-access\" method=\"post\">\n                          <input type=\"hidden\" name=\"action\" value=\"revoke_invite\" />\n                          <input type=\"hidden\" name=\"invite_id\" value={i.id} />\n                          <button type=\"submit\" className=\"rounded border border-red-500/30 bg-red-500/10 px-2 py-1 text-xs text-red-200 hover:bg-red-500/20\">\n                            Revoke\n                          </button>\n                        </form>\n                      </td>\n                    </tr>\n                  )) : (\n                    <tr className=\"bg-black/10\">\n                      <td colSpan={4} className=\"px-3 py-2 text-xs text-white/60\">No pending invites.</td>\n                    </tr>\n                  )}\n                </tbody>\n              </table>\n            </div>\n          </>\n        )}\n      </div>\n\n      <div className=\"mt-4 rounded-xl border border-white/10 bg-white/5 p-4\">\n        <h2 className=\"text-sm font-semibold\">RBAC permission overrides</h2>\n        <p className=\"mt-1 text-xs text-white/50\">\n          Owner-level policy controls for role permissions. These overrides take precedence over defaults in code.\n        </p>\n\n        {!rbacTableReady ? (\n          <div className=\"mt-3 rounded-lg border border-amber-500/30 bg-amber-500/10 px-3 py-2 text-xs text-amber-200\">\n            RBAC override table not found. Run <span className=\"font-mono\">scripts/sql/enterprise_rbac.sql</span>.\n          </div>\n        ) : (\n          <div className=\"mt-3 overflow-x-auto\">\n            <table className=\"w-full min-w-[740px] text-left text-sm\">\n              <thead className=\"bg-black/30 text-xs text-white/60\">\n                <tr>\n                  <th className=\"px-3 py-2\">Permission</th>\n                  {roles.map((r) => (\n                    <th key={r} className=\"px-3 py-2 capitalize\">{r}</th>\n                  ))}\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-white/10\">\n                {RBAC_PERMISSIONS.map((perm) => (\n                  <tr key={perm} className=\"bg-black/10\">\n                    <td className=\"px-3 py-2 font-mono text-xs text-white/80\">{perm}</td>\n                    {roles.map((role) => {\n                      const key = `${perm}:${role}`;\n                      const allowed = rbacMap.get(key);\n                      const current = allowed == null ? \"default\" : allowed ? \"allow\" : \"deny\";\n                      return (\n                        <td key={key} className=\"px-3 py-2\">\n                          <form action=\"/api/admin/security/rbac\" method=\"post\" className=\"flex items-center gap-2\">\n                            <input type=\"hidden\" name=\"permission\" value={perm} />\n                            <input type=\"hidden\" name=\"role\" value={role} />\n                            <select\n                              name=\"allowed\"\n                              defaultValue={current === \"deny\" ? \"0\" : \"1\"}\n                              className=\"rounded border border-white/15 bg-black/40 px-2 py-1 text-xs text-white\"\n                            >\n                              <option value=\"1\">{current === \"default\" ? \"Default/Allow\" : \"Allow\"}</option>\n                              <option value=\"0\">Deny</option>\n                            </select>\n                            <button className=\"rounded border border-white/15 bg-white/5 px-2 py-1 text-xs hover:bg-white/10\" type=\"submit\">\n                              Save\n                            </button>\n                          </form>\n                        </td>\n                      );\n                    })}\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\viewer-uploads\\ViewerUploadsTableClient.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3292,3295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3292,3295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3730,3733],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3730,3733],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":133,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":133,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5057,5060],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5057,5060],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useMemo, useState, useTransition } from \"react\";\nimport {\n  bulkDeleteDocsAction,\n  bulkRevokeAllSharesForDocsAction,\n  deleteDocAction,\n  revokeAllSharesForDocAction,\n} from \"@/app/admin/actions\";\n\nexport type ViewerUploadRow = {\n  doc_id: string;\n  title: string | null;\n  uploader_email: string | null;\n  uploader_role: string | null;\n  created_at: string | null;\n  size_bytes: number | null;\n  moderation_status: string | null;\n  scan_status: string | null;\n  risk_level: string | null;\n  alias: string | null;\n  active_shares: number;\n  total_views: number;\n};\n\ntype SortKey = \"created_at\" | \"title\" | \"uploader_email\" | \"size_bytes\" | \"total_views\" | \"active_shares\";\n\nfunction fmtBytes(n: number | null) {\n  if (!n || !Number.isFinite(n)) return \"-\";\n  if (n < 1024) return `${n} B`;\n  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;\n  if (n < 1024 * 1024 * 1024) return `${(n / (1024 * 1024)).toFixed(2)} MB`;\n  return `${(n / (1024 * 1024 * 1024)).toFixed(2)} GB`;\n}\n\nfunction fmtDate(s: string | null) {\n  if (!s) return \"-\";\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return s;\n  return d.toLocaleString();\n}\n\nexport default function ViewerUploadsTableClient({ rows }: { rows: ViewerUploadRow[] }) {\n  const [isPending, startTransition] = useTransition();\n  const [q, setQ] = useState(\"\");\n  const [moderation, setModeration] = useState(\"all\");\n  const [scan, setScan] = useState(\"all\");\n  const [risk, setRisk] = useState(\"all\");\n  const [recent, setRecent] = useState(\"all\");\n  const [sortKey, setSortKey] = useState<SortKey>(\"created_at\");\n  const [sortDesc, setSortDesc] = useState(true);\n  const [reason, setReason] = useState(\"\");\n  const [selected, setSelected] = useState<Record<string, boolean>>({});\n  const [error, setError] = useState<string | null>(null);\n\n  const filtered = useMemo(() => {\n    const query = q.trim().toLowerCase();\n    const now = Date.now();\n    return rows\n      .filter((r) => {\n        if (query) {\n          const hay = `${r.doc_id} ${r.title || \"\"} ${r.alias || \"\"} ${r.uploader_email || \"\"}`.toLowerCase();\n          if (!hay.includes(query)) return false;\n        }\n        if (moderation !== \"all\" && String(r.moderation_status || \"active\").toLowerCase() !== moderation) return false;\n        if (scan !== \"all\" && String(r.scan_status || \"unscanned\").toLowerCase() !== scan) return false;\n        if (risk !== \"all\" && String(r.risk_level || \"low\").toLowerCase() !== risk) return false;\n        if (recent !== \"all\") {\n          const created = r.created_at ? new Date(r.created_at).getTime() : 0;\n          const days = recent === \"24h\" ? 1 : recent === \"7d\" ? 7 : 30;\n          if (!created || created < now - days * 24 * 60 * 60 * 1000) return false;\n        }\n        return true;\n      })\n      .sort((a, b) => {\n        const dir = sortDesc ? -1 : 1;\n        const av =\n          sortKey === \"created_at\"\n            ? new Date(a.created_at || 0).getTime()\n            : sortKey === \"size_bytes\"\n              ? Number(a.size_bytes || 0)\n              : sortKey === \"total_views\"\n                ? Number(a.total_views || 0)\n                : sortKey === \"active_shares\"\n                  ? Number(a.active_shares || 0)\n                  : String((a as any)[sortKey] || \"\").toLowerCase();\n        const bv =\n          sortKey === \"created_at\"\n            ? new Date(b.created_at || 0).getTime()\n            : sortKey === \"size_bytes\"\n              ? Number(b.size_bytes || 0)\n              : sortKey === \"total_views\"\n                ? Number(b.total_views || 0)\n                : sortKey === \"active_shares\"\n                  ? Number(b.active_shares || 0)\n                  : String((b as any)[sortKey] || \"\").toLowerCase();\n        if (av === bv) return 0;\n        return av > bv ? dir : -dir;\n      });\n  }, [rows, q, moderation, scan, risk, recent, sortKey, sortDesc]);\n\n  const selectedIds = useMemo(() => filtered.map((r) => r.doc_id).filter((id) => selected[id]), [filtered, selected]);\n  const allVisibleSelected = filtered.length > 0 && filtered.every((r) => selected[r.doc_id]);\n\n  function setAllVisible(v: boolean) {\n    setSelected((prev) => {\n      const next = { ...prev };\n      for (const r of filtered) next[r.doc_id] = v;\n      return next;\n    });\n  }\n\n  async function runAbuseAction(action: \"quarantine_doc\" | \"disable_doc\", docIds: string[]) {\n    setError(null);\n    if (!docIds.length) return;\n    startTransition(async () => {\n      try {\n        for (const docId of docIds) {\n          const res = await fetch(\"/api/admin/abuse\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n              action,\n              docId,\n              reason: reason || null,\n            }),\n          });\n          const json = await res.json().catch(() => ({}));\n          if (!res.ok || !json?.ok) throw new Error(json?.error || json?.message || \"Action failed\");\n        }\n        window.location.reload();\n      } catch (e: any) {\n        setError(e?.message || \"Action failed\");\n      }\n    });\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4\">\n        <div className=\"grid gap-3 md:grid-cols-2 xl:grid-cols-6\">\n          <div>\n            <label htmlFor=\"viewer-uploads-search\" className=\"sr-only\">Search uploads</label>\n            <input\n              id=\"viewer-uploads-search\"\n              aria-label=\"Search uploads\"\n              value={q}\n              onChange={(e) => setQ(e.target.value)}\n              placeholder=\"Search title, alias, uploader, doc id\"\n              className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm text-white\"\n            />\n          </div>\n          <div>\n          <label htmlFor=\"viewer-uploads-moderation\" className=\"sr-only\">Moderation filter</label>\n          <select id=\"viewer-uploads-moderation\" aria-label=\"Moderation filter\" value={moderation} onChange={(e) => setModeration(e.target.value)} className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm\">\n            <option value=\"all\">Moderation: all</option>\n            <option value=\"active\">Active</option>\n            <option value=\"quarantined\">Quarantined</option>\n            <option value=\"disabled\">Disabled</option>\n            <option value=\"deleted\">Deleted</option>\n          </select>\n          </div>\n          <div>\n          <label htmlFor=\"viewer-uploads-scan\" className=\"sr-only\">Scan status filter</label>\n          <select id=\"viewer-uploads-scan\" aria-label=\"Scan status filter\" value={scan} onChange={(e) => setScan(e.target.value)} className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm\">\n            <option value=\"all\">Scan: all</option>\n            <option value=\"clean\">Clean</option>\n            <option value=\"risky\">Risky</option>\n            <option value=\"quarantined\">Quarantined</option>\n            <option value=\"error\">Error</option>\n            <option value=\"failed\">Failed</option>\n            <option value=\"unscanned\">Unscanned</option>\n          </select>\n          </div>\n          <div>\n          <label htmlFor=\"viewer-uploads-risk\" className=\"sr-only\">Risk filter</label>\n          <select id=\"viewer-uploads-risk\" aria-label=\"Risk filter\" value={risk} onChange={(e) => setRisk(e.target.value)} className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm\">\n            <option value=\"all\">Risk: all</option>\n            <option value=\"low\">Low</option>\n            <option value=\"medium\">Medium</option>\n            <option value=\"high\">High</option>\n          </select>\n          </div>\n          <div>\n          <label htmlFor=\"viewer-uploads-recent\" className=\"sr-only\">Created date filter</label>\n          <select id=\"viewer-uploads-recent\" aria-label=\"Created date filter\" value={recent} onChange={(e) => setRecent(e.target.value)} className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm\">\n            <option value=\"all\">Created: all</option>\n            <option value=\"24h\">Last 24h</option>\n            <option value=\"7d\">Last 7d</option>\n            <option value=\"30d\">Last 30d</option>\n          </select>\n          </div>\n          <div>\n            <label htmlFor=\"viewer-uploads-reason\" className=\"sr-only\">Action reason</label>\n            <input\n              id=\"viewer-uploads-reason\"\n              aria-label=\"Action reason\"\n              value={reason}\n              onChange={(e) => setReason(e.target.value)}\n              placeholder=\"Action reason (logged)\"\n              className=\"rounded-lg border border-neutral-800 bg-black/30 px-3 py-2 text-sm text-white\"\n            />\n          </div>\n        </div>\n        <div className=\"mt-3 flex flex-wrap items-center gap-2 text-xs text-neutral-400\">\n          <span>Rows: {filtered.length}</span>\n          <span>Selected: {selectedIds.length}</span>\n          <span className=\"ml-2\">Sort:</span>\n          {([\"created_at\", \"title\", \"uploader_email\", \"size_bytes\", \"total_views\", \"active_shares\"] as SortKey[]).map((k) => (\n            <button\n              key={k}\n              type=\"button\"\n              onClick={() => {\n                if (sortKey === k) setSortDesc((d) => !d);\n                else {\n                  setSortKey(k);\n                  setSortDesc(true);\n                }\n              }}\n              className={`rounded-md px-2 py-1 ${sortKey === k ? \"bg-white/20 text-white\" : \"bg-white/5 text-white/80\"}`}\n            >\n              {k}\n            </button>\n          ))}\n        </div>\n      </div>\n\n      {error ? <div className=\"rounded-lg border border-red-800 bg-red-950/40 px-3 py-2 text-sm text-red-200\">{error}</div> : null}\n\n      <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-3\">\n        <div className=\"flex flex-wrap gap-2\">\n          <button type=\"button\" disabled={isPending || !selectedIds.length} onClick={() => runAbuseAction(\"quarantine_doc\", selectedIds)} className=\"rounded-md border border-amber-600/40 bg-amber-500/20 px-3 py-1.5 text-sm text-amber-100 disabled:opacity-50\">\n            Quarantine selected\n          </button>\n          <button type=\"button\" disabled={isPending || !selectedIds.length} onClick={() => runAbuseAction(\"disable_doc\", selectedIds)} className=\"rounded-md border border-amber-600/40 bg-amber-500/10 px-3 py-1.5 text-sm text-amber-100 disabled:opacity-50\">\n            Disable selected\n          </button>\n          <form\n            action={(fd) => {\n              if (!selectedIds.length) return;\n              if (!window.confirm(`Revoke all shares for ${selectedIds.length} selected docs?`)) return;\n              fd.set(\"docIds\", JSON.stringify(selectedIds));\n              startTransition(() => bulkRevokeAllSharesForDocsAction(fd));\n            }}\n          >\n            <input type=\"hidden\" name=\"docIds\" value=\"[]\" />\n            <button type=\"submit\" disabled={isPending || !selectedIds.length} className=\"rounded-md border border-neutral-700 bg-white/5 px-3 py-1.5 text-sm disabled:opacity-50\">\n              Revoke shares\n            </button>\n          </form>\n          <form\n            action={(fd) => {\n              if (!selectedIds.length) return;\n              const confirm = window.prompt(`Type DELETE ${selectedIds.length} to confirm bulk deletion.`);\n              if (confirm !== `DELETE ${selectedIds.length}`) return;\n              fd.set(\"docIds\", JSON.stringify(selectedIds));\n              fd.set(\"reason\", reason || \"\");\n              startTransition(() => bulkDeleteDocsAction(fd));\n            }}\n          >\n            <input type=\"hidden\" name=\"docIds\" value=\"[]\" />\n            <input type=\"hidden\" name=\"reason\" value={reason} />\n            <button type=\"submit\" disabled={isPending || !selectedIds.length} className=\"rounded-md border border-red-700/60 bg-red-700/20 px-3 py-1.5 text-sm text-red-100 disabled:opacity-50\">\n              Delete selected\n            </button>\n          </form>\n        </div>\n      </div>\n\n      <div className=\"overflow-hidden rounded-xl border border-neutral-800\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"bg-neutral-900 text-neutral-300\">\n            <tr>\n              <th className=\"px-3 py-2 text-left\">\n                <input type=\"checkbox\" aria-label=\"Select all visible uploads\" checked={allVisibleSelected} onChange={(e) => setAllVisible(e.target.checked)} />\n              </th>\n              <th className=\"px-3 py-2 text-left\">Document</th>\n              <th className=\"px-3 py-2 text-left\">Uploader</th>\n              <th className=\"px-3 py-2 text-left\">Created</th>\n              <th className=\"px-3 py-2 text-right\">Size</th>\n              <th className=\"px-3 py-2 text-left\">Status</th>\n              <th className=\"px-3 py-2 text-right\">Views</th>\n              <th className=\"px-3 py-2 text-right\">Shares</th>\n              <th className=\"px-3 py-2 text-right\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {filtered.map((r) => (\n              <tr key={r.doc_id} className=\"border-t border-neutral-800 bg-black/20\">\n                <td className=\"px-3 py-2 align-top\">\n                  <input type=\"checkbox\" aria-label={`Select upload ${r.title || r.doc_id}`} checked={!!selected[r.doc_id]} onChange={(e) => setSelected((prev) => ({ ...prev, [r.doc_id]: e.target.checked }))} />\n                </td>\n                <td className=\"px-3 py-2\">\n                  <div className=\"font-medium text-white\">{r.title || \"Untitled\"}</div>\n                  <div className=\"font-mono text-xs text-neutral-400\">{r.doc_id}</div>\n                  {r.alias ? <Link className=\"text-xs text-sky-300 hover:underline\" href={`/d/${r.alias}`} target=\"_blank\">/d/{r.alias}</Link> : null}\n                </td>\n                <td className=\"px-3 py-2\">\n                  <div>{r.uploader_email || \"-\"}</div>\n                  <div className=\"text-xs text-neutral-500\">{r.uploader_role || \"viewer\"}</div>\n                </td>\n                <td className=\"px-3 py-2\">{fmtDate(r.created_at)}</td>\n                <td className=\"px-3 py-2 text-right\">{fmtBytes(r.size_bytes)}</td>\n                <td className=\"px-3 py-2\">\n                  <div className=\"text-xs\">mod: {r.moderation_status || \"active\"}</div>\n                  <div className=\"text-xs\">scan: {r.scan_status || \"unscanned\"}</div>\n                  <div className=\"text-xs\">risk: {r.risk_level || \"low\"}</div>\n                </td>\n                <td className=\"px-3 py-2 text-right\">{r.total_views}</td>\n                <td className=\"px-3 py-2 text-right\">{r.active_shares}</td>\n                <td className=\"px-3 py-2 text-right\">\n                  <div className=\"flex flex-wrap justify-end gap-2\">\n                    <Link aria-label={`Open upload ${r.title || r.doc_id}`} href={`/admin/docs/${r.doc_id}`} className=\"rounded-md border border-neutral-700 bg-white/5 px-2 py-1 text-xs\">Open</Link>\n                    <button aria-label={`Quarantine upload ${r.title || r.doc_id}`} type=\"button\" onClick={() => runAbuseAction(\"quarantine_doc\", [r.doc_id])} className=\"rounded-md border border-amber-700/50 bg-amber-700/20 px-2 py-1 text-xs text-amber-100\">Quarantine</button>\n                    <button aria-label={`Disable upload ${r.title || r.doc_id}`} type=\"button\" onClick={() => runAbuseAction(\"disable_doc\", [r.doc_id])} className=\"rounded-md border border-amber-700/50 bg-amber-700/10 px-2 py-1 text-xs text-amber-100\">Disable</button>\n                    <form\n                      action={(fd) => {\n                        if (!window.confirm(\"Revoke all shares for this document?\")) return;\n                        startTransition(() => revokeAllSharesForDocAction(fd));\n                      }}\n                    >\n                      <input type=\"hidden\" name=\"docId\" value={r.doc_id} />\n                      <button aria-label={`Revoke all shares for upload ${r.title || r.doc_id}`} type=\"submit\" className=\"rounded-md border border-neutral-700 bg-white/5 px-2 py-1 text-xs\">Revoke shares</button>\n                    </form>\n                    <form\n                      action={(fd) => {\n                        const confirm = window.prompt(`Type DELETE to remove \"${r.title || r.doc_id}\".`);\n                        if (confirm !== \"DELETE\") return;\n                        fd.set(\"reason\", reason || \"\");\n                        startTransition(() => deleteDocAction(fd));\n                      }}\n                    >\n                      <input type=\"hidden\" name=\"docId\" value={r.doc_id} />\n                      <input type=\"hidden\" name=\"reason\" value={reason} />\n                      <button aria-label={`Delete upload ${r.title || r.doc_id}`} type=\"submit\" className=\"rounded-md border border-red-700/60 bg-red-700/20 px-2 py-1 text-xs text-red-100\">Delete</button>\n                    </form>\n                  </div>\n                </td>\n              </tr>\n            ))}\n            {!filtered.length ? (\n              <tr>\n                <td colSpan={9} className=\"px-3 py-8 text-center text-sm text-neutral-400\">No viewer uploads matched your filters.</td>\n              </tr>\n            ) : null}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\viewer-uploads\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\webhooks\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3778,3781],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3778,3781],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/webhooks/actions.ts\n\"use server\";\n\nimport { revalidatePath } from \"next/cache\";\nimport { sql } from \"@/lib/db\";\nimport { requireUser } from \"@/lib/authz\";\nimport { processWebhookDeliveries } from \"@/lib/webhooks\";\n\nfunction parseEvents(formData: FormData): string[] {\n  const raw = formData.getAll(\"events\").map((v) => String(v || \"\").trim()).filter(Boolean);\n  // Ensure uniqueness\n  return Array.from(new Set(raw));\n}\n\nexport async function createWebhookAction(formData: FormData): Promise<void> {\n  const u = await requireUser();\n  if (!(u.role === \"owner\" || u.role === \"admin\")) throw new Error(\"Forbidden\");\n\n  const name = String(formData.get(\"name\") || \"\").trim();\n  const url = String(formData.get(\"url\") || \"\").trim();\n  const secret = String(formData.get(\"secret\") || \"\").trim() || null;\n  const enabledRaw = String(formData.get(\"enabled\") || \"\");\n  const enabled = enabledRaw === \"on\" || enabledRaw === \"true\" || enabledRaw === \"1\";\n  const events = parseEvents(formData);\n\n  if (!name) throw new Error(\"Missing name.\");\n  if (!url || !/^https?:\\/\\//i.test(url)) throw new Error(\"URL must start with http:// or https://\");\n\n  await sql`\n    insert into public.webhooks (owner_id, name, url, secret, events, enabled)\n    values (${u.id}::uuid, ${name}, ${url}, ${secret}, ${events}::text[], ${enabled})\n  `;\n\n  revalidatePath(\"/admin/webhooks\");\n}\n\nexport async function updateWebhookAction(formData: FormData): Promise<void> {\n  const u = await requireUser();\n  if (!(u.role === \"owner\" || u.role === \"admin\")) throw new Error(\"Forbidden\");\n\n  const id = String(formData.get(\"id\") || \"\").trim();\n  const name = String(formData.get(\"name\") || \"\").trim();\n  const url = String(formData.get(\"url\") || \"\").trim();\n  const secret = String(formData.get(\"secret\") || \"\").trim() || null;\n  const enabledRaw = String(formData.get(\"enabled\") || \"\");\n  const enabled = enabledRaw === \"on\" || enabledRaw === \"true\" || enabledRaw === \"1\";\n  const events = parseEvents(formData);\n\n  if (!id) throw new Error(\"Missing id.\");\n  if (!name) throw new Error(\"Missing name.\");\n  if (!url || !/^https?:\\/\\//i.test(url)) throw new Error(\"URL must start with http:// or https://\");\n\n  await sql`\n    update public.webhooks\n    set\n      name = ${name},\n      url = ${url},\n      secret = ${secret},\n      events = ${events}::text[],\n      enabled = ${enabled}\n    where id = ${id}::uuid\n      and owner_id = ${u.id}::uuid\n  `;\n\n  revalidatePath(\"/admin/webhooks\");\n}\n\nexport async function deleteWebhookAction(formData: FormData): Promise<void> {\n  const u = await requireUser();\n  if (!(u.role === \"owner\" || u.role === \"admin\")) throw new Error(\"Forbidden\");\n\n  const id = String(formData.get(\"id\") || \"\").trim();\n  if (!id) throw new Error(\"Missing id.\");\n\n  await sql`\n    delete from public.webhooks\n    where id = ${id}::uuid\n      and owner_id = ${u.id}::uuid\n  `;\n\n  revalidatePath(\"/admin/webhooks\");\n}\n\nexport async function testWebhookAction(formData: FormData): Promise<void> {\n  const u = await requireUser();\n  if (!(u.role === \"owner\" || u.role === \"admin\")) throw new Error(\"Forbidden\");\n\n  const id = String(formData.get(\"id\") || \"\").trim();\n  if (!id) throw new Error(\"Missing id.\");\n\n  // Prefer queue (if table exists), fall back to setting last_error.\n  try {\n    const payload = {\n      test: true,\n      message: \"Hello from cyang.io\",\n      requested_by: u.email,\n      requested_at: new Date().toISOString(),\n    };\n\n    await sql`\n      insert into public.webhook_deliveries (webhook_id, owner_id, event, payload)\n      values (${id}::uuid, ${u.id}::uuid, 'webhook.test', ${JSON.stringify(payload)}::jsonb)\n    `;\n\n    // Try to deliver immediately for nicer UX.\n    await processWebhookDeliveries({ maxBatch: 5, maxAttempts: 8 });\n  } catch (e: any) {\n    await sql`\n      update public.webhooks\n      set last_error = ${String(e?.message || e || \"Failed to enqueue test\")}\n      where id = ${id}::uuid and owner_id = ${u.id}::uuid\n    `;\n  }\n\n  revalidatePath(\"/admin/webhooks\");\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\(owner)\\webhooks\\page.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":74,"column":11,"nodeType":"JSXOpeningElement","endLine":74,"endColumn":159},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":153,"column":21,"nodeType":"JSXOpeningElement","endLine":153,"endColumn":132},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":235,"column":25,"nodeType":"JSXOpeningElement","endLine":235,"endColumn":148}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/(owner)/webhooks/page.tsx\nimport { redirect } from \"next/navigation\";\nimport { unstable_noStore as noStore } from \"next/cache\";\nimport { sql } from \"@/lib/db\";\nimport { getAuthedUser } from \"@/lib/authz\";\nimport {\n  createWebhookAction,\n  updateWebhookAction,\n  deleteWebhookAction,\n  testWebhookAction,\n} from \"./actions\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nconst ALL_EVENTS = [\n  \"share.created\",\n  \"share.revoked\",\n  \"alias.created\",\n  \"alias.disabled\",\n  \"doc.deleted\",\n  \"doc.viewed\",\n  \"doc.accessed\",\n] as const;\n\ntype HookRow = {\n  id: string;\n  name: string;\n  url: string;\n  secret: string | null;\n  events: string[];\n  enabled: boolean;\n  created_at: string;\n  last_sent_at: string | null;\n  last_status: number | null;\n  last_error: string | null;\n};\n\ntype DeliveryRow = {\n  id: number;\n  webhook_id: string;\n  event: string;\n  status: string;\n  attempt_count: number;\n  next_attempt_at: string;\n  last_status: number | null;\n  last_error: string | null;\n  created_at: string;\n};\n\nfunction Pill({ children }: { children: React.ReactNode }) {\n  return <span className=\"ui-badge inline-flex items-center rounded-full px-2 py-0.5 text-[11px]\">{children}</span>;\n}\n\nfunction FieldLabel({ children }: { children: React.ReactNode }) {\n  return <label className=\"text-xs text-white/65\">{children}</label>;\n}\n\nfunction TextInput(props: React.InputHTMLAttributes<HTMLInputElement>) {\n  return (\n    <input\n      {...props}\n      className={`mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none ${props.className || \"\"}`}\n    />\n  );\n}\n\nfunction EventCheckboxes({ defaultEvents, namePrefix }: { defaultEvents: string[]; namePrefix: string }) {\n  return (\n    <div className=\"mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3\">\n      {ALL_EVENTS.map((e) => (\n        <label key={`${namePrefix}-${e}`} className=\"flex items-center gap-2 text-xs text-white/75\">\n          <input type=\"checkbox\" name=\"events\" value={e} defaultChecked={defaultEvents.includes(e)} className=\"h-4 w-4 rounded border-white/20 bg-black/30\" />\n          <span className=\"font-mono text-[11px]\">{e}</span>\n        </label>\n      ))}\n    </div>\n  );\n}\n\nexport default async function WebhooksPage() {\n  noStore();\n\n  const u = await getAuthedUser();\n  if (!u) redirect(\"/api/auth/signin\");\n  const canAdmin = u.role === \"owner\" || u.role === \"admin\";\n  if (!canAdmin) redirect(\"/\");\n\n  const hooks = (await sql`\n    select\n      id::text as id,\n      name,\n      url,\n      secret,\n      events,\n      enabled,\n      created_at::text as created_at,\n      last_sent_at::text as last_sent_at,\n      last_status,\n      last_error\n    from public.webhooks\n    where owner_id = ${u.id}::uuid\n    order by created_at desc\n    limit 200\n  `) as unknown as HookRow[];\n\n  let deliveries: DeliveryRow[] = [];\n  try {\n    deliveries = (await sql`\n      select\n        id,\n        webhook_id::text as webhook_id,\n        event,\n        status,\n        attempt_count,\n        next_attempt_at::text as next_attempt_at,\n        last_status,\n        last_error,\n        created_at::text as created_at\n      from public.webhook_deliveries\n      where owner_id = ${u.id}::uuid\n      order by created_at desc\n      limit 80\n    `) as unknown as DeliveryRow[];\n  } catch {\n    // queue table may not exist yet\n  }\n\n  return (\n    <div className=\"mx-auto max-w-6xl p-4 text-white md:p-6\">\n      <div className=\"mb-6 flex flex-wrap items-center justify-between gap-3\">\n        <h1 className=\"text-2xl font-semibold tracking-tight\">Webhooks</h1>\n      </div>\n\n      <section className=\"glass-card-strong rounded-2xl p-4\">\n        <div className=\"text-sm text-white/70\">\n          Webhooks are outbound HTTP POSTs. If you set a secret, the JSON body is signed with HMAC-SHA256 and sent in\n          <span className=\"ml-1 font-mono text-xs text-white/65\">x-cyang-signature</span>.\n        </div>\n\n        <div className=\"mt-4 grid grid-cols-1 gap-3 md:grid-cols-2\">\n          <div className=\"glass-card rounded-xl p-4\">\n            <h2 className=\"text-base font-medium\">Create webhook</h2>\n            <form action={createWebhookAction} className=\"mt-3 space-y-3\">\n              <div className=\"grid grid-cols-1 gap-3 sm:grid-cols-2\">\n                <div>\n                  <FieldLabel>Name</FieldLabel>\n                  <TextInput name=\"name\" placeholder=\"Production\" />\n                </div>\n                <div className=\"flex items-end gap-2\">\n                  <label className=\"flex items-center gap-2 text-xs text-white/75\">\n                    <input type=\"checkbox\" name=\"enabled\" defaultChecked className=\"h-4 w-4 rounded border-white/20 bg-black/30\" />\n                    Enabled\n                  </label>\n                </div>\n              </div>\n\n              <div>\n                <FieldLabel>URL</FieldLabel>\n                <TextInput name=\"url\" placeholder=\"https://example.com/webhook\" />\n              </div>\n\n              <div>\n                <FieldLabel>Secret (optional)</FieldLabel>\n                <TextInput name=\"secret\" placeholder=\"shared secret\" />\n              </div>\n\n              <div>\n                <div className=\"text-xs text-white/65\">Events</div>\n                <EventCheckboxes defaultEvents={[\"share.created\", \"share.revoked\"]} namePrefix=\"create\" />\n              </div>\n\n              <button className=\"btn-base btn-primary rounded-xl px-3 py-2 text-sm font-medium\">Create</button>\n            </form>\n          </div>\n\n          <div className=\"glass-card rounded-xl p-4\">\n            <h3 className=\"text-sm font-medium\">Delivery model</h3>\n            <ul className=\"mt-2 list-disc space-y-1 pl-5 text-sm text-white/70\">\n              <li>\n                Preferred: queued deliveries with retry and backoff via cron worker\n                <span className=\"ml-2 font-mono text-xs text-white/60\">/api/cron/webhooks</span>\n              </li>\n              <li>Fallback: synchronous best-effort if the queue table is not installed yet</li>\n              <li>\n                Dead-letter: deliveries become <Pill>dead</Pill> after max attempts (default 8)\n              </li>\n            </ul>\n            <div className=\"mt-3 text-xs text-white/60\">\n              Tip: run <span className=\"font-mono\">scripts/sql/webhooks.sql</span> to add the queue table.\n            </div>\n          </div>\n        </div>\n      </section>\n\n      <section className=\"mt-8\">\n        <h2 className=\"text-lg font-medium\">Your webhooks</h2>\n\n        <div className=\"mt-3 space-y-3\">\n          {hooks.map((h) => (\n            <div key={h.id} className=\"glass-card-strong rounded-2xl p-4\">\n              <div className=\"flex flex-wrap items-start justify-between gap-3\">\n                <div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"text-base font-semibold\">{h.name}</div>\n                    {h.enabled ? <Pill>enabled</Pill> : <Pill>disabled</Pill>}\n                  </div>\n                  <div className=\"mt-1 text-xs text-white/60\">{h.url}</div>\n                  <div className=\"mt-2 flex flex-wrap gap-2\">\n                    {(h.events?.length ? h.events : [\"(all events)\"]).map((e) => (\n                      <Pill key={`${h.id}-${e}`}>{e}</Pill>\n                    ))}\n                  </div>\n                </div>\n\n                <div className=\"text-right text-xs text-white/60\">\n                  <div>Last sent: {h.last_sent_at ?? \"-\"}</div>\n                  <div>Last status: {h.last_status ?? \"-\"}</div>\n                  <div className=\"max-w-[380px] truncate\">Last error: {h.last_error ?? \"-\"}</div>\n                </div>\n              </div>\n\n              <details className=\"mt-4\">\n                <summary className=\"cursor-pointer text-sm text-white/80 hover:text-white\">Edit</summary>\n                <form action={updateWebhookAction} className=\"mt-3 space-y-3\">\n                  <input type=\"hidden\" name=\"id\" value={h.id} />\n                  <div className=\"grid grid-cols-1 gap-3 sm:grid-cols-2\">\n                    <div>\n                      <FieldLabel>Name</FieldLabel>\n                      <TextInput name=\"name\" defaultValue={h.name} />\n                    </div>\n                    <div className=\"flex items-end gap-2\">\n                      <label className=\"flex items-center gap-2 text-xs text-white/75\">\n                        <input type=\"checkbox\" name=\"enabled\" defaultChecked={h.enabled} className=\"h-4 w-4 rounded border-white/20 bg-black/30\" />\n                        Enabled\n                      </label>\n                    </div>\n                  </div>\n                  <div>\n                    <FieldLabel>URL</FieldLabel>\n                    <TextInput name=\"url\" defaultValue={h.url} />\n                  </div>\n                  <div>\n                    <FieldLabel>Secret (optional)</FieldLabel>\n                    <TextInput name=\"secret\" defaultValue={h.secret ?? \"\"} />\n                  </div>\n                  <div>\n                    <div className=\"text-xs text-white/65\">Events</div>\n                    <EventCheckboxes defaultEvents={h.events || []} namePrefix={h.id} />\n                  </div>\n\n                  <div className=\"flex flex-wrap items-center gap-2\">\n                    <button className=\"btn-base btn-primary rounded-xl px-3 py-2 text-sm font-medium\">Save</button>\n                    <button formAction={testWebhookAction} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm\">\n                      Test\n                    </button>\n                  </div>\n                </form>\n\n                <form action={deleteWebhookAction} className=\"mt-2\">\n                  <input type=\"hidden\" name=\"id\" value={h.id} />\n                  <button className=\"btn-base btn-danger rounded-xl px-3 py-2 text-sm\">Delete</button>\n                </form>\n              </details>\n            </div>\n          ))}\n\n          {!hooks.length ? (\n            <div className=\"glass-card-strong rounded-2xl p-6 text-white/60\">No webhooks yet.</div>\n          ) : null}\n        </div>\n      </section>\n\n      <section className=\"mt-10\">\n        <h2 className=\"text-lg font-medium\">Recent deliveries</h2>\n        <div className=\"glass-card-strong mt-3 overflow-x-auto rounded-2xl border border-white/10\">\n          <table className=\"min-w-[1100px] text-sm\">\n            <thead className=\"bg-[#10192b]/95 text-white/75 backdrop-blur\">\n              <tr>\n                <th className=\"px-4 py-3 text-left\">Created</th>\n                <th className=\"px-4 py-3 text-left\">Webhook</th>\n                <th className=\"px-4 py-3 text-left\">Event</th>\n                <th className=\"px-4 py-3 text-left\">Status</th>\n                <th className=\"px-4 py-3 text-left\">Attempts</th>\n                <th className=\"px-4 py-3 text-left\">Next attempt</th>\n                <th className=\"px-4 py-3 text-left\">Last status</th>\n                <th className=\"px-4 py-3 text-left\">Last error</th>\n              </tr>\n            </thead>\n            <tbody>\n              {deliveries.map((d) => (\n                <tr key={d.id} className=\"border-t border-white/10 hover:bg-white/[0.03]\">\n                  <td className=\"whitespace-nowrap px-4 py-3 text-white/70\">{d.created_at}</td>\n                  <td className=\"whitespace-nowrap px-4 py-3 font-mono text-xs text-white/75\">{d.webhook_id}</td>\n                  <td className=\"whitespace-nowrap px-4 py-3 font-mono text-xs text-white/90\">{d.event}</td>\n                  <td className=\"whitespace-nowrap px-4 py-3\">\n                    {d.status === \"succeeded\" ? (\n                      <span className=\"text-emerald-100\">succeeded</span>\n                    ) : d.status === \"dead\" ? (\n                      <span className=\"text-rose-100\">dead</span>\n                    ) : (\n                      <span className=\"text-white/80\">{d.status}</span>\n                    )}\n                  </td>\n                  <td className=\"whitespace-nowrap px-4 py-3 text-white/75\">{d.attempt_count}</td>\n                  <td className=\"whitespace-nowrap px-4 py-3 text-white/75\">{d.next_attempt_at}</td>\n                  <td className=\"whitespace-nowrap px-4 py-3 text-white/75\">{d.last_status ?? \"-\"}</td>\n                  <td className=\"max-w-[420px] truncate px-4 py-3 text-white/60\">{d.last_error ?? \"-\"}</td>\n                </tr>\n              ))}\n              {!deliveries.length ? (\n                <tr>\n                  <td className=\"px-4 py-6 text-white/60\" colSpan={8}>\n                    No deliveries yet (or queue table not installed).\n                  </td>\n                </tr>\n              ) : null}\n            </tbody>\n          </table>\n        </div>\n      </section>\n    </div>\n  );\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\DeleteDocForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\_components\\AdminShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\_components\\AdminTopNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2646,2649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2646,2649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":921,"column":59,"nodeType":"Identifier","messageId":"unusedVar","endLine":921,"endColumn":60}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/actions.ts\n\"use server\";\n\nimport { DeleteObjectCommand } from \"@aws-sdk/client-s3\";\nimport { revalidatePath } from \"next/cache\";\nimport bcrypt from \"bcryptjs\";\n\nimport { sql } from \"@/lib/db\";\nimport { getR2Bucket, getR2Prefix, r2Client } from \"@/lib/r2\";\nimport { sendMail } from \"@/lib/email\";\nimport { requireDocWrite, requireRole, requireUser } from \"@/lib/authz\";\nimport { setRetentionSettings, setExpirationAlertSettings, getExpirationAlertSettings } from \"@/lib/settings\";\nimport { generateApiKey, hashApiKey } from \"@/lib/apiKeys\";\nimport { emitWebhook } from \"@/lib/webhooks\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nfunction getBaseUrl() {\n  const explicit = process.env.BASE_URL || process.env.NEXTAUTH_URL;\n  if (explicit) return explicit.replace(/\\/+$/, \"\");\n\n  const vercel = process.env.VERCEL_URL;\n  if (vercel) return `https://${vercel}`.replace(/\\/+$/, \"\");\n\n  return \"http://localhost:3000\";\n}\n\nasync function appendAdminAudit(args: {\n  action: string;\n  docId?: string | null;\n  subjectId?: string | null;\n  payload?: Record<string, unknown> | null;\n}) {\n  try {\n    const u = await requireUser();\n    await appendImmutableAudit({\n      streamKey: args.docId ? `doc:${args.docId}` : `admin:${u.id}`,\n      action: args.action,\n      actorUserId: u.id,\n      orgId: u.orgId ?? null,\n      docId: args.docId ?? undefined,\n      subjectId: args.subjectId ?? null,\n      payload: args.payload ?? null,\n    });\n  } catch {\n    // best-effort audit logging; do not block admin flow\n  }\n}\n\nasync function requireShareWrite(token: string) {\n  const t = String(token || \"\").trim();\n  if (!t) throw new Error(\"Missing token.\");\n\n  const rows = (await sql`\n    select doc_id::text as doc_id\n    from public.share_tokens\n    where token = ${t}\n    limit 1\n  `) as unknown as Array<{ doc_id: string }>;\n\n  const docId = rows?.[0]?.doc_id ?? null;\n  if (!docId) throw new Error(\"Token not found.\");\n  await requireDocWrite(docId);\n}\n\nasync function resolveR2LocationForDoc(docId: string): Promise<{ bucket: string; key: string }> {\n  const r2Prefix = getR2Prefix();\n  const r2Bucket = getR2Bucket();\n  // Attempt 1: docs.pointer = \"r2://bucket/key\"\n  try {\n    const rows = (await sql`\n      select pointer\n      from docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as unknown as Array<{ pointer: string | null }>;\n\n    const pointer = rows[0]?.pointer ?? null;\n    if (!pointer) throw new Error(\"Doc not found.\");\n    if (!pointer.startsWith(r2Prefix)) throw new Error(\"Invalid pointer.\");\n    const key = pointer.slice(r2Prefix.length);\n    return { bucket: r2Bucket, key };\n  } catch (e: any) {\n    const msg = String(e?.message || \"\").toLowerCase();\n    const missingPointerCol =\n      msg.includes(\"column\") && msg.includes(\"pointer\") && msg.includes(\"does not exist\");\n\n    if (!missingPointerCol) throw e;\n  }\n\n  // Attempt 2: docs.r2_bucket + docs.r2_key\n  const rows2 = (await sql`\n    select r2_bucket, r2_key\n    from docs\n    where id = ${docId}::uuid\n    limit 1\n  `) as unknown as Array<{ r2_bucket: string | null; r2_key: string | null }>;\n\n  const r2b = rows2[0]?.r2_bucket ?? null;\n  const r2k = rows2[0]?.r2_key ?? null;\n  if (!r2b || !r2k) throw new Error(\"Doc not found.\");\n  return { bucket: r2b, key: r2k };\n}\n\nasync function tableExists(name: string): Promise<boolean> {\n  try {\n    const rows = (await sql`select to_regclass(${name})::text as reg`) as unknown as Array<{ reg: string | null }>;\n    return Boolean(rows?.[0]?.reg);\n  } catch {\n    return false;\n  }\n}\n\nasync function purgeDocGraphRows(docId: string): Promise<boolean> {\n  const shareTokensExists = await tableExists(\"public.share_tokens\");\n  const shareUnlocksExists = await tableExists(\"public.share_unlocks\");\n  const docAliasesExists = await tableExists(\"public.doc_aliases\");\n  const docAccessGrantsExists = await tableExists(\"public.doc_access_grants\");\n  const scanJobsExists = await tableExists(\"public.malware_scan_jobs\");\n\n  if (shareUnlocksExists && shareTokensExists) {\n    await sql`\n      delete from public.share_unlocks\n      where token in (\n        select token from public.share_tokens where doc_id = ${docId}::uuid\n      )\n    `;\n  }\n  if (shareTokensExists) {\n    await sql`delete from public.share_tokens where doc_id = ${docId}::uuid`;\n  }\n  if (docAliasesExists) {\n    await sql`delete from public.doc_aliases where doc_id = ${docId}::uuid`;\n  }\n  if (docAccessGrantsExists) {\n    await sql`delete from public.doc_access_grants where doc_id = ${docId}::uuid`;\n  }\n  if (scanJobsExists) {\n    await sql`delete from public.malware_scan_jobs where doc_id = ${docId}::uuid`;\n  }\n\n  const deleted = (await sql`\n    delete from public.docs\n    where id = ${docId}::uuid\n    returning id::text as id\n  `) as unknown as Array<{ id: string }>;\n  return deleted.length > 0;\n}\n\n// Back-compat export expected by older admin UI\nexport async function uploadPdfAction(): Promise<void> {\n  await requireRole(\"admin\");\n  throw new Error(\"uploadPdfAction is deprecated. Use /admin/upload instead.\");\n}\n\n// Used as <form action={createOrAssignAliasAction}> — must return void\nexport async function createOrAssignAliasAction(formData: FormData): Promise<void> {\n  const alias = String(formData.get(\"alias\") || \"\").trim();\n  const docId = String(formData.get(\"docId\") || formData.get(\"doc_id\") || \"\").trim();\n\n  if (!alias) throw new Error(\"Missing alias.\");\n  if (!docId) throw new Error(\"Missing docId.\");\n\n  await requireDocWrite(docId);\n  if (!/^[a-zA-Z0-9_-]{3,80}$/.test(alias)) {\n    throw new Error(\"Alias must be 3-80 chars: letters, numbers, underscore, dash.\");\n  }\n\n  const created = (await sql`\n    insert into doc_aliases (alias, doc_id)\n    values (${alias}, ${docId}::uuid)\n    on conflict (alias) do nothing\n    returning alias::text as alias\n  `) as unknown as Array<{ alias: string }>;\n  if (!created.length) {\n    throw new Error(\"Alias is already in use.\");\n  }\n\n  emitWebhook(\"alias.created\", { alias, doc_id: docId });\n  await appendAdminAudit({\n    action: \"doc.alias_upserted\",\n    docId,\n    subjectId: alias,\n    payload: { alias },\n  });\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/dashboard\");\n}\n\n// Used as <form action={emailMagicLinkAction}> — must return void\nexport async function emailMagicLinkAction(formData: FormData): Promise<void> {\n  const u = await requireUser();\n\n  const to = String(\n    formData.get(\"to\") || formData.get(\"email\") || formData.get(\"recipient\") || \"\"\n  ).trim();\n\n  const docId = String(formData.get(\"docId\") || formData.get(\"doc_id\") || \"\").trim();\n  const alias = String(formData.get(\"alias\") || \"\").trim();\n\n  if (!to) throw new Error(\"Missing recipient email.\");\n  if (!alias && !docId) throw new Error(\"Provide alias or docId.\");\n\n  // AuthZ: verify ownership when docId/alias is provided.\n  if (docId) {\n    await requireDocWrite(docId);\n  } else if (alias) {\n    const rows = (await sql`\n      select doc_id::text as doc_id\n      from public.doc_aliases\n      where lower(alias) = lower(${alias})\n      limit 1\n    `) as unknown as Array<{ doc_id: string }>;\n    const did = rows?.[0]?.doc_id ?? null;\n    if (!did) throw new Error(\"Alias not found.\");\n    await requireDocWrite(did);\n  }\n\n  const base = getBaseUrl();\n  const token = alias || docId;\n  const url = `${base}/d/${encodeURIComponent(token)}`;\n\n  await sendMail({\n    to,\n    subject: \"Your document link\",\n    text: `Here is your secure link:\\n\\n${url}\\n\\nIf you did not expect this message, you can ignore it.`,\n  });\n\n  // Optional audit\n  await sendMail({\n    to: u.email,\n    subject: \"cyang.io: link emailed\",\n    text: `Sent link to ${to}\\n\\n${url}`,\n  });\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/dashboard\");\n}\n\n// Retention settings (admin toggle)\nexport async function updateRetentionSettingsAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n\n  const enabledRaw = String(formData.get(\"retention_enabled\") ?? \"\");\n  const deleteExpiredRaw = String(formData.get(\"retention_delete_expired_shares\") ?? \"\");\n  const graceRaw = String(formData.get(\"retention_share_grace_days\") ?? \"\");\n\n  const enabled = enabledRaw === \"on\" || enabledRaw === \"true\" || enabledRaw === \"1\";\n  const deleteExpiredShares = deleteExpiredRaw === \"on\" || deleteExpiredRaw === \"true\" || deleteExpiredRaw === \"1\";\n\n  const graceNum = Number(graceRaw);\n  const shareGraceDays = Number.isFinite(graceNum) ? Math.max(0, Math.floor(graceNum)) : 0;\n\n  const res = await setRetentionSettings({ enabled, deleteExpiredShares, shareGraceDays });\n  if (!res.ok) {\n    throw new Error(`Failed to save retention settings: ${res.error}`);\n  }\n\n  revalidatePath(\"/admin/dashboard\");\n}\n\n\n// Expiration alert settings (admin toggle)\nexport async function updateExpirationAlertSettingsAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n\n  const enabledRaw = String(formData.get(\"expiration_alerts_enabled\") ?? \"\");\n  const emailEnabledRaw = String(formData.get(\"expiration_alert_email_enabled\") ?? \"\");\n  const daysRaw = String(formData.get(\"expiration_alert_days\") ?? \"\");\n\n  const enabled = enabledRaw === \"on\" || enabledRaw === \"true\" || enabledRaw === \"1\";\n  const emailEnabled = emailEnabledRaw === \"on\" || emailEnabledRaw === \"true\" || emailEnabledRaw === \"1\";\n\n  const daysNum = Number(daysRaw);\n  const days = Number.isFinite(daysNum) ? Math.max(1, Math.min(30, Math.floor(daysNum))) : 3;\n\n  const res = await setExpirationAlertSettings({ enabled, emailEnabled, days });\n  if (!res.ok) throw new Error(`Failed to save expiration settings: ${res.error}`);\n\n  revalidatePath(\"/admin/dashboard\");\n}\n\n\n// Used as <form action={deleteDocAction}> — must return void\nexport async function deleteDocAction(formData: FormData): Promise<void> {\n  const docId = String(formData.get(\"docId\") || formData.get(\"doc_id\") || \"\").trim();\n  const reason = String(formData.get(\"reason\") || \"\").trim() || null;\n  if (!docId) throw new Error(\"Missing docId.\");\n\n  await requireDocWrite(docId);\n\n  const drows = (await sql`\n    select title::text as title\n    from public.docs\n    where id = ${docId}::uuid\n    limit 1\n  `) as unknown as Array<{ title: string | null }>;\n  const title = drows?.[0]?.title ?? null;\n\n  const { bucket, key } = await resolveR2LocationForDoc(docId);\n\n  await r2Client.send(\n    new DeleteObjectCommand({\n      Bucket: bucket,\n      Key: key,\n    })\n  );\n\n  const deleted = await purgeDocGraphRows(docId);\n  if (!deleted) {\n    throw new Error(\"Document not found.\");\n  }\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/dashboard\");\n\n  emitWebhook(\"doc.deleted\", { doc_id: docId, title });\n  await appendImmutableAudit(\n    {\n      streamKey: `doc:${docId}`,\n      action: \"doc.deleted\",\n      docId,\n      payload: { title, reason, via: \"admin_action\" },\n    },\n    { strict: true }\n  );\n}\n\n/**\n * Share admin actions\n * Expected table: share_tokens(token text primary key, revoked_at timestamptz, password_hash text null, ...)\n */\n\n// Used as <form action={revokeDocShareAction}>\nexport async function revokeDocShareAction(formData: FormData): Promise<void> {\n  const token = String(formData.get(\"token\") || \"\").trim();\n  if (!token) throw new Error(\"Missing token.\");\n\n  await requireShareWrite(token);\n\n  const before = (await sql`\n    select doc_id::text as doc_id, to_email, expires_at::text as expires_at, max_views, views_count\n    from public.share_tokens\n    where token = ${token}\n    limit 1\n  `) as unknown as Array<{\n    doc_id: string;\n    to_email: string | null;\n    expires_at: string | null;\n    max_views: number | null;\n    views_count: number | null;\n  }>;\n\n  await sql`\n    update share_tokens\n    set revoked_at = now()\n    where token = ${token}\n      and revoked_at is null\n  `;\n\n  // Webhook (best-effort)\n  emitWebhook(\"share.revoked\", {\n    token,\n    doc_id: before?.[0]?.doc_id ?? null,\n    to_email: before?.[0]?.to_email ?? null,\n    expires_at: before?.[0]?.expires_at ?? null,\n    max_views: before?.[0]?.max_views ?? null,\n    views_count: before?.[0]?.views_count ?? null,\n  });\n  await appendAdminAudit({\n    action: \"share.revoked\",\n    docId: before?.[0]?.doc_id ?? null,\n    subjectId: token,\n    payload: {\n      toEmail: before?.[0]?.to_email ?? null,\n      expiresAt: before?.[0]?.expires_at ?? null,\n      maxViews: before?.[0]?.max_views ?? null,\n      viewsCount: before?.[0]?.views_count ?? null,\n      via: \"admin_action\",\n    },\n  });\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\n// Used as <form action={setSharePasswordAction}>\nexport async function setSharePasswordAction(formData: FormData): Promise<void> {\n  const token = String(formData.get(\"token\") || \"\").trim();\n  const password = String(formData.get(\"password\") || \"\").trim();\n\n  if (!token) throw new Error(\"Missing token.\");\n  if (password.length < 4) throw new Error(\"Password must be at least 4 characters.\");\n\n  await requireShareWrite(token);\n\n  // bcrypt cost (12 is a good default for serverless)\n  const hash = await bcrypt.hash(password, 12);\n\n  await sql`\n    update share_tokens\n    set password_hash = ${hash}\n    where token = ${token}\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\n// Used as <form action={clearSharePasswordAction}>\nexport async function clearSharePasswordAction(formData: FormData): Promise<void> {\n  const token = String(formData.get(\"token\") || \"\").trim();\n  if (!token) throw new Error(\"Missing token.\");\n\n  await requireShareWrite(token);\n\n  await sql`\n    update share_tokens\n    set password_hash = null\n    where token = ${token}\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\n// --- Dashboard v2 actions (actionable + bulk) ---\n\nexport async function revokeAllSharesForDocAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const docId = String(formData.get(\"docId\") || \"\").trim();\n  if (!docId) throw new Error(\"Missing docId.\");\n\n  await sql`\n    update public.share_tokens\n    set revoked_at = now()\n    where doc_id = ${docId}::uuid\n      and revoked_at is null\n  `;\n  await appendAdminAudit({\n    action: \"share.bulk_revoked_for_doc\",\n    docId,\n    payload: { via: \"admin_action\" },\n  });\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n  revalidatePath(`/admin/docs/${docId}`);\n}\n\nexport async function disableAliasForDocAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const docId = String(formData.get(\"docId\") || \"\").trim();\n  if (!docId) throw new Error(\"Missing docId.\");\n\n  const arows = (await sql`\n    select alias::text as alias\n    from public.doc_aliases\n    where doc_id = ${docId}::uuid\n    limit 1\n  `) as unknown as Array<{ alias: string }>;\n  const alias = arows?.[0]?.alias ?? null;\n\n  // Best-effort: prefer is_active=false if the column exists; fall back to revoked_at.\n  try {\n    await sql`\n      update public.doc_aliases\n      set is_active = false\n      where doc_id = ${docId}::uuid\n    `;\n  } catch {\n    try {\n      await sql`\n        update public.doc_aliases\n        set revoked_at = now()\n        where doc_id = ${docId}::uuid\n          and revoked_at is null\n      `;\n    } catch {\n      // last-resort: delete (older envs)\n      await sql`\n        delete from public.doc_aliases\n        where doc_id = ${docId}::uuid\n      `;\n    }\n  }\n\n  emitWebhook(\"alias.disabled\", { doc_id: docId, alias });\n  await appendAdminAudit({\n    action: \"doc.alias_disabled\",\n    docId,\n    subjectId: alias,\n    payload: { alias, via: \"admin_action\" },\n  });\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n  revalidatePath(`/admin/docs/${docId}`);\n}\n\nexport async function extendAliasExpirationAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const docId = String(formData.get(\"docId\") || \"\").trim();\n  const days = Number(formData.get(\"days\") || 0);\n  if (!docId) throw new Error(\"Missing docId.\");\n  if (!Number.isFinite(days) || days <= 0) throw new Error(\"Invalid days.\");\n\n  // Extend alias expiration (or set it) by +days from now.\n  try {\n    await sql`\n      update public.doc_aliases\n      set expires_at = greatest(coalesce(expires_at, now()), now()) + (${days}::int * interval '1 day')\n      where doc_id = ${docId}::uuid\n    `;\n  } catch {\n    // If the env doesn't have expires_at, ignore.\n  }\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n  revalidatePath(`/admin/docs/${docId}`);\n}\n\nexport async function extendShareExpirationAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const token = String(formData.get(\"token\") || \"\").trim();\n  const days = Number(formData.get(\"days\") || 0);\n  if (!token) throw new Error(\"Missing token.\");\n  if (!Number.isFinite(days) || days <= 0) throw new Error(\"Invalid days.\");\n\n  await sql`\n    update public.share_tokens\n    set expires_at = greatest(coalesce(expires_at, now()), now()) + (${days}::int * interval '1 day')\n    where token = ${token}\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function setShareMaxViewsAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const token = String(formData.get(\"token\") || \"\").trim();\n  const maxViewsRaw = String(formData.get(\"maxViews\") || \"\").trim();\n  if (!token) throw new Error(\"Missing token.\");\n\n  const maxViews = maxViewsRaw === \"\" ? null : Number(maxViewsRaw);\n  if (maxViews !== null && (!Number.isFinite(maxViews) || maxViews < 0)) {\n    throw new Error(\"Invalid maxViews.\");\n  }\n\n  await sql`\n    update public.share_tokens\n    set max_views = ${maxViews}\n    where token = ${token}\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function resetShareViewsCountAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const token = String(formData.get(\"token\") || \"\").trim();\n  if (!token) throw new Error(\"Missing token.\");\n\n  await sql`\n    update public.share_tokens\n    set views_count = 0\n    where token = ${token}\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function forceSharePasswordResetAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const token = String(formData.get(\"token\") || \"\").trim();\n  if (!token) throw new Error(\"Missing token.\");\n\n  await sql`\n    update public.share_tokens\n    set password_hash = null\n    where token = ${token}\n  `;\n\n  // Also invalidate existing unlocks (if table exists).\n  try {\n    await sql`delete from public.share_unlocks where token = ${token}`;\n  } catch {\n    // ignore\n  }\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function bulkRevokeSharesAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const raw = String(formData.get(\"tokens\") || \"\").trim();\n  if (!raw) throw new Error(\"Missing tokens.\");\n  const tokens = JSON.parse(raw) as string[];\n  if (!Array.isArray(tokens) || tokens.length === 0) return;\n\n  await sql`\n    update public.share_tokens\n    set revoked_at = now()\n    where token = any(${tokens}::text[])\n      and revoked_at is null\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function bulkExtendSharesAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const raw = String(formData.get(\"tokens\") || \"\").trim();\n  const days = Number(formData.get(\"days\") || 0);\n  if (!raw) throw new Error(\"Missing tokens.\");\n  if (!Number.isFinite(days) || days <= 0) throw new Error(\"Invalid days.\");\n  const tokens = JSON.parse(raw) as string[];\n  if (!Array.isArray(tokens) || tokens.length === 0) return;\n\n  await sql`\n    update public.share_tokens\n    set expires_at = greatest(coalesce(expires_at, now()), now()) + (${days}::int * interval '1 day')\n    where token = any(${tokens}::text[])\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\nexport async function bulkRevokeAllSharesForDocsAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const raw = String(formData.get(\"docIds\") || \"\").trim();\n  if (!raw) throw new Error(\"Missing docIds.\");\n  const docIds = JSON.parse(raw) as string[];\n  if (!Array.isArray(docIds) || docIds.length === 0) return;\n\n  await sql`\n    update public.share_tokens\n    set revoked_at = now()\n    where doc_id = any(${docIds}::uuid[])\n      and revoked_at is null\n  `;\n  for (const docId of docIds) {\n    await appendAdminAudit({\n      action: \"share.bulk_revoked_for_doc\",\n      docId,\n      payload: { via: \"admin_action\", bulk: true },\n    });\n  }\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n  for (const id of docIds) revalidatePath(`/admin/docs/${id}`);\n}\n\nexport async function bulkDisableAliasesForDocsAction(formData: FormData): Promise<void> {\n  await requireRole(\"admin\");\n  const raw = String(formData.get(\"docIds\") || \"\").trim();\n  if (!raw) throw new Error(\"Missing docIds.\");\n  const docIds = JSON.parse(raw) as string[];\n  if (!Array.isArray(docIds) || docIds.length === 0) return;\n\n  try {\n    await sql`\n      update public.doc_aliases\n      set is_active = false\n      where doc_id = any(${docIds}::uuid[])\n    `;\n  } catch {\n    try {\n      await sql`\n        update public.doc_aliases\n        set revoked_at = now()\n        where doc_id = any(${docIds}::uuid[])\n          and revoked_at is null\n      `;\n    } catch {\n      await sql`\n        delete from public.doc_aliases\n        where doc_id = any(${docIds}::uuid[])\n      `;\n    }\n  }\n  for (const docId of docIds) {\n    await appendAdminAudit({\n      action: \"doc.alias_disabled\",\n      docId,\n      payload: { via: \"admin_action\", bulk: true },\n    });\n  }\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n  for (const id of docIds) revalidatePath(`/admin/docs/${id}`);\n}\n\nexport async function bulkDeleteDocsAction(formData: FormData): Promise<void> {\n  await requireUser();\n  const raw = String(formData.get(\"docIds\") || \"\").trim();\n  const reason = String(formData.get(\"reason\") || \"\").trim() || null;\n  if (!raw) throw new Error(\"Missing docIds.\");\n  const docIds = JSON.parse(raw) as string[];\n  if (!Array.isArray(docIds) || docIds.length === 0) return;\n\n  for (const docId of docIds) {\n    const id = String(docId || \"\").trim();\n    if (!id) continue;\n\n    try {\n      await requireDocWrite(id);\n\n      const drows = (await sql`\n        select title::text as title\n        from public.docs\n        where id = ${id}::uuid\n        limit 1\n      `) as unknown as Array<{ title: string | null }>;\n      const title = drows?.[0]?.title ?? null;\n\n      const { bucket, key } = await resolveR2LocationForDoc(id);\n      await r2Client.send(\n        new DeleteObjectCommand({\n          Bucket: bucket,\n          Key: key,\n        })\n      );\n      await purgeDocGraphRows(id);\n\n      emitWebhook(\"doc.deleted\", { doc_id: id, title, bulk: true, reason });\n      await appendImmutableAudit(\n        {\n          streamKey: `doc:${id}`,\n          action: \"doc.deleted\",\n          docId: id,\n          payload: { title, reason, via: \"owner_bulk_delete\" },\n        },\n        { strict: true }\n      );\n    } catch {\n      // continue processing other selected docs\n    }\n  }\n\n  revalidatePath(\"/admin/viewer-uploads\");\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\n// Expiration warning email (best-effort; uses doc_aliases.expires_at + share_tokens.expires_at)\nexport async function sendExpirationAlertAction(formData: FormData): Promise<void> {\n  const u = await requireRole(\"admin\");\n\n  const settingsRes = await getExpirationAlertSettings();\n  const settings = settingsRes.ok ? settingsRes.settings : { enabled: true, days: 3, emailEnabled: true };\n\n  const daysRaw = String(formData.get(\"days\") || settings.days || \"3\").trim();\n  const daysNum = Number(daysRaw);\n  const days = Number.isFinite(daysNum) ? Math.max(1, Math.min(30, Math.floor(daysNum))) : settings.days;\n\n  if (!settings.enabled || !settings.emailEnabled) {\n    // Still revalidate, but do nothing.\n    revalidatePath(\"/admin/dashboard\");\n    revalidatePath(\"/admin\");\n    return;\n  }\n\n  const base = getBaseUrl();\n\n  let aliasRows: Array<{ doc_id: string; title: string | null; alias: string | null; expires_at: string | null }> = [];\n  let shareRows: Array<{ token: string; doc_id: string; title: string | null; to_email: string | null; expires_at: string | null }> = [];\n\n  try {\n    aliasRows = (await sql`\n      select\n        d.id::text as doc_id,\n        d.title,\n        a.alias,\n        a.expires_at::text as expires_at\n      from public.doc_aliases a\n      join public.docs d on d.id = a.doc_id\n      where d.owner_id = ${u.id}::uuid\n        and coalesce(a.is_active, true) = true\n        and a.revoked_at is null\n        and a.expires_at is not null\n        and a.expires_at > now()\n        and a.expires_at <= (now() + (${days}::int * interval '1 day'))\n      order by a.expires_at asc\n      limit 100\n    `) as unknown as Array<{ doc_id: string; title: string | null; alias: string | null; expires_at: string | null }>;\n  } catch {\n    aliasRows = [];\n  }\n\n  try {\n    shareRows = (await sql`\n      select\n        st.token::text as token,\n        d.id::text as doc_id,\n        d.title,\n        st.to_email,\n        st.expires_at::text as expires_at\n      from public.share_tokens st\n      join public.docs d on d.id = st.doc_id\n      where d.owner_id = ${u.id}::uuid\n        and st.revoked_at is null\n        and st.expires_at is not null\n        and st.expires_at > now()\n        and st.expires_at <= (now() + (${days}::int * interval '1 day'))\n      order by st.expires_at asc\n      limit 100\n    `) as unknown as Array<{ token: string; doc_id: string; title: string | null; to_email: string | null; expires_at: string | null }>;\n  } catch {\n    shareRows = [];\n  }\n\n  const lines: string[] = [];\n\n  if (aliasRows.length) {\n    lines.push(`Aliases expiring in the next ${days} day(s):`);\n    for (const r of aliasRows) {\n      const name = r.title || \"Untitled\";\n      const docUrl = `${base}/admin/docs/${encodeURIComponent(r.doc_id)}`;\n      const aliasUrl = r.alias ? `${base}/d/${encodeURIComponent(r.alias)}` : \"\";\n      const exp = r.expires_at || \"\";\n      lines.push(`- ${name} (${r.doc_id})\\n  expires: ${exp}\\n  admin: ${docUrl}${aliasUrl ? `\\n  link: ${aliasUrl}` : \"\"}`);\n    }\n    lines.push(\"\");\n  }\n\n  if (shareRows.length) {\n    lines.push(`Shares expiring in the next ${days} day(s):`);\n    for (const r of shareRows) {\n      const name = r.title || \"Untitled\";\n      const docUrl = `${base}/admin/docs/${encodeURIComponent(r.doc_id)}`;\n      const shareUrl = `${base}/s/${encodeURIComponent(r.token)}`;\n      const exp = r.expires_at || \"\";\n      lines.push(`- ${name} (${r.doc_id})\\n  expires: ${exp}\\n  token: ${r.token}${r.to_email ? `\\n  to: ${r.to_email}` : \"\"}\\n  admin: ${docUrl}\\n  link: ${shareUrl}`);\n    }\n    lines.push(\"\");\n  }\n\n  const body =\n    lines.length === 0 ? `No items expiring in the next ${days} day(s).` : lines.join(\"\\n\\n\");\n\n  await sendMail({\n    to: u.email,\n    subject: `cyang.io: expirations in ${days} day(s)`,\n    text: body,\n  });\n\n  revalidatePath(\"/admin/dashboard\");\n  revalidatePath(\"/admin\");\n}\n\n\n// =========================\n// API Keys (admin/owner)\n// =========================\n\nexport async function createApiKeyAction(formData: FormData) {\n  const u = await requireRole(\"admin\");\n\n  const name = String(formData.get(\"name\") || \"\").trim();\n  if (!name) throw new Error(\"Missing name.\");\n\n  const { plaintext, prefix } = generateApiKey();\n  const keyHash = hashApiKey(plaintext);\n\n  const rows = (await sql`\n    insert into public.api_keys (owner_id, name, prefix, key_hash)\n    values (${u.id}::uuid, ${name}, ${prefix}, ${keyHash})\n    returning id::text as id\n  `) as unknown as Array<{ id: string }>;\n\n  revalidatePath(\"/admin/api-keys\");\n  return { ok: true as const, id: rows?.[0]?.id ?? null, apiKey: plaintext };\n}\n\nexport async function revokeApiKeyAction(formData: FormData) {\n  await requireRole(\"admin\");\n  const id = String(formData.get(\"id\") || \"\").trim();\n  if (!id) throw new Error(\"Missing id.\");\n\n  await sql`\n    update public.api_keys\n    set revoked_at = now()\n    where id = ${id}::uuid\n  `;\n\n  revalidatePath(\"/admin/api-keys\");\n  return { ok: true as const };\n}\n\n\n// --- Admin notifications (expiration alerts) ---\n\nexport async function markAdminNotificationReadAction(formData: FormData) {\n  await requireRole(\"admin\");\n  const u = await requireUser();\n\n  const id = String(formData.get(\"id\") || \"\").trim();\n  if (!id) throw new Error(\"Missing id.\");\n\n  await sql`\n    update public.admin_notifications\n    set read_at = now()\n    where id = ${id}::uuid\n      and owner_id = ${u.id}::uuid\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  return { ok: true as const };\n}\n\nexport async function markAllAdminNotificationsReadAction(_: FormData) {\n  await requireRole(\"admin\");\n  const u = await requireUser();\n\n  await sql`\n    update public.admin_notifications\n    set read_at = now()\n    where owner_id = ${u.id}::uuid\n      and read_at is null\n  `;\n\n  revalidatePath(\"/admin/dashboard\");\n  return { ok: true as const };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\components\\AdminHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\AnalyticsWidgets.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\RevokeShareForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\SharePasswordForm.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":30,"column":9,"nodeType":"JSXOpeningElement","endLine":37,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/dashboard/SharePasswordForm.tsx\n\"use client\";\n\nimport { useState } from \"react\";\n\nexport default function SharePasswordForm(props: {\n  token: string;\n  hasPassword: boolean;\n  setAction: (fd: FormData) => Promise<void>;\n  clearAction: (fd: FormData) => Promise<void>;\n}) {\n  const [pw, setPw] = useState(\"\");\n  const [busy, setBusy] = useState(false);\n\n  return (\n    <div className=\"inline-flex items-center justify-end gap-2\">\n      <form\n        action={async (fd) => {\n          setBusy(true);\n          try {\n            await props.setAction(fd);\n            setPw(\"\");\n          } finally {\n            setBusy(false);\n          }\n        }}\n        className=\"inline-flex items-center gap-2\"\n      >\n        <input type=\"hidden\" name=\"token\" value={props.token} />\n        <input\n          name=\"password\"\n          type=\"password\"\n          value={pw}\n          onChange={(e) => setPw(e.target.value)}\n          placeholder={props.hasPassword ? \"New password\" : \"Set password\"}\n          className=\"w-[140px] rounded-lg border border-white/20 bg-black/20 px-2 py-1 text-xs text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none\"\n        />\n        <button\n          type=\"submit\"\n          disabled={busy || pw.trim().length < 4}\n          className=\"btn-base btn-secondary rounded-lg px-2 py-1 text-xs disabled:opacity-50\"\n          title=\"Set or change password\"\n        >\n          {busy ? \"...\" : props.hasPassword ? \"Change\" : \"Set\"}\n        </button>\n      </form>\n\n      <form\n        action={async (fd) => {\n          setBusy(true);\n          try {\n            await props.clearAction(fd);\n          } finally {\n            setBusy(false);\n          }\n        }}\n      >\n        <input type=\"hidden\" name=\"token\" value={props.token} />\n        <button\n          type=\"submit\"\n          disabled={busy || !props.hasPassword}\n          className=\"btn-base btn-secondary rounded-lg px-2 py-1 text-xs disabled:opacity-50\"\n          title=\"Remove password protection\"\n        >\n          Clear\n        </button>\n      </form>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\SharesTableClient.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":178,"column":13,"nodeType":"JSXOpeningElement","endLine":187,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/dashboard/SharesTableClient.tsx\n\"use client\";\n\nimport Link from \"next/link\";\nimport { useMemo, useState } from \"react\";\nimport { usePathname, useRouter, useSearchParams } from \"next/navigation\";\nimport RevokeShareForm from \"./RevokeShareForm\";\nimport SharePasswordForm from \"./SharePasswordForm\";\nimport {\n  revokeDocShareAction,\n  setSharePasswordAction,\n  clearSharePasswordAction,\n  extendShareExpirationAction,\n  setShareMaxViewsAction,\n  resetShareViewsCountAction,\n  forceSharePasswordResetAction,\n  bulkRevokeSharesAction,\n  bulkExtendSharesAction,\n} from \"../actions\";\n\nexport type ShareRow = {\n  token: string;\n  doc_id: string;\n  to_email: string | null;\n  created_at: string;\n  expires_at: string | null;\n  max_views: number | null;\n  view_count: number;\n  revoked_at: string | null;\n  doc_title: string | null;\n  alias: string | null;\n  has_password: boolean;\n};\n\nfunction fmtDate(s: string | null) {\n  if (!s) return \"-\";\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return s;\n  return d.toLocaleString();\n}\n\nfunction maxLabel(n: number | null) {\n  if (n === null) return \"-\";\n  if (n === 0) return \"inf\";\n  return String(n);\n}\n\ntype Status = \"all\" | \"active\" | \"expired\" | \"maxed\" | \"revoked\";\ntype StatusFilter = Status | \"expiring\";\n\nfunction computeStatus(s: ShareRow, nowTs: number): Exclude<Status, \"all\"> {\n  if (s.revoked_at) return \"revoked\";\n  if (s.expires_at && new Date(s.expires_at).getTime() <= nowTs) return \"expired\";\n  if (s.max_views != null && s.max_views !== 0 && s.view_count >= s.max_views) return \"maxed\";\n  return \"active\";\n}\n\nfunction statusBadge(status: Exclude<Status, \"all\">) {\n  switch (status) {\n    case \"revoked\":\n      return { label: \"Revoked\", cls: \"border-amber-500/25 bg-amber-500/10 text-amber-100\" };\n    case \"expired\":\n      return { label: \"Expired\", cls: \"border-rose-500/25 bg-rose-500/10 text-rose-100\" };\n    case \"maxed\":\n      return { label: \"Maxed\", cls: \"border-rose-500/25 bg-rose-500/10 text-rose-100\" };\n    default:\n      return { label: \"Active\", cls: \"border-emerald-500/25 bg-emerald-500/10 text-emerald-100\" };\n  }\n}\n\nexport default function SharesTableClient(props: { shares: ShareRow[]; nowTs: number }) {\n  const sp = useSearchParams();\n  const router = useRouter();\n  const pathname = usePathname();\n\n  const [selected, setSelected] = useState<Record<string, boolean>>({});\n\n  const q = (sp.get(\"shareQ\") || \"\").trim();\n  const status = (sp.get(\"shareStatus\") || \"all\") as StatusFilter;\n  const nowTs = props.nowTs;\n\n  const normalizedQ = q.trim().toLowerCase();\n\n  const filtered = useMemo(() => {\n    return props.shares.filter((s) => {\n      const st = computeStatus(s, nowTs);\n      if (status !== \"all\") {\n        if (status === \"expiring\") {\n          if (st !== \"active\") return false;\n          if (!s.expires_at) return false;\n          const exp = new Date(s.expires_at).getTime();\n          const sevenDays = 7 * 24 * 60 * 60 * 1000;\n          if (Number.isNaN(exp)) return false;\n          if (exp <= nowTs) return false;\n          if (exp > nowTs + sevenDays) return false;\n        } else if (st !== status) {\n          return false;\n        }\n      }\n      if (!normalizedQ) return true;\n      const hay = [s.to_email ?? \"\", s.token, s.doc_title ?? \"\", s.alias ?? \"\", s.doc_id, s.has_password ? \"password protected\" : \"no password\"].join(\" \").toLowerCase();\n      return hay.includes(normalizedQ);\n    });\n  }, [props.shares, normalizedQ, status, nowTs]);\n\n  const counts = useMemo(() => {\n    const c = { all: props.shares.length, active: 0, expired: 0, maxed: 0, revoked: 0 };\n    for (const s of props.shares) c[computeStatus(s, nowTs)] += 1;\n    return c;\n  }, [props.shares, nowTs]);\n\n  const expiringCount = useMemo(() => {\n    const sevenDays = 7 * 24 * 60 * 60 * 1000;\n    let n = 0;\n    for (const s of props.shares) {\n      if (computeStatus(s, nowTs) !== \"active\") continue;\n      if (!s.expires_at) continue;\n      const exp = new Date(s.expires_at).getTime();\n      if (Number.isNaN(exp)) continue;\n      if (exp > nowTs && exp <= nowTs + sevenDays) n += 1;\n    }\n    return n;\n  }, [props.shares, nowTs]);\n\n  function syncUrl(next: { shareQ?: string; shareStatus?: StatusFilter }) {\n    const params = new URLSearchParams(sp.toString());\n    if (next.shareQ !== undefined) {\n      const v = next.shareQ.trim();\n      if (v) params.set(\"shareQ\", v);\n      else params.delete(\"shareQ\");\n    }\n    if (next.shareStatus !== undefined) {\n      if (next.shareStatus && next.shareStatus !== \"all\") params.set(\"shareStatus\", next.shareStatus);\n      else params.delete(\"shareStatus\");\n    }\n    const hash = typeof window !== \"undefined\" ? window.location.hash : \"\";\n    const qs = params.toString();\n    router.replace(`${pathname}${qs ? `?${qs}` : \"\"}${hash}`, { scroll: false });\n  }\n\n  const filteredTokens = useMemo(() => filtered.map((s) => s.token), [filtered]);\n  const selectedTokens = useMemo(() => Object.keys(selected).filter((k) => selected[k]), [selected]);\n  const anySelected = selectedTokens.length > 0;\n  const allVisibleSelected = useMemo(() => filteredTokens.length > 0 && filteredTokens.every((t) => selected[t]), [filteredTokens, selected]);\n\n  function toggleAllVisible(next: boolean) {\n    setSelected((prev) => {\n      const out = { ...prev };\n      for (const t of filteredTokens) out[t] = next;\n      return out;\n    });\n  }\n\n  function downloadCsvForSelected() {\n    const rows = props.shares.filter((s) => selected[s.token]);\n    const header = [\"token\", \"doc_id\", \"alias\", \"doc_title\", \"to_email\", \"created_at\", \"expires_at\", \"max_views\", \"view_count\", \"revoked_at\", \"has_password\"].join(\",\");\n    const lines = rows.map((s) =>\n      [s.token, s.doc_id, JSON.stringify(s.alias || \"\"), JSON.stringify(s.doc_title || \"\"), JSON.stringify(s.to_email || \"\"), JSON.stringify(s.created_at || \"\"), JSON.stringify(s.expires_at || \"\"), s.max_views == null ? \"\" : String(s.max_views), String(s.view_count ?? 0), JSON.stringify(s.revoked_at || \"\"), s.has_password ? \"true\" : \"false\"].join(\",\")\n    );\n    const csv = [header, ...lines].join(\"\\n\");\n    const blob = new Blob([csv], { type: \"text/csv;charset=utf-8\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `shares_export_${new Date().toISOString().slice(0, 10)}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n    URL.revokeObjectURL(url);\n  }\n\n  return (\n    <div className=\"glass-card-strong mt-4 rounded-2xl p-4\">\n      <div className=\"flex flex-col gap-3 md:flex-row md:items-end md:justify-between\">\n        <div className=\"flex flex-col gap-2 md:flex-row md:items-center\">\n          <div>\n            <label htmlFor=\"share-search\" className=\"block text-xs text-white/60\">Search</label>\n            <input\n              id=\"share-search\"\n              value={q}\n              onChange={(e) => {\n                const v = e.target.value;\n                syncUrl({ shareQ: v });\n              }}\n              placeholder=\"email, alias, title, token...\"\n              className=\"mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none md:w-[360px]\"\n            />\n          </div>\n          <div>\n            <label htmlFor=\"share-status\" className=\"block text-xs text-white/60\">Status</label>\n            <select\n              id=\"share-status\"\n              value={status}\n              onChange={(e) => {\n                const v = e.target.value as StatusFilter;\n                syncUrl({ shareStatus: v });\n              }}\n              className=\"mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white focus:border-cyan-300/55 focus:outline-none md:w-[190px]\"\n            >\n              <option value=\"all\">All ({counts.all})</option>\n              <option value=\"active\">Active ({counts.active})</option>\n              <option value=\"expiring\">Expiring (7d) ({expiringCount})</option>\n              <option value=\"expired\">Expired ({counts.expired})</option>\n              <option value=\"maxed\">Maxed ({counts.maxed})</option>\n              <option value=\"revoked\">Revoked ({counts.revoked})</option>\n            </select>\n          </div>\n          <button\n            onClick={() => {\n              syncUrl({ shareQ: \"\", shareStatus: \"all\" });\n            }}\n            className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm md:mb-[2px]\"\n          >\n            Clear\n          </button>\n        </div>\n\n        <div className=\"text-xs text-white/60\">\n          Showing <span className=\"text-white\">{filtered.length}</span> of <span className=\"text-white\">{props.shares.length}</span>\n        </div>\n      </div>\n\n      <div className=\"mt-3 overflow-hidden rounded-xl border border-white/10\">\n        <div className=\"max-h-[560px] overflow-auto\">\n          <table className=\"w-full text-sm\">\n            <thead className=\"sticky top-0 bg-[#10192b]/95 text-white/75 backdrop-blur\">\n              <tr>\n                <th className=\"w-[44px] px-4 py-3 text-left\">\n                  <input type=\"checkbox\" checked={allVisibleSelected} onChange={(e) => toggleAllVisible(e.target.checked)} aria-label=\"Select all visible shares\" />\n                </th>\n                <th className=\"px-4 py-3 text-left\">Recipient</th>\n                <th className=\"px-4 py-3 text-left\">Token</th>\n                <th className=\"px-4 py-3 text-left\">Doc</th>\n                <th className=\"px-4 py-3 text-left\">Status</th>\n                <th className=\"px-4 py-3 text-left\">Expires</th>\n                <th className=\"px-4 py-3 text-right\">Max</th>\n                <th className=\"px-4 py-3 text-right\">Views</th>\n                <th className=\"px-4 py-3 text-right\">Password</th>\n                <th className=\"px-4 py-3 text-right\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filtered.length === 0 ? (\n                <tr><td colSpan={10} className=\"px-4 py-6 text-white/60\">No shares match your filters.</td></tr>\n              ) : (\n                filtered.map((s) => {\n                  const st = computeStatus(s, nowTs);\n                  const badge = statusBadge(st);\n                  const tokenShort = s.token.length > 16 ? `${s.token.slice(0, 8)}...${s.token.slice(-4)}` : s.token;\n                  return (\n                    <tr key={s.token} className=\"border-t border-white/10 hover:bg-white/[0.03]\">\n                      <td className=\"px-4 py-3 align-top\">\n                        <input type=\"checkbox\" checked={!!selected[s.token]} onChange={(e) => setSelected((prev) => ({ ...prev, [s.token]: e.target.checked }))} aria-label={`Select ${s.token}`} />\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <div className=\"text-white\">{s.to_email || <span className=\"text-white/55\">(public)</span>}</div>\n                        <div className=\"text-xs text-white/55\">{fmtDate(s.created_at)}</div>\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <div className=\"font-mono text-xs text-white/90\">{tokenShort}</div>\n                        <div className=\"mt-1 text-xs text-white/50\">Hidden share path</div>\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <div className=\"text-white\">{s.doc_title || \"Untitled\"}</div>\n                        <div className=\"mt-1 text-xs text-white/55\">\n                          {s.alias ? (\n                            <Link href={`/d/${s.alias}`} target=\"_blank\" className=\"text-cyan-200 hover:underline\">/d/{s.alias}</Link>\n                          ) : (\n                            <span className=\"font-mono\">{s.doc_id}</span>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs ${badge.cls}`}>{badge.label}</span>\n                      </td>\n                      <td className=\"px-4 py-3 text-white/65\">{fmtDate(s.expires_at)}</td>\n                      <td className=\"px-4 py-3 text-right text-white/90\">{maxLabel(s.max_views)}</td>\n                      <td className=\"px-4 py-3 text-right text-white/90\">{s.view_count ?? 0}</td>\n                      <td className=\"px-4 py-3 text-right\">\n                        <SharePasswordForm token={s.token} hasPassword={Boolean(s.has_password)} setAction={setSharePasswordAction} clearAction={clearSharePasswordAction} />\n                      </td>\n                      <td className=\"whitespace-nowrap px-4 py-3 text-right\">\n                        <div className=\"flex flex-wrap items-center justify-end gap-2\">\n                          <form action={extendShareExpirationAction}>\n                            <input type=\"hidden\" name=\"token\" value={s.token} />\n                            <input type=\"hidden\" name=\"days\" value=\"7\" />\n                            <button type=\"submit\" disabled={!!s.revoked_at} className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs disabled:opacity-40\">+7d</button>\n                          </form>\n                          <form action={extendShareExpirationAction}>\n                            <input type=\"hidden\" name=\"token\" value={s.token} />\n                            <input type=\"hidden\" name=\"days\" value=\"30\" />\n                            <button type=\"submit\" disabled={!!s.revoked_at} className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs disabled:opacity-40\">+30d</button>\n                          </form>\n                          <form action={resetShareViewsCountAction}>\n                            <input type=\"hidden\" name=\"token\" value={s.token} />\n                            <button type=\"submit\" disabled={!!s.revoked_at} className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs disabled:opacity-40\">Reset views</button>\n                          </form>\n                          <form action={forceSharePasswordResetAction}>\n                            <input type=\"hidden\" name=\"token\" value={s.token} />\n                            <button type=\"submit\" disabled={!!s.revoked_at} className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs disabled:opacity-40\">Clear pw</button>\n                          </form>\n                          <form\n                            action={setShareMaxViewsAction}\n                            onSubmit={(e) => {\n                              const input = (e.currentTarget.querySelector('input[name=\"maxViews\"]') as HTMLInputElement) || null;\n                              if (!input) return;\n                              const v = window.prompt(\"Set max views (number). Use 0 for unlimited. Leave blank to clear.\", s.max_views == null ? \"\" : String(s.max_views));\n                              if (v === null) {\n                                e.preventDefault();\n                                return;\n                              }\n                              input.value = v.trim();\n                            }}\n                          >\n                            <input type=\"hidden\" name=\"token\" value={s.token} />\n                            <input type=\"hidden\" name=\"maxViews\" defaultValue=\"\" />\n                            <button type=\"submit\" disabled={!!s.revoked_at} className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs disabled:opacity-40\">Set max</button>\n                          </form>\n                          <RevokeShareForm token={s.token} revoked={Boolean(s.revoked_at)} action={revokeDocShareAction} />\n                        </div>\n                      </td>\n                    </tr>\n                  );\n                })\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      <div className=\"mt-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between\">\n        <div className=\"text-xs text-white/60\">Selected: <span className=\"text-white\">{selectedTokens.length}</span></div>\n        <div className=\"flex flex-wrap gap-2\">\n          <form action={bulkRevokeSharesAction} onSubmit={(e) => { if (!anySelected) e.preventDefault(); }}>\n            <input type=\"hidden\" name=\"tokens\" value={JSON.stringify(selectedTokens)} />\n            <button type=\"submit\" disabled={!anySelected} className=\"btn-base btn-danger rounded-xl px-3 py-2 text-sm disabled:opacity-40\">Revoke selected</button>\n          </form>\n          <form\n            action={bulkExtendSharesAction}\n            onSubmit={(e) => {\n              if (!anySelected) {\n                e.preventDefault();\n                return;\n              }\n              const days = window.prompt(\"Extend expiration by how many days?\", \"7\");\n              if (days === null) {\n                e.preventDefault();\n                return;\n              }\n              const d = (e.currentTarget.querySelector('input[name=\"days\"]') as HTMLInputElement) || null;\n              if (d) d.value = days.trim();\n            }}\n          >\n            <input type=\"hidden\" name=\"tokens\" value={JSON.stringify(selectedTokens)} />\n            <input type=\"hidden\" name=\"days\" defaultValue=\"7\" />\n            <button type=\"submit\" disabled={!anySelected} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm disabled:opacity-40\">Extend selected...</button>\n          </form>\n          <button type=\"button\" disabled={!anySelected} onClick={() => { if (anySelected) downloadCsvForSelected(); }} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm disabled:opacity-40\">\n            Export CSV\n          </button>\n          <button type=\"button\" onClick={() => setSelected({})} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm\">\n            Clear selection\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\UnifiedDocsTableClient.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":245,"column":11,"nodeType":"JSXOpeningElement","endLine":252,"endColumn":13},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":334,"column":21,"nodeType":"JSXOpeningElement","endLine":334,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/dashboard/UnifiedDocsTableClient.tsx\n\"use client\";\n\nimport Link from \"next/link\";\nimport DeleteDocForm from \"../DeleteDocForm\";\nimport { bulkDeleteDocsAction, deleteDocAction } from \"../actions\";\nimport { useEffect, useMemo, useState, useTransition } from \"react\";\nimport { usePathname, useRouter, useSearchParams } from \"next/navigation\";\n\nexport type UnifiedDocRow = {\n  doc_id: string;\n  doc_title: string | null;\n  alias: string | null;\n  scan_status: string | null;\n  total_views: number;\n  last_view: string | null;\n  active_shares: number;\n  alias_expires_at: string | null;\n  alias_is_active: boolean | null;\n  alias_revoked_at: string | null;\n};\n\nfunction fmtDate(s: string | null) {\n  if (!s) return \"-\";\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return s;\n  return d.toLocaleString();\n}\n\nfunction daysUntil(s: string | null): number | null {\n  if (!s) return null;\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return null;\n  const ms = d.getTime() - Date.now();\n  return Math.floor(ms / (24 * 60 * 60 * 1000));\n}\n\ntype SortKey =\n  | \"doc_title\"\n  | \"total_views\"\n  | \"last_view\"\n  | \"active_shares\"\n  | \"alias_expires_at\"\n  | \"status\";\n\ntype SortDir = \"asc\" | \"desc\";\n\nfunction statusFor(r: UnifiedDocRow): { label: string; tone: \"good\" | \"warn\" | \"bad\" | \"muted\" } {\n  const now = Date.now();\n  const isActive = r.alias_is_active ?? true;\n  const revoked = !!r.alias_revoked_at;\n  const exp = r.alias_expires_at ? new Date(r.alias_expires_at).getTime() : null;\n  const expired = exp != null && Number.isFinite(exp) && exp <= now;\n\n  if (!r.alias) return { label: \"No alias\", tone: \"muted\" };\n  if (!isActive || revoked) return { label: \"Disabled\", tone: \"bad\" };\n  if (expired) return { label: \"Expired\", tone: \"bad\" };\n\n  const d = daysUntil(r.alias_expires_at);\n  if (d != null && d >= 0 && d <= 3) return { label: `Expiring (${d}d)`, tone: \"warn\" };\n  return { label: \"Active\", tone: \"good\" };\n}\n\nfunction Badge({ label, tone }: { label: string; tone: \"good\" | \"warn\" | \"bad\" | \"muted\" }) {\n  const cls =\n    tone === \"good\"\n      ? \"border-emerald-500/25 bg-emerald-500/10 text-emerald-100\"\n      : tone === \"warn\"\n      ? \"border-amber-500/25 bg-amber-500/10 text-amber-100\"\n      : tone === \"bad\"\n      ? \"border-rose-500/25 bg-rose-500/10 text-rose-100\"\n      : \"ui-badge\";\n  return <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] ${cls}`}>{label}</span>;\n}\n\nfunction SortButton({\n  label,\n  active,\n  dir,\n  onClick,\n}: {\n  label: string;\n  active: boolean;\n  dir: SortDir;\n  onClick: () => void;\n}) {\n  return (\n    <button\n      className={`inline-flex items-center gap-1 text-xs font-medium ${active ? \"text-white\" : \"text-white/70 hover:text-white\"}`}\n      onClick={onClick}\n      type=\"button\"\n    >\n      {label}\n      {active ? <span className=\"text-[10px] text-white/50\">{dir === \"asc\" ? \"up\" : \"down\"}</span> : null}\n    </button>\n  );\n}\n\nexport default function UnifiedDocsTableClient(props: {\n  rows: UnifiedDocRow[];\n  defaultPageSize?: number;\n  showDelete?: boolean;\n}) {\n  const sp = useSearchParams();\n  const router = useRouter();\n  const pathname = usePathname();\n  const showDelete = !!props.showDelete;\n  const [selectedIds, setSelectedIds] = useState<string[]>([]);\n  const [isPending, startTransition] = useTransition();\n\n  const q = (sp.get(\"docQ\") || \"\").trim();\n  const pageRaw = Number(sp.get(\"docPage\") || \"1\");\n  const page = Number.isFinite(pageRaw) && pageRaw > 0 ? pageRaw : 1;\n  const pageSizeRaw = Number(sp.get(\"docPageSize\") || String(props.defaultPageSize ?? 10));\n  const pageSize = Number.isFinite(pageSizeRaw) && pageSizeRaw > 0 ? pageSizeRaw : (props.defaultPageSize ?? 10);\n  const sortKey = ((sp.get(\"docSort\") || \"total_views\") as SortKey);\n  const sortDir: SortDir = (sp.get(\"docDir\") || \"desc\") === \"asc\" ? \"asc\" : \"desc\";\n\n  function syncUrl(next: Partial<{ docQ: string; docPage: number; docPageSize: number; docSort: SortKey; docDir: SortDir }>) {\n    const params = new URLSearchParams(sp.toString());\n    if (next.docQ !== undefined) {\n      const v = next.docQ.trim();\n      if (v) params.set(\"docQ\", v);\n      else params.delete(\"docQ\");\n    }\n    if (next.docPage !== undefined) params.set(\"docPage\", String(next.docPage));\n    if (next.docPageSize !== undefined) params.set(\"docPageSize\", String(next.docPageSize));\n    if (next.docSort !== undefined) params.set(\"docSort\", next.docSort);\n    if (next.docDir !== undefined) params.set(\"docDir\", next.docDir);\n    const hash = typeof window !== \"undefined\" ? window.location.hash : \"\";\n    router.replace(`${pathname}?${params.toString()}${hash}`, { scroll: false });\n  }\n\n  const normalizedQ = q.trim().toLowerCase();\n\n  const hasPendingScans = useMemo(() => {\n    return props.rows.some((r) => {\n      const s = String(r.scan_status || \"unscanned\").toLowerCase();\n      return s === \"pending\" || s === \"queued\" || s === \"running\" || s === \"unscanned\";\n    });\n  }, [props.rows]);\n\n  useEffect(() => {\n    if (!hasPendingScans) return;\n    const id = window.setInterval(() => {\n      router.refresh();\n    }, 10_000);\n    return () => window.clearInterval(id);\n  }, [hasPendingScans, router]);\n\n  const filtered = useMemo(() => {\n    if (!normalizedQ) return props.rows;\n    return props.rows.filter((r) => {\n      const hay = [r.doc_title ?? \"\", r.alias ?? \"\", r.doc_id].join(\" \").toLowerCase();\n      return hay.includes(normalizedQ);\n    });\n  }, [props.rows, normalizedQ]);\n\n  const sorted = useMemo(() => {\n    const dir = sortDir === \"asc\" ? 1 : -1;\n    const a = [...filtered];\n    a.sort((x, y) => {\n      const getVal = (r: UnifiedDocRow) => {\n        switch (sortKey) {\n          case \"doc_title\":\n            return (r.doc_title || \"\").toLowerCase();\n          case \"total_views\":\n            return r.total_views || 0;\n          case \"last_view\":\n            return r.last_view ? new Date(r.last_view).getTime() : 0;\n          case \"active_shares\":\n            return r.active_shares || 0;\n          case \"alias_expires_at\":\n            return r.alias_expires_at ? new Date(r.alias_expires_at).getTime() : 0;\n          case \"status\":\n            return r.alias ? statusFor(r).label : \"zzzz\";\n        }\n      };\n      const vx = getVal(x);\n      const vy = getVal(y);\n      if (typeof vx === \"number\" && typeof vy === \"number\") {\n        if (vx === vy) return 0;\n        return vx > vy ? dir : -dir;\n      }\n      const s1 = String(vx);\n      const s2 = String(vy);\n      if (s1 === s2) return 0;\n      return s1 > s2 ? dir : -dir;\n    });\n    return a;\n  }, [filtered, sortKey, sortDir]);\n\n  const total = sorted.length;\n  const totalPages = Math.max(1, Math.ceil(total / pageSize));\n  const safePage = Math.min(Math.max(1, page), totalPages);\n\n  const pageRows = useMemo(() => {\n    const start = (safePage - 1) * pageSize;\n    return sorted.slice(start, start + pageSize);\n  }, [sorted, safePage, pageSize]);\n\n  const pageDocIds = pageRows.map((r) => r.doc_id);\n  const allPageSelected = pageDocIds.length > 0 && pageDocIds.every((id) => selectedIds.includes(id));\n  const anySelected = selectedIds.length > 0;\n\n  function toggleRow(id: string, checked: boolean) {\n    setSelectedIds((prev) => (checked ? Array.from(new Set([...prev, id])) : prev.filter((x) => x !== id)));\n  }\n\n  function toggleSelectAllOnPage(checked: boolean) {\n    setSelectedIds((prev) => {\n      if (!checked) return prev.filter((id) => !pageDocIds.includes(id));\n      return Array.from(new Set([...prev, ...pageDocIds]));\n    });\n  }\n\n  function scanBadge(scanStatus: string | null) {\n    const s = String(scanStatus || \"unscanned\").toLowerCase();\n    const cls =\n      s === \"clean\"\n        ? \"border-emerald-500/25 bg-emerald-500/10 text-emerald-100\"\n        : s === \"pending\" || s === \"queued\" || s === \"running\"\n        ? \"border-amber-500/25 bg-amber-500/10 text-amber-100\"\n        : s === \"infected\" || s === \"failed\" || s === \"quarantined\"\n        ? \"border-rose-500/25 bg-rose-500/10 text-rose-100\"\n        : \"ui-badge\";\n    return <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-[11px] ${cls}`}>{s}</span>;\n  }\n\n  function toggleSort(k: SortKey) {\n    if (k === sortKey) {\n      const nextDir: SortDir = sortDir === \"asc\" ? \"desc\" : \"asc\";\n      syncUrl({ docSort: k, docDir: nextDir, docPage: 1 });\n      return;\n    }\n    const nextDir: SortDir = k === \"doc_title\" || k === \"status\" ? \"asc\" : \"desc\";\n    syncUrl({ docSort: k, docDir: nextDir, docPage: 1 });\n  }\n\n  return (\n    <div className=\"glass-card-strong mt-4 rounded-2xl\">\n      <div className=\"flex flex-col gap-3 p-4 md:flex-row md:items-end md:justify-between\">\n        <div className=\"flex flex-col gap-2\">\n          <div className=\"text-xs text-white/60\">Search</div>\n          <input\n            value={q}\n            onChange={(e) => {\n              syncUrl({ docQ: e.target.value, docPage: 1 });\n            }}\n            placeholder=\"title, alias, doc id\"\n            className=\"w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none md:w-[320px]\"\n          />\n        </div>\n        <div className=\"flex flex-wrap items-center gap-3 text-xs text-white/60\">\n          <div>Rows: <span className=\"text-white\">{total}</span></div>\n          {showDelete ? (\n            <button\n              type=\"button\"\n              disabled={!anySelected || isPending}\n              className=\"btn-base btn-danger rounded-lg px-3 py-1.5 text-xs disabled:opacity-40\"\n              onClick={() => {\n                if (!anySelected) return;\n                const confirmText = window.prompt(`Type DELETE ${selectedIds.length} to confirm bulk deletion.`);\n                if (confirmText !== `DELETE ${selectedIds.length}`) return;\n                const fd = new FormData();\n                fd.set(\"docIds\", JSON.stringify(selectedIds));\n                startTransition(() => bulkDeleteDocsAction(fd));\n                setSelectedIds([]);\n              }}\n            >\n              {isPending ? \"Deleting...\" : `Delete selected (${selectedIds.length})`}\n            </button>\n          ) : null}\n          <label className=\"flex items-center gap-2\">\n            <span>Page size</span>\n            <select\n              value={pageSize}\n              onChange={(e) => {\n                const next = Number(e.target.value);\n                syncUrl({ docPageSize: next, docPage: 1 });\n              }}\n              className=\"rounded-lg border border-white/20 bg-black/20 px-2 py-1 text-white\"\n            >\n              {[10, 25, 50, 100].map((n) => (\n                <option key={n} value={n}>{n}</option>\n              ))}\n            </select>\n          </label>\n        </div>\n      </div>\n\n      <div className=\"max-h-[560px] overflow-auto border-t border-white/10\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"sticky top-0 bg-[#10192b]/95 backdrop-blur\">\n            <tr>\n              {showDelete ? (\n                <th className=\"px-3 py-3 text-left\">\n                  <input\n                    type=\"checkbox\"\n                    aria-label=\"Select all documents on page\"\n                    checked={allPageSelected}\n                    onChange={(e) => toggleSelectAllOnPage(e.target.checked)}\n                  />\n                </th>\n              ) : null}\n              <th className=\"px-4 py-3 text-left\"><SortButton label=\"Doc name\" active={sortKey === \"doc_title\"} dir={sortDir} onClick={() => toggleSort(\"doc_title\")} /></th>\n              <th className=\"px-4 py-3 text-left text-xs text-white/70\">Scan</th>\n              <th className=\"px-4 py-3 text-right\"><SortButton label=\"Total views\" active={sortKey === \"total_views\"} dir={sortDir} onClick={() => toggleSort(\"total_views\")} /></th>\n              <th className=\"px-4 py-3 text-left\"><SortButton label=\"Last viewed\" active={sortKey === \"last_view\"} dir={sortDir} onClick={() => toggleSort(\"last_view\")} /></th>\n              <th className=\"px-4 py-3 text-right\"><SortButton label=\"Active shares\" active={sortKey === \"active_shares\"} dir={sortDir} onClick={() => toggleSort(\"active_shares\")} /></th>\n              <th className=\"px-4 py-3 text-left\"><SortButton label=\"Expiration date\" active={sortKey === \"alias_expires_at\"} dir={sortDir} onClick={() => toggleSort(\"alias_expires_at\")} /></th>\n              <th className=\"px-4 py-3 text-left\"><SortButton label=\"Status\" active={sortKey === \"status\"} dir={sortDir} onClick={() => toggleSort(\"status\")} /></th>\n              {showDelete ? <th className=\"px-4 py-3 text-right text-xs text-white/70\">Actions</th> : null}\n            </tr>\n          </thead>\n          <tbody>\n            {pageRows.length === 0 ? (\n              <tr><td colSpan={showDelete ? 9 : 7} className=\"px-4 py-10 text-white/60\">No documents found.</td></tr>\n            ) : (\n              pageRows.map((r) => {\n                const st = statusFor(r);\n                return (\n                  <tr key={r.doc_id} className=\"border-t border-white/10 hover:bg-white/[0.03]\">\n                    {showDelete ? (\n                      <td className=\"px-3 py-3\">\n                        <input\n                          type=\"checkbox\"\n                          aria-label={`Select ${r.doc_title || r.doc_id}`}\n                          checked={selectedIds.includes(r.doc_id)}\n                          onChange={(e) => toggleRow(r.doc_id, e.target.checked)}\n                        />\n                      </td>\n                    ) : null}\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex flex-col gap-1\">\n                        <Link href={`/admin/docs/${r.doc_id}`} className=\"text-white hover:underline\" title=\"Open per-document detail\">\n                          {r.doc_title || \"Untitled\"}\n                        </Link>\n                        <div className=\"flex flex-wrap items-center gap-2 text-xs text-white/60\">\n                          <span className=\"font-mono\">{r.doc_id}</span>\n                          {r.alias ? (\n                            <Link href={`/d/${r.alias}`} target=\"_blank\" className=\"text-cyan-200 hover:underline\">/d/{r.alias}</Link>\n                          ) : null}\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">{scanBadge(r.scan_status)}</td>\n                    <td className=\"px-4 py-3 text-right text-white/90\">{r.total_views ?? 0}</td>\n                    <td className=\"px-4 py-3 text-white/80\">{fmtDate(r.last_view)}</td>\n                    <td className=\"px-4 py-3 text-right text-white/90\">{r.active_shares ?? 0}</td>\n                    <td className=\"px-4 py-3 text-white/80\">{fmtDate(r.alias_expires_at)}</td>\n                    <td className=\"px-4 py-3\"><Badge label={st.label} tone={st.tone} /></td>\n                    {showDelete ? (\n                      <td className=\"px-4 py-3 text-right\">\n                        <DeleteDocForm docId={r.doc_id} title={r.doc_title || r.alias || r.doc_id} action={deleteDocAction} />\n                      </td>\n                    ) : null}\n                  </tr>\n                );\n              })\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"flex flex-col gap-2 border-t border-white/10 p-4 text-xs text-white/60 md:flex-row md:items-center md:justify-between\">\n        <div>Page <span className=\"text-white\">{safePage}</span> / <span className=\"text-white\">{totalPages}</span></div>\n        <div className=\"flex items-center gap-2\">\n          <button type=\"button\" onClick={() => syncUrl({ docPage: 1 })} disabled={safePage <= 1} className=\"btn-base btn-secondary rounded-lg px-2 py-1 disabled:opacity-40\">First</button>\n          <button type=\"button\" onClick={() => syncUrl({ docPage: Math.max(1, safePage - 1) })} disabled={safePage <= 1} className=\"btn-base btn-secondary rounded-lg px-2 py-1 disabled:opacity-40\">Prev</button>\n          <button type=\"button\" onClick={() => syncUrl({ docPage: Math.min(totalPages, safePage + 1) })} disabled={safePage >= totalPages} className=\"btn-base btn-secondary rounded-lg px-2 py-1 disabled:opacity-40\">Next</button>\n          <button type=\"button\" onClick={() => syncUrl({ docPage: totalPages })} disabled={safePage >= totalPages} className=\"btn-base btn-secondary rounded-lg px-2 py-1 disabled:opacity-40\">Last</button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\UploadPanel.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":272,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7655,7658],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7655,7658],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":272,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7690,7693],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7690,7693],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":311,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":311,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9156,9159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9156,9159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":311,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":311,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9190,9193],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9190,9193],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":343,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":343,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9986,9989],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9986,9989],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":348,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":348,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10144,10147],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10144,10147],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\n\ntype PresignResponse =\n  | {\n      ok: true;\n      doc_id: string;\n      upload_url: string;\n      r2_key: string;\n      bucket: string;\n      expires_in: number;\n      upload_headers?: Record<string, string>;\n    }\n  | { ok: false; error: string; message?: string };\n\ntype CompleteResponse =\n  | { ok: true; doc_id: string; alias: string; view_url: string; target_url?: string }\n  | { ok: false; error: string; message?: string };\n\ntype KeyStatusResponse =\n  | { ok: true; configured: boolean; active_key_id: string | null; revoked_active: boolean }\n  | { ok: false; error: string; message?: string };\n\ntype UploadItem = {\n  id: string;\n  file: File;\n  status: \"queued\" | \"uploading\" | \"done\" | \"error\";\n  message?: string;\n  viewUrl?: string;\n  docId?: string;\n};\n\nfunction isTerminalStatus(status: UploadItem[\"status\"]): boolean {\n  return status === \"done\" || status === \"error\";\n}\n\nconst ALLOWED_EXTS = new Set([\n  \"pdf\",\n  \"doc\",\n  \"docx\",\n  \"txt\",\n  \"rtf\",\n  \"odt\",\n  \"xls\",\n  \"xlsx\",\n  \"csv\",\n  \"ppt\",\n  \"pptx\",\n  \"jpg\",\n  \"jpeg\",\n  \"png\",\n  \"gif\",\n  \"bmp\",\n  \"heic\",\n  \"zip\",\n  \"rar\",\n  \"mp3\",\n  \"wav\",\n  \"mp4\",\n  \"mov\",\n  \"avi\",\n]);\n\nconst EXECUTABLE_EXTS = new Set([\n  \"js\",\n  \"mjs\",\n  \"cjs\",\n  \"vbs\",\n  \"vbe\",\n  \"ps1\",\n  \"psm1\",\n  \"py\",\n  \"php\",\n  \"exe\",\n  \"msi\",\n  \"com\",\n  \"scr\",\n  \"dll\",\n  \"sys\",\n  \"lnk\",\n  \"pif\",\n  \"bat\",\n  \"cmd\",\n  \"jar\",\n  \"apk\",\n  \"sh\",\n  \"bin\",\n  \"docm\",\n  \"xlsm\",\n  \"pptm\",\n  \"svg\",\n]);\n\nconst ACCEPT_ATTR =\n  \".pdf,.doc,.docx,.txt,.rtf,.odt,.xls,.xlsx,.csv,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.bmp,.heic,.zip,.rar,.mp3,.wav,.mp4,.mov,.avi\";\n\nfunction extOf(name: string): string {\n  const n = String(name || \"\").trim().toLowerCase();\n  const idx = n.lastIndexOf(\".\");\n  return idx >= 0 ? n.slice(idx + 1) : \"\";\n}\n\nfunction guessMimeFromFilename(name: string): string {\n  const ext = extOf(name);\n  const map: Record<string, string> = {\n    pdf: \"application/pdf\",\n    doc: \"application/msword\",\n    docx: \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    txt: \"text/plain\",\n    rtf: \"application/rtf\",\n    odt: \"application/vnd.oasis.opendocument.text\",\n    xls: \"application/vnd.ms-excel\",\n    xlsx: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    csv: \"text/csv\",\n    ppt: \"application/vnd.ms-powerpoint\",\n    pptx: \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n    jpg: \"image/jpeg\",\n    jpeg: \"image/jpeg\",\n    png: \"image/png\",\n    gif: \"image/gif\",\n    bmp: \"image/bmp\",\n    svg: \"image/svg+xml\",\n    heic: \"image/heic\",\n    zip: \"application/zip\",\n    rar: \"application/vnd.rar\",\n    mp3: \"audio/mpeg\",\n    wav: \"audio/wav\",\n    mp4: \"video/mp4\",\n    mov: \"video/quicktime\",\n    avi: \"video/x-msvideo\",\n  };\n  return map[ext] || \"application/octet-stream\";\n}\n\nfunction fmtBytes(n: number) {\n  if (!Number.isFinite(n)) return \"\";\n  if (n < 1024) return `${n} B`;\n  if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;\n  return `${(n / (1024 * 1024)).toFixed(2)} MB`;\n}\n\nexport default function UploadPanel({\n  canCheckEncryptionStatus,\n}: {\n  canCheckEncryptionStatus: boolean;\n}) {\n  const router = useRouter();\n  const fileInputRef = useRef<HTMLInputElement | null>(null);\n\n  const [items, setItems] = useState<UploadItem[]>([]);\n  const [busy, setBusy] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [dragOver, setDragOver] = useState(false);\n\n  const [encryptionReady, setEncryptionReady] = useState<boolean | null>(null);\n  const [encryptionMsg, setEncryptionMsg] = useState<string | null>(null);\n  const inputId = \"upload-panel-file-input\";\n\n  const queuedCount = useMemo(() => items.filter((i) => i.status === \"queued\").length, [items]);\n  const doneCount = useMemo(() => items.filter((i) => i.status === \"done\").length, [items]);\n  const errorCount = useMemo(() => items.filter((i) => i.status === \"error\").length, [items]);\n  const allowedTypeSummary =\n    \"Documents: .pdf, .doc, .docx, .txt, .rtf, .odt | Spreadsheets: .xls, .xlsx, .csv | Presentations: .ppt, .pptx | Images: .jpg, .jpeg, .png, .gif, .bmp, .heic | Archives: .zip, .rar | Audio/Video: .mp3, .wav, .mp4, .mov, .avi\";\n\n  useEffect(() => {\n    if (!canCheckEncryptionStatus) {\n      setEncryptionReady(null);\n      setEncryptionMsg(null);\n      return;\n    }\n\n    let cancelled = false;\n\n    async function loadKeyStatus() {\n      try {\n        const r = await fetch(\"/api/admin/security/keys\", { method: \"GET\" });\n        const j = (await r.json().catch(() => null)) as KeyStatusResponse | null;\n        if (cancelled) return;\n\n        if (!r.ok || !j || j.ok !== true) {\n          setEncryptionReady(false);\n          setEncryptionMsg(\"Encryption status unavailable.\");\n          return;\n        }\n\n        if (!j.configured || j.revoked_active) {\n          setEncryptionReady(false);\n          setEncryptionMsg(!j.configured ? \"Missing DOC_MASTER_KEYS\" : \"Active master key is revoked (rotate to a new key).\");\n          return;\n        }\n\n        setEncryptionReady(true);\n        setEncryptionMsg(null);\n      } catch {\n        if (cancelled) return;\n        setEncryptionReady(false);\n        setEncryptionMsg(\"Encryption status unavailable.\");\n      }\n    }\n\n    loadKeyStatus();\n    return () => {\n      cancelled = true;\n    };\n  }, [canCheckEncryptionStatus]);\n\n  function addFiles(files: FileList | File[]) {\n    const arr = Array.from(files || []);\n    const allowed = arr.filter((f) => {\n      const ext = extOf(f.name);\n      if (!ext) return false;\n      if (EXECUTABLE_EXTS.has(ext)) return false;\n      return ALLOWED_EXTS.has(ext);\n    });\n    if (arr.length && !allowed.length) {\n      setError(\"Unsupported file type. Executable file types are blocked.\");\n      return;\n    }\n    if (!allowed.length) return;\n    setError(null);\n    const nextItems = allowed.map((file) => ({\n      id: `${file.name}-${file.size}-${file.lastModified}-${crypto.randomUUID()}`,\n      file,\n      status: \"queued\" as const,\n    }));\n    setItems((prev) => {\n      const shouldReset = prev.length > 0 && prev.every((i) => isTerminalStatus(i.status));\n      return shouldReset ? nextItems : [...prev, ...nextItems];\n    });\n  }\n\n  function updateItem(id: string, patch: Partial<UploadItem>) {\n    setItems((prev) => prev.map((i) => (i.id === id ? { ...i, ...patch } : i)));\n  }\n\n  async function uploadOne(item: UploadItem) {\n    const file = item.file;\n    updateItem(item.id, { status: \"uploading\", message: undefined });\n\n    let presignJson: Extract<PresignResponse, { ok: true }> | null = null;\n\n    const abortIfStaged = async () => {\n      if (!presignJson?.doc_id) return;\n      try {\n        await fetch(\"/api/admin/upload/abort\", {\n          method: \"POST\",\n          headers: { \"content-type\": \"application/json\" },\n          body: JSON.stringify({ doc_id: presignJson.doc_id }),\n        });\n      } catch {\n        // Best-effort cleanup; upload error is still surfaced to UI.\n      }\n    };\n\n    try {\n    const presignRes = await fetch(\"/api/admin/upload/presign\", {\n      method: \"POST\",\n      headers: { \"content-type\": \"application/json\" },\n      body: JSON.stringify({\n        title: file.name,\n        filename: file.name,\n        contentType: file.type || guessMimeFromFilename(file.name),\n        sizeBytes: file.size,\n        encrypt: true,\n      }),\n    });\n\n    const presignParsed = (await presignRes.json().catch(() => null)) as PresignResponse | null;\n    if (!presignRes.ok || !presignParsed || presignParsed.ok !== true) {\n      const msg = (presignParsed as any)?.message || (presignParsed as any)?.error || `Init failed (${presignRes.status})`;\n      throw new Error(msg);\n    }\n    presignJson = presignParsed;\n\n    const uploadHeaders: Record<string, string> =\n      presignJson.upload_headers && typeof presignJson.upload_headers === \"object\"\n        ? presignJson.upload_headers\n        : {\n            \"content-type\": file.type || guessMimeFromFilename(file.name),\n            \"x-amz-meta-doc-id\": presignJson.doc_id,\n            \"x-amz-meta-orig-content-type\": file.type || guessMimeFromFilename(file.name),\n            \"x-amz-meta-orig-ext\": extOf(file.name),\n          };\n\n    const putRes = await fetch(presignJson.upload_url, {\n      method: \"PUT\",\n      headers: uploadHeaders,\n      body: file,\n    });\n    if (!putRes.ok) {\n      const txt = await putRes.text().catch(() => \"\");\n      throw new Error(`R2 upload failed (${putRes.status})${txt ? `: ${txt}` : \"\"}`);\n    }\n\n    const completeRes = await fetch(\"/api/admin/upload/complete\", {\n      method: \"POST\",\n      headers: { \"content-type\": \"application/json\" },\n      body: JSON.stringify({\n        doc_id: presignJson.doc_id,\n        title: file.name,\n        original_filename: file.name,\n        r2_bucket: presignJson.bucket,\n        r2_key: presignJson.r2_key,\n      }),\n    });\n\n    const completeJson = (await completeRes.json().catch(() => null)) as CompleteResponse | null;\n    if (!completeRes.ok || !completeJson || completeJson.ok !== true) {\n      const msg = (completeJson as any)?.message || (completeJson as any)?.error || `Finalize failed (${completeRes.status})`;\n      throw new Error(msg);\n    }\n\n    updateItem(item.id, {\n      status: \"done\",\n      docId: completeJson.doc_id,\n      viewUrl: completeJson.view_url,\n    });\n    } catch (e) {\n      await abortIfStaged();\n      throw e;\n    }\n  }\n\n  async function onUploadAll() {\n    setError(null);\n    if (encryptionReady === false) {\n      setError(encryptionMsg || \"Encryption is not configured.\");\n      return;\n    }\n    if (!items.some((i) => i.status === \"queued\")) {\n      setError(\"Add at least one supported file first.\");\n      return;\n    }\n\n    setBusy(true);\n    try {\n      const queue = items.filter((i) => i.status === \"queued\");\n      for (const item of queue) {\n        try {\n          await uploadOne(item);\n        } catch (e: any) {\n          updateItem(item.id, { status: \"error\", message: e?.message || \"Upload failed.\" });\n        }\n      }\n      router.refresh();\n    } catch (e: any) {\n      setError(e?.message || \"Upload failed.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <div className=\"rounded-xl border border-white/10 bg-white/5 p-5\">\n      <div className=\"flex items-start justify-between gap-3\">\n        <div>\n          <h2 className=\"text-lg font-semibold\">Upload documents</h2>\n          <p className=\"mt-1 text-sm text-white/60\">\n            Drag and drop one or many supported files. Document title is automatically set from filename.\n          </p>\n          <p className=\"mt-2 text-xs leading-relaxed text-white/60\">\n            Allowed types: {allowedTypeSummary}\n          </p>\n          <p className=\"mt-1 text-xs leading-relaxed text-amber-200/80\">\n            Blocked: executable, script, shortcut, and macro-enabled file types (for example .exe, .js, .ps1, .lnk, .docm).\n          </p>\n        </div>\n\n        <button\n          onClick={onUploadAll}\n          disabled={busy || queuedCount === 0 || encryptionReady === false}\n          className=\"rounded-lg border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold hover:bg-white/10 disabled:opacity-50\"\n        >\n          {busy ? \"Uploading...\" : `Upload${queuedCount > 0 ? ` (${queuedCount})` : \"\"}`}\n        </button>\n      </div>\n\n      <div className=\"mt-4\">\n        <div\n          role=\"button\"\n          tabIndex={0}\n          aria-label=\"Upload files\"\n          aria-describedby=\"upload-dropzone-help\"\n          onDragOver={(e) => {\n            e.preventDefault();\n            setDragOver(true);\n          }}\n          onDragLeave={() => setDragOver(false)}\n          onDrop={(e) => {\n            e.preventDefault();\n            setDragOver(false);\n            if (e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files);\n          }}\n          onClick={() => fileInputRef.current?.click()}\n          onKeyDown={(e) => {\n            if (e.key === \"Enter\" || e.key === \" \") {\n              e.preventDefault();\n              fileInputRef.current?.click();\n            }\n          }}\n          className={`cursor-pointer rounded-xl border-2 border-dashed px-4 py-8 text-center transition ${\n            dragOver ? \"border-sky-300 bg-sky-500/10\" : \"border-white/20 bg-black/30 hover:border-white/40\"\n          }`}\n        >\n          <div className=\"text-sm font-medium text-white\">Drop files here</div>\n          <div id=\"upload-dropzone-help\" className=\"mt-1 text-xs text-white/60\">or click to browse multiple files</div>\n          <input\n            id={inputId}\n            ref={fileInputRef}\n            type=\"file\"\n            aria-label=\"Choose files to upload\"\n            multiple\n            accept={ACCEPT_ATTR}\n            className=\"hidden\"\n            onChange={(e) => {\n              if (e.target.files?.length) addFiles(e.target.files);\n              e.currentTarget.value = \"\";\n            }}\n          />\n        </div>\n      </div>\n\n      <div className=\"mt-3 rounded-lg border border-emerald-400/10 bg-emerald-400/5 px-3 py-2 text-xs text-emerald-200/90\">\n        Documents are encrypted end-to-end (AES-256-GCM). Unencrypted upload/serve paths are disabled.\n      </div>\n\n      {canCheckEncryptionStatus && encryptionReady === false && (\n        <div role=\"status\" aria-live=\"polite\" className=\"mt-2 text-sm text-red-300\">{encryptionMsg ?? \"Encryption not configured.\"}</div>\n      )}\n\n      {error && <div role=\"alert\" aria-live=\"assertive\" className=\"mt-3 text-sm text-red-300\">{error}</div>}\n\n      {items.length > 0 ? (\n        <div className=\"mt-4 rounded-lg border border-white/10 bg-black/30 p-3 text-sm\">\n          <div className=\"mb-2 flex flex-wrap items-center gap-3 text-xs text-white/60\">\n            <span>Total: {items.length}</span>\n            <span>Done: {doneCount}</span>\n            <span>Errors: {errorCount}</span>\n          </div>\n          <div className=\"max-h-72 overflow-auto\">\n            <table className=\"w-full text-left text-xs\">\n              <thead className=\"text-white/50\">\n                <tr>\n                  <th className=\"py-1 pr-2\">File</th>\n                  <th className=\"py-1 pr-2\">Size</th>\n                  <th className=\"py-1 pr-2\">Status</th>\n                  <th className=\"py-1 pr-2\">Result</th>\n                </tr>\n              </thead>\n              <tbody>\n                {items.map((item) => (\n                  <tr key={item.id} className=\"border-t border-white/10\">\n                    <td className=\"py-2 pr-2 text-white/85\">{item.file.name}</td>\n                    <td className=\"py-2 pr-2 text-white/60\">{fmtBytes(item.file.size)}</td>\n                    <td className=\"py-2 pr-2\">\n                      {item.status === \"done\"\n                        ? \"Done\"\n                        : item.status === \"error\"\n                          ? \"Error\"\n                          : item.status === \"uploading\"\n                            ? \"Uploading...\"\n                            : \"Queued\"}\n                    </td>\n                    <td className=\"py-2 pr-2 text-white/70\">\n                      {item.status === \"error\" ? (\n                        <span className=\"text-red-300\">{item.message || \"Upload failed\"}</span>\n                      ) : item.viewUrl ? (\n                        <a href={item.viewUrl} className=\"text-sky-300 hover:underline\">\n                          Open\n                        </a>\n                      ) : (\n                        \"-\"\n                      )}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      ) : null}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\ViewerHelpfulTiles.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\ViewerUsageWidget.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\ViewsByDocTableClient.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":1,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nC:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\ViewsByDocTableClient.tsx:44:5\n  42 |     const limRaw = (sp.get(\"viewLimit\") || \"\").trim();\n  43 |     const lim = limRaw ? Number(limRaw) : null;\n> 44 |     setQ(nextQ);\n     |     ^^^^ Avoid calling setState() directly within an effect\n  45 |     setLimit(Number.isFinite(lim as number) && (lim as number) > 0 ? (lim as number) : null);\n  46 |   }, [sp]);\n  47 |","line":44,"column":5,"nodeType":null,"endLine":44,"endColumn":9},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":110,"column":13,"nodeType":"JSXOpeningElement","endLine":110,"endColumn":60},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":111,"column":13,"nodeType":"JSXOpeningElement","endLine":120,"endColumn":15},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":124,"column":13,"nodeType":"JSXOpeningElement","endLine":124,"endColumn":60},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":211,"column":21,"nodeType":"JSXOpeningElement","endLine":211,"endColumn":76}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/dashboard/ViewsByDocTableClient.tsx\n\"use client\";\n\nimport Link from \"next/link\";\nimport { useMemo, useState, useEffect } from \"react\";\nimport { usePathname, useRouter, useSearchParams } from \"next/navigation\";\nimport {\n  revokeAllSharesForDocAction,\n  disableAliasForDocAction,\n  extendAliasExpirationAction,\n  bulkRevokeAllSharesForDocsAction,\n  bulkDisableAliasesForDocsAction,\n} from \"../actions\";\n\nexport type ViewsByDocRow = {\n  doc_id: string;\n  doc_title: string | null;\n  alias: string | null;\n  views: number;\n  unique_ips: number;\n  last_view: string | null;\n};\n\nfunction fmtDate(s: string | null) {\n  if (!s) return \"-\";\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return s;\n  return d.toLocaleString();\n}\n\nexport default function ViewsByDocTableClient(props: { rows: ViewsByDocRow[] }) {\n  const sp = useSearchParams();\n  const router = useRouter();\n  const pathname = usePathname();\n\n  const [q, setQ] = useState(\"\");\n  const [limit, setLimit] = useState<number | null>(null);\n  const [selected, setSelected] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    const nextQ = (sp.get(\"viewQ\") || \"\").trim();\n    const limRaw = (sp.get(\"viewLimit\") || \"\").trim();\n    const lim = limRaw ? Number(limRaw) : null;\n    setQ(nextQ);\n    setLimit(Number.isFinite(lim as number) && (lim as number) > 0 ? (lim as number) : null);\n  }, [sp]);\n\n  const normalizedQ = q.trim().toLowerCase();\n  const filtered = useMemo(() => {\n    let out = props.rows;\n    if (normalizedQ) {\n      out = out.filter((r) => [r.doc_title ?? \"\", r.alias ?? \"\", r.doc_id].join(\" \").toLowerCase().includes(normalizedQ));\n    }\n    if (limit != null) out = out.slice(0, limit);\n    return out;\n  }, [props.rows, normalizedQ, limit]);\n\n  const filteredIds = useMemo(() => filtered.map((r) => r.doc_id), [filtered]);\n  const selectedIds = useMemo(() => Object.keys(selected).filter((k) => selected[k]), [selected]);\n  const allVisibleSelected = useMemo(() => filteredIds.length > 0 && filteredIds.every((id) => selected[id]), [filteredIds, selected]);\n  const anySelected = selectedIds.length > 0;\n\n  function toggleAllVisible(next: boolean) {\n    setSelected((prev) => {\n      const out = { ...prev };\n      for (const id of filteredIds) out[id] = next;\n      return out;\n    });\n  }\n\n  function downloadCsvForSelected() {\n    const rows = props.rows.filter((r) => selected[r.doc_id]);\n    const header = [\"doc_id\", \"doc_title\", \"alias\", \"views\", \"unique_ips\", \"last_view\"].join(\",\");\n    const lines = rows.map((r) =>\n      [r.doc_id, JSON.stringify(r.doc_title || \"\"), JSON.stringify(r.alias || \"\"), String(r.views), String(r.unique_ips), JSON.stringify(r.last_view || \"\")].join(\",\")\n    );\n    const csv = [header, ...lines].join(\"\\n\");\n    const blob = new Blob([csv], { type: \"text/csv;charset=utf-8\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `docs_export_${new Date().toISOString().slice(0, 10)}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    a.remove();\n    URL.revokeObjectURL(url);\n  }\n\n  function syncUrl(next: { viewQ?: string; viewLimit?: number | null }) {\n    const params = new URLSearchParams(sp.toString());\n    if (next.viewQ !== undefined) {\n      const v = next.viewQ.trim();\n      if (v) params.set(\"viewQ\", v);\n      else params.delete(\"viewQ\");\n    }\n    if (next.viewLimit !== undefined) {\n      if (next.viewLimit != null && next.viewLimit > 0) params.set(\"viewLimit\", String(next.viewLimit));\n      else params.delete(\"viewLimit\");\n    }\n    const hash = typeof window !== \"undefined\" ? window.location.hash : \"\";\n    const qs = params.toString();\n    router.replace(`${pathname}${qs ? `?${qs}` : \"\"}${hash}`, { scroll: false });\n  }\n\n  return (\n    <div className=\"glass-card-strong mt-4 rounded-2xl p-4\">\n      <div className=\"flex flex-col gap-3 md:flex-row md:items-end md:justify-between\">\n        <div className=\"flex flex-col gap-2 md:flex-row md:items-center\">\n          <div>\n            <label className=\"block text-xs text-white/60\">Search</label>\n            <input\n              value={q}\n              onChange={(e) => {\n                const v = e.target.value;\n                setQ(v);\n                syncUrl({ viewQ: v });\n              }}\n              placeholder=\"title, alias, doc id...\"\n              className=\"mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white placeholder:text-white/45 focus:border-cyan-300/55 focus:outline-none md:w-[360px]\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-xs text-white/60\">Show</label>\n            <select\n              value={limit == null ? \"all\" : String(limit)}\n              onChange={(e) => {\n                const v = e.target.value;\n                const nextLimit = v === \"all\" ? null : Number(v);\n                setLimit(nextLimit);\n                syncUrl({ viewLimit: nextLimit });\n              }}\n              className=\"mt-1 w-full rounded-xl border border-white/20 bg-black/20 px-3 py-2 text-sm text-white focus:border-cyan-300/55 focus:outline-none md:w-[180px]\"\n            >\n              <option value=\"all\">All</option>\n              <option value=\"5\">Top 5</option>\n              <option value=\"10\">Top 10</option>\n              <option value=\"25\">Top 25</option>\n              <option value=\"50\">Top 50</option>\n            </select>\n          </div>\n\n          <button\n            onClick={() => {\n              setQ(\"\");\n              setLimit(null);\n              syncUrl({ viewQ: \"\", viewLimit: null });\n            }}\n            className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm md:mb-[2px]\"\n          >\n            Clear\n          </button>\n        </div>\n\n        <div className=\"text-xs text-white/60\">\n          Showing <span className=\"text-white\">{filtered.length}</span> of <span className=\"text-white\">{props.rows.length}</span>\n        </div>\n      </div>\n\n      <div className=\"mt-3 overflow-hidden rounded-xl border border-white/10\">\n        <div className=\"max-h-[560px] overflow-auto\">\n          <table className=\"w-full text-sm\">\n            <thead className=\"sticky top-0 bg-[#10192b]/95 text-white/75 backdrop-blur\">\n              <tr>\n                <th className=\"w-[44px] px-4 py-3 text-left\">\n                  <input type=\"checkbox\" checked={allVisibleSelected} onChange={(e) => toggleAllVisible(e.target.checked)} aria-label=\"Select all visible documents\" />\n                </th>\n                <th className=\"px-4 py-3 text-left\">Doc</th>\n                <th className=\"px-4 py-3 text-left\">View</th>\n                <th className=\"px-4 py-3 text-right\">Views</th>\n                <th className=\"px-4 py-3 text-right\">Unique IPs</th>\n                <th className=\"px-4 py-3 text-right\">Last view</th>\n                <th className=\"px-4 py-3 text-right\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {filtered.length === 0 ? (\n                <tr><td colSpan={7} className=\"px-4 py-6 text-white/60\">No documents match your filters.</td></tr>\n              ) : (\n                filtered.map((r) => (\n                  <tr key={r.doc_id} className=\"border-t border-white/10 hover:bg-white/[0.03]\">\n                    <td className=\"px-4 py-3 align-top\">\n                      <input\n                        type=\"checkbox\"\n                        checked={!!selected[r.doc_id]}\n                        onChange={(e) => setSelected((prev) => ({ ...prev, [r.doc_id]: e.target.checked }))}\n                        aria-label={`Select ${r.doc_title || r.doc_id}`}\n                      />\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"text-white\">{r.doc_title || \"Untitled\"}</div>\n                      <div className=\"font-mono text-xs text-white/55\">{r.doc_id}</div>\n                      <div className=\"mt-1 text-xs\">\n                        <Link href={`/admin/docs/${encodeURIComponent(r.doc_id)}`} className=\"text-cyan-200 hover:underline\">\n                          Investigate\n                        </Link>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {r.alias ? (\n                        <Link href={`/d/${r.alias}`} target=\"_blank\" className=\"text-cyan-200 hover:underline\">\n                          /d/{r.alias}\n                        </Link>\n                      ) : (\n                        <span className=\"text-white/55\">-</span>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3 text-right text-white/90\">{r.views}</td>\n                    <td className=\"px-4 py-3 text-right text-white/90\">{r.unique_ips}</td>\n                    <td className=\"whitespace-nowrap px-4 py-3 text-right text-white/65\">{fmtDate(r.last_view)}</td>\n                    <td className=\"whitespace-nowrap px-4 py-3 text-right\">\n                      <div className=\"flex flex-wrap justify-end gap-2\">\n                        <button\n                          type=\"button\"\n                          onClick={async () => {\n                            const link = r.alias ? `${window.location.origin}/d/${r.alias}` : r.doc_id;\n                            await navigator.clipboard.writeText(link);\n                          }}\n                          className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs\"\n                        >\n                          Copy link\n                        </button>\n                        <form action={revokeAllSharesForDocAction}>\n                          <input type=\"hidden\" name=\"docId\" value={r.doc_id} />\n                          <button type=\"submit\" className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs\">Revoke shares</button>\n                        </form>\n                        <form action={extendAliasExpirationAction}>\n                          <input type=\"hidden\" name=\"docId\" value={r.doc_id} />\n                          <input type=\"hidden\" name=\"days\" value=\"7\" />\n                          <button type=\"submit\" className=\"btn-base btn-secondary rounded-lg px-2.5 py-1.5 text-xs\">+7d</button>\n                        </form>\n                        <form action={disableAliasForDocAction}>\n                          <input type=\"hidden\" name=\"docId\" value={r.doc_id} />\n                          <button type=\"submit\" className=\"btn-base btn-danger rounded-lg px-2.5 py-1.5 text-xs\">Disable alias</button>\n                        </form>\n                      </div>\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n\n      <div className=\"mt-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between\">\n        <div className=\"text-xs text-white/60\">Selected: <span className=\"text-white\">{selectedIds.length}</span></div>\n        <div className=\"flex flex-wrap gap-2\">\n          <form action={bulkRevokeAllSharesForDocsAction} onSubmit={(e) => { if (!anySelected) e.preventDefault(); }}>\n            <input type=\"hidden\" name=\"docIds\" value={JSON.stringify(selectedIds)} />\n            <button type=\"submit\" disabled={!anySelected} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm disabled:opacity-40\">Revoke all shares</button>\n          </form>\n          <form action={bulkDisableAliasesForDocsAction} onSubmit={(e) => { if (!anySelected) e.preventDefault(); }}>\n            <input type=\"hidden\" name=\"docIds\" value={JSON.stringify(selectedIds)} />\n            <button type=\"submit\" disabled={!anySelected} className=\"btn-base btn-danger rounded-xl px-3 py-2 text-sm disabled:opacity-40\">Disable aliases</button>\n          </form>\n          <button\n            type=\"button\"\n            disabled={!anySelected}\n            onClick={() => { if (anySelected) downloadCsvForSelected(); }}\n            className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm disabled:opacity-40\"\n          >\n            Export CSV\n          </button>\n          <button type=\"button\" onClick={() => setSelected({})} className=\"btn-base btn-secondary rounded-xl px-3 py-2 text-sm\">\n            Clear selection\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\docs\\[docId]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1775,1778],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1775,1778],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/admin/docs/[docId]/page.tsx\nimport Link from \"next/link\";\nimport { redirect, notFound } from \"next/navigation\";\nimport { sql } from \"@/lib/db\";\nimport { requireUser, roleAtLeast } from \"@/lib/authz\";\nimport Sparkline from \"@/components/Sparkline\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nasync function tableExists(fqTable: string): Promise<boolean> {\n  try {\n    const rows = (await sql`select to_regclass(${fqTable})::text as reg`) as unknown as Array<{ reg: string | null }>;\n    return !!rows?.[0]?.reg;\n  } catch {\n    return false;\n  }\n}\n\nasync function columnExists(table: string, column: string): Promise<boolean> {\n  try {\n    const rows = (await sql`\n      select 1\n      from information_schema.columns\n      where table_schema = 'public'\n        and table_name = ${table}\n        and column_name = ${column}\n      limit 1\n    `) as unknown as Array<{ \"?column?\": number }>;\n    return rows.length > 0;\n  } catch {\n    return false;\n  }\n}\n\nfunction fmtInt(n: number) {\n  try {\n    return new Intl.NumberFormat().format(n);\n  } catch {\n    return String(n);\n  }\n}\n\nfunction fmtDate(s: string | null) {\n  if (!s) return \"—\";\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return s;\n  return d.toLocaleString();\n}\n\nconst card = \"rounded-2xl border border-neutral-800 bg-neutral-950 p-4 shadow-sm\";\nconst subtle = \"text-xs text-neutral-400\";\n\nexport default async function AdminDocDetailPage({\n  params,\n}: {\n  // Next.js 16 App Router: params can be async in production builds.\n  params: Promise<{ docId: string }> | { docId: string };\n}) {\n  let u;\n  try {\n    u = await requireUser();\n  } catch {\n    redirect(\"/api/auth/signin\");\n  }\n\n  const resolvedParams = (await (params as any)) as { docId?: string };\n  const docId = resolvedParams?.docId;\n  if (!docId) notFound();\n\n  const canSeeAll = roleAtLeast(u.role, \"admin\");\n  const hasDocs = await tableExists(\"public.docs\");\n  if (!hasDocs) notFound();\n\n  const hasOwnerId = await columnExists(\"docs\", \"owner_id\");\n  const hasOrgId = await columnExists(\"docs\", \"org_id\");\n  const hasCreatedByEmail = await columnExists(\"docs\", \"created_by_email\");\n  const orgGate = hasOrgId && u.orgId ? sql`and d.org_id = ${u.orgId}::uuid` : sql``;\n  const ownerGate = !canSeeAll\n    ? hasOwnerId\n      ? hasCreatedByEmail\n        ? sql`and (d.owner_id = ${u.id}::uuid or (d.owner_id is null and lower(coalesce(d.created_by_email,'')) = lower(${u.email})))`\n        : sql`and d.owner_id = ${u.id}::uuid`\n      : hasCreatedByEmail\n        ? sql`and lower(coalesce(d.created_by_email,'')) = lower(${u.email})`\n        : sql``\n    : sql``;\n  const scopeGate = sql`${orgGate} ${ownerGate}`;\n\n  const docRows = (await sql`\n    select\n      d.id::text as id,\n      d.title::text as title,\n      d.created_at::text as created_at\n    from public.docs d\n    where d.id = ${docId}::uuid\n      ${scopeGate}\n    limit 1\n  `) as unknown as Array<{ id: string; title: string | null; created_at: string | null }>;\n\n  const doc = docRows?.[0];\n  if (!doc) notFound();\n\n  // Alias (latest)\n  const hasDocAliases = await tableExists(\"public.doc_aliases\");\n  let alias: string | null = null;\n  let aliasExpires: string | null = null;\n  let aliasActive: boolean | null = null;\n  let aliasRevokedAt: string | null = null;\n\n  if (hasDocAliases) {\n    try {\n      const rows = (await sql`\n        select alias::text as alias, expires_at::text as expires_at, is_active, revoked_at::text as revoked_at\n        from public.doc_aliases\n        where doc_id = ${docId}::uuid\n        order by created_at desc nulls last\n        limit 1\n      `) as unknown as Array<{ alias: string | null; expires_at: string | null; is_active: boolean | null; revoked_at: string | null }>;\n      alias = rows?.[0]?.alias ?? null;\n      aliasExpires = rows?.[0]?.expires_at ?? null;\n      aliasActive = rows?.[0]?.is_active ?? null;\n      aliasRevokedAt = rows?.[0]?.revoked_at ?? null;\n    } catch {\n      // ignore\n    }\n  }\n\n  // 30-day view series\n  const hasDocViewDaily = await tableExists(\"public.doc_view_daily\");\n  const hasDocViews = await tableExists(\"public.doc_views\");\n\n  let series30: Array<{ day: string; views: number; unique_ips: number }> = [];\n  let views30 = 0;\n  let views7 = 0;\n\n  if (hasDocViewDaily) {\n    try {\n      series30 = (await sql`\n        with days as (\n          select generate_series(current_date - interval '29 days', current_date, interval '1 day')::date as day\n        )\n        select\n          days.day::text as day,\n          coalesce(dvd.view_count, 0)::int as views,\n          coalesce(dvd.unique_ip_count, 0)::int as unique_ips\n        from days\n        left join public.doc_view_daily dvd\n          on dvd.date = days.day\n         and dvd.doc_id = ${docId}::uuid\n        order by 1 asc\n      `) as unknown as Array<{ day: string; views: number; unique_ips: number }>;\n    } catch {\n      series30 = [];\n    }\n  } else if (hasDocViews) {\n    // Fallback: compute per-day from raw logs.\n    try {\n      series30 = (await sql`\n        with days as (\n          select generate_series(current_date - interval '29 days', current_date, interval '1 day')::date as day\n        ),\n        agg as (\n          select\n            date_trunc('day', v.created_at)::date as day,\n            count(*)::int as views,\n            count(distinct coalesce(v.ip_hash, ''))::int as unique_ips\n          from public.doc_views v\n          where v.doc_id = ${docId}::uuid\n            and v.created_at >= (now() - interval '30 days')\n          group by 1\n        )\n        select\n          days.day::text as day,\n          coalesce(agg.views, 0)::int as views,\n          coalesce(agg.unique_ips, 0)::int as unique_ips\n        from days\n        left join agg on agg.day = days.day\n        order by 1 asc\n      `) as unknown as Array<{ day: string; views: number; unique_ips: number }>;\n    } catch {\n      series30 = [];\n    }\n  }\n\n  const sparkVals = series30.map((r) => r.views);\n  views30 = sparkVals.reduce((a, b) => a + b, 0);\n  views7 = sparkVals.slice(-7).reduce((a, b) => a + b, 0);\n\n  // Shares list + counts\n  const hasShareTokens = await tableExists(\"public.share_tokens\");\n  type ShareRow = {\n    token: string;\n    created_at: string | null;\n    expires_at: string | null;\n    revoked_at: string | null;\n    views_count: number | null;\n    max_views: number | null;\n  };\n  let shares: ShareRow[] = [];\n  let activeShares = 0;\n\n  if (hasShareTokens) {\n    try {\n      shares = (await sql`\n        select\n          st.token::text as token,\n          st.created_at::text as created_at,\n          st.expires_at::text as expires_at,\n          st.revoked_at::text as revoked_at,\n          st.views_count::int as views_count,\n          st.max_views::int as max_views\n        from public.share_tokens st\n        where st.doc_id = ${docId}::uuid\n        order by st.created_at desc nulls last\n        limit 50\n      `) as unknown as ShareRow[];\n\n      activeShares = shares.filter((s) => {\n        if (s.revoked_at) return false;\n        if (s.expires_at && new Date(s.expires_at).getTime() <= Date.now()) return false;\n        if (s.max_views && s.max_views > 0 && (s.views_count || 0) >= s.max_views) return false;\n        return true;\n      }).length;\n    } catch {\n      shares = [];\n    }\n  }\n\n  // IP breakdown (top 10) from doc_views (best-effort)\n  type IpRow = { ip_hash: string; views: number };\n  let ipRows: IpRow[] = [];\n  if (hasDocViews) {\n    try {\n      ipRows = (await sql`\n        select\n          coalesce(v.ip_hash, '')::text as ip_hash,\n          count(*)::int as views\n        from public.doc_views v\n        where v.doc_id = ${docId}::uuid\n          and v.created_at >= (now() - interval '30 days')\n        group by 1\n        order by views desc\n        limit 10\n      `) as unknown as IpRow[];\n    } catch {\n      ipRows = [];\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between gap-3\">\n        <div>\n          <div className={subtle}>Document</div>\n          <h1 className=\"text-2xl font-semibold text-neutral-100\">{doc.title || doc.id}</h1>\n          <div className=\"mt-1 text-xs text-neutral-400\">Created: {fmtDate(doc.created_at)}</div>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Link\n            className=\"rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-100 shadow-sm hover:bg-neutral-900\"\n            href=\"/admin/dashboard\"\n          >\n            ← Back\n          </Link>\n          {alias ? (\n            <Link\n              className=\"rounded-xl border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm text-neutral-100 shadow-sm hover:bg-neutral-900\"\n              href={`/d/${alias}`}\n            >\n              Open\n            </Link>\n          ) : null}\n        </div>\n      </div>\n\n      <section className=\"grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-3\">\n        <div className={card}>\n          <div className={subtle}>Views</div>\n          <div className=\"mt-1 text-2xl font-semibold text-neutral-100\">{fmtInt(views30)}</div>\n          <div className={subtle}>Last 30 days</div>\n          <div className=\"mt-2 flex items-center justify-between gap-3\">\n            <div className=\"text-sm font-medium text-neutral-200\">\n              {fmtInt(views7)} <span className=\"text-xs text-neutral-400\">/ 7d</span>\n            </div>\n            <div className=\"text-neutral-400\">\n              <Sparkline values={sparkVals} ariaLabel=\"30 day views sparkline\" />\n            </div>\n          </div>\n        </div>\n\n        <div className={card}>\n          <div className={subtle}>Alias</div>\n          <div className=\"mt-1 text-sm font-medium text-neutral-200\">{alias || \"—\"}</div>\n          <div className=\"mt-2 text-xs text-neutral-400\">\n            Expires: {fmtDate(aliasExpires)} • Active: {String(aliasActive ?? true)} • Revoked: {fmtDate(aliasRevokedAt)}\n          </div>\n        </div>\n\n        <div className={card}>\n          <div className={subtle}>Shares</div>\n          <div className=\"mt-1 text-2xl font-semibold text-neutral-100\">{fmtInt(activeShares)}</div>\n          <div className={subtle}>Active (top 50 listed)</div>\n        </div>\n      </section>\n\n      <section className={card}>\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-base font-semibold text-neutral-100\">30-day view history</h2>\n          <div className={subtle}>{hasDocViewDaily ? \"Using doc_view_daily\" : hasDocViews ? \"Using doc_views\" : \"No view tables found\"}</div>\n        </div>\n\n        <div className=\"mt-3 overflow-x-auto\">\n          <table className=\"min-w-[680px] w-full text-sm\">\n            <thead className=\"text-left text-xs text-neutral-400\">\n              <tr>\n                <th className=\"py-2 pr-4\">Day</th>\n                <th className=\"py-2 pr-4\">Views</th>\n                <th className=\"py-2 pr-4\">Unique IPs</th>\n              </tr>\n            </thead>\n            <tbody className=\"text-neutral-200\">\n              {series30.length ? (\n                series30\n                  .slice()\n                  .reverse()\n                  .map((r) => (\n                    <tr key={r.day} className=\"border-t border-neutral-800\">\n                      <td className=\"py-2 pr-4\">{r.day}</td>\n                      <td className=\"py-2 pr-4\">{fmtInt(r.views)}</td>\n                      <td className=\"py-2 pr-4\">{fmtInt(r.unique_ips)}</td>\n                    </tr>\n                  ))\n              ) : (\n                <tr className=\"border-t border-neutral-800\">\n                  <td className=\"py-3 text-xs text-neutral-400\" colSpan={3}>\n                    No data yet.\n                  </td>\n                </tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </section>\n\n      <section className=\"grid grid-cols-1 gap-3 xl:grid-cols-2\">\n        <div className={card}>\n          <h2 className=\"text-base font-semibold text-neutral-100\">Share history</h2>\n          <div className=\"mt-3 overflow-x-auto\">\n            <table className=\"min-w-[760px] w-full text-sm\">\n              <thead className=\"text-left text-xs text-neutral-400\">\n                <tr>\n                  <th className=\"py-2 pr-4\">Token</th>\n                  <th className=\"py-2 pr-4\">Created</th>\n                  <th className=\"py-2 pr-4\">Expires</th>\n                  <th className=\"py-2 pr-4\">Views</th>\n                  <th className=\"py-2 pr-4\">Max</th>\n                  <th className=\"py-2 pr-4\">Revoked</th>\n                </tr>\n              </thead>\n              <tbody className=\"text-neutral-200\">\n                {shares.length ? (\n                  shares.map((s) => (\n                    <tr key={s.token} className=\"border-t border-neutral-800\">\n                      <td className=\"py-2 pr-4 font-mono text-xs\">{s.token.slice(0, 10)}…</td>\n                      <td className=\"py-2 pr-4\">{fmtDate(s.created_at)}</td>\n                      <td className=\"py-2 pr-4\">{fmtDate(s.expires_at)}</td>\n                      <td className=\"py-2 pr-4\">{fmtInt(s.views_count ?? 0)}</td>\n                      <td className=\"py-2 pr-4\">{s.max_views ?? \"—\"}</td>\n                      <td className=\"py-2 pr-4\">{fmtDate(s.revoked_at)}</td>\n                    </tr>\n                  ))\n                ) : (\n                  <tr className=\"border-t border-neutral-800\">\n                    <td className=\"py-3 text-xs text-neutral-400\" colSpan={6}>\n                      No shares found.\n                    </td>\n                  </tr>\n                )}\n              </tbody>\n            </table>\n          </div>\n        </div>\n\n        <div className={card}>\n          <h2 className=\"text-base font-semibold text-neutral-100\">IP breakdown (30d)</h2>\n          <div className=\"mt-1 text-xs text-neutral-400\">Hashed IPs (privacy-preserving).</div>\n          <div className=\"mt-3 overflow-x-auto\">\n            <table className=\"min-w-[520px] w-full text-sm\">\n              <thead className=\"text-left text-xs text-neutral-400\">\n                <tr>\n                  <th className=\"py-2 pr-4\">IP hash</th>\n                  <th className=\"py-2 pr-4\">Views</th>\n                </tr>\n              </thead>\n              <tbody className=\"text-neutral-200\">\n                {ipRows.length ? (\n                  ipRows.map((r) => (\n                    <tr key={r.ip_hash} className=\"border-t border-neutral-800\">\n                      <td className=\"py-2 pr-4 font-mono text-xs\">{(r.ip_hash || \"—\").slice(0, 18)}…</td>\n                      <td className=\"py-2 pr-4\">{fmtInt(r.views)}</td>\n                    </tr>\n                  ))\n                ) : (\n                  <tr className=\"border-t border-neutral-800\">\n                    <td className=\"py-3 text-xs text-neutral-400\" colSpan={2}>\n                      No data yet.\n                    </td>\n                  </tr>\n                )}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      </section>\n\n      <div className=\"text-xs text-neutral-400\">\n        Note: download counts are not tracked separately yet; current page shows view/access activity only.\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[572,575],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[572,575],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { redirect } from \"next/navigation\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/auth\";\nimport AdminShell from \"./_components/AdminShell\";\nimport { getBillingFlags } from \"@/lib/settings\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nexport default async function AdminLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  const session = await getServerSession(authOptions);\n\n  // Require login for all /admin routes\n  if (!session?.user) redirect(\"/signin\");\n\n  const role = (session.user as any)?.role as string | undefined;\n  const isOwner = role === \"owner\";\n  const billingFlags = await getBillingFlags();\n\n  return (\n    <AdminShell email={session.user.email} isOwner={isOwner} showPricingUi={billingFlags.flags.pricingUiEnabled}>\n      {children}\n    </AdminShell>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\upgrade\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\admin\\upload\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\abuse\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1073,1076],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1073,1076],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2154,2157],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2154,2157],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2194,2197],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2194,2197],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2225,2228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2225,2228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2352,2355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2352,2355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2843,2846],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2843,2846],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2897,2900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2897,2900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":100,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3609,3612],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3609,3612],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3763,3766],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3763,3766],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3810,3813],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3810,3813],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3864,3867],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3864,3867],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5319,5322],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5319,5322],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5366,5369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5366,5369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":190,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6526,6529],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6526,6529],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6769,6772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6769,6772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":200,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":200,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6823,6826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6823,6826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":224,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":224,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7542,7545],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7542,7545],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":231,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7692,7695],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7692,7695],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":232,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7735,7738],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7735,7738],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":232,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":232,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7764,7767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7764,7767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { sql } from \"@/lib/db\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { clientIpKey, logSecurityEvent, enforceGlobalApiRateLimit } from \"@/lib/securityTelemetry\";\nimport { createQuarantineOverride, revokeActiveQuarantineOverride } from \"@/lib/quarantineOverride\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\ntype Action =\n  | { action: \"disable_doc\"; docId: string; reason?: string | null; reportId?: string | null }\n  | { action: \"quarantine_doc\"; docId: string; reason?: string | null; reportId?: string | null }\n  | { action: \"override_quarantine\"; docId: string; reason?: string | null; ttlMinutes?: number; confirm: string }\n  | { action: \"revoke_override\"; docId: string; reason?: string | null; confirm: string }\n  | { action: \"revoke_share\"; token: string; reason?: string | null; reportId?: string | null }\n  | { action: \"close_report\"; reportId: string; notes?: string | null };\n\nfunction norm(s: any): string {\n  return String(s || \"\").trim();\n}\n\nexport async function POST(req: NextRequest) {\n  let user;\n  try {\n    user = await requirePermission(\"abuse.manage\");\n  } catch (e: unknown) {\n    const msg = e instanceof Error ? e.message : \"FORBIDDEN\";\n    const status = msg === \"UNAUTHENTICATED\" ? 401 : 403;\n    return NextResponse.json({ ok: false, error: status === 401 ? \"UNAUTHENTICATED\" : \"FORBIDDEN\" }, { status });\n  }\n\n  const ipInfo = clientIpKey(req);\n\n  // Throttle admin abuse actions (safety)\n  const rl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:admin_abuse_actions\",\n    limit: Number(process.env.RATE_LIMIT_ADMIN_ABUSE_PER_MIN || 120),\n    windowSeconds: 60,\n  });\n  if (!rl.ok) {\n    return NextResponse.json(\n      { ok: false, error: \"RATE_LIMIT\" },\n      { status: rl.status, headers: { \"Retry-After\": String(rl.retryAfterSeconds) } }\n    );\n  }\n\n  let body: Action;\n  try {\n    body = (await req.json()) as Action;\n  } catch {\n    return NextResponse.json({ ok: false, error: \"BAD_JSON\" }, { status: 400 });\n  }\n\n  const act = (body as any)?.action;\n  const reason = (body as any)?.reason ? String((body as any).reason).slice(0, 500) : null;\n\n  if (act === \"disable_doc\" || act === \"quarantine_doc\") {\n    const docId = norm((body as any).docId);\n    if (!docId) return NextResponse.json({ ok: false, error: \"MISSING_DOC\" }, { status: 400 });\n\n    await sql`\n      update public.docs\n      set\n        moderation_status = ${act === \"disable_doc\" ? \"disabled\" : \"quarantined\"},\n        scan_status = ${act === \"quarantine_doc\" ? \"quarantined\" : sql`scan_status`},\n        disabled_at = now(),\n        disabled_by = ${user.id}::uuid,\n        disabled_reason = ${reason}\n      where id = ${docId}::uuid\n    `;\n\n    if ((body as any).reportId) {\n      const reportId = norm((body as any).reportId);\n      if (reportId) {\n        await sql`\n          update public.abuse_reports\n          set status = 'reviewing'\n          where id = ${reportId}::uuid\n        `;\n      }\n    }\n\n    await logSecurityEvent({\n      type: act === \"disable_doc\" ? \"doc_disabled\" : \"doc_quarantined\",\n      severity: \"high\",\n      ip: ipInfo.ip,\n      docId,\n      scope: \"admin_abuse\",\n      message: reason || \"Admin moderation action\",\n    });\n    await appendImmutableAudit({\n      streamKey: `admin:${user.id}`,\n      action: \"admin.abuse_doc_action\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      docId,\n      ipHash: ipInfo.ipHash,\n      payload: { action: act, reason, reportId: (body as any).reportId ?? null },\n    });\n\n    return NextResponse.json({ ok: true });\n  }\n\n  if (act === \"override_quarantine\") {\n    const docId = norm((body as any).docId);\n    const confirm = norm((body as any).confirm);\n    const ttlMinutes = Number((body as any).ttlMinutes ?? 30);\n    if (!docId) return NextResponse.json({ ok: false, error: \"MISSING_DOC\" }, { status: 400 });\n    if (confirm !== `OVERRIDE ${docId}`) {\n      return NextResponse.json(\n        { ok: false, error: \"CONFIRMATION_REQUIRED\", message: `confirm must equal \"OVERRIDE ${docId}\"` },\n        { status: 400 }\n      );\n    }\n\n    const created = await createQuarantineOverride({\n      docId,\n      actorUserId: user.id,\n      reason,\n      ttlMinutes,\n    });\n    if (!created) return NextResponse.json({ ok: false, error: \"OVERRIDE_CREATE_FAILED\" }, { status: 500 });\n\n    await logSecurityEvent({\n      type: \"quarantine_override_granted\",\n      severity: \"high\",\n      ip: ipInfo.ip,\n      docId,\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      scope: \"admin_abuse\",\n      message: reason || \"Temporary quarantine override granted\",\n      meta: { overrideId: created.id, expiresAt: created.expires_at, ttlMinutes },\n    });\n    await appendImmutableAudit({\n      streamKey: `doc:${docId}`,\n      action: \"doc.quarantine_override_granted\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      docId,\n      ipHash: ipInfo.ipHash,\n      payload: { reason, ttlMinutes, overrideId: created.id, expiresAt: created.expires_at },\n    });\n\n    return NextResponse.json({ ok: true, override_id: created.id, expires_at: created.expires_at });\n  }\n\n  if (act === \"revoke_override\") {\n    const docId = norm((body as any).docId);\n    const confirm = norm((body as any).confirm);\n    if (!docId) return NextResponse.json({ ok: false, error: \"MISSING_DOC\" }, { status: 400 });\n    if (confirm !== `REVOKE_OVERRIDE ${docId}`) {\n      return NextResponse.json(\n        { ok: false, error: \"CONFIRMATION_REQUIRED\", message: `confirm must equal \"REVOKE_OVERRIDE ${docId}\"` },\n        { status: 400 }\n      );\n    }\n\n    const revoked = await revokeActiveQuarantineOverride({\n      docId,\n      actorUserId: user.id,\n      reason,\n    });\n    await logSecurityEvent({\n      type: \"quarantine_override_revoked\",\n      severity: \"high\",\n      ip: ipInfo.ip,\n      docId,\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      scope: \"admin_abuse\",\n      message: reason || \"Quarantine override revoked\",\n      meta: { revoked },\n    });\n    await appendImmutableAudit({\n      streamKey: `doc:${docId}`,\n      action: \"doc.quarantine_override_revoked\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      docId,\n      ipHash: ipInfo.ipHash,\n      payload: { reason, revoked },\n    });\n    return NextResponse.json({ ok: true, revoked });\n  }\n\n  if (act === \"revoke_share\") {\n    const token = norm((body as any).token);\n    if (!token) return NextResponse.json({ ok: false, error: \"MISSING_TOKEN\" }, { status: 400 });\n\n    await sql`\n      update public.share_tokens\n      set revoked_at = now()\n      where token = ${token}\n    `;\n\n    if ((body as any).reportId) {\n      const reportId = norm((body as any).reportId);\n      if (reportId) {\n        await sql`\n          update public.abuse_reports\n          set status = 'reviewing'\n          where id = ${reportId}::uuid\n        `;\n      }\n    }\n\n    await logSecurityEvent({\n      type: \"share_revoked\",\n      severity: \"medium\",\n      ip: ipInfo.ip,\n      scope: \"admin_abuse\",\n      message: reason || \"Share revoked via abuse workflow\",\n      meta: { token: token.slice(0, 12) },\n    });\n    await appendImmutableAudit({\n      streamKey: `admin:${user.id}`,\n      action: \"admin.abuse_revoke_share\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      ipHash: ipInfo.ipHash,\n      payload: { tokenPrefix: token.slice(0, 12), reason, reportId: (body as any).reportId ?? null },\n    });\n\n    return NextResponse.json({ ok: true });\n  }\n\n  if (act === \"close_report\") {\n    const reportId = norm((body as any).reportId);\n    const notes = (body as any).notes ? String((body as any).notes).slice(0, 2000) : null;\n    if (!reportId) return NextResponse.json({ ok: false, error: \"MISSING_REPORT\" }, { status: 400 });\n\n    await sql`\n      update public.abuse_reports\n      set\n        status = 'closed',\n        admin_notes = ${notes},\n        closed_at = now(),\n        closed_by = ${user.id}::uuid\n      where id = ${reportId}::uuid\n    `;\n\n    await logSecurityEvent({\n      type: \"abuse_report_closed\",\n      severity: \"low\",\n      ip: ipInfo.ip,\n      scope: \"admin_abuse\",\n      message: \"Abuse report closed\",\n      meta: { reportId },\n    });\n    await appendImmutableAudit({\n      streamKey: `admin:${user.id}`,\n      action: \"admin.abuse_close_report\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      ipHash: ipInfo.ipHash,\n      payload: { reportId, notes },\n    });\n\n    return NextResponse.json({ ok: true });\n  }\n\n  return NextResponse.json({ ok: false, error: \"UNKNOWN_ACTION\" }, { status: 400 });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\analytics\\aggregate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\audit\\export\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[365,368],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[365,368],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2386,2389],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2386,2389],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":74,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":74,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2646,2649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2646,2649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2906,2909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2906,2909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3138,3141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3138,3141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3167,3170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3167,3170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":98,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3425,3428],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3425,3428],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/api/admin/audit/export/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest } from \"next/server\";\nimport { sql } from \"@/lib/db\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { getPlanForUser } from \"@/lib/monetization\";\n\ntype ExportType = \"audit\" | \"access\" | \"views\";\n\nfunction csvEscape(v: any): string {\n  if (v === null || v === undefined) return \"\";\n  const s = String(v);\n  if (/[\",\\r\\n]/.test(s)) return `\"${s.replace(/\"/g, '\"\"')}\"`;\n  return s;\n}\n\nfunction parseIntParam(raw: string | null, fallback: number, min: number, max: number): number {\n  const n = Number(raw);\n  if (!Number.isFinite(n)) return fallback;\n  const i = Math.floor(n);\n  return Math.max(min, Math.min(max, i));\n}\n\n// NOTE: Our DB client (Neon `sql`) is a *tagged template* function.\n// That means we can't pass a raw string query into it without fighting types.\n// For export we keep the query fully static (by `type`) and parameterize values.\n\n// All current audit/access/views tables use `created_at`.\n// We keep it static so the query stays fully typed and parameterized.\n\nexport async function GET(req: NextRequest) {\n  let userId: string | null = null;\n  try {\n    const u = await requirePermission(\"audit.export\");\n    userId = u.id;\n  } catch {\n    return new Response(\"Forbidden\", { status: 403 });\n  }\n\n  if (userId) {\n    const plan = await getPlanForUser(userId);\n    if (!plan.allowAuditExport) {\n      return new Response(\"Audit export requires a plan with export entitlement.\", { status: 403 });\n    }\n  }\n\n  const url = new URL(req.url);\n  const type = (url.searchParams.get(\"type\") || \"audit\").toLowerCase() as ExportType;\n  const days = parseIntParam(url.searchParams.get(\"days\"), 30, 1, 365);\n  const limit = parseIntParam(url.searchParams.get(\"limit\"), 20000, 1, 50000);\n\n  const map: Record<ExportType, { table: string; filename: string }> = {\n    audit: { table: \"doc_audit\", filename: \"audit_events.csv\" },\n    access: { table: \"doc_access_log\", filename: \"access_logs.csv\" },\n    views: { table: \"doc_views\", filename: \"views.csv\" },\n  };\n\n  const picked = map[type] ?? map.audit;\n\n  // Build query (static per table) so we can keep using the tagged template.\n  // We assume these tables have `created_at` (true for our schemas).\n  // If a table is missing the column, we'll surface a clean error.\n  let rows: any[] = [];\n  try {\n    if (type === \"audit\") {\n      rows = (await sql`\n        select *\n        from public.doc_audit\n        where created_at >= (now() - (${days}::int * interval '1 day'))\n        order by created_at desc\n        limit ${limit}\n      `) as any[];\n    } else if (type === \"access\") {\n      rows = (await sql`\n        select *\n        from public.doc_access_log\n        where created_at >= (now() - (${days}::int * interval '1 day'))\n        order by created_at desc\n        limit ${limit}\n      `) as any[];\n    } else {\n      rows = (await sql`\n        select *\n        from public.doc_views\n        where created_at >= (now() - (${days}::int * interval '1 day'))\n        order by created_at desc\n        limit ${limit}\n      `) as any[];\n    }\n  } catch (err: any) {\n    return new Response(`Export failed: ${err?.message || \"unknown error\"}`, { status: 500 });\n  }\n\n  const cols = rows?.[0] ? Object.keys(rows[0]) : [];\n  const header = cols.join(\",\");\n  const lines = rows.map((r) => cols.map((c) => csvEscape((r as any)[c])).join(\",\"));\n  const csv = [header, ...lines].join(\"\\n\");\n\n  const stamp = new Date().toISOString().slice(0, 10);\n  const filename = `${stamp}_${picked.filename}`;\n\n  return new Response(csv, {\n    status: 200,\n    headers: {\n      \"content-type\": \"text/csv; charset=utf-8\",\n      \"content-disposition\": `attachment; filename=\"${filename}\"`,\n      \"cache-control\": \"no-store\",\n    },\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\checkout\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3677,3680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3677,3680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { sql } from \"@/lib/db\";\nimport { ensureStripeCustomer, stripeApi } from \"@/lib/stripeClient\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nfunction baseUrl(req: NextRequest): string {\n  const configured =\n    String(process.env.APP_URL || \"\").trim() ||\n    String(process.env.NEXTAUTH_URL || \"\").trim() ||\n    (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"\");\n  if (configured) return configured.replace(/\\/+$/, \"\");\n  return new URL(req.url).origin.replace(/\\/+$/, \"\");\n}\n\nfunction getProPriceId(): string {\n  const ids = String(process.env.STRIPE_PRO_PRICE_IDS || \"\")\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n  if (!ids.length) throw new Error(\"STRIPE_PRO_PRICE_IDS is not configured\");\n  return ids[0];\n}\n\nasync function readExistingCustomerId(userId: string): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select stripe_customer_id::text as stripe_customer_id\n      from public.users\n      where id = ${userId}::uuid\n      limit 1\n    `) as unknown as Array<{ stripe_customer_id: string | null }>;\n    return rows?.[0]?.stripe_customer_id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function persistCustomerId(userId: string, customerId: string): Promise<void> {\n  try {\n    await sql`\n      update public.users\n      set stripe_customer_id = ${customerId}\n      where id = ${userId}::uuid\n    `;\n  } catch {\n    // optional column in older schemas\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_CHECKOUT_MS\", 15_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const u = await requirePermission(\"billing.manage\");\n        const existingCustomerId = await readExistingCustomerId(u.id);\n        const customerId = await ensureStripeCustomer({\n          userId: u.id,\n          email: u.email,\n          existingCustomerId,\n        });\n        if (customerId !== existingCustomerId) {\n          await persistCustomerId(u.id, customerId);\n        }\n\n        const origin = baseUrl(req);\n        const successUrl = `${origin}/admin/billing?checkout=success`;\n        const cancelUrl = `${origin}/admin/billing?checkout=canceled`;\n        const priceId = getProPriceId();\n\n        const session = await stripeApi(\"checkout/sessions\", {\n          method: \"POST\",\n          body: {\n            mode: \"subscription\",\n            customer: customerId,\n            \"line_items[0][price]\": priceId,\n            \"line_items[0][quantity]\": \"1\",\n            success_url: successUrl,\n            cancel_url: cancelUrl,\n            \"metadata[user_id]\": u.id,\n          },\n        });\n\n        const checkoutUrl = String(session?.url || \"\").trim();\n        if (!checkoutUrl) throw new Error(\"Stripe checkout did not return a session URL\");\n\n        await appendImmutableAudit({\n          streamKey: `user:${u.id}:billing`,\n          action: \"billing.checkout_session.created\",\n          actorUserId: u.id,\n          orgId: u.orgId ?? null,\n          payload: {\n            customerId,\n            priceId,\n          },\n        });\n\n        return NextResponse.redirect(checkoutUrl, { status: 303 });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.redirect(new URL(\"/admin/billing?error=ENV_MISCONFIGURED\", req.url), { status: 303 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"billing_checkout_timeout\",\n        severity: \"high\",\n        scope: \"billing\",\n        message: \"Checkout session creation exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.redirect(new URL(\"/admin/billing?error=TIMEOUT\", req.url), { status: 303 });\n    }\n    const msg = String(e?.message || e || \"checkout_failed\");\n    const safeError =\n      msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\"\n        ? \"FORBIDDEN\"\n        : msg === \"STRIPE_PRO_PRICE_IDS is not configured\"\n          ? \"ENV_MISCONFIGURED\"\n          : \"CHECKOUT_FAILED\";\n    await logSecurityEvent({\n      type: \"billing_checkout_failed\",\n      severity: \"medium\",\n      scope: \"billing\",\n      message: \"Stripe checkout session creation failed\",\n      meta: { code: safeError },\n    });\n    return NextResponse.redirect(new URL(`/admin/billing?error=${encodeURIComponent(safeError)}`, req.url), { status: 303 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\invoices\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2285,2288],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2285,2288],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3009,3012],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3009,3012],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { sql } from \"@/lib/db\";\nimport { ensureStripeCustomer, stripeApi } from \"@/lib/stripeClient\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nasync function readExistingCustomerId(userId: string): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select stripe_customer_id::text as stripe_customer_id\n      from public.users\n      where id = ${userId}::uuid\n      limit 1\n    `) as unknown as Array<{ stripe_customer_id: string | null }>;\n    return rows?.[0]?.stripe_customer_id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function persistCustomerId(userId: string, customerId: string): Promise<void> {\n  try {\n    await sql`\n      update public.users\n      set stripe_customer_id = ${customerId}\n      where id = ${userId}::uuid\n    `;\n  } catch {\n    // optional column in older schemas\n  }\n}\n\nexport async function GET(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_INVOICES_MS\", 15_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const u = await requirePermission(\"billing.manage\");\n        const limitRaw = Number(new URL(req.url).searchParams.get(\"limit\") || 20);\n        const limit = Math.max(1, Math.min(100, Number.isFinite(limitRaw) ? Math.floor(limitRaw) : 20));\n\n        const existingCustomerId = await readExistingCustomerId(u.id);\n        const customerId = await ensureStripeCustomer({\n          userId: u.id,\n          email: u.email,\n          existingCustomerId,\n        });\n        if (customerId !== existingCustomerId) {\n          await persistCustomerId(u.id, customerId);\n        }\n\n        const invoices = await stripeApi(`invoices?customer=${encodeURIComponent(customerId)}&limit=${limit}`, {\n          method: \"GET\",\n        });\n        const items = Array.isArray(invoices?.data) ? invoices.data : [];\n\n        return NextResponse.json({\n          ok: true,\n          customerId,\n          invoices: items.map((inv: any) => ({\n            id: String(inv?.id || \"\"),\n            number: String(inv?.number || \"\"),\n            status: String(inv?.status || \"\"),\n            amountDue: Number(inv?.amount_due || 0),\n            amountPaid: Number(inv?.amount_paid || 0),\n            currency: String(inv?.currency || \"usd\").toUpperCase(),\n            hostedInvoiceUrl: inv?.hosted_invoice_url ? String(inv.hosted_invoice_url) : null,\n            invoicePdf: inv?.invoice_pdf ? String(inv.invoice_pdf) : null,\n            periodStart: Number(inv?.period_start || 0),\n            periodEnd: Number(inv?.period_end || 0),\n            created: Number(inv?.created || 0),\n          })),\n        });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.json({ ok: false, error: \"ENV_MISCONFIGURED\" }, { status: 503 });\n    }\n    if (isRouteTimeoutError(e)) {\n      return NextResponse.json({ ok: false, error: \"TIMEOUT\" }, { status: 504 });\n    }\n    const msg = String(e?.message || e || \"failed\");\n    if (msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\") {\n      return NextResponse.json({ ok: false, error: \"FORBIDDEN\" }, { status: 403 });\n    }\n    return NextResponse.json({ ok: false, error: \"BILLING_UPSTREAM_ERROR\" }, { status: 502 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\portal\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3021,3024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3021,3024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { sql } from \"@/lib/db\";\nimport { ensureStripeCustomer, stripeApi } from \"@/lib/stripeClient\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nfunction baseUrl(req: NextRequest): string {\n  const configured =\n    String(process.env.APP_URL || \"\").trim() ||\n    String(process.env.NEXTAUTH_URL || \"\").trim() ||\n    (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"\");\n  if (configured) return configured.replace(/\\/+$/, \"\");\n  return new URL(req.url).origin.replace(/\\/+$/, \"\");\n}\n\nasync function readExistingCustomerId(userId: string): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select stripe_customer_id::text as stripe_customer_id\n      from public.users\n      where id = ${userId}::uuid\n      limit 1\n    `) as unknown as Array<{ stripe_customer_id: string | null }>;\n    return rows?.[0]?.stripe_customer_id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function persistCustomerId(userId: string, customerId: string): Promise<void> {\n  try {\n    await sql`\n      update public.users\n      set stripe_customer_id = ${customerId}\n      where id = ${userId}::uuid\n    `;\n  } catch {\n    // optional column in older schemas\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_PORTAL_MS\", 15_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const u = await requirePermission(\"billing.manage\");\n        const existingCustomerId = await readExistingCustomerId(u.id);\n        const customerId = await ensureStripeCustomer({\n          userId: u.id,\n          email: u.email,\n          existingCustomerId,\n        });\n        if (customerId !== existingCustomerId) {\n          await persistCustomerId(u.id, customerId);\n        }\n\n        const returnUrl = `${baseUrl(req)}/admin/billing`;\n        const portal = await stripeApi(\"billing_portal/sessions\", {\n          method: \"POST\",\n          body: {\n            customer: customerId,\n            return_url: returnUrl,\n          },\n        });\n\n        const portalUrl = String(portal?.url || \"\").trim();\n        if (!portalUrl) throw new Error(\"Stripe portal did not return a URL\");\n\n        await appendImmutableAudit({\n          streamKey: `user:${u.id}:billing`,\n          action: \"billing.portal_session.created\",\n          actorUserId: u.id,\n          orgId: u.orgId ?? null,\n          payload: {\n            customerId,\n          },\n        });\n\n        return NextResponse.redirect(portalUrl, { status: 303 });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.redirect(new URL(\"/admin/billing?error=ENV_MISCONFIGURED\", req.url), { status: 303 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"billing_portal_timeout\",\n        severity: \"high\",\n        scope: \"billing\",\n        message: \"Portal session creation exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.redirect(new URL(\"/admin/billing?error=TIMEOUT\", req.url), { status: 303 });\n    }\n    const msg = String(e?.message || e || \"portal_failed\");\n    const safeError =\n      msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\"\n        ? \"FORBIDDEN\"\n        : msg === \"STRIPE_SECRET_KEY is not configured\"\n          ? \"ENV_MISCONFIGURED\"\n          : \"PORTAL_FAILED\";\n    await logSecurityEvent({\n      type: \"billing_portal_failed\",\n      severity: \"medium\",\n      scope: \"billing\",\n      message: \"Stripe portal session creation failed\",\n      meta: { code: safeError },\n    });\n    return NextResponse.redirect(new URL(`/admin/billing?error=${encodeURIComponent(safeError)}`, req.url), { status: 303 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\status\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1262,1265],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1262,1265],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { getPlanForUser } from \"@/lib/monetization\";\nimport { classifyBillingEntitlement, getBillingSnapshotForUser } from \"@/lib/billingSubscription\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nexport async function GET() {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_STATUS_MS\", 10_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const u = await requirePermission(\"billing.manage\");\n        const plan = await getPlanForUser(u.id);\n        const snapshot = await getBillingSnapshotForUser(u.id);\n        const entitlement = classifyBillingEntitlement(snapshot.subscription);\n        return NextResponse.json({\n          ok: true,\n          user: { id: u.id, email: u.email },\n          effectivePlan: plan,\n          entitlement,\n          subscription: snapshot.subscription,\n          webhookEvents: snapshot.events,\n        });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.json({ ok: false, error: \"ENV_MISCONFIGURED\" }, { status: 503 });\n    }\n    if (isRouteTimeoutError(e)) {\n      return NextResponse.json({ ok: false, error: \"TIMEOUT\" }, { status: 504 });\n    }\n    const msg = String(e?.message || e || \"failed\");\n    if (msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\") {\n      return NextResponse.json({ ok: false, error: \"FORBIDDEN\" }, { status: 403 });\n    }\n    return NextResponse.json({ ok: false, error: \"SERVER_ERROR\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\sync\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":45,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1698,1701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1698,1701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { runBillingMaintenance } from \"@/lib/billingSubscription\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_SYNC_MS\", 30_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const u = await requirePermission(\"billing.manage\");\n        const result = await runBillingMaintenance({\n          maxUsers: Math.max(1, Math.min(5000, Number(process.env.BILLING_MAINTENANCE_MAX_USERS || 500))),\n        });\n\n        await appendImmutableAudit({\n          streamKey: `user:${u.id}:billing`,\n          action: \"billing.maintenance.manual_run\",\n          actorUserId: u.id,\n          orgId: u.orgId ?? null,\n          payload: result,\n        });\n\n        await logSecurityEvent({\n          type: \"billing_maintenance_manual_run\",\n          severity: \"medium\",\n          actorUserId: u.id,\n          orgId: u.orgId ?? null,\n          scope: \"billing\",\n          message: \"Manual billing maintenance run completed\",\n          meta: result,\n        });\n\n        return NextResponse.redirect(new URL(\"/admin/billing/stripe?sync=ok\", req.url), { status: 303 });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.redirect(new URL(\"/admin/billing/stripe?error=ENV_MISCONFIGURED\", req.url), { status: 303 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"billing_maintenance_timeout\",\n        severity: \"high\",\n        scope: \"billing\",\n        message: \"Manual billing maintenance exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.redirect(new URL(\"/admin/billing/stripe?error=TIMEOUT\", req.url), { status: 303 });\n    }\n    const msg = String(e?.message || e || \"billing_sync_failed\");\n    const safeError =\n      msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\"\n        ? \"FORBIDDEN\"\n        : \"BILLING_SYNC_FAILED\";\n    return NextResponse.redirect(new URL(`/admin/billing/stripe?error=${encodeURIComponent(safeError)}`, req.url), { status: 303 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\billing\\view-override\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\db-index-audit\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\dbinfo\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[914,917],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[914,917],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { sql } from \"@/lib/db\";\r\nimport { requireRole } from \"@/lib/authz\";\r\n\r\nasync function regclass(name: string) {\r\n  const rows = (await sql`select to_regclass(${name})::text as reg`) as { reg: string | null }[];\r\n  return rows?.[0]?.reg ?? null;\r\n}\r\n\r\nexport async function GET() {\r\n  await requireRole(\"admin\");\r\n\r\n  // NOTE: We intentionally do NOT return DATABASE_URL (would leak credentials).\r\n  const infoRows = await sql`\r\n    select\r\n      current_database() as current_database,\r\n      current_user as current_user,\r\n      current_schema() as current_schema,\r\n      current_setting('search_path') as search_path,\r\n      inet_server_addr()::text as inet_server_addr,\r\n      inet_server_port() as inet_server_port,\r\n      version() as version\r\n  `;\r\n\r\n  const info = (infoRows as any[])?.[0] ?? null;\r\n\r\n  const tables = {\r\n    \"public.doc_audit\": await regclass(\"public.doc_audit\"),\r\n    \"public.doc_access_log\": await regclass(\"public.doc_access_log\"),\r\n    \"public.doc_views\": await regclass(\"public.doc_views\"),\r\n    \"public.docs\": await regclass(\"public.docs\"),\r\n    \"public.documents\": await regclass(\"public.documents\"),\r\n  };\r\n\r\n  return NextResponse.json({\r\n    ok: true,\r\n    now: new Date().toISOString(),\r\n    info,\r\n    tables,\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\debug\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3621,3624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3621,3624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":117,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":117,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4103,4106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4103,4106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4542,4545],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4542,4545],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4769,4772],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4769,4772],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5399,5402],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5399,5402],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":194,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":194,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6796,6799],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6796,6799],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\r\nexport const dynamic = \"force-dynamic\";\r\n\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { sql } from \"@/lib/db\";\r\nimport { requireRole } from \"@/lib/authz\";\n\nimport { HeadObjectCommand } from \"@aws-sdk/client-s3\";\nimport { getR2Bucket, r2Client } from \"@/lib/r2\";\n\r\ntype AliasRow = {\r\n  alias: string;\r\n  doc_id: string;\r\n  revoked_at: string | null;\r\n  expires_at: string | null;\r\n  created_at?: string | null;\r\n};\r\n\r\nfunction boolEnv(name: string) {\r\n  return Boolean(process.env[name] && String(process.env[name]).trim().length > 0);\r\n}\r\n\r\nasync function tableExists(regclass: string) {\r\n  const rows = (await sql`\r\n    select to_regclass(${regclass})::text as reg\r\n  `) as { reg: string | null }[];\r\n  return Boolean(rows?.[0]?.reg);\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\n  try {\n    const r2Bucket = getR2Bucket();\n    const enabled =\n      process.env.NODE_ENV !== \"production\" ||\n      [\"1\", \"true\", \"yes\", \"on\"].includes(String(process.env.ADMIN_DEBUG_ENABLED || \"\").trim().toLowerCase());\n    if (!enabled) {\n      return NextResponse.json({ ok: false, error: \"NOT_FOUND\" }, { status: 404 });\n    }\n\n    await requireRole(\"owner\");\n\r\n    const url = new URL(req.url);\r\n    const alias = (url.searchParams.get(\"alias\") || \"\").trim();\r\n    if (!alias) return NextResponse.json({ ok: false, error: \"MISSING_ALIAS\" }, { status: 400 });\r\n\r\n    // Detect what tables exist (helps catch schema drift between old \"documents\" and new \"docs\")\r\n    const [hasDocs, hasDocuments, hasDocAliases, hasDocViews] = await Promise.all([\r\n      tableExists(\"public.docs\"),\r\n      tableExists(\"public.documents\"),\r\n      tableExists(\"public.doc_aliases\"),\r\n      tableExists(\"public.doc_views\"),\r\n    ]);\r\n\r\n    const notes: string[] = [];\r\n    if (hasDocuments && hasDocs) {\r\n      notes.push(\"Both public.docs and public.documents exist. Make sure your /serve route reads from the same table your uploader writes to.\");\r\n    } else if (hasDocuments && !hasDocs) {\r\n      notes.push(\"public.docs does NOT exist but public.documents does. Your newer upload routes (presign/complete) look like they write to public.docs.\");\r\n    } else if (hasDocs && !hasDocuments) {\r\n      notes.push(\"public.documents does NOT exist but public.docs does. If /serve is still querying public.documents, it will return Not Found.\");\r\n    } else {\r\n      notes.push(\"Neither public.docs nor public.documents exists (unexpected). Check your DB connection / migrations.\");\r\n    }\r\n\r\n    if (!hasDocAliases) {\r\n      notes.push(\"public.doc_aliases does NOT exist. /d/[alias] cannot resolve anything without it.\");\r\n    }\r\n\r\n    // Read alias row (always from public.doc_aliases, when present)\r\n    let aliasRow: AliasRow | null = null;\r\n    if (hasDocAliases) {\r\n      const rows = (await sql`\r\n        select\r\n          alias,\r\n          doc_id::text as doc_id,\r\n          revoked_at,\r\n          expires_at,\r\n          created_at\r\n        from public.doc_aliases\r\n        where alias = ${alias}\r\n        order by created_at desc\r\n        limit 1\r\n      `) as AliasRow[];\r\n\r\n      aliasRow = rows?.[0] ?? null;\r\n\r\n      if (!aliasRow) {\r\n        notes.push(\"Alias row NOT found in public.doc_aliases for this alias.\");\r\n      } else {\r\n        if (aliasRow.revoked_at) notes.push(\"Alias is revoked (revoked_at is set).\");\r\n        if (aliasRow.expires_at) notes.push(\"Alias has an expires_at value; if it's in the past it will be treated as expired.\");\r\n      }\r\n    }\r\n\r\n    // Read document row from whichever table exists\r\n    const docId = aliasRow?.doc_id ?? null;\r\n    let docRow: any = null;\r\n\r\n    if (docId) {\r\n      if (hasDocs) {\r\n        const rows = await sql`\r\n          select\r\n            id::text as id,\r\n            title,\r\n            original_filename,\r\n            content_type,\r\n            size_bytes,\r\n            r2_bucket,\r\n            r2_key,\r\n            created_by_email,\r\n            status,\r\n            created_at\r\n          from public.docs\r\n          where id = ${docId}::uuid\r\n          limit 1\r\n        `;\r\n        docRow = (rows as any[])?.[0] ?? null;\r\n        if (!docRow) notes.push(\"No row found in public.docs for doc_id (alias points to missing doc).\");\r\n      } else if (hasDocuments) {\r\n        const rows = await sql`\r\n          select\r\n            id::text as id,\r\n            title,\r\n            target_url,\r\n            created_at\r\n          from public.documents\r\n          where id = ${docId}::uuid\r\n          limit 1\r\n        `;\r\n        docRow = (rows as any[])?.[0] ?? null;\r\n        if (!docRow) notes.push(\"No row found in public.documents for doc_id (alias points to missing doc).\");\r\n      }\r\n    }\r\n\r\n    // Best-effort R2 HEAD (only if we have a bucket/key)\r\n    let r2Head: any = null;\r\n    if (docRow?.r2_key) {\r\n      try {\r\n        const bucket = docRow?.r2_bucket || r2Bucket;\r\n        const head = await r2Client.send(\r\n          new HeadObjectCommand({\r\n            Bucket: bucket,\r\n            Key: docRow.r2_key,\r\n          })\r\n        );\r\n        r2Head = {\r\n          ok: true,\r\n          bucket,\r\n          key: docRow.r2_key,\r\n          contentLength: head.ContentLength ?? null,\r\n          contentType: head.ContentType ?? null,\r\n          etag: head.ETag ?? null,\r\n          lastModified: head.LastModified ? new Date(head.LastModified).toISOString() : null,\r\n        };\r\n      } catch (e: any) {\n        r2Head = { ok: false, error: e?.name ?? \"HEAD_FAILED\", message: \"Object HEAD failed\" };\n        notes.push(\"R2 HEAD failed (bucket/key may be wrong, or credentials missing).\");\n      }\n    } else if (docRow && hasDocs) {\r\n      notes.push(\"Doc row exists in public.docs but r2_key is empty/null (serve cannot fetch from R2).\");\r\n    }\r\n\r\n    const env = {\r\n      NEXT_PUBLIC_SITE_URL: boolEnv(\"NEXT_PUBLIC_SITE_URL\"),\r\n      DATABASE_URL: boolEnv(\"DATABASE_URL\"),\r\n      OWNER_EMAIL: boolEnv(\"OWNER_EMAIL\"),\r\n      AUTH_SECRET: boolEnv(\"AUTH_SECRET\"),\r\n      GOOGLE_CLIENT_ID: boolEnv(\"GOOGLE_CLIENT_ID\"),\r\n      GOOGLE_CLIENT_SECRET: boolEnv(\"GOOGLE_CLIENT_SECRET\"),\r\n      R2_ACCOUNT_ID: boolEnv(\"R2_ACCOUNT_ID\"),\r\n      R2_ACCESS_KEY_ID: boolEnv(\"R2_ACCESS_KEY_ID\"),\r\n      R2_SECRET_ACCESS_KEY: boolEnv(\"R2_SECRET_ACCESS_KEY\"),\r\n      R2_BUCKET: boolEnv(\"R2_BUCKET\"),\r\n      R2_PREFIX: boolEnv(\"R2_PREFIX\"),\r\n      VIEW_SALT: boolEnv(\"VIEW_SALT\"),\r\n    };\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      now: new Date().toISOString(),\r\n      alias,\r\n      tables: {\r\n        \"public.docs\": hasDocs,\r\n        \"public.documents\": hasDocuments,\r\n        \"public.doc_aliases\": hasDocAliases,\r\n        \"public.doc_views\": hasDocViews,\r\n      },\r\n      env,\r\n      alias_row: aliasRow,\r\n      doc_row: docRow,\r\n      r2_head: r2Head,\r\n      notes,\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"ADMIN DEBUG ERROR:\", err);\r\n    return NextResponse.json({ ok: false, error: \"SERVER_ERROR\", message: \"Debug inspection failed.\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\dmca\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\retention\\run\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\activate\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\freeze\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\keys\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1326,1329],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1326,1329],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { listMasterKeysWithStatus, isMasterKeyRevoked, getDbActiveMasterKeyId, listRecentMasterKeyChanges } from \"@/lib/masterKeys\";\nimport { getActiveMasterKey } from \"@/lib/encryption\";\nimport { listKeyRotationJobs, getKeyRotationStatusSummary } from \"@/lib/keyRotationJobs\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nexport async function GET() {\n  try {\n    await requirePermission(\"security.keys.read\");\n\n    let activeId: string | null = null;\n    try {\n      activeId = getActiveMasterKey().id;\n    } catch {\n      activeId = null;\n    }\n\n    const keys = await listMasterKeysWithStatus();\n    const dbActiveId = await getDbActiveMasterKeyId();\n    const configured = keys.length > 0 && !!activeId;\n    const revoked_active = activeId ? await isMasterKeyRevoked(activeId) : false;\n    const changes = await listRecentMasterKeyChanges(20);\n    const jobs = await listKeyRotationJobs(20);\n    const jobSummary = await getKeyRotationStatusSummary();\n\n    return NextResponse.json({\n      ok: true,\n      configured,\n      active_key_id: activeId,\n      db_active_key_id: dbActiveId,\n      revoked_active,\n      keys,\n      changes,\n      jobs,\n      job_summary: jobSummary,\n    });\n  } catch (e: any) {\n    const status = e?.message === \"FORBIDDEN\" || e?.message === \"UNAUTHENTICATED\" ? 403 : 500;\n    return NextResponse.json({ ok: false, error: status === 403 ? \"FORBIDDEN\" : \"SERVER_ERROR\" }, { status });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\migrate-legacy\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\org-access\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\rbac\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\requeue-scans\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\revoke\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1501,1504],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1501,1504],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { revokeMasterKey } from \"@/lib/masterKeys\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nconst Body = z.object({\n  key_id: z.string().min(1),\n});\n\nexport async function POST(req: Request) {\n  try {\n    const u = await requirePermission(\"security.keys.manage\");\n    const json = await req.json().catch(() => null);\n    const parsed = Body.safeParse(json);\n    if (!parsed.success) return NextResponse.json({ ok: false, error: \"BAD_REQUEST\" }, { status: 400 });\n\n    await revokeMasterKey({ id: parsed.data.key_id, actorUserId: u.id });\n\n    try {\n      await appendImmutableAudit({\n        streamKey: \"security:key-management\",\n        action: \"encryption.key.revoke\",\n        actorUserId: u.id,\n        subjectId: parsed.data.key_id,\n        payload: {\n          keyId: parsed.data.key_id,\n        },\n      });\n    } catch {\n      // ignore immutable audit failures to avoid blocking control-plane operation\n    }\n\n    void logSecurityEvent({\n      type: \"master_key_revoke\",\n      severity: \"high\",\n      actorUserId: u.id,\n      orgId: u.orgId ?? null,\n      scope: \"crypto\",\n      message: \"Master key revoked\",\n      meta: { keyId: parsed.data.key_id },\n    });\n\n    return NextResponse.json({ ok: true });\n  } catch (e: any) {\n    const status = e?.message === \"FORBIDDEN\" || e?.message === \"UNAUTHENTICATED\" ? 403 : 500;\n    return NextResponse.json({ ok: false, error: status === 403 ? \"FORBIDDEN\" : \"SERVER_ERROR\" }, { status });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\rollback\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\rotate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3774,3777],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3774,3777],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport { requirePermission } from \"@/lib/rbac\";\nimport { rotateDocKeys } from \"@/lib/masterKeys\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { enqueueKeyRotationJob } from \"@/lib/keyRotationJobs\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nconst Body = z.object({\n  from_key_id: z.string().min(1),\n  to_key_id: z.string().optional(),\n  limit: z.number().int().positive().max(2000).optional(),\n  async_job: z.boolean().optional(),\n});\n\nexport async function POST(req: Request) {\n  try {\n    const u = await requirePermission(\"security.keys.manage\");\n    const json = await req.json().catch(() => null);\n    const parsed = Body.safeParse(json);\n    if (!parsed.success) return NextResponse.json({ ok: false, error: \"BAD_REQUEST\" }, { status: 400 });\n\n    const asyncJob = parsed.data.async_job ?? true;\n\n    if (asyncJob) {\n      const toKeyId = parsed.data.to_key_id || \"\";\n      if (!toKeyId) {\n        return NextResponse.json(\n          { ok: false, error: \"TO_KEY_REQUIRED\", message: \"to_key_id is required for async rotation job.\" },\n          { status: 400 }\n        );\n      }\n      const job = await enqueueKeyRotationJob({\n        fromKeyId: parsed.data.from_key_id,\n        toKeyId,\n        maxBatch: parsed.data.limit ?? 250,\n        requestedByUserId: u.id,\n      });\n\n      try {\n        await appendImmutableAudit({\n          streamKey: \"security:key-management\",\n          action: \"encryption.key.rotate.enqueued\",\n          actorUserId: u.id,\n          subjectId: job.id,\n          payload: {\n            fromKeyId: parsed.data.from_key_id,\n            toKeyId,\n            limit: parsed.data.limit ?? 250,\n            mode: \"async\",\n          },\n        });\n      } catch {\n        // ignore immutable audit failures to avoid blocking control-plane operation\n      }\n\n      void logSecurityEvent({\n        type: \"master_key_rotate_job_enqueued\",\n        severity: \"medium\",\n        actorUserId: u.id,\n        orgId: u.orgId ?? null,\n        scope: \"crypto\",\n        message: \"Master key rotation job enqueued\",\n        meta: { from: parsed.data.from_key_id, to: toKeyId, jobId: job.id, limit: parsed.data.limit ?? 250 },\n      });\n\n      return NextResponse.json({ ok: true, job_id: job.id, mode: \"async\" });\n    }\n\n    const res = await rotateDocKeys({\n      fromKeyId: parsed.data.from_key_id,\n      toKeyId: parsed.data.to_key_id,\n      limit: parsed.data.limit ?? 250,\n    });\n\n    try {\n      await appendImmutableAudit({\n        streamKey: \"security:key-management\",\n        action: \"encryption.key.rotate.executed\",\n        actorUserId: u.id,\n        subjectId: parsed.data.from_key_id,\n        payload: {\n          fromKeyId: parsed.data.from_key_id,\n          toKeyId: parsed.data.to_key_id ?? \"active\",\n          limit: parsed.data.limit ?? 250,\n          mode: \"sync\",\n          scanned: res.scanned,\n          rotated: res.rotated,\n          failed: res.failed,\n          remaining: res.remaining,\n        },\n      });\n    } catch {\n      // ignore immutable audit failures to avoid blocking control-plane operation\n    }\n\n    void logSecurityEvent({\n      type: \"master_key_rotate\",\n      severity: \"medium\",\n      actorUserId: u.id,\n      orgId: u.orgId ?? null,\n      scope: \"crypto\",\n      message: \"Rewrapped document data keys\",\n      meta: { from: parsed.data.from_key_id, to: parsed.data.to_key_id ?? \"active\", rotated: res.rotated, failed: res.failed, remaining: res.remaining },\n    });\n\n    return NextResponse.json({ ok: true, mode: \"sync\", rotated: res.rotated, failed: res.failed, scanned: res.scanned, remaining: res.remaining });\n  } catch (e: any) {\n    const status = e?.message === \"FORBIDDEN\" || e?.message === \"UNAUTHENTICATED\" ? 403 : 500;\n    return NextResponse.json({ ok: false, error: status === 403 ? \"FORBIDDEN\" : \"SERVER_ERROR\" }, { status });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\security\\tenant-freeze\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\upload\\abort\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\upload\\complete\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1519,1522],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1519,1522],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1610,1613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1610,1613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":177,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6111,6114],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6111,6114],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":231,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7924,7927],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7924,7927],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8380,8383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8380,8383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":245,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8438,8441],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8438,8441],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":246,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":246,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8491,8494],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8491,8494],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":346,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":346,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12485,12488],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12485,12488],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":355,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":355,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12747,12750],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12747,12750],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":1,"message":"'encAlg' is never reassigned. Use 'const' instead.","line":410,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":410,"endColumn":15,"fix":{"range":[15115,15142],"text":"const encAlg = \"AES-256-GCM\";"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":474,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":474,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17559,17562],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17559,17562],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":563,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":563,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20327,20330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20327,20330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":1,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { HeadObjectCommand } from \"@aws-sdk/client-s3\";\nimport { GetObjectCommand } from \"@aws-sdk/client-s3\";\nimport { PutObjectCommand } from \"@aws-sdk/client-s3\";\nimport { DeleteObjectCommand } from \"@aws-sdk/client-s3\";\nimport { validatePdfBuffer } from \"@/lib/pdfSafety\";\nimport { sql } from \"@/lib/db\";\nimport { slugify } from \"@/lib/slug\";\nimport { requireDocWrite, requireUser } from \"@/lib/authz\";\nimport { incrementUploads } from \"@/lib/monetization\";\nimport { enforceGlobalApiRateLimit, clientIpKey, logDbErrorEvent, logSecurityEvent, detectStorageSpike } from \"@/lib/securityTelemetry\";\nimport { getR2Bucket, r2Client } from \"@/lib/r2\";\nimport { enqueueDocScan } from \"@/lib/scanQueue\";\nimport { encryptAes256Gcm, generateDataKey, generateIv, wrapDataKey } from \"@/lib/encryption\";\nimport { getActiveMasterKeyOrThrow } from \"@/lib/masterKeys\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\nimport { validateUploadType } from \"@/lib/uploadTypeValidation\";\n\ntype CompleteRequest = {\n  // Newer flow: doc_id from /presign response\n  doc_id?: string;\n\n  // Older flow (what your Network screenshot shows right now)\n  r2_bucket?: string;\n  r2_key?: string;\n\n  title?: string | null;\n  original_filename?: string | null;\n};\n\nasync function streamToBuffer(body: any): Promise<Buffer> {\n  const chunks: Buffer[] = [];\n  for await (const chunk of body as any) {\n    chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk));\n  }\n  return Buffer.concat(chunks);\n}\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_UPLOAD_COMPLETE_MS\", 45_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"upload_complete\");\n\n        const r2Bucket = getR2Bucket();\n        await requireUser();\n        // Global API throttle (best-effort)\n        const globalRl = await enforceGlobalApiRateLimit({\n          req,\n          scope: \"ip:api\",\n          limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n          windowSeconds: 60,\n          strict: true,\n        });\n        if (!globalRl.ok) {\n          return NextResponse.json(\n            { ok: false, error: \"RATE_LIMIT\" },\n            { status: globalRl.status, headers: { \"Retry-After\": String(globalRl.retryAfterSeconds) } }\n          );\n        }\n\n        // Upload complete throttle per-IP\n        const ipInfo = clientIpKey(req);\n        const completeRl = await enforceGlobalApiRateLimit({\n          req,\n          scope: \"ip:upload_complete\",\n          limit: Number(process.env.RATE_LIMIT_UPLOAD_COMPLETE_IP_PER_MIN || 30),\n          windowSeconds: 60,\n          strict: true,\n        });\n        if (!completeRl.ok) {\n          await logSecurityEvent({\n            type: \"upload_throttle\",\n            severity: \"medium\",\n            ip: ipInfo.ip,\n            scope: \"ip:upload_complete\",\n            message: \"Upload complete throttled\",\n          });\n          return NextResponse.json(\n            { ok: false, error: \"RATE_LIMIT\" },\n            { status: completeRl.status, headers: { \"Retry-After\": String(completeRl.retryAfterSeconds) } }\n          );\n        }\n\n    const body = (await req.json()) as CompleteRequest;\n\n    const title = body.title ?? null;\n    const originalFilename = body.original_filename ?? null;\n\n    // 1) Resolve docId either directly or via (bucket,key)\n    let docId: string | null = body.doc_id ?? null;\n\n    if (!docId) {\n      const bucket = body.r2_bucket ?? null;\n      const key = body.r2_key ?? null;\n\n      if (bucket && key) {\n        const rows = (await sql`\n          select id::text as id\n          from public.docs\n          where r2_bucket = ${bucket}\n            and r2_key = ${key}\n          limit 1\n        `) as { id: string }[];\n\n        docId = rows?.[0]?.id ?? null;\n      }\n    }\n\n    if (!docId) {\n      return NextResponse.json(\n        {\n          ok: false,\n          error: \"missing_doc_id\",\n          message: \"Send doc_id (preferred) or r2_bucket + r2_key.\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // AuthZ: must be able to manage this doc.\n    await requireDocWrite(docId);\n\n    // 2) Fetch existing doc (for slug fallback)\n    const docRows = (await sql`\n      select\n        id::text as id,\n        coalesce(original_filename, title, '')::text as name,\n        coalesce(content_type, '')::text as content_type,\n        r2_bucket::text as r2_bucket,\n        r2_key::text as r2_key\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as { id: string; name: string; content_type: string; r2_bucket: string | null; r2_key: string | null }[];\n\n    if (!docRows.length) {\n      return NextResponse.json({ ok: false, error: \"doc_not_found\" }, { status: 404 });\n    }\n\n    const existingName = docRows[0].name;\n\n    const docBucket = docRows[0].r2_bucket;\n    const docKey = docRows[0].r2_key;\n    if (!docBucket || !docKey) {\n      return NextResponse.json({ ok: false, error: \"missing_r2_pointer\" }, { status: 409 });\n    }\n\n    // Defensive: ensure this doc points at the configured bucket.\n    // (Prevents any future cross-bucket pointer mistakes from becoming a data exfil path.)\n    if (docBucket !== r2Bucket) {\n      await logSecurityEvent({\n        type: \"upload_complete_bucket_mismatch\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"Doc bucket does not match configured R2 bucket\",\n        meta: { docBucket, configuredBucket: r2Bucket },\n      });\n      return NextResponse.json({ ok: false, error: \"bucket_mismatch\" }, { status: 409 });\n    }\n\n    const cleanupRejectedObject = async (reason: string, meta?: Record<string, unknown>) => {\n      try {\n        await r2Client.send(\n          new DeleteObjectCommand({\n            Bucket: docBucket,\n            Key: docKey,\n          })\n        );\n      } catch (e: any) {\n        await logSecurityEvent({\n          type: \"upload_complete_cleanup_failed\",\n          severity: \"high\",\n          ip: ipInfo.ip,\n          docId,\n          scope: \"upload_complete\",\n          message: \"Failed to delete rejected object from R2\",\n          meta: { reason, error: String(e?.message || e), ...(meta || {}) },\n        });\n      }\n    };\n\n    // 3) Verify the object exists in R2 and matches expected constraints.\n    // This closes the bypass where a client can lie about size/type during presign.\n    const absMax = Number(process.env.UPLOAD_ABSOLUTE_MAX_BYTES || 26_214_400); // 25 MB default\n\n    // Pull expected size and encryption flag from DB.\n    const verifyRows = (await sql`\n      select\n        size_bytes::bigint as size_bytes,\n        encryption_enabled::boolean as encryption_enabled\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as unknown as Array<{\n      size_bytes: number | string | null;\n      encryption_enabled: boolean | null;\n    }>;\n\n    const expectedPlain = Number(verifyRows?.[0]?.size_bytes ?? 0);\n    const encryptionEnabled = Boolean(verifyRows?.[0]?.encryption_enabled);\n\n    if (!encryptionEnabled) {\n      await logSecurityEvent({\n        type: \"upload_complete_encryption_required\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"Upload completion blocked because encryption is not enabled for this doc\",\n      });\n      await cleanupRejectedObject(\"encryption_required\");\n      return NextResponse.json({ ok: false, error: \"encryption_required\" }, { status: 409 });\n    }\n\n    let head;\n    try {\n      head = await r2Client.send(\n        new HeadObjectCommand({\n          Bucket: docBucket,\n          Key: docKey,\n        })\n      );\n    } catch (e: any) {\n      await logSecurityEvent({\n        type: \"upload_complete_missing_object\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"Upload complete called but R2 object missing\",\n        meta: { err: e?.name ?? e?.message ?? String(e) },\n      });\n      return NextResponse.json({ ok: false, error: \"object_missing\" }, { status: 409 });\n    }\n\n    const contentLength = Number((head as any)?.ContentLength ?? 0);\n    const ct = String((head as any)?.ContentType ?? \"\");\n    const meta = ((head as any)?.Metadata ?? {}) as Record<string, string>;\n\n    if (!Number.isFinite(contentLength) || contentLength <= 0) {\n      await cleanupRejectedObject(\"invalid_object\", { contentLength });\n      return NextResponse.json({ ok: false, error: \"invalid_object\" }, { status: 409 });\n    }\n    if (Number.isFinite(absMax) && absMax > 0 && contentLength > absMax) {\n      await logSecurityEvent({\n        type: \"upload_complete_too_large\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"Uploaded object exceeds absolute max\",\n        meta: { contentLength, absMax },\n      });\n      await cleanupRejectedObject(\"object_too_large\", { contentLength, absMax });\n      return NextResponse.json({ ok: false, error: \"object_too_large\" }, { status: 413 });\n    }\n\n    if (Number.isFinite(expectedPlain) && expectedPlain > 0) {\n      const allowedSizes = new Set<number>([expectedPlain]);\n      if (!allowedSizes.has(contentLength)) {\n        await logSecurityEvent({\n          type: \"upload_complete_size_mismatch\",\n          severity: \"high\",\n          ip: ipInfo.ip,\n          docId,\n          scope: \"upload_complete\",\n          message: \"Uploaded object size mismatch\",\n          meta: { expectedPlain, contentLength, encryptionEnabled },\n        });\n        await cleanupRejectedObject(\"size_mismatch\", { expectedPlain, contentLength, encryptionEnabled });\n        return NextResponse.json({ ok: false, error: \"size_mismatch\" }, { status: 409 });\n      }\n    }\n\n    // Verify signed metadata we attached during presign.\n    const metaDocId = (meta[\"doc-id\"] || meta[\"doc_id\"] || \"\").toString();\n    const metaOrigCt = (meta[\"orig-content-type\"] || meta[\"orig_content_type\"] || \"\").toString();\n    const metaOrigExt = (meta[\"orig-ext\"] || meta[\"orig_ext\"] || \"\").toString();\n\n    if (!metaDocId) {\n      await logSecurityEvent({\n        type: \"upload_complete_meta_missing_doc_id\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"R2 object metadata doc-id missing\",\n      });\n      await cleanupRejectedObject(\"metadata_missing\");\n      return NextResponse.json({ ok: false, error: \"metadata_missing\" }, { status: 409 });\n    }\n\n    if (metaDocId !== docId) {\n      await logSecurityEvent({\n        type: \"upload_complete_meta_mismatch\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"R2 object metadata doc-id mismatch\",\n        meta: { metaDocId, docId },\n      });\n      await cleanupRejectedObject(\"metadata_mismatch\", { metaDocId, docId });\n      return NextResponse.json({ ok: false, error: \"metadata_mismatch\" }, { status: 409 });\n    }\n\n    if (!metaOrigCt) {\n      await logSecurityEvent({\n        type: \"upload_complete_mime_missing\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"R2 metadata orig-content-type is missing\",\n        meta: { metaOrigCt, ct, metaOrigExt },\n      });\n      await cleanupRejectedObject(\"mime_missing\", { metaOrigCt, contentType: ct, metaOrigExt });\n      return NextResponse.json({ ok: false, error: \"mime_missing\" }, { status: 409 });\n    }\n\n    if (ct && ct !== metaOrigCt) {\n      await logSecurityEvent({\n        type: \"upload_complete_content_type_mismatch\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"Upload object content-type mismatch with declared metadata\",\n        meta: { contentType: ct, metaOrigCt },\n      });\n      await cleanupRejectedObject(\"content_type_mismatch\", { encryptionEnabled: true, contentType: ct, metaOrigCt });\n      return NextResponse.json({ ok: false, error: \"content_type_mismatch\" }, { status: 409 });\n    }\n\n    // 4) Read uploaded PDF bytes and validate server-side before encryption.\n    let scanStatus: string = \"pending\";\n    let riskLevel: string = \"low\";\n    let riskFlags: any = null;\n    let uploadedBytes: Buffer;\n    try {\n      const uploadedObj = await r2Client.send(\n        new GetObjectCommand({\n          Bucket: docBucket,\n          Key: docKey,\n        })\n      );\n      uploadedBytes = await streamToBuffer((uploadedObj as any).Body);\n    } catch {\n      await cleanupRejectedObject(\"object_read_failed\");\n      return NextResponse.json({ ok: false, error: \"object_read_failed\" }, { status: 409 });\n    }\n\n    const filenameForValidation = (originalFilename || docRows[0].name || \"upload.bin\").trim();\n    const typeCheck = validateUploadType({\n      filename: filenameForValidation,\n      declaredMime: metaOrigCt || docRows[0].content_type || null,\n      bytes: uploadedBytes,\n    });\n    if (!typeCheck.ok) {\n      await logSecurityEvent({\n        type: \"upload_complete_type_validation_failed\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        docId,\n        scope: \"upload_complete\",\n        message: \"File type validation failed before encryption\",\n        meta: { error: typeCheck.error, message: typeCheck.message, metaOrigCt, filenameForValidation },\n      });\n      await cleanupRejectedObject(\"type_validation_failed_before_encrypt\", { error: typeCheck.error });\n      return NextResponse.json({ ok: false, error: typeCheck.error, message: typeCheck.message }, { status: 409 });\n    }\n\n    if (typeCheck.canonicalMime === \"application/pdf\") {\n      const safety = validatePdfBuffer({\n        bytes: uploadedBytes,\n        absMaxBytes: absMax,\n        maxPdfPages: Number(process.env.PDF_MAX_PAGES || 2000),\n      });\n      if (!safety.ok) {\n        await logSecurityEvent({\n          type: \"upload_complete_pdf_validation_failed\",\n          severity: \"high\",\n          ip: ipInfo.ip,\n          docId,\n          scope: \"upload_complete\",\n          message: \"PDF validation failed before encryption\",\n          meta: { error: safety.error, message: safety.message, details: safety.details ?? null },\n        });\n        await cleanupRejectedObject(\"pdf_validation_failed_before_encrypt\", { error: safety.error });\n        return NextResponse.json({ ok: false, error: safety.error, message: safety.message }, { status: 409 });\n      }\n      scanStatus = \"pending\";\n      riskLevel = safety.riskLevel;\n      riskFlags = { flags: safety.flags, details: safety.details, mode: \"server_validation\" };\n    } else {\n      scanStatus = \"pending\";\n      riskLevel = \"low\";\n      riskFlags = { flags: [], details: { mime: typeCheck.canonicalMime, ext: typeCheck.ext }, mode: \"server_validation\" };\n    }\n\n    // 5) Encrypt file server-side and overwrite uploaded plaintext object.\n    let encAlg = \"AES-256-GCM\";\n    let encIv: Buffer | null = null;\n    let encKeyVersion = \"\";\n    let encWrappedKey: Buffer | null = null;\n    let encWrapIv: Buffer | null = null;\n    let encWrapTag: Buffer | null = null;\n    try {\n      const mk = await getActiveMasterKeyOrThrow();\n      const dataKey = generateDataKey();\n      encIv = generateIv();\n      const wrap = wrapDataKey({ dataKey, masterKey: mk.key });\n      const ciphertext = encryptAes256Gcm({ plaintext: uploadedBytes, iv: encIv, key: dataKey });\n      await r2Client.send(\n        new PutObjectCommand({\n          Bucket: docBucket,\n          Key: docKey,\n          Body: ciphertext,\n          ContentType: \"application/octet-stream\",\n          Metadata: {\n            \"doc-id\": docId,\n            \"orig-content-type\": typeCheck.canonicalMime,\n            \"orig-ext\": typeCheck.ext,\n          },\n        })\n      );\n      encKeyVersion = mk.id;\n      encWrappedKey = wrap.wrapped;\n      encWrapIv = wrap.iv;\n      encWrapTag = wrap.tag;\n    } catch {\n      await cleanupRejectedObject(\"server_side_encrypt_failed\");\n      return NextResponse.json({ ok: false, error: \"server_side_encrypt_failed\" }, { status: 500 });\n    }\n    if (!encIv || !encKeyVersion || !encWrappedKey || !encWrapIv || !encWrapTag) {\n      await cleanupRejectedObject(\"server_side_encrypt_metadata_missing\");\n      return NextResponse.json({ ok: false, error: \"server_side_encrypt_metadata_missing\" }, { status: 500 });\n    }\n\n// 6) Mark doc ready + update metadata (best-effort)\n    await sql`\n      update public.docs\n      set\n        title = coalesce(${title}, title),\n        original_filename = coalesce(${originalFilename}, original_filename),\n        content_type = ${typeCheck.canonicalMime},\n        status = 'ready',\n        scan_status = ${scanStatus}::text,\n        risk_level = ${riskLevel}::text,\n        risk_flags = ${riskFlags}::jsonb,\n        enc_alg = ${encAlg},\n        enc_iv = ${encIv},\n        enc_key_version = ${encKeyVersion},\n        enc_wrapped_key = ${encWrappedKey},\n        enc_wrap_iv = ${encWrapIv},\n        enc_wrap_tag = ${encWrapTag},\n        moderation_status = case when ${riskLevel}::text = 'high' then 'quarantined' else coalesce(moderation_status, 'active') end\n      where id = ${docId}::uuid\n    `;\n\n\n\n// 4b) Enqueue async malware scan (best-effort; runs via /api/cron/scan)\ntry {\n  await enqueueDocScan({ docId, bucket: docBucket, key: docKey });\n} catch (e: any) {\n  // Non-fatal; upload is still usable unless other rules quarantine it.\n  await logSecurityEvent({\n    type: \"malware_scan_enqueue_failed\",\n    severity: \"medium\",\n    ip: ipInfo.ip,\n    docId,\n    scope: \"upload_complete\",\n    message: \"Failed to enqueue malware scan job\",\n    meta: { error: String(e?.message || e) },\n  });\n}\n// --- Monetization counters (hidden) ---\n// Count this as an upload for the doc owner (usually the signed-in user).\ntry {\n  const usageRows = (await sql`\n    select owner_id::text as owner_id\n         , org_id::text as org_id\n         , size_bytes::bigint as size_bytes\n    from public.docs\n    where id = ${docId}::uuid\n    limit 1\n  `) as unknown as Array<{ owner_id: string | null; org_id: string | null; size_bytes: number | string | null }>;\n  const ownerId = usageRows?.[0]?.owner_id ?? null;\n  const orgId = usageRows?.[0]?.org_id ?? null;\n  const sizeBytes = Number(usageRows?.[0]?.size_bytes ?? 0);\n  if (ownerId) {\n    await incrementUploads(ownerId, 1);\n\n    // Storage spike detection (best-effort)\n    if (Number.isFinite(sizeBytes) && sizeBytes > 0) {\n      await detectStorageSpike({ ownerId, sizeBytes, ip: ipInfo.ip, orgId, docId });\n    }\n  }\n} catch (e) {\n  // best-effort; do not block completion\n  console.warn(\"Failed to increment upload usage:\", e);\n}\n\n\n    // 4) Generate alias base\n    let base = slugify(title || originalFilename || existingName || \"document\");\n    if (!base) base = `doc-${docId.slice(0, 8)}`;\n\n    // 5) Create alias with collision handling\n    let finalAlias: string | null = null;\n\n    for (let i = 0; i < 50; i++) {\n      const candidateAlias = i === 0 ? base : `${base}-${i + 1}`;\n\n      try {\n        await sql`\n          insert into public.doc_aliases (alias, doc_id)\n          values (${candidateAlias}, ${docId}::uuid)\n        `;\n        finalAlias = candidateAlias;\n        break;\n      } catch {\n        // alias collision, try next\n      }\n    }\n\n    if (!finalAlias) {\n      return NextResponse.json({ ok: false, error: \"alias_generation_failed\" }, { status: 500 });\n    }\n\n    const baseUrl =\n      process.env.NEXT_PUBLIC_SITE_URL ||\n      (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"http://localhost:3000\");\n\n        await logSecurityEvent({\n          type: \"upload_complete_success\",\n          severity: \"low\",\n          ip: ipInfo.ip,\n          scope: \"upload_complete\",\n          message: \"Upload finalized successfully\",\n          docId,\n          meta: { sizeBytes: expectedPlain || null },\n        });\n\n        return NextResponse.json({\n          ok: true,\n          doc_id: docId,\n          alias: finalAlias,\n          view_url: `${baseUrl}/d/${encodeURIComponent(finalAlias)}`,\n        });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.json({ ok: false, error: \"ENV_MISCONFIGURED\" }, { status: 503 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"upload_complete_timeout\",\n        severity: \"high\",\n        ip: clientIpKey(req).ip,\n        scope: \"upload_complete\",\n        message: \"Upload completion exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.json({ ok: false, error: \"TIMEOUT\" }, { status: 504 });\n    }\n    await logDbErrorEvent({\n      scope: \"upload_complete\",\n      message: String(e?.message || e || \"server_error\"),\n      ip: clientIpKey(req).ip,\n      meta: { route: \"/api/admin/upload/complete\" },\n    });\n    return NextResponse.json(\n      { ok: false, error: \"server_error\", message: \"Unable to finalize upload.\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\upload\\presign\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":244,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":244,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8140,8143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8140,8143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\nimport { PutObjectCommand } from \"@aws-sdk/client-s3\";\nimport { getSignedUrl } from \"@aws-sdk/s3-request-presigner\";\nimport crypto from \"node:crypto\";\n\nimport { sql } from \"@/lib/db\";\nimport { getR2Bucket, r2Client } from \"@/lib/r2\";\nimport { requireUser } from \"@/lib/authz\";\nimport { assertCanUpload } from \"@/lib/monetization\";\nimport { enforcePlanLimitsEnabled } from \"@/lib/billingFlags\";\nimport {\n  enforceGlobalApiRateLimit,\n  clientIpKey,\n  detectPresignFailureSpike,\n  enforceIpAbuseBlock,\n  logSecurityEvent,\n  maybeBlockIpOnAbuse,\n} from \"@/lib/securityTelemetry\";\nimport { getActiveMasterKeyOrThrow } from \"@/lib/masterKeys\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { reportException } from \"@/lib/observability\";\nimport { validateUploadType } from \"@/lib/uploadTypeValidation\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\n// Enterprise: encryption is mandatory.\n// We keep \"encrypt\" in the schema for backward compatibility, but it must be true (or omitted).\nconst BodySchema = z.object({\n  title: z.string().optional(),\n  filename: z.string().min(1).max(240),\n  contentType: z.string().min(1),\n  sizeBytes: z.number().int().positive().optional(),\n  encrypt: z.boolean().optional(),\n});\n\nfunction safeKeyPart(name: string) {\n  return name.replace(/[^a-zA-Z0-9._-]+/g, \"_\").replace(/_+/g, \"_\").slice(0, 120);\n}\n\nfunction getKeyPrefix() {\n  const p = process.env.R2_PREFIX || \"docs/\";\n  if (p.startsWith(\"r2://\")) return \"docs/\";\n  return p.endsWith(\"/\") ? p : `${p}/`;\n}\n\nexport async function POST(req: Request) {\n  const ipInfo = clientIpKey(req);\n  try {\n    const abuseBlock = await enforceIpAbuseBlock({ req, scope: \"upload_presign\" });\n    if (!abuseBlock.ok) {\n      return NextResponse.json(\n        { ok: false, error: \"ABUSE_BLOCKED\" },\n        { status: 403, headers: { \"Retry-After\": String(abuseBlock.retryAfterSeconds) } }\n      );\n    }\n    const r2Bucket = getR2Bucket();\n    const user = await requireUser();\n\n    // Global API throttle (best-effort)\n    const globalRl = await enforceGlobalApiRateLimit({\n      req,\n      scope: \"ip:api\",\n      limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n      windowSeconds: 60,\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      strict: true,\n    });\n    if (!globalRl.ok) {\n      return NextResponse.json(\n        { ok: false, error: \"RATE_LIMIT\" },\n        { status: globalRl.status, headers: { \"Retry-After\": String(globalRl.retryAfterSeconds) } }\n      );\n    }\n\n    // Upload presign throttle per-IP (stronger)\n    const presignRl = await enforceGlobalApiRateLimit({\n      req,\n      scope: \"ip:upload_presign\",\n      limit: Number(process.env.RATE_LIMIT_UPLOAD_PRESIGN_IP_PER_MIN || 30),\n      windowSeconds: 60,\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      strict: true,\n    });\n    if (!presignRl.ok) {\n      await logSecurityEvent({\n        type: \"upload_throttle\",\n        severity: \"medium\",\n        ip: ipInfo.ip,\n        actorUserId: user.id,\n        orgId: user.orgId ?? null,\n        scope: \"ip:upload_presign\",\n        message: \"Upload presign throttled\",\n      });\n      await maybeBlockIpOnAbuse({\n        ip: ipInfo.ip,\n        category: \"upload_presign_abuse\",\n        scope: \"upload_presign\",\n        threshold: Number(process.env.ABUSE_BLOCK_PRESIGN_THRESHOLD || 20),\n        windowSeconds: Number(process.env.ABUSE_BLOCK_PRESIGN_WINDOW_SECONDS || 600),\n        blockSeconds: Number(process.env.ABUSE_BLOCK_TTL_SECONDS || 3600),\n        reason: \"Repeated upload presign abuse\",\n      });\n      return NextResponse.json(\n        { ok: false, error: \"RATE_LIMIT\" },\n        { status: presignRl.status, headers: { \"Retry-After\": String(presignRl.retryAfterSeconds) } }\n      );\n    }\n\n    const json = await req.json().catch(() => null);\n    const parsed = BodySchema.safeParse(json);\n    if (!parsed.success) {\n      return NextResponse.json({ ok: false, error: \"BAD_REQUEST\" }, { status: 400 });\n    }\n\n    const { title, filename } = parsed.data;\n    const declaredType = validateUploadType({\n      filename,\n      declaredMime: parsed.data.contentType,\n    });\n    if (!declaredType.ok) {\n      return NextResponse.json(\n        { ok: false, error: declaredType.error, message: declaredType.message },\n        { status: 400 }\n      );\n    }\n\n    // Enterprise mode: encryption is mandatory for everyone.\n    // Non-owner accounts are allowed to upload; they just cannot disable encryption.\n    const encryptRequested = parsed.data.encrypt;\n    if (encryptRequested === false) {\n      return NextResponse.json(\n        { ok: false, error: \"ENCRYPTION_REQUIRED\", message: \"Encryption is mandatory.\" },\n        { status: 400 }\n      );\n    }\n    const contentType = declaredType.canonicalMime;\n    const sizeBytes = parsed.data.sizeBytes ?? null;\n    const absMax = Number(process.env.UPLOAD_ABSOLUTE_MAX_BYTES || 26_214_400); // 25 MB default\n\n    // Hard enforcement needs an explicit sizeBytes to prevent bypassing storage/file-size caps.\n    if (enforcePlanLimitsEnabled() && (sizeBytes == null || !Number.isFinite(sizeBytes) || sizeBytes <= 0)) {\n      return NextResponse.json({ ok: false, error: \"MISSING_SIZE\", message: \"sizeBytes is required.\" }, { status: 400 });\n    }\n    if (sizeBytes != null && Number.isFinite(absMax) && absMax > 0 && sizeBytes > absMax) {\n      return NextResponse.json(\n        { ok: false, error: \"FILE_TOO_LARGE\", message: `File exceeds absolute limit (${absMax} bytes).` },\n        { status: 413 }\n      );\n    }\n\n    // --- Monetization / plan limits (hidden) ---\n    const canUpload = await assertCanUpload({ userId: user.id, sizeBytes: sizeBytes ?? null });\n    if (!canUpload.ok) {\n      return NextResponse.json(\n        { ok: false, error: \"PAYMENT_REQUIRED\", message: canUpload.message || \"Upgrade required to upload.\" },\n        { status: 402 }\n      );\n    }\n\n    // --- Mandatory encryption configuration ---\n    let activeKeyId: string;\n    try {\n      activeKeyId = (await getActiveMasterKeyOrThrow()).id;\n    } catch (e: unknown) {\n      const msg = e instanceof Error && e.message === \"MASTER_KEY_REVOKED\" ? \"Active master key is revoked.\" : \"Missing DOC_MASTER_KEYS.\";\n      await logSecurityEvent({\n        type: \"upload_presign_error\",\n        severity: \"high\",\n        ip: ipInfo.ip,\n        actorUserId: user.id,\n        orgId: user.orgId ?? null,\n        scope: \"upload_presign\",\n        message: \"Encryption configuration unavailable during presign\",\n        meta: { reason: msg },\n      });\n      await detectPresignFailureSpike({ ip: ipInfo.ip });\n      return NextResponse.json(\n        { ok: false, error: \"ENCRYPTION_NOT_CONFIGURED\", message: \"Encryption configuration unavailable.\" },\n        { status: 500 }\n      );\n    }\n\n    const docId = crypto.randomUUID();\n    const keyPrefix = getKeyPrefix();\n    const safeName = safeKeyPart(filename);\n    const key = `${keyPrefix}${docId}_${safeName}`;\n\n    const createdByEmail = user.email;\n\n    await sql`\n      insert into docs (\n        id,\n        org_id,\n        owner_id,\n        title,\n        original_filename,\n        content_type,\n        size_bytes,\n        r2_bucket,\n        r2_key,\n        created_by_email,\n        status,\n        encryption_enabled\n      )\n      values (\n        ${docId}::uuid,\n        ${user.orgId ? user.orgId : null}::uuid,\n        ${user.id}::uuid,\n        ${title ?? filename},\n        ${filename},\n        ${contentType},\n        ${sizeBytes}::bigint,\n        ${r2Bucket},\n        ${key},\n        ${createdByEmail},\n        'uploading',\n        true\n      )\n    `;\n\n    await appendImmutableAudit({\n      streamKey: `doc:${docId}`,\n      action: \"doc.upload_initiated\",\n      actorUserId: user.id,\n      orgId: user.orgId ?? null,\n      docId,\n      ipHash: ipInfo.ipHash,\n      payload: {\n        encryptionEnabled: true,\n        encAlg: \"AES-256-GCM\",\n        encKeyVersion: activeKeyId,\n        contentType,\n        sizeBytes,\n        filename,\n      },\n    });\n\n    const expiresIn = 10 * 60;\n\n    const putParams: any = {\n      Bucket: r2Bucket,\n      Key: key,\n      ContentType: contentType,\n      Metadata: {\n        \"doc-id\": docId,\n        \"orig-content-type\": contentType,\n        \"orig-ext\": declaredType.ext,\n      },\n    };\n\n    const unhoistableHeaders = new Set([\n      \"content-type\",\n      \"x-amz-meta-doc-id\",\n      \"x-amz-meta-orig-content-type\",\n      \"x-amz-meta-orig-ext\",\n    ]);\n\n    const uploadUrl = await getSignedUrl(r2Client, new PutObjectCommand(putParams), {\n      expiresIn,\n      unhoistableHeaders,\n    });\n\n    return NextResponse.json({\n      ok: true,\n      doc_id: docId,\n      upload_url: uploadUrl,\n      r2_key: key,\n      bucket: r2Bucket,\n      expires_in: expiresIn,\n      upload_headers: {\n        \"content-type\": contentType,\n        \"x-amz-meta-doc-id\": docId,\n        \"x-amz-meta-orig-content-type\": contentType,\n        \"x-amz-meta-orig-ext\": declaredType.ext,\n      },\n    });\n  } catch (err: unknown) {\n    await logSecurityEvent({\n      type: \"upload_presign_error\",\n      severity: \"high\",\n      ip: ipInfo.ip,\n      scope: \"upload_presign\",\n      message: \"Unhandled presign error\",\n      meta: { error: err instanceof Error ? err.message : String(err) },\n    });\n    await detectPresignFailureSpike({ ip: ipInfo.ip });\n    await reportException({\n      error: err,\n      event: \"upload_presign_route_error\",\n      context: { route: \"/api/admin/upload/presign\" },\n    });\n    return NextResponse.json(\n      { ok: false, error: \"SERVER_ERROR\", message: \"Unable to initialize upload.\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\admin\\upload\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\auth\\[...nextauth]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\billing\\checkout\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3870,3873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3870,3873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { requireUser } from \"@/lib/authz\";\nimport { sql } from \"@/lib/db\";\nimport { ensureStripeCustomer, stripeApi } from \"@/lib/stripeClient\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\nimport { getBillingFlags } from \"@/lib/settings\";\n\nfunction baseUrl(req: NextRequest): string {\n  const configured =\n    String(process.env.APP_URL || \"\").trim() ||\n    String(process.env.NEXTAUTH_URL || \"\").trim() ||\n    (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"\");\n  if (configured) return configured.replace(/\\/+$/, \"\");\n  return new URL(req.url).origin.replace(/\\/+$/, \"\");\n}\n\nfunction getProPriceId(): string {\n  const ids = String(process.env.STRIPE_PRO_PRICE_IDS || \"\")\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n  if (!ids.length) throw new Error(\"STRIPE_PRO_PRICE_IDS is not configured\");\n  return ids[0];\n}\n\nasync function readExistingCustomerId(userId: string): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select stripe_customer_id::text as stripe_customer_id\n      from public.users\n      where id = ${userId}::uuid\n      limit 1\n    `) as unknown as Array<{ stripe_customer_id: string | null }>;\n    return rows?.[0]?.stripe_customer_id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nasync function persistCustomerId(userId: string, customerId: string): Promise<void> {\n  try {\n    await sql`\n      update public.users\n      set stripe_customer_id = ${customerId}\n      where id = ${userId}::uuid\n    `;\n  } catch {\n    // optional column in older schemas\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_BILLING_CHECKOUT_MS\", 15_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_admin\");\n        const flags = await getBillingFlags();\n        if (!flags.flags.pricingUiEnabled) {\n          return NextResponse.redirect(new URL(\"/admin/dashboard\", req.url), { status: 303 });\n        }\n\n        const u = await requireUser();\n        const existingCustomerId = await readExistingCustomerId(u.id);\n        const customerId = await ensureStripeCustomer({\n          userId: u.id,\n          email: u.email,\n          existingCustomerId,\n        });\n        if (customerId !== existingCustomerId) {\n          await persistCustomerId(u.id, customerId);\n        }\n\n        const origin = baseUrl(req);\n        const successUrl = `${origin}/admin/upgrade?checkout=success`;\n        const cancelUrl = `${origin}/admin/upgrade?checkout=canceled`;\n        const priceId = getProPriceId();\n\n        const session = await stripeApi(\"checkout/sessions\", {\n          method: \"POST\",\n          body: {\n            mode: \"subscription\",\n            customer: customerId,\n            \"line_items[0][price]\": priceId,\n            \"line_items[0][quantity]\": \"1\",\n            success_url: successUrl,\n            cancel_url: cancelUrl,\n            \"metadata[user_id]\": u.id,\n          },\n        });\n\n        const checkoutUrl = String(session?.url || \"\").trim();\n        if (!checkoutUrl) throw new Error(\"Stripe checkout did not return a session URL\");\n\n        await appendImmutableAudit({\n          streamKey: `user:${u.id}:billing`,\n          action: \"billing.checkout_session.created.viewer\",\n          actorUserId: u.id,\n          orgId: u.orgId ?? null,\n          payload: { customerId, priceId },\n        });\n\n        return NextResponse.redirect(checkoutUrl, { status: 303 });\n      })(),\n      timeoutMs\n    );\n  } catch (e: any) {\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.redirect(new URL(\"/admin/upgrade?error=ENV_MISCONFIGURED\", req.url), { status: 303 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"billing_checkout_timeout\",\n        severity: \"high\",\n        scope: \"billing\",\n        message: \"Viewer checkout session creation exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.redirect(new URL(\"/admin/upgrade?error=TIMEOUT\", req.url), { status: 303 });\n    }\n    const msg = String(e?.message || e || \"checkout_failed\");\n    const safeError =\n      msg === \"FORBIDDEN\" || msg === \"UNAUTHENTICATED\"\n        ? \"FORBIDDEN\"\n        : msg === \"STRIPE_PRO_PRICE_IDS is not configured\"\n          ? \"ENV_MISCONFIGURED\"\n          : \"CHECKOUT_FAILED\";\n    await logSecurityEvent({\n      type: \"billing_checkout_failed\",\n      severity: \"medium\",\n      scope: \"billing\",\n      message: \"Viewer checkout session creation failed\",\n      meta: { code: safeError },\n    });\n    return NextResponse.redirect(new URL(`/admin/upgrade?error=${encodeURIComponent(safeError)}`, req.url), { status: 303 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\aggregate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1209,1212],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1209,1212],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { aggregateDocViewDaily } from \"@/lib/analytics\";\nimport { isCronAuthorized } from \"@/lib/cronAuth\";\nimport { logCronRun } from \"@/lib/cronTelemetry\";\n\nexport async function GET(req: NextRequest) {\n  if (!isCronAuthorized(req)) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: \"UNAUTHORIZED\",\n        hint:\n          \"Set CRON_SECRET in Vercel env vars. Vercel will send it as the Authorization header for cron invocations.\",\n      },\n      { status: 401 }\n    );\n  }\n\n  const startedAt = Date.now();\n\n  // Optional query param: ?daysBack=120\n  const url = new URL(req.url);\n  const daysBackRaw = (url.searchParams.get(\"daysBack\") || \"\").trim();\n  const daysBack = daysBackRaw ? Math.max(1, Math.min(3650, Number(daysBackRaw) || 0)) : undefined;\n\n  try {\n    const aggregate = await aggregateDocViewDaily(daysBack ? { daysBack: Math.floor(daysBack) } : undefined);\n    const duration = Date.now() - startedAt;\n    await logCronRun({\n      job: \"aggregate\",\n      ok: true,\n      durationMs: duration,\n      meta: { aggregated: (aggregate as any)?.aggregated ?? null, daysBack: daysBack ?? null },\n    });\n    return NextResponse.json({\n      ok: true,\n      now: new Date().toISOString(),\n      duration_ms: duration,\n      aggregate,\n    });\n  } catch (e: unknown) {\n    const duration = Date.now() - startedAt;\n    const msg = e instanceof Error ? e.message : String(e);\n    await logCronRun({\n      job: \"aggregate\",\n      ok: false,\n      durationMs: duration,\n      meta: { error: msg, daysBack: daysBack ?? null },\n    });\n    return NextResponse.json({ ok: false, error: \"CRON_AGGREGATE_FAILED\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\billing-sync\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1193,1196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1193,1196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { isCronAuthorized } from \"@/lib/cronAuth\";\nimport { runBillingMaintenance } from \"@/lib/billingSubscription\";\nimport { logCronRun } from \"@/lib/cronTelemetry\";\n\nexport async function GET(req: NextRequest) {\n  if (!isCronAuthorized(req)) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: \"UNAUTHORIZED\",\n        hint:\n          \"Set CRON_SECRET in Vercel env vars. Vercel will send it as the Authorization header for cron invocations.\",\n      },\n      { status: 401 }\n    );\n  }\n\n  const startedAt = Date.now();\n  try {\n    const result = await runBillingMaintenance({\n      maxUsers: Math.max(1, Math.min(5000, Number(process.env.BILLING_MAINTENANCE_MAX_USERS || 500))),\n    });\n\n    const duration = Date.now() - startedAt;\n    await logCronRun({\n      job: \"billing-sync\",\n      ok: Boolean(result.ok),\n      durationMs: duration,\n      meta: result,\n    });\n\n    return NextResponse.json({\n      ok: true,\n      now: new Date().toISOString(),\n      duration_ms: duration,\n      billing_sync: result,\n    });\n  } catch (e: any) {\n    const duration = Date.now() - startedAt;\n    const msg = String(e?.message || e || \"failed\");\n    await logCronRun({\n      job: \"billing-sync\",\n      ok: false,\n      durationMs: duration,\n      meta: { error: msg },\n    });\n    return NextResponse.json({ ok: false, error: \"CRON_BILLING_SYNC_FAILED\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\key-rotation\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\nightly\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3887,3890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3887,3890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3939,3942],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3939,3942],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4000,4003],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4000,4003],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":114,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4123,4126],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4123,4126],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":115,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":115,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4195,4198],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4195,4198],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { aggregateDocViewDaily } from \"@/lib/analytics\";\nimport { runRetention } from \"@/lib/retention\";\nimport { sendExpirationAlerts } from \"@/lib/expirationAlerts\";\nimport { runAutomatedKeyRotation } from \"@/lib/keyRotation\";\nimport { migrateLegacyEncryptionBatch } from \"@/lib/encryptionMigration\";\nimport { runBackupRecoveryCheck } from \"@/lib/backupRecovery\";\nimport { processKeyRotationJobs } from \"@/lib/keyRotationJobs\";\nimport { revokeExpiredSharesBatch } from \"@/lib/shareLifecycle\";\nimport { runUsageMaintenance } from \"@/lib/usageMaintenance\";\nimport {\n  detectAliasAccessDeniedSpike,\n  detectDbErrorSpike,\n  detectScanFailureSpike,\n  detectTokenAccessDeniedSpike,\n  detectUploadCompletionSpike,\n  detectViewSpike,\n  logSecurityEvent,\n} from \"@/lib/securityTelemetry\";\nimport { logCronRun } from \"@/lib/cronTelemetry\";\nimport { runBillingMaintenance } from \"@/lib/billingSubscription\";\n\nimport { isCronAuthorized } from \"@/lib/cronAuth\";\n\nexport async function GET(req: NextRequest) {\n  if (!isCronAuthorized(req)) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: \"UNAUTHORIZED\",\n        hint:\n          \"Set CRON_SECRET in Vercel env vars. Vercel will send it as the Authorization header for cron invocations.\",\n      },\n      { status: 401 }\n    );\n  }\n\n  const startedAt = Date.now();\n  try {\n\n  // 1) Aggregate daily view counts\n  const aggregate = await aggregateDocViewDaily();\n\n  // 2) Retention cleanup for raw/high-volume tables\n  const retention = await runRetention();\n\n  // 3) Expiration alert emails + in-app notifications\n  const expiration_alerts = await sendExpirationAlerts();\n\n  // 4) Optional automated key rotation\n  const key_rotation = await runAutomatedKeyRotation();\n  const key_rotation_jobs = await processKeyRotationJobs({\n    maxJobs: Math.max(1, Math.min(25, Number(process.env.KEY_ROTATION_CRON_MAX_JOBS || 5))),\n  });\n\n  // 5) Optional legacy encryption migration batch\n  const legacy_migration_enabled = [\"1\", \"true\", \"yes\", \"on\"].includes(\n    String(process.env.LEGACY_MIGRATION_ENABLED || \"\").trim().toLowerCase()\n  );\n  const legacy_encryption_migration = legacy_migration_enabled\n    ? await migrateLegacyEncryptionBatch({\n        limit: Math.max(1, Math.min(250, Number(process.env.LEGACY_MIGRATION_BATCH || 25))),\n        dryRun: false,\n      })\n    : { enabled: false };\n\n  // 6) Auto-disable expired shares so plan limits count strictly by active records\n  const expiredSharesRevoked = await revokeExpiredSharesBatch(\n    Math.max(1, Math.min(5000, Number(process.env.EXPIRED_SHARES_REVOKE_BATCH || 1000)))\n  );\n\n  // 7) Monthly usage maintenance/reset hygiene\n  const usage_maintenance = await runUsageMaintenance();\n\n  // 8) Optional backup + recovery checks\n  const backup_recovery = await runBackupRecoveryCheck();\n\n  // 9) Billing entitlement maintenance (grace expiry / plan sync)\n  const billing_sync = await runBillingMaintenance({\n    maxUsers: Math.max(1, Math.min(5000, Number(process.env.BILLING_MAINTENANCE_MAX_USERS || 500))),\n  });\n\n  // 10) Spike alerting rollups (best-effort)\n  await detectScanFailureSpike();\n  await detectUploadCompletionSpike();\n  await detectDbErrorSpike();\n  await detectAliasAccessDeniedSpike({});\n  await detectTokenAccessDeniedSpike({});\n  await detectViewSpike();\n\n  if (expiredSharesRevoked.revoked > 0) {\n    await logSecurityEvent({\n      type: \"expired_shares_auto_revoked\",\n      severity: \"low\",\n      scope: \"cron_nightly\",\n      message: \"Auto-revoked expired share tokens\",\n      meta: { revoked: expiredSharesRevoked.revoked },\n    });\n  }\n\n  const duration = Date.now() - startedAt;\n  await logCronRun({\n    job: \"nightly\",\n    ok: true,\n    durationMs: duration,\n    meta: {\n      aggregateOk: Boolean((aggregate as any)?.ok),\n      retentionOk: Boolean((retention as any)?.ok),\n      keyRotationProcessed: (key_rotation_jobs as any)?.processed ?? null,\n      revokedExpiredShares: expiredSharesRevoked.revoked,\n      backupStatus: (backup_recovery as any)?.backupStatus ?? null,\n      billingUsersScanned: (billing_sync as any)?.usersScanned ?? null,\n    },\n  });\n  return NextResponse.json({\n    ok: true,\n    now: new Date().toISOString(),\n    duration_ms: duration,\n    aggregate,\n    retention,\n    expiration_alerts,\n    key_rotation,\n    key_rotation_jobs,\n    legacy_encryption_migration,\n    expired_shares_revoked: expiredSharesRevoked,\n    usage_maintenance,\n    backup_recovery,\n    billing_sync,\n  });\n  } catch (e: unknown) {\n    const duration = Date.now() - startedAt;\n    const msg = e instanceof Error ? e.message : String(e);\n    await logCronRun({\n      job: \"nightly\",\n      ok: false,\n      durationMs: duration,\n      meta: { error: msg },\n    });\n    return NextResponse.json({ ok: false, error: \"CRON_NIGHTLY_FAILED\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\retention\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\scan\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\cron\\webhooks\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1263,1266],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1263,1266],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1315,1318],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1315,1318],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1364,1367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1364,1367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { processWebhookDeliveries } from \"@/lib/webhooks\";\nimport { logCronRun } from \"@/lib/cronTelemetry\";\n\nfunction isAuthorized(req: NextRequest): boolean {\n  const secret = (process.env.CRON_SECRET || \"\").trim();\n  if (!secret) return false;\n\n  const auth = (req.headers.get(\"authorization\") || \"\").trim();\n  if (!auth) return false;\n\n  if (auth === secret) return true;\n  if (auth.toLowerCase().startsWith(\"bearer \") && auth.slice(7).trim() === secret) return true;\n  return false;\n}\n\nexport async function GET(req: NextRequest) {\n  if (!isAuthorized(req)) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: \"UNAUTHORIZED\",\n        hint:\n          \"Set CRON_SECRET in Vercel env vars. Vercel will send it as the Authorization header for cron invocations.\",\n      },\n      { status: 401 }\n    );\n  }\n\n  const startedAt = Date.now();\n  try {\n    const res = await processWebhookDeliveries({ maxBatch: 25, maxAttempts: 8 });\n    const duration = Date.now() - startedAt;\n    await logCronRun({\n      job: \"webhooks\",\n      ok: true,\n      durationMs: duration,\n      meta: {\n        attempted: (res as any)?.attempted ?? null,\n        delivered: (res as any)?.delivered ?? null,\n        failed: (res as any)?.failed ?? null,\n      },\n    });\n    return NextResponse.json({\n      ...res,\n      now: new Date().toISOString(),\n      duration_ms: duration,\n    });\n  } catch (e: unknown) {\n    const duration = Date.now() - startedAt;\n    const msg = e instanceof Error ? e.message : String(e);\n    await logCronRun({\n      job: \"webhooks\",\n      ok: false,\n      durationMs: duration,\n      meta: { error: msg },\n    });\n    return NextResponse.json({ ok: false, error: \"CRON_WEBHOOKS_FAILED\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\debug\\alias\\[alias]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[619,622],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[619,622],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1043,1046],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1043,1046],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { sql } from \"@/lib/db\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nexport async function GET(\n  _req: Request,\n  context: { params: Promise<{ alias: string }> }\n) {\n  const { alias: rawAlias } = await context.params;\n  const alias = decodeURIComponent(rawAlias || \"\").trim().toLowerCase();\n\n  if (!alias) {\n    return NextResponse.json(\n      { ok: false, error: \"missing_alias\" },\n      { status: 400 }\n    );\n  }\n\n  const dbInfo = await sql`\n    select current_database() as db, current_schema() as schema\n  `;\n\n  let rowDocAliases: any[] = [];\n  try {\n    rowDocAliases = await sql`\n    select\n      'doc_aliases'::text as source_table,\n      alias,\n      doc_id::text as doc_id,\n      is_active,\n      revoked_at::text as revoked_at,\n      expires_at::text as expires_at,\n      created_at::text as created_at\n    from public.doc_aliases\n    where lower(alias) = ${alias}\n    limit 1\n  `;\n  } catch {\n    rowDocAliases = [];\n  }\n\n  let rowDocumentAliases: any[] = [];\n  try {\n    rowDocumentAliases = await sql`\n    select\n      'document_aliases'::text as source_table,\n      alias,\n      doc_id::text as doc_id,\n      null::bool as is_active,\n      null::text as revoked_at,\n      expires_at::text as expires_at,\n      created_at::text as created_at\n    from public.document_aliases\n    where lower(alias) = ${alias}\n    limit 1\n  `;\n  } catch {\n    // table may not exist in some environments; ignore\n    rowDocumentAliases = [];\n\n  }\n\n  const row = rowDocAliases?.[0] ?? rowDocumentAliases?.[0] ?? null;\n\n  return NextResponse.json({\n    ok: true,\n    alias,\n    db: dbInfo?.[0] ?? null,\n    found: !!row,\n    row,\n  });\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\health\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\stripe\\webhook\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1159,1162],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1159,1162],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":197,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":197,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7639,7642],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7639,7642],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { verifyStripeWebhookSignature } from \"@/lib/stripeWebhook\";\nimport {\n  beginWebhookEvent,\n  billingTablesReady,\n  completeWebhookEvent,\n  getUserIdByStripeCustomerId,\n  markPaymentFailure,\n  markPaymentSucceeded,\n  syncUserPlanFromSubscription,\n  unixToIso,\n  upsertStripeSubscription,\n} from \"@/lib/billingSubscription\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport {\n  enforceGlobalApiRateLimit,\n  enforceIpAbuseBlock,\n  logDbErrorEvent,\n  logSecurityEvent,\n  maybeBlockIpOnAbuse,\n} from \"@/lib/securityTelemetry\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nfunction planFromStripePriceId(priceId: string | null): \"free\" | \"pro\" {\n  const proPrices = String(process.env.STRIPE_PRO_PRICE_IDS || \"\")\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n  if (priceId && proPrices.includes(priceId)) return \"pro\";\n  return \"free\";\n}\n\nfunction getSubPriceId(obj: any): string | null {\n  try {\n    const arr = obj?.items?.data;\n    if (!Array.isArray(arr) || arr.length === 0) return null;\n    return String(arr[0]?.price?.id || \"\").trim() || null;\n  } catch {\n    return null;\n  }\n}\n\nfunction getGraceDays(): number {\n  const n = Number(process.env.STRIPE_GRACE_DAYS || 7);\n  if (!Number.isFinite(n)) return 7;\n  return Math.max(0, Math.floor(n));\n}\n\nexport async function POST(req: NextRequest) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_STRIPE_WEBHOOK_MS\", 15_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"stripe_webhook\");\n        const abuseBlock = await enforceIpAbuseBlock({ req, scope: \"billing_webhook\" });\n        if (!abuseBlock.ok) {\n          return NextResponse.json(\n            { ok: false, error: \"ABUSE_BLOCKED\" },\n            { status: 403, headers: { \"Retry-After\": String(abuseBlock.retryAfterSeconds) } }\n          );\n        }\n        const webhookRl = await enforceGlobalApiRateLimit({\n          req,\n          scope: \"ip:stripe_webhook\",\n          limit: Number(process.env.RATE_LIMIT_STRIPE_WEBHOOK_IP_PER_MIN || 300),\n          windowSeconds: 60,\n          strict: true,\n        });\n        if (!webhookRl.ok) {\n          return NextResponse.json(\n            { ok: false, error: \"RATE_LIMIT\" },\n            { status: webhookRl.status, headers: { \"Retry-After\": String(webhookRl.retryAfterSeconds) } }\n          );\n        }\n\n        const rawBody = await req.text();\n        const signature = req.headers.get(\"stripe-signature\");\n        const verified = verifyStripeWebhookSignature({\n          rawBody,\n          signatureHeader: signature,\n          secret: process.env.STRIPE_WEBHOOK_SECRET ?? null,\n          toleranceSeconds: Number(process.env.STRIPE_WEBHOOK_TOLERANCE_SECONDS || 300),\n        });\n\n        if (!verified.ok) {\n          const ip = req.headers.get(\"x-forwarded-for\") || null;\n          await logSecurityEvent({\n            type: \"stripe_webhook_invalid_signature\",\n            severity: \"high\",\n            ip,\n            scope: \"billing_webhook\",\n            message: verified.error,\n          });\n          if (ip) {\n            await maybeBlockIpOnAbuse({\n              ip,\n              category: \"stripe_webhook_invalid_signature\",\n              scope: \"billing_webhook\",\n              threshold: Number(process.env.ABUSE_BLOCK_STRIPE_SIG_THRESHOLD || 15),\n              windowSeconds: Number(process.env.ABUSE_BLOCK_STRIPE_SIG_WINDOW_SECONDS || 600),\n              blockSeconds: Number(process.env.ABUSE_BLOCK_TTL_SECONDS || 3600),\n              reason: \"Repeated invalid Stripe webhook signatures\",\n            });\n          }\n          return NextResponse.json({ ok: false, error: \"INVALID_SIGNATURE\" }, { status: 400 });\n        }\n\n        const ready = await billingTablesReady();\n        if (!ready) {\n          return NextResponse.json({ ok: false, error: \"BILLING_TABLES_NOT_READY\" }, { status: 503 });\n        }\n\n        const dedupe = await beginWebhookEvent(verified.eventId, verified.eventType, verified.payload);\n        if (dedupe === \"duplicate\") {\n          return NextResponse.json({ ok: true, duplicate: true });\n        }\n\n        const event = verified.payload;\n        const obj = event?.data?.object ?? {};\n        const eventType = String(event?.type || \"\");\n        const eventCreatedUnix = Number.isFinite(Number(event?.created))\n          ? Math.max(0, Math.floor(Number(event.created)))\n          : null;\n\n        let webhookStatus: \"processed\" | \"ignored\" | \"failed\" = \"processed\";\n        let webhookMessage: string | null = null;\n\n        try {\n          if (\n            eventType === \"customer.subscription.created\" ||\n            eventType === \"customer.subscription.updated\" ||\n            eventType === \"customer.subscription.deleted\"\n          ) {\n            const stripeSubscriptionId = String(obj?.id || \"\").trim();\n            const stripeCustomerId = String(obj?.customer || \"\").trim() || null;\n            const metadataUserId = String(obj?.metadata?.user_id || \"\").trim() || null;\n            const userId = metadataUserId || (await getUserIdByStripeCustomerId(stripeCustomerId));\n\n            const status = String(obj?.status || (eventType.endsWith(\".deleted\") ? \"canceled\" : \"incomplete\")).toLowerCase();\n            const planId = planFromStripePriceId(getSubPriceId(obj));\n            const currentPeriodEnd = unixToIso(obj?.current_period_end);\n            const cancelAtPeriodEnd = Boolean(obj?.cancel_at_period_end);\n\n            await upsertStripeSubscription({\n              userId,\n              stripeCustomerId,\n              stripeSubscriptionId,\n              status,\n              planId,\n              currentPeriodEnd,\n              cancelAtPeriodEnd,\n              graceUntil: null,\n              eventCreatedUnix,\n            });\n\n            if (userId) {\n              await syncUserPlanFromSubscription(userId);\n            }\n          } else if (eventType === \"invoice.payment_failed\") {\n            const stripeSubscriptionId = String(obj?.subscription || \"\").trim() || null;\n            const stripeCustomerId = String(obj?.customer || \"\").trim() || null;\n            const userId = await getUserIdByStripeCustomerId(stripeCustomerId);\n            await markPaymentFailure({\n              stripeSubscriptionId,\n              stripeCustomerId,\n              graceDays: getGraceDays(),\n              eventCreatedUnix,\n            });\n            if (userId) await syncUserPlanFromSubscription(userId);\n          } else if (eventType === \"invoice.payment_succeeded\") {\n            const stripeSubscriptionId = String(obj?.subscription || \"\").trim() || null;\n            const stripeCustomerId = String(obj?.customer || \"\").trim() || null;\n            const userId = await getUserIdByStripeCustomerId(stripeCustomerId);\n            await markPaymentSucceeded({\n              stripeSubscriptionId,\n              stripeCustomerId,\n              eventCreatedUnix,\n            });\n            if (userId) await syncUserPlanFromSubscription(userId);\n          } else {\n            webhookStatus = \"ignored\";\n            webhookMessage = `Unhandled event type: ${eventType}`;\n          }\n\n          await appendImmutableAudit({\n            streamKey: \"billing:stripe_webhook\",\n            action: `billing.stripe.${eventType}`,\n            subjectId: verified.eventId,\n            payload: {\n              eventType,\n            },\n          });\n        } catch (e: any) {\n          webhookStatus = \"failed\";\n          webhookMessage = String(e?.message || e || \"webhook_failed\");\n          await logDbErrorEvent({\n            scope: \"billing_webhook\",\n            message: webhookMessage,\n            ip: req.headers.get(\"x-forwarded-for\") || null,\n            meta: { route: \"/api/stripe/webhook\", eventType, eventId: verified.eventId },\n          });\n          await logSecurityEvent({\n            type: \"stripe_webhook_processing_failed\",\n            severity: \"high\",\n            ip: req.headers.get(\"x-forwarded-for\") || null,\n            scope: \"billing_webhook\",\n            message: webhookMessage,\n            meta: { eventType, eventId: verified.eventId },\n          });\n        }\n\n        await completeWebhookEvent(verified.eventId, webhookStatus, webhookMessage);\n\n        if (webhookStatus === \"failed\") {\n          return NextResponse.json({ ok: false, error: \"WEBHOOK_PROCESSING_FAILED\" }, { status: 500 });\n        }\n\n        return NextResponse.json({ ok: true, status: webhookStatus });\n      })(),\n      timeoutMs\n    );\n  } catch (e: unknown) {\n    if (e instanceof Error) {\n      await logDbErrorEvent({\n        scope: \"billing_webhook\",\n        message: e.message,\n        ip: req.headers.get(\"x-forwarded-for\") || null,\n        meta: { route: \"/api/stripe/webhook\" },\n      });\n    }\n    if (isRuntimeEnvError(e)) {\n      return NextResponse.json({ ok: false, error: \"ENV_MISCONFIGURED\" }, { status: 503 });\n    }\n    if (isRouteTimeoutError(e)) {\n      await logSecurityEvent({\n        type: \"stripe_webhook_timeout\",\n        severity: \"high\",\n        ip: req.headers.get(\"x-forwarded-for\") || null,\n        scope: \"billing_webhook\",\n        message: \"Stripe webhook processing exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return NextResponse.json({ ok: false, error: \"TIMEOUT\" }, { status: 504 });\n    }\n    throw e;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\abuse\\report\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\aliases\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1029,1032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1029,1032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { sql } from \"@/lib/db\";\nimport { verifyApiKeyFromRequest } from \"@/lib/apiAuth\";\nimport { emitWebhook } from \"@/lib/webhooks\";\nimport { clientIpKey, enforceGlobalApiRateLimit } from \"@/lib/securityTelemetry\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nexport async function POST(req: NextRequest) {\n  const ipInfo = clientIpKey(req);\n  const rl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:api\",\n    limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n    windowSeconds: 60,\n  });\n  if (!rl.ok) {\n    return NextResponse.json(\n      { ok: false, error: \"RATE_LIMIT\" },\n      { status: rl.status, headers: { \"Retry-After\": String(rl.retryAfterSeconds) } }\n    );\n  }\n\n  const auth = await verifyApiKeyFromRequest(req);\n  if (!auth.ok) {\n    return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });\n  }\n\n  let body: any = null;\n  try {\n    body = await req.json();\n  } catch {\n    return NextResponse.json({ ok: false, error: \"INVALID_JSON\" }, { status: 400 });\n  }\n\n  const docId = String(body?.doc_id || body?.docId || \"\").trim();\n  const alias = String(body?.alias || \"\").trim();\n  if (!docId) return NextResponse.json({ ok: false, error: \"MISSING_DOC_ID\" }, { status: 400 });\n  if (!alias) return NextResponse.json({ ok: false, error: \"MISSING_ALIAS\" }, { status: 400 });\n  if (!/^[a-zA-Z0-9_-]{3,80}$/.test(alias)) {\n    return NextResponse.json({ ok: false, error: \"INVALID_ALIAS\" }, { status: 400 });\n  }\n\n  const owns = (await sql`\n    select 1\n    from public.docs\n    where id = ${docId}::uuid\n      and owner_id = ${auth.ownerId}::uuid\n    limit 1\n  `) as unknown as Array<{ \"?column?\": number }>;\n  if (!owns.length) return NextResponse.json({ ok: false, error: \"FORBIDDEN\" }, { status: 403 });\n\n  const created = (await sql`\n    insert into public.doc_aliases (alias, doc_id)\n    values (${alias}, ${docId}::uuid)\n    on conflict (alias) do nothing\n    returning alias::text as alias\n  `) as unknown as Array<{ alias: string }>;\n  if (!created.length) {\n    return NextResponse.json({ ok: false, error: \"ALIAS_TAKEN\" }, { status: 409 });\n  }\n\n  emitWebhook(\"alias.created\", { alias, doc_id: docId, created_via: \"api\" });\n  await appendImmutableAudit(\n    {\n      streamKey: `doc:${docId}`,\n      action: \"doc.alias_created\",\n      actorUserId: auth.ownerId,\n      docId,\n      subjectId: alias,\n      ipHash: ipInfo.ipHash,\n      payload: {\n        alias,\n        via: \"api\",\n      },\n    },\n    { strict: true }\n  );\n\n  return NextResponse.json({ ok: true, alias, doc_id: docId });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\docs\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\shares\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1299,1302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1299,1302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3479,3482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3479,3482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport bcrypt from \"bcryptjs\";\nimport { sql } from \"@/lib/db\";\nimport { verifyApiKeyFromRequest } from \"@/lib/apiAuth\";\nimport { emitWebhook } from \"@/lib/webhooks\";\nimport { assertCanCreateShare, getPlanForUser, normalizeExpiresAtForPlan, normalizeMaxViewsForPlan } from \"@/lib/monetization\";\nimport crypto from \"crypto\";\nimport { clientIpKey, enforceGlobalApiRateLimit } from \"@/lib/securityTelemetry\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nfunction newToken(): string {\n  return crypto.randomBytes(16).toString(\"hex\");\n}\n\nexport async function POST(req: NextRequest) {\n  const ipInfo = clientIpKey(req);\n  const rl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:api\",\n    limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n    windowSeconds: 60,\n  });\n  if (!rl.ok) {\n    return NextResponse.json(\n      { ok: false, error: \"RATE_LIMIT\" },\n      { status: rl.status, headers: { \"Retry-After\": String(rl.retryAfterSeconds) } }\n    );\n  }\n\n  const auth = await verifyApiKeyFromRequest(req);\n  if (!auth.ok) {\n    return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });\n  }\n\n  let body: any = null;\n  try {\n    body = await req.json();\n  } catch {\n    return NextResponse.json({ ok: false, error: \"INVALID_JSON\" }, { status: 400 });\n  }\n\n  const docId = String(body?.doc_id || body?.docId || \"\").trim();\n  if (!docId) return NextResponse.json({ ok: false, error: \"MISSING_DOC_ID\" }, { status: 400 });\n\n  // Ensure ownership\n  const owns = (await sql`\n    select 1\n    from public.docs\n    where id = ${docId}::uuid\n      and owner_id = ${auth.ownerId}::uuid\n    limit 1\n  `) as unknown as Array<{ \"?column?\": number }>;\n  if (!owns.length) return NextResponse.json({ ok: false, error: \"FORBIDDEN\" }, { status: 403 });\n\n\n// --- Monetization / plan limits (hidden) ---\nconst shareAllowed = await assertCanCreateShare(auth.ownerId);\nif (!shareAllowed.ok) {\n  return NextResponse.json(\n    { ok: false, error: \"PAYMENT_REQUIRED\", message: shareAllowed.message || \"Upgrade required for more active shares.\" },\n    { status: 402 }\n  );\n}\nconst plan = await getPlanForUser(auth.ownerId);\n\n  const toEmailRaw = String(body?.to_email || body?.toEmail || \"\").trim();\n  const toEmail = toEmailRaw ? toEmailRaw.toLowerCase() : null;\n\n  const expiresAtRaw = String(body?.expires_at || body?.expiresAt || \"\").trim();\n  const expiresAt = expiresAtRaw && !Number.isNaN(Date.parse(expiresAtRaw)) ? new Date(expiresAtRaw).toISOString() : null;\n\n  const normalizedExpiresAt = normalizeExpiresAtForPlan({ plan, requestedExpiresAtIso: expiresAt, defaultDaysIfNotAllowed: 30 });\n\n  const maxViewsRaw = body?.max_views ?? body?.maxViews;\n  const maxViewsNum = maxViewsRaw === null || maxViewsRaw === undefined ? null : Number(maxViewsRaw);\n  const requestedMaxViews =\n    maxViewsNum !== null && Number.isFinite(maxViewsNum) ? Math.max(0, Math.floor(maxViewsNum)) : null;\n  const maxViews = normalizeMaxViewsForPlan({ plan, requestedMaxViews });\n\n  const passwordRaw = String(body?.password || \"\").trim();\n  const passwordHash = passwordRaw ? await bcrypt.hash(passwordRaw, 12) : null;\n\n  const allowedCountriesRaw = body?.allowed_countries ?? body?.allowedCountries ?? null;\nconst blockedCountriesRaw = body?.blocked_countries ?? body?.blockedCountries ?? null;\n\nconst normCountries = (v: any): string[] | null => {\n  if (v == null) return null;\n  const arr = Array.isArray(v) ? v : String(v).split(/[,\\s]+/g);\n  const out = arr\n    .map((x) => String(x || \"\").trim().toUpperCase())\n    .filter((x) => /^[A-Z]{2}$/.test(x));\n  return out.length ? out : [];\n};\n\nconst allowedCountries = normCountries(allowedCountriesRaw);\nconst blockedCountries = normCountries(blockedCountriesRaw);\n\nconst watermarkEnabledRaw = body?.watermark_enabled ?? body?.watermarkEnabled ?? null;\nconst watermarkEnabled =\n  watermarkEnabledRaw == null ? null : Boolean(watermarkEnabledRaw);\n\nconst watermarkTextRaw = String(body?.watermark_text ?? body?.watermarkText ?? \"\").trim();\nconst watermarkText = watermarkTextRaw ? watermarkTextRaw.slice(0, 400) : null;\n\nconst token = newToken();\n  // Newer schema supports geo + watermark columns; fall back silently if not present.\ntry {\n  await sql`\n    insert into public.share_tokens\n      (token, doc_id, to_email, expires_at, max_views, password_hash, allowed_countries, blocked_countries, watermark_enabled, watermark_text)\n    values\n      (${token}, ${docId}::uuid, ${toEmail}, ${normalizedExpiresAt}, ${maxViews}, ${passwordHash}, ${allowedCountries}, ${blockedCountries}, ${watermarkEnabled ?? false}, ${watermarkText})\n  `;\n} catch {\n  await sql`\n    insert into public.share_tokens (token, doc_id, to_email, expires_at, max_views, password_hash)\n    values (${token}, ${docId}::uuid, ${toEmail}, ${normalizedExpiresAt}, ${maxViews}, ${passwordHash})\n  `;\n}\n\nconst base = (process.env.BASE_URL || process.env.NEXTAUTH_URL || (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"http://localhost:3000\")).replace(/\\/+$/, \"\");\n  const url = `${base}/s/${token}`;\n\n  emitWebhook(\"share.created\", {\n    token,\n    doc_id: docId,\n    to_email: toEmail,\n    expires_at: normalizedExpiresAt,\n    max_views: maxViews,\n    has_password: !!passwordHash,\n    created_via: \"api\",\n  });\n\n  await appendImmutableAudit({\n    streamKey: `doc:${docId}`,\n    action: \"share.create\",\n    actorUserId: auth.ownerId,\n    docId,\n    subjectId: token,\n    ipHash: ipInfo.ipHash,\n    payload: {\n      toEmail,\n      expiresAt: normalizedExpiresAt,\n      maxViews,\n      hasPassword: Boolean(passwordHash),\n      allowedCountries,\n      blockedCountries,\n      watermarkEnabled: watermarkEnabled ?? false,\n      watermarkText: watermarkText ?? null,\n      via: \"api\",\n    },\n  });\n\n  return NextResponse.json({ ok: true, token, url });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\takedown\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[668,671],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[668,671],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":1,"message":"'shareToken' is never reassigned. Use 'const' instead.","line":64,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":64,"endColumn":32,"fix":{"range":[2096,2142],"text":"const shareToken: string | null = token || null;"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"// src/app/api/v1/takedown/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { sql } from \"@/lib/db\";\nimport { enforceGlobalApiRateLimit, clientIpKey, logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { resolveShareMeta, resolveDoc } from \"@/lib/resolveDoc\";\n\ntype Body = {\n  token?: string | null;\n  alias?: string | null;\n  doc_id?: string | null;\n\n  requester_name?: string | null;\n  requester_email?: string | null;\n  claimant_company?: string | null;\n\n  message?: string | null;\n  statement?: string | null;\n  signature?: string | null;\n};\n\nfunction norm(s: any, max = 4000): string | null {\n  const v = String(s ?? \"\").trim();\n  if (!v) return null;\n  return v.length > max ? v.slice(0, max) : v;\n}\n\nexport async function POST(req: NextRequest) {\n  // Basic global throttle\n  const globalRl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:api\",\n    limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n    windowSeconds: 60,\n  });\n  if (!globalRl.ok) {\n    return NextResponse.json({ ok: false, error: \"RATE_LIMITED\" }, { status: 429 });\n  }\n\n  const ipInfo = clientIpKey(req);\n  const body = (await req.json().catch(() => null)) as Body | null;\n  if (!body) return NextResponse.json({ ok: false, error: \"BAD_JSON\" }, { status: 400 });\n\n  const token = norm(body.token, 256);\n  const alias = norm(body.alias, 256)?.toLowerCase() ?? null;\n  const docIdInput = norm(body.doc_id, 128);\n\n  const requesterName = norm(body.requester_name, 256);\n  const requesterEmail = norm(body.requester_email, 256)?.toLowerCase() ?? null;\n  const claimantCompany = norm(body.claimant_company, 256);\n\n  const message = norm(body.message, 8000);\n  const statement = norm(body.statement, 8000);\n  const signature = norm(body.signature, 512);\n\n  if (!token && !alias && !docIdInput) {\n    return NextResponse.json({ ok: false, error: \"MISSING_TARGET\" }, { status: 400 });\n  }\n\n  // Resolve to doc_id (best-effort). Prefer token -> alias -> explicit.\n  let docId: string | null = null;\n  let shareToken: string | null = token || null;\n\n  try {\n    if (token) {\n      const meta = await resolveShareMeta(token);\n      if (meta.ok) docId = meta.docId;\n    } else if (alias) {\n      const r = await resolveDoc({ alias });\n      if (r.ok) docId = r.docId;\n    } else if (docIdInput) {\n      docId = docIdInput;\n    }\n  } catch {\n    // ignore resolution errors; we still store notice\n  }\n\n  const rows = (await sql`\n    insert into public.dmca_notices (\n      doc_id, share_token,\n      requester_name, requester_email, claimant_company,\n      message, statement, signature,\n      ip_hash, user_agent\n    )\n    values (\n      ${docId ? sql`${docId}::uuid` : sql`null`},\n      ${shareToken},\n      ${requesterName}, ${requesterEmail}, ${claimantCompany},\n      ${message}, ${statement}, ${signature},\n      ${ipInfo.ipHash},\n      ${req.headers.get(\"user-agent\") || \"\"}\n    )\n    returning id::text as id\n  `) as unknown as Array<{ id: string }>;\n\n  const noticeId = rows?.[0]?.id ?? null;\n\n  // Put doc into quarantine while pending review (if we could resolve it).\n  if (docId) {\n    await sql`\n      update public.docs\n      set\n        dmca_status = 'pending',\n        dmca_last_notice_id = ${noticeId ? sql`${noticeId}::uuid` : sql`null`},\n        moderation_status = 'quarantined',\n        disabled_reason = coalesce(disabled_reason, 'dmca:pending')\n      where id = ${docId}::uuid\n    `;\n  }\n\n  await logSecurityEvent({\n    type: \"dmca_notice_submitted\",\n    severity: \"medium\",\n    ip: ipInfo.ip,\n    docId: docId || undefined,\n    scope: \"dmca\",\n    message: \"DMCA/takedown notice submitted\",\n    meta: { noticeId, hasDocId: !!docId, hasToken: !!token, hasAlias: !!alias },\n  });\n\n  return NextResponse.json({ ok: true, id: noticeId });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\v1\\webhooks\\test\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[933,936],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[933,936],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2515,2518],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2515,2518],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { sql } from \"@/lib/db\";\nimport { verifyApiKeyFromRequest } from \"@/lib/apiAuth\";\nimport { processWebhookDeliveries } from \"@/lib/webhooks\";\nimport { enforceGlobalApiRateLimit } from \"@/lib/securityTelemetry\";\n\nexport async function POST(req: NextRequest) {\n  const rl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:api\",\n    limit: Number(process.env.RATE_LIMIT_API_IP_PER_MIN || 240),\n    windowSeconds: 60,\n  });\n  if (!rl.ok) {\n    return NextResponse.json(\n      { ok: false, error: \"RATE_LIMIT\" },\n      { status: rl.status, headers: { \"Retry-After\": String(rl.retryAfterSeconds) } }\n    );\n  }\n\n  const auth = await verifyApiKeyFromRequest(req);\n  if (!auth.ok) {\n    return NextResponse.json({ ok: false, error: auth.error }, { status: auth.status });\n  }\n\n  let body: any = null;\n  try {\n    body = await req.json();\n  } catch {\n    body = {};\n  }\n\n  const webhookId = String(body?.webhook_id || body?.webhookId || \"\").trim() || null;\n\n  // Load hooks\n  const hooks = webhookId\n    ? ((await sql`\n        select id::text as id\n        from public.webhooks\n        where owner_id = ${auth.ownerId}::uuid\n          and enabled = true\n          and id = ${webhookId}::uuid\n        limit 1\n      `) as unknown as Array<{ id: string }> )\n    : ((await sql`\n        select id::text as id\n        from public.webhooks\n        where owner_id = ${auth.ownerId}::uuid\n          and enabled = true\n        order by created_at desc\n        limit 50\n      `) as unknown as Array<{ id: string }>);\n\n  if (!hooks.length) {\n    return NextResponse.json({ ok: false, error: \"NO_WEBHOOKS\" }, { status: 404 });\n  }\n\n  // Enqueue a test event for each (preferred). If queue is unavailable, return 501.\n  try {\n    for (const h of hooks) {\n      const payload = {\n        test: true,\n        message: body?.message || \"Hello from cyang.io\",\n        requested_at: new Date().toISOString(),\n        api_key_prefix: auth.prefix,\n      };\n\n      await sql`\n        insert into public.webhook_deliveries (webhook_id, owner_id, event, payload)\n        values (${h.id}::uuid, ${auth.ownerId}::uuid, 'webhook.test', ${JSON.stringify(payload)}::jsonb)\n      `;\n    }\n\n    // Small immediate attempt\n    const delivered = await processWebhookDeliveries({ maxBatch: 10, maxAttempts: 8 });\n    return NextResponse.json({ ok: true, enqueued: hooks.length, delivered });\n  } catch (e: any) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: \"DELIVERY_QUEUE_UNAVAILABLE\",\n        hint: \"Run scripts/sql/webhooks.sql to create public.webhook_deliveries, and configure /api/cron/webhooks\",\n        details: String(e?.message || e || \"failed\"),\n      },\n      { status: 501 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\api\\viewer\\office\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\auth\\email\\consume\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DocSession' is defined but never used.","line":5,"column":6,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\nimport { cookieHeader } from \"@/lib/cookies\";\nimport { hmacSha256Hex, signPayload } from \"@/lib/crypto\";\n\ntype DocSession = { grant_id: number; exp: number };\n\ntype LoginTokenRow = {\n  id: number;\n  email: string;\n  expires_at: string;\n  use_count: number;\n  max_uses: number;\n  revoked_at: string | null;\n  alias: string;\n};\n\ntype DocAliasRow = { doc_id: string; is_active: boolean };\ntype GrantRow = { id: number };\n\nexport async function GET(req: Request) {\n  const url = new URL(req.url);\n  const token = (url.searchParams.get(\"t\") || \"\").trim();\n  const alias = (url.searchParams.get(\"alias\") || \"\").trim();\n\n  if (!token || !alias) return new Response(\"Bad request\", { status: 400 });\n\n  const tokenHash = hmacSha256Hex(token);\n\n  const rows = (await sql`\n    select id, email, expires_at, use_count, max_uses, revoked_at, alias\n    from login_tokens\n    where token_hash = ${tokenHash}\n    limit 1\n  `) as LoginTokenRow[];\n\n  if (rows.length === 0) return new Response(\"This sign-in link is invalid or expired.\", { status: 400 });\n\n  const t = rows[0];\n  if (t.revoked_at) return new Response(\"This sign-in link is no longer valid.\", { status: 400 });\n  if (t.alias !== alias) return new Response(\"This sign-in link does not match the document.\", { status: 400 });\n  if (new Date(t.expires_at).getTime() <= Date.now()) return new Response(\"This sign-in link has expired.\", { status: 400 });\n  if (t.use_count >= t.max_uses) return new Response(\"This sign-in link has already been used.\", { status: 400 });\n\n  // Mark token used\n  await sql`\n    update login_tokens\n    set use_count = use_count + 1\n    where id = ${t.id}\n  `;\n\n  // Resolve alias -> doc_id\n  const docs = (await sql`\n    select doc_id, is_active\n    from document_aliases\n    where alias = ${alias}\n    limit 1\n  `) as DocAliasRow[];\n\n  if (docs.length === 0 || !docs[0].is_active) return new Response(\"Document not found.\", { status: 404 });\n\n  const docId = docs[0].doc_id;\n\n  // Create doc-only access grant (8 hours)\n  const expiresAt = new Date(Date.now() + 8 * 60 * 60 * 1000);\n\n  const grantRows = (await sql`\n    insert into doc_access_grants (doc_id, principal, provider, expires_at)\n    values (${docId}, ${t.email}, 'email', ${expiresAt.toISOString()})\n    returning id\n  `) as GrantRow[];\n\n  const grantId = grantRows[0].id;\n  const expUnix = Math.floor(expiresAt.getTime() / 1000);\n\n  const signed = signPayload({ grant_id: grantId, exp: expUnix });\n\n  const headers = new Headers();\n  headers.append(\"Set-Cookie\", cookieHeader(\"cy_doc_session\", signed, { maxAgeSeconds: 8 * 60 * 60 }));\n  headers.set(\"Location\", `/d/${encodeURIComponent(alias)}`);\n\n  return new Response(null, { status: 302, headers });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\auth\\email\\start\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\auth\\google\\callback\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'signInFallback' is defined but never used.","line":18,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const runtime = \"nodejs\";\n\nimport { sql } from \"@/lib/db\";\nimport { cookieHeader, getCookie } from \"@/lib/cookies\";\nimport { signPayload } from \"@/lib/crypto\";\nimport { exchangeGoogleCode } from \"@/lib/oauth-google\";\n\ntype DocSession = { grant_id: number; exp: number };\n\ntype AliasLookupRow = { doc_id: string; target_url: string; is_active: boolean };\ntype GrantRow = { id: number };\n\nfunction clearCookie(headers: Headers, name: string) {\n  const secure = process.env.APP_URL?.startsWith(\"https://\") ? \"; Secure\" : \"\";\n  headers.append(\"Set-Cookie\", `${name}=; Path=/; HttpOnly; SameSite=Lax; Max-Age=0${secure}`);\n}\n\nfunction signInFallback(alias?: string) {\n  const a = alias ? encodeURIComponent(alias) : \"\";\n  return new Response(null, {\n    status: 302,\n    headers: { Location: a ? `/d/${a}` : \"/\" },\n  });\n}\n\nexport async function GET(req: Request) {\n  const alias = (getCookie(req, \"cy_oauth_alias\") || \"\").trim();\n  const codeVerifier = (getCookie(req, \"cy_oauth_cv\") || \"\").trim();\n  const expectedState = (getCookie(req, \"cy_oauth_state\") || \"\").trim();\n  const expectedNonce = (getCookie(req, \"cy_oauth_nonce\") || \"\").trim();\n\n  const headers = new Headers();\n  // Clear oauth cookies no matter what\n  clearCookie(headers, \"cy_oauth_alias\");\n  clearCookie(headers, \"cy_oauth_cv\");\n  clearCookie(headers, \"cy_oauth_state\");\n  clearCookie(headers, \"cy_oauth_nonce\");\n\n  if (!alias || !codeVerifier || !expectedState || !expectedNonce) {\n    // Missing checks => restart sign-in\n    headers.set(\"Location\", alias ? `/d/${encodeURIComponent(alias)}` : \"/\");\n    return new Response(null, { status: 302, headers });\n  }\n\n  // 1) Exchange code for tokens + validate (state/nonce/PKCE)\n   const { claims } = await exchangeGoogleCode(req, {\n    codeVerifier,\n    state: expectedState,\n    nonce: expectedNonce,\n  });\n\n  const email = typeof claims?.email === \"string\" ? claims.email.toLowerCase() : \"\";\n  const emailVerified = claims?.email_verified === true;\n\n  if (!email || !emailVerified) {\n    headers.set(\"Location\", `/d/${encodeURIComponent(alias)}`);\n    return new Response(null, { status: 302, headers });\n  }\n\n\n  // 2) Look up alias -> doc_id + target_url + is_active\n  const rows = (await sql`\n    select a.doc_id, d.target_url, a.is_active\n    from document_aliases a\n    join documents d on d.id = a.doc_id\n    where a.alias = ${alias}\n    limit 1\n  `) as AliasLookupRow[];\n\n  if (rows.length === 0 || !rows[0].is_active) {\n    headers.set(\"Location\", `/d/${encodeURIComponent(alias)}`);\n    return new Response(null, { status: 302, headers });\n  }\n\n  const docId = rows[0].doc_id;\n\n  // 3) Create doc-only access grant (8 hours)\n  const expiresAt = new Date(Date.now() + 8 * 60 * 60 * 1000);\n  const grantRows = (await sql`\n    insert into doc_access_grants (doc_id, principal, provider, expires_at)\n    values (${docId}, ${email}, 'google', ${expiresAt.toISOString()})\n    returning id\n  `) as GrantRow[];\n\n  const grantId = grantRows[0]?.id;\n  if (!grantId) {\n    headers.set(\"Location\", `/d/${encodeURIComponent(alias)}`);\n    return new Response(null, { status: 302, headers });\n  }\n\n  // 4) Set your doc session cookie and redirect back to the doc\n  const expUnix = Math.floor(expiresAt.getTime() / 1000);\n  const signed = signPayload({ grant_id: grantId, exp: expUnix } satisfies DocSession);\n\n  headers.append(\n    \"Set-Cookie\",\n    cookieHeader(\"cy_doc_session\", signed, { maxAgeSeconds: 8 * 60 * 60 })\n  );\n  headers.set(\"Location\", `/d/${encodeURIComponent(alias)}`);\n\n  return new Response(null, { status: 302, headers });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\auth\\google\\start\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_ctx' is defined but never used.","line":18,"column":45,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":49},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":1,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":18,"column":69,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":18,"endColumn":71,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[752,754],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[752,754],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/auth/google/start/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport { NextRequest } from \"next/server\";\nimport { createGoogleAuthRequest } from \"@/lib/oauth-google\";\n\nfunction setCookie(headers: Headers, name: string, value: string, maxAgeSeconds: number) {\n  const secure = process.env.APP_URL?.startsWith(\"https://\") ? \"; Secure\" : \"\";\n  headers.append(\n    \"Set-Cookie\",\n    `${name}=${encodeURIComponent(value)}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${maxAgeSeconds}${secure}`\n  );\n}\n\n// Note: include `ctx` with `params: Promise<{}>` even if unused.\n// This satisfies Next's route handler type validator during `next build`.\nexport async function GET(req: NextRequest, _ctx: { params: Promise<{}> }) {\n  const url = new URL(req.url);\n  const alias = (url.searchParams.get(\"alias\") || \"\").trim();\n\n  if (!alias) return new Response(\"Missing alias\", { status: 400 });\n\n  const { authorizationUrl, codeVerifier, state, nonce } = await createGoogleAuthRequest(alias);\n\n  const headers = new Headers();\n  setCookie(headers, \"cy_oauth_alias\", alias, 10 * 60);\n  setCookie(headers, \"cy_oauth_cv\", codeVerifier, 10 * 60);\n  setCookie(headers, \"cy_oauth_state\", state, 10 * 60);\n  setCookie(headers, \"cy_oauth_nonce\", nonce, 10 * 60);\n\n  headers.set(\"Location\", authorizationUrl);\n  return new Response(null, { status: 302, headers });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\components\\SecurePdfCanvasViewer.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[211,214],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[211,214],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1452,1455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1452,1455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":72,"column":10,"nodeType":"JSXOpeningElement","endLine":72,"endColumn":97},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3166,3169],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3166,3169],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4870,4873],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4870,4873],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":166,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5698,5701],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5698,5701],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6592,6595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6592,6595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":219,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7488,7491],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7488,7491],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/no-noninteractive-element-interactions","severity":1,"message":"Non-interactive elements should not be assigned mouse or keyboard event listeners.","line":287,"column":5,"nodeType":"JSXOpeningElement","endLine":304,"endColumn":6},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":362,"column":15,"nodeType":"JSXOpeningElement","endLine":368,"endColumn":17},{"ruleId":"jsx-a11y/img-redundant-alt","severity":1,"message":"Redundant alt attribute. Screen-readers already announce `img` tags as an image. You don’t need to use the words `image`, `photo,` or `picture` (or any specified custom words) in the alt prop.","line":362,"column":15,"nodeType":"JSXOpeningElement","endLine":368,"endColumn":17},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":373,"column":17,"nodeType":"JSXOpeningElement","endLine":393,"endColumn":19},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":408,"column":19,"nodeType":"JSXOpeningElement","endLine":422,"endColumn":21},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":431,"column":15,"nodeType":"JSXOpeningElement","endLine":431,"endColumn":132}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\n\ntype PdfJsModule = {\n  GlobalWorkerOptions: { workerSrc: string };\n  getDocument: (src: { data: ArrayBuffer }) => { promise: Promise<any> };\n};\n\ntype PageDims = { width: number; height: number };\n\nfunction isOfficeMime(mimeType: string): boolean {\n  const m = String(mimeType || \"\").toLowerCase();\n  return (\n    m === \"application/msword\" ||\n    m === \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\" ||\n    m === \"application/vnd.ms-excel\" ||\n    m === \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\" ||\n    m === \"application/vnd.ms-powerpoint\" ||\n    m === \"application/vnd.openxmlformats-officedocument.presentationml.presentation\" ||\n    m === \"application/vnd.oasis.opendocument.text\"\n  );\n}\n\nfunction viewerTypeOf(mimeType: string): \"pdf\" | \"image\" | \"video\" | \"audio\" | \"text\" | \"office\" | \"binary\" {\n  const m = String(mimeType || \"\").toLowerCase();\n  if (!m) return \"binary\";\n  if (m === \"application/pdf\") return \"pdf\";\n  if (m.startsWith(\"image/\")) return \"image\";\n  if (m.startsWith(\"video/\")) return \"video\";\n  if (m.startsWith(\"audio/\")) return \"audio\";\n  if (isOfficeMime(m)) return \"office\";\n  if (m.startsWith(\"text/\") || m === \"application/json\" || m === \"application/xml\" || m === \"application/rtf\") return \"text\";\n  return \"binary\";\n}\n\nfunction PdfPageCanvas({\n  doc,\n  pageNo,\n  scale,\n  dims,\n}: {\n  doc: any;\n  pageNo: number;\n  scale: number;\n  dims: PageDims;\n}) {\n  const ref = useRef<HTMLCanvasElement | null>(null);\n  useEffect(() => {\n    let cancelled = false;\n    (async () => {\n      const canvas = ref.current;\n      if (!canvas || !doc) return;\n      const pdfPage = await doc.getPage(pageNo);\n      if (cancelled || !canvas) return;\n      const viewport = pdfPage.getViewport({ scale });\n      const ctx = canvas.getContext(\"2d\");\n      if (!ctx) return;\n      const dpr = window.devicePixelRatio || 1;\n      canvas.width = Math.max(1, Math.floor(viewport.width * dpr));\n      canvas.height = Math.max(1, Math.floor(viewport.height * dpr));\n      canvas.style.width = `${Math.floor(viewport.width)}px`;\n      canvas.style.height = `${Math.floor(viewport.height)}px`;\n      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n      await pdfPage.render({ canvasContext: ctx, viewport }).promise;\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [doc, pageNo, scale]);\n\n  return <canvas ref={ref} style={{ width: dims.width * scale, height: dims.height * scale }} />;\n}\n\nexport default function SecurePdfCanvasViewer(props: {\n  rawUrl: string;\n  mimeType?: string | null;\n  watermarkEnabled?: boolean;\n  watermarkText?: string;\n  className?: string;\n}) {\n  const mimeType = String(props.mimeType || \"\").trim().toLowerCase();\n  const mode = useMemo(() => viewerTypeOf(mimeType), [mimeType]);\n  const [notice, setNotice] = useState<string | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [scale, setScale] = useState(1);\n\n  const [pdfjs, setPdfjs] = useState<PdfJsModule | null>(null);\n  const [pdfDoc, setPdfDoc] = useState<any>(null);\n  const [numPages, setNumPages] = useState(0);\n  const [pageDims, setPageDims] = useState<Record<number, PageDims>>({});\n  const [visibleRange, setVisibleRange] = useState<{ start: number; end: number }>({ start: 1, end: 3 });\n  const scrollRef = useRef<HTMLDivElement | null>(null);\n\n  const [textContent, setTextContent] = useState(\"\");\n  const [officeHtml, setOfficeHtml] = useState(\"\");\n\n  const videoRef = useRef<HTMLVideoElement | null>(null);\n  const [videoReady, setVideoReady] = useState(false);\n  const [videoDuration, setVideoDuration] = useState(0);\n  const [videoTime, setVideoTime] = useState(0);\n  const [isPlaying, setIsPlaying] = useState(false);\n\n  function deter(msg: string) {\n    setNotice(msg);\n    window.setTimeout(() => setNotice(null), 1800);\n  }\n\n  useEffect(() => {\n    let cancelled = false;\n    (async () => {\n      try {\n        const lib = (await import(\"pdfjs-dist/legacy/build/pdf.mjs\")) as unknown as PdfJsModule;\n        if (cancelled) return;\n        lib.GlobalWorkerOptions.workerSrc = new URL(\n          \"pdfjs-dist/legacy/build/pdf.worker.min.mjs\",\n          import.meta.url\n        ).toString();\n        setPdfjs(lib);\n      } catch {\n        if (!cancelled && mode === \"pdf\") setError(\"Viewer runtime unavailable.\");\n      }\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [mode]);\n\n  useEffect(() => {\n    setLoading(true);\n    setError(null);\n    setTextContent(\"\");\n    setOfficeHtml(\"\");\n    setPdfDoc(null);\n    setNumPages(0);\n    setPageDims({});\n    setVisibleRange({ start: 1, end: 3 });\n  }, [props.rawUrl, mode]);\n\n  useEffect(() => {\n    if (mode !== \"pdf\" || !pdfjs) return;\n    let cancelled = false;\n    let localDoc: any = null;\n    (async () => {\n      try {\n        const res = await fetch(props.rawUrl, {\n          method: \"GET\",\n          credentials: \"include\",\n          cache: \"no-store\",\n          headers: { accept: \"application/pdf,*/*\" },\n        });\n        if (!res.ok) throw new Error(`Document unavailable (${res.status})`);\n        const data = await res.arrayBuffer();\n        const task = pdfjs.getDocument({ data });\n        localDoc = await task.promise;\n        if (cancelled) return;\n        setPdfDoc(localDoc);\n        const pages = Number(localDoc.numPages || 0);\n        setNumPages(pages);\n        if (pages > 0) {\n          const first = await localDoc.getPage(1);\n          const vp = first.getViewport({ scale: 1 });\n          setPageDims({ 1: { width: vp.width, height: vp.height } });\n        }\n      } catch (e: any) {\n        if (!cancelled) setError(e?.message || \"Unable to load PDF.\");\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    })();\n    return () => {\n      cancelled = true;\n      if (localDoc?.destroy) void localDoc.destroy();\n    };\n  }, [mode, pdfjs, props.rawUrl]);\n\n  useEffect(() => {\n    if (mode !== \"text\") return;\n    let cancelled = false;\n    (async () => {\n      try {\n        const res = await fetch(props.rawUrl, {\n          method: \"GET\",\n          credentials: \"include\",\n          cache: \"no-store\",\n          headers: { accept: `${mimeType || \"text/plain\"},*/*` },\n        });\n        if (!res.ok) throw new Error(`Document unavailable (${res.status})`);\n        const data = await res.arrayBuffer();\n        const decoded = new TextDecoder(\"utf-8\", { fatal: false }).decode(data);\n        if (!cancelled) setTextContent(decoded);\n      } catch (e: any) {\n        if (!cancelled) setError(e?.message || \"Unable to load text preview.\");\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [mode, props.rawUrl, mimeType]);\n\n  useEffect(() => {\n    if (mode !== \"office\") return;\n    let cancelled = false;\n    (async () => {\n      try {\n        const r = await fetch(\"/api/viewer/office\", {\n          method: \"POST\",\n          headers: { \"content-type\": \"application/json\" },\n          body: JSON.stringify({ rawPath: props.rawUrl, mimeType }),\n        });\n        const j = (await r.json().catch(() => null)) as { ok?: boolean; html?: string; message?: string } | null;\n        if (!r.ok || !j?.ok || !j?.html) {\n          throw new Error(j?.message || `Conversion failed (${r.status})`);\n        }\n        if (!cancelled) setOfficeHtml(j.html);\n      } catch (e: any) {\n        if (!cancelled) setError(e?.message || \"Unable to render office preview.\");\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    })();\n    return () => {\n      cancelled = true;\n    };\n  }, [mode, props.rawUrl, mimeType]);\n\n  useEffect(() => {\n    if (mode === \"image\" || mode === \"audio\" || mode === \"video\" || mode === \"binary\") {\n      setLoading(false);\n      setError(null);\n    }\n  }, [mode]);\n\n  useEffect(() => {\n    if (mode !== \"pdf\") return;\n    const el = scrollRef.current;\n    if (!el || numPages <= 0) return;\n    const firstDims = pageDims[1] || { width: 800, height: 1100 };\n    const rowH = firstDims.height * scale + 24;\n    const onScroll = () => {\n      const top = el.scrollTop;\n      const h = el.clientHeight;\n      const start = Math.max(1, Math.floor(top / rowH) - 2);\n      const end = Math.min(numPages, Math.ceil((top + h) / rowH) + 2);\n      setVisibleRange({ start, end });\n    };\n    onScroll();\n    el.addEventListener(\"scroll\", onScroll, { passive: true });\n    return () => {\n      el.removeEventListener(\"scroll\", onScroll);\n    };\n  }, [mode, numPages, pageDims, scale]);\n\n  const watermark = useMemo(() => {\n    if (!props.watermarkEnabled) return null;\n    const text = (props.watermarkText || \"Confidential\").trim() || \"Confidential\";\n    return (\n      <div\n        aria-hidden=\"true\"\n        className=\"pointer-events-none absolute inset-0 z-10\"\n        style={{\n          backgroundImage: `repeating-linear-gradient(\n            -35deg,\n            rgba(255,255,255,0.08) 0px,\n            rgba(255,255,255,0.08) 2px,\n            rgba(0,0,0,0) 2px,\n            rgba(0,0,0,0) 140px\n          )`,\n        }}\n      >\n        <div className=\"absolute inset-0 flex items-center justify-center\">\n          <div className=\"whitespace-pre-wrap text-center text-3xl font-semibold tracking-widest text-white/20\">\n            {text}\n          </div>\n        </div>\n      </div>\n    );\n  }, [props.watermarkEnabled, props.watermarkText]);\n\n  const zoomAllowed = mode === \"pdf\" || mode === \"image\" || mode === \"video\" || mode === \"text\" || mode === \"office\";\n  const modeLabel = mode.toUpperCase();\n\n  return (\n    <div\n      className={`relative rounded-2xl border border-white/10 bg-black/40 ${props.className || \"\"}`}\n      onContextMenu={(e) => {\n        e.preventDefault();\n        deter(\"Context actions are disabled for protected viewing.\");\n      }}\n      onKeyDownCapture={(e) => {\n        const k = String(e.key || \"\").toLowerCase();\n        const cmd = e.metaKey || e.ctrlKey;\n        if ((cmd && (k === \"s\" || k === \"p\")) || k === \"printscreen\") {\n          e.preventDefault();\n          deter(\"Export and print shortcuts are disabled.\");\n        }\n      }}\n      tabIndex={0}\n      role=\"application\"\n      aria-label=\"Secure document viewer\"\n    >\n      <div className=\"sticky top-0 z-20 flex items-center justify-between gap-3 border-b border-white/10 bg-black/70 px-3 py-2 text-xs text-white/80 backdrop-blur\">\n        <div className=\"flex items-center gap-2\">\n          <span>{modeLabel} preview</span>\n          {mode === \"pdf\" ? <span>{numPages ? `${numPages} pages` : \"\"}</span> : null}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {zoomAllowed ? (\n            <>\n              <button\n                type=\"button\"\n                className=\"rounded border border-white/20 px-2 py-1 disabled:opacity-40\"\n                disabled={loading || !!error}\n                onClick={() => setScale((s) => Math.max(0.6, Number((s - 0.1).toFixed(2))))}\n              >\n                -\n              </button>\n              <span>{Math.round(scale * 100)}%</span>\n              <button\n                type=\"button\"\n                className=\"rounded border border-white/20 px-2 py-1 disabled:opacity-40\"\n                disabled={loading || !!error}\n                onClick={() => setScale((s) => Math.min(2.2, Number((s + 0.1).toFixed(2))))}\n              >\n                +\n              </button>\n            </>\n          ) : null}\n        </div>\n      </div>\n\n      <div ref={scrollRef} className=\"relative h-full overflow-auto p-3\">\n        {loading ? <div className=\"py-16 text-center text-sm text-white/70\">Loading document...</div> : null}\n        {error ? <div className=\"py-16 text-center text-sm text-red-200\">{error}</div> : null}\n        {!loading && !error ? (\n          <div className=\"relative mx-auto w-fit\">\n            {mode === \"pdf\" ? (\n              <div className=\"space-y-6\">\n                {Array.from({ length: numPages }, (_, i) => i + 1).map((pageNo) => {\n                  const dims = pageDims[pageNo] || pageDims[1] || { width: 800, height: 1100 };\n                  const shouldRender = pageNo >= visibleRange.start && pageNo <= visibleRange.end;\n                  return (\n                    <div key={pageNo} className=\"relative flex justify-center\">\n                      {shouldRender ? (\n                        <PdfPageCanvas doc={pdfDoc} pageNo={pageNo} scale={scale} dims={dims} />\n                      ) : (\n                        <div\n                          className=\"rounded border border-white/5 bg-white/[0.03]\"\n                          style={{ width: dims.width * scale, height: dims.height * scale }}\n                        />\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            ) : null}\n\n            {mode === \"image\" ? (\n              <img\n                src={props.rawUrl}\n                alt=\"Protected document image\"\n                className=\"block max-w-none\"\n                style={{ transform: `scale(${scale})`, transformOrigin: \"top left\" }}\n                draggable={false}\n              />\n            ) : null}\n\n            {mode === \"video\" ? (\n              <div className=\"space-y-2\">\n                <video\n                  ref={videoRef}\n                  src={props.rawUrl}\n                  className=\"block max-w-none bg-black\"\n                  style={{ transform: `scale(${scale})`, transformOrigin: \"top left\" }}\n                  controls={false}\n                  controlsList=\"nodownload noplaybackrate nofullscreen\"\n                  onLoadedMetadata={() => {\n                    const v = videoRef.current;\n                    if (!v) return;\n                    setVideoReady(true);\n                    setVideoDuration(Number.isFinite(v.duration) ? v.duration : 0);\n                  }}\n                  onTimeUpdate={() => {\n                    const v = videoRef.current;\n                    if (!v) return;\n                    setVideoTime(v.currentTime || 0);\n                  }}\n                  onPlay={() => setIsPlaying(true)}\n                  onPause={() => setIsPlaying(false)}\n                />\n                <div className=\"flex items-center gap-2 text-xs text-white/80\">\n                  <button\n                    type=\"button\"\n                    className=\"rounded border border-white/20 px-2 py-1 disabled:opacity-40\"\n                    disabled={!videoReady}\n                    onClick={() => {\n                      const v = videoRef.current;\n                      if (!v) return;\n                      if (v.paused) void v.play();\n                      else v.pause();\n                    }}\n                  >\n                    {isPlaying ? \"Pause\" : \"Play\"}\n                  </button>\n                  <input\n                    type=\"range\"\n                    min={0}\n                    max={Math.max(0, videoDuration)}\n                    step={0.1}\n                    value={Math.min(videoTime, videoDuration || 0)}\n                    disabled={!videoReady}\n                    onChange={(e) => {\n                      const v = videoRef.current;\n                      if (!v) return;\n                      v.currentTime = Number(e.target.value || 0);\n                      setVideoTime(v.currentTime || 0);\n                    }}\n                    className=\"w-64\"\n                  />\n                  <span>\n                    {Math.floor(videoTime)}s / {Math.floor(videoDuration)}s\n                  </span>\n                </div>\n              </div>\n            ) : null}\n\n            {mode === \"audio\" ? (\n              <audio src={props.rawUrl} className=\"block w-full min-w-[340px]\" controls controlsList=\"nodownload noplaybackrate\" />\n            ) : null}\n\n            {mode === \"text\" ? (\n              <pre\n                className=\"max-w-[90vw] overflow-auto rounded border border-white/10 bg-black/30 p-3 text-white/90\"\n                style={{ fontSize: `${Math.max(10, Math.floor(14 * scale))}px`, lineHeight: 1.5 }}\n              >\n                {textContent}\n              </pre>\n            ) : null}\n\n            {mode === \"office\" ? (\n              <iframe\n                title=\"Office preview\"\n                srcDoc={officeHtml}\n                className=\"h-[80vh] w-[min(1000px,90vw)] rounded border border-white/10 bg-black\"\n                sandbox=\"allow-same-origin\"\n                referrerPolicy=\"no-referrer\"\n                style={{ transform: `scale(${scale})`, transformOrigin: \"top left\" }}\n              />\n            ) : null}\n\n            {mode === \"binary\" ? (\n              <div className=\"rounded border border-amber-500/30 bg-amber-500/10 p-4 text-sm text-amber-100\">\n                Preview is not available for this file type in the secure inline viewer yet.\n              </div>\n            ) : null}\n\n            {watermark}\n          </div>\n        ) : null}\n      </div>\n\n      {notice ? (\n        <div className=\"pointer-events-none absolute bottom-3 right-3 z-30 rounded-lg border border-red-500/30 bg-red-500/20 px-3 py-2 text-xs text-red-100\">\n          {notice}\n        </div>\n      ) : null}\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\components\\SiteFooter.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\components\\SiteHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\components\\SiteShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\AliasPasswordGate.tsx","messages":[{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":23,"column":17,"nodeType":"JSXOpeningElement","endLine":29,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/d/[alias]/AliasPasswordGate.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { verifyAliasPasswordResultAction } from \"./unlockActions\";\n\nexport default function AliasPasswordGate({ alias }: { alias: string }) {\n    const [pw, setPw] = useState(\"\");\n    const [err, setErr] = useState<string | null>(null);\n    const [busy, setBusy] = useState(false);\n\n    return (\n        <div className=\"mt-6 rounded-lg border border-neutral-800 bg-neutral-950 p-4\">\n            <div className=\"text-sm text-neutral-400\">This link is password protected.</div>\n\n            {err ? (\n                <div className=\"mt-3 rounded-md border border-red-900/40 bg-red-950/30 px-3 py-2 text-sm text-red-200\">\n                    {err}\n                </div>\n            ) : null}\n\n            <div className=\"mt-4 space-y-3\">\n                <input\n                    type=\"password\"\n                    value={pw}\n                    onChange={(e) => setPw(e.target.value)}\n                    placeholder=\"Password\"\n                    className=\"w-full rounded-md border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500\"\n                />\n\n                <button\n                    disabled={busy}\n                    onClick={async () => {\n                        setErr(null);\n                        setBusy(true);\n                        try {\n                            const fd = new FormData();\n                            fd.set(\"alias\", alias);\n                            fd.set(\"password\", pw);\n\n                            const res = await verifyAliasPasswordResultAction(fd);\n                            if (!res.ok) {\n                                setErr(res.message);\n                                return;\n                            }\n\n                            // cookie is set server-side; reload to render the viewer\n                            window.location.href = `/d/${encodeURIComponent(alias)}`;\n                        } finally {\n                            setBusy(false);\n                        }\n                    }}\n                    className=\"w-full rounded-md bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-500 disabled:opacity-60\"\n                >\n                    {busy ? \"Unlocking…\" : \"Unlock\"}\n                </button>\n            </div>\n        </div>\n    );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\ShareForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1148,1151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1148,1151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1693,1696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1693,1696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1894,1897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1894,1897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2116,2119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2116,2119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2308,2311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2308,2311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":87,"column":11,"nodeType":"JSXOpeningElement","endLine":87,"endColumn":67},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":93,"column":11,"nodeType":"JSXOpeningElement","endLine":98,"endColumn":13},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":102,"column":11,"nodeType":"JSXOpeningElement","endLine":102,"endColumn":67},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":108,"column":11,"nodeType":"JSXOpeningElement","endLine":113,"endColumn":13},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":117,"column":11,"nodeType":"JSXOpeningElement","endLine":117,"endColumn":67},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":123,"column":11,"nodeType":"JSXOpeningElement","endLine":129,"endColumn":13},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":134,"column":13,"nodeType":"JSXOpeningElement","endLine":134,"endColumn":69},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":140,"column":13,"nodeType":"JSXOpeningElement","endLine":146,"endColumn":15},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":150,"column":13,"nodeType":"JSXOpeningElement","endLine":150,"endColumn":69},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":156,"column":13,"nodeType":"JSXOpeningElement","endLine":161,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/d/[alias]/ShareForm.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { createAndEmailShareToken, getShareStatsByToken } from \"./actions\";\n\nfunction fmtIso(iso: string | null) {\n  if (!iso) return \"—\";\n  try {\n    const d = new Date(iso);\n    return d.toLocaleString();\n  } catch {\n    return iso;\n  }\n}\n\nfunction toIsoFromDatetimeLocal(v: string): string | \"\" {\n  const s = (v || \"\").trim();\n  if (!s) return \"\";\n  // datetime-local returns \"YYYY-MM-DDTHH:mm\"\n  const d = new Date(s);\n  if (Number.isNaN(d.getTime())) return \"\";\n  return d.toISOString();\n}\n\nexport default function ShareForm({ docId, alias }: { docId: string; alias?: string }) {\n  const [shareTitle, setShareTitle] = useState(\"\");\n  const [toEmail, setToEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [maxViews, setMaxViews] = useState<string>(\"\");\n  const [expiresLocal, setExpiresLocal] = useState<string>(\"\"); // datetime-local\n\n  const [busy, setBusy] = useState(false);\n  const [err, setErr] = useState<string | null>(null);\n  const [token, setToken] = useState<string | null>(null);\n  const [stats, setStats] = useState<any>(null);\n\n  async function onCreate() {\n    setErr(null);\n    setStats(null);\n    setBusy(true);\n    try {\n      const fd = new FormData();\n      fd.set(\"docId\", docId);\n      fd.set(\"alias\", alias || \"\");\n      fd.set(\"shareTitle\", shareTitle.trim() ? shareTitle.trim() : \"\");\n      fd.set(\"toEmail\", toEmail.trim() ? toEmail.trim() : \"\");\n      fd.set(\"password\", password); // may be blank\n      fd.set(\"expiresAt\", toIsoFromDatetimeLocal(expiresLocal));\n      fd.set(\"maxViews\", maxViews.trim() ? maxViews.trim() : \"\");\n\n      const res: any = await createAndEmailShareToken(fd);\n      if (!res.ok) {\n        setErr(res.message || res.error || \"Failed to create token.\");\n        return;\n      }\n      setToken(res.token);\n    } catch (e: any) {\n      setErr(e?.message || \"Unexpected error.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  async function onStats() {\n    if (!token) return;\n    setErr(null);\n    setBusy(true);\n    try {\n      const res: any = await getShareStatsByToken(token);\n      if (!res.ok) {\n        setErr(res.message || res.error || \"Failed to load stats.\");\n        return;\n      }\n      setStats(res);\n    } catch (e: any) {\n      setErr(e?.message || \"Unexpected error.\");\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <div className=\"rounded-xl border border-neutral-800 bg-neutral-950 p-4 shadow-sm\">\n      <div className=\"flex flex-col gap-3\">\n        <div>\n          <label className=\"text-sm font-medium text-neutral-300\">\n            Title before sharing (optional)\n          </label>\n          <div className=\"mt-1 text-xs text-neutral-500\">\n            If set, updates this document title before creating the share link.\n          </div>\n          <input\n            value={shareTitle}\n            onChange={(e) => setShareTitle(e.target.value)}\n            placeholder=\"Leave blank to keep current title\"\n            className=\"mt-2 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-700 transition\"\n          />\n        </div>\n\n        <div>\n          <label className=\"text-sm font-medium text-neutral-300\">\n            Recipient Email (optional)\n          </label>\n          <div className=\"mt-1 text-xs text-neutral-500\">\n            If set, the viewer must enter this email to unlock.\n          </div>\n          <input\n            value={toEmail}\n            onChange={(e) => setToEmail(e.target.value)}\n            placeholder=\"recipient@example.com\"\n            className=\"mt-2 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-700 transition\"\n          />\n        </div>\n\n        <div>\n          <label className=\"text-sm font-medium text-neutral-300\">\n            Password (optional)\n          </label>\n          <div className=\"mt-1 text-xs text-neutral-500\">\n            If set, the viewer must enter this password (in addition to email, if required).\n          </div>\n          <input\n            value={password}\n            onChange={(e) => setPassword(e.target.value)}\n            placeholder=\"Set a password\"\n            type=\"password\"\n            className=\"mt-2 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-700 transition\"\n          />\n        </div>\n\n        <div className=\"grid grid-cols-1 gap-3 md:grid-cols-2\">\n          <div>\n            <label className=\"text-sm font-medium text-neutral-300\">\n              Max Views (optional)\n            </label>\n            <div className=\"mt-1 text-xs text-neutral-500\">\n              Leave blank for unlimited. Use 1 for single-view.\n            </div>\n            <input\n              value={maxViews}\n              onChange={(e) => setMaxViews(e.target.value)}\n              placeholder=\"e.g. 3\"\n              inputMode=\"numeric\"\n              className=\"mt-2 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-700 transition\"\n            />\n          </div>\n\n          <div>\n            <label className=\"text-sm font-medium text-neutral-300\">\n              Expiration (optional)\n            </label>\n            <div className=\"mt-1 text-xs text-neutral-500\">\n              When set, the link stops working after this time.\n            </div>\n            <input\n              value={expiresLocal}\n              onChange={(e) => setExpiresLocal(e.target.value)}\n              type=\"datetime-local\"\n              className=\"mt-2 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-neutral-600 focus:outline-none focus:ring-2 focus:ring-neutral-700 transition\"\n            />\n          </div>\n        </div>\n\n        <div className=\"flex flex-wrap gap-2\">\n          <button\n            onClick={onCreate}\n            disabled={busy || !docId}\n            className=\"rounded-lg bg-neutral-100 px-3 py-2 text-sm font-medium text-neutral-950 hover:bg-white disabled:opacity-50\"\n          >\n            {busy ? \"Working…\" : \"Create + Email link\"}\n          </button>\n\n          <button\n            onClick={onStats}\n            disabled={busy || !token}\n            className=\"rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-200 hover:bg-neutral-800 disabled:opacity-50\"\n          >\n            Stats\n          </button>\n        </div>\n\n        {err ? (\n          <div className=\"rounded-lg border border-red-900/40 bg-red-950/30 p-3 text-sm text-red-200\">\n            {err}\n          </div>\n        ) : null}\n\n        {stats?.ok ? (\n          <div className=\"rounded-lg border border-neutral-800 bg-neutral-950 p-3 text-sm text-neutral-200\">\n            <div className=\"grid grid-cols-1 gap-1 md:grid-cols-2\">\n              <div>\n                <span className=\"text-neutral-500\">Created:</span>{\" \"}\n                {fmtIso(stats.row.created_at)}\n              </div>\n              <div>\n                <span className=\"text-neutral-500\">Expires:</span>{\" \"}\n                {fmtIso(stats.row.expires_at)}\n              </div>\n              <div>\n                <span className=\"text-neutral-500\">Max Views:</span>{\" \"}\n                {stats.row.max_views ?? \"—\"}\n              </div>\n              <div>\n                <span className=\"text-neutral-500\">Views:</span>{\" \"}\n                {stats.row.view_count ?? stats.row.views_count ?? 0}\n              </div>\n              <div className=\"md:col-span-2\">\n                <span className=\"text-neutral-500\">Recipient:</span>{\" \"}\n                {stats.row.to_email || \"—\"}\n              </div>\n            </div>\n          </div>\n        ) : null}\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\SharePanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":95,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":95,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2569,2572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2569,2572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":152,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":152,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4441,4444],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4441,4444],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":219,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":219,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":219,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6755,6758],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6755,6758],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":270,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":270,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":270,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":270,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8065,8068],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8065,8068],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":299,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":299,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":299,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":299,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8832,8835],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8832,8835],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/d/[alias]/actions.ts\n\"use server\";\n\nimport { sql } from \"@/lib/db\";\nimport { requireDocWrite } from \"@/lib/authz\";\nimport { randomBytes } from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport { emitWebhook } from \"@/lib/webhooks\";\nimport { assertCanCreateShare, getPlanForUser, normalizeExpiresAtForPlan, normalizeMaxViewsForPlan } from \"@/lib/monetization\";\n\n/**\n * NOTE:\n * SharePanel synthesizes a ShareRow immediately after creating a token,\n * before it can hydrate real stats from the DB. For that reason `doc_id`\n * is optional here.\n */\nexport type ShareRow = {\n  token: string;\n  doc_id?: string;\n  to_email: string | null;\n  created_at: string;\n  expires_at: string | null;\n  max_views: number | null;\n  view_count: number | null;\n  revoked_at: string | null;\n  last_viewed_at: string | null;\n};\n\nexport type CreateShareResult =\n  | { ok: true; token: string; url: string }\n  | { ok: false; error: string; message?: string };\n\nexport type ShareStatsResult =\n  | { ok: true; row: ShareRow }\n  | { ok: false; error: string; message?: string };\n\nexport type RevokeShareResult =\n  | { ok: true; token: string }\n  | { ok: false; error: string; message?: string };\n\nfunction newToken(): string {\n  return randomBytes(16).toString(\"hex\");\n}\n\nfunction baseUrlFromEnv(): string {\n  const u =\n    process.env.NEXT_PUBLIC_SITE_URL ||\n    process.env.NEXT_PUBLIC_BASE_URL ||\n    process.env.VERCEL_URL ||\n    \"http://localhost:3000\";\n\n  if (u.startsWith(\"http\")) return u;\n  return `https://${u}`;\n}\n\nfunction buildShareUrl(token: string): string {\n  // IMPORTANT: link users to /s/<token> (NOT /raw) so they hit the gate UI.\n  const base = baseUrlFromEnv().replace(/\\/+$/, \"\");\n  return `${base}/s/${token}`;\n}\n\nasync function trySendResendEmail(opts: {\n  to: string;\n  subject: string;\n  html: string;\n}): Promise<{ ok: true } | { ok: false; message: string }> {\n  const key = process.env.RESEND_API_KEY;\n  const from =\n    process.env.EMAIL_FROM ||\n    process.env.RESEND_FROM ||\n    \"Cyang Docs <no-reply@cyang.io>\";\n\n  if (!key) return { ok: false, message: \"Email service unavailable\" };\n\n  try {\n    const r = await fetch(\"https://api.resend.com/emails\", {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${key}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        from,\n        to: [opts.to],\n        subject: opts.subject,\n        html: opts.html,\n      }),\n    });\n\n    if (!r.ok) {\n      return { ok: false, message: \"Failed to send email\" };\n    }\n\n    return { ok: true };\n  } catch (e: any) {\n    return { ok: false, message: \"Failed to send email\" };\n  }\n}\n\nexport async function createAndEmailShareToken(\n  form: FormData\n): Promise<CreateShareResult> {\n  try {\n    const docId = String(form.get(\"docId\") || \"\").trim();\n    const alias = String(form.get(\"alias\") || \"\").trim();\n    const shareTitleRaw = String(form.get(\"shareTitle\") || \"\").trim();\n    const shareTitle = shareTitleRaw ? shareTitleRaw.slice(0, 240) : null;\n    const toEmailRaw = String(form.get(\"toEmail\") || \"\").trim();\n    const expiresAtRaw = String(form.get(\"expiresAt\") || \"\").trim();\n    const maxViewsRaw = String(form.get(\"maxViews\") || \"\").trim();\n    const passwordRaw = String(form.get(\"password\") || \"\");\n\n    if (!docId)\n      return { ok: false, error: \"bad_request\", message: \"Missing docId\" };\n\n    await requireDocWrite(docId);\n\n    if (shareTitle) {\n      await sql`\n        update public.docs\n        set title = ${shareTitle}\n        where id = ${docId}::uuid\n      `;\n    }\n\n    const toEmail = toEmailRaw ? toEmailRaw.toLowerCase() : null;\n\n    let expiresAt =\n      expiresAtRaw && !Number.isNaN(Date.parse(expiresAtRaw))\n        ? new Date(expiresAtRaw).toISOString()\n        : null;\n\n    const requestedMaxViews =\n      maxViewsRaw && /^\\d+$/.test(maxViewsRaw) ? Number(maxViewsRaw) : null;\n    let maxViews: number | null = requestedMaxViews;\n\n    const password = passwordRaw.trim();\n    const passwordHash = password ? await bcrypt.hash(password, 10) : null;\n\n    const docRows = (await sql`\n      select id::text as id, title::text as title, owner_id::text as owner_id\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as unknown as { id: string; title: string | null }[];\n\n    if (!docRows || docRows.length === 0) {\n      return { ok: false, error: \"not_found\", message: \"Document not found\" };\n    }\n\n\nconst ownerId = (docRows as any)?.[0]?.owner_id ?? null;\nif (ownerId) {\n  const shareAllowed = await assertCanCreateShare(ownerId);\n  if (!shareAllowed.ok) {\n    return { ok: false, error: shareAllowed.error, message: shareAllowed.message };\n  }\n}\n\n// --- Monetization: custom expiration is currently hidden ---\n// If plan disallows, clamp to <= 30 days.\nif (ownerId) {\n  const plan = await getPlanForUser(ownerId);\n  const normalized = normalizeExpiresAtForPlan({ plan, requestedExpiresAtIso: expiresAt, defaultDaysIfNotAllowed: 30 });\n      expiresAt = normalized;\n      maxViews = normalizeMaxViewsForPlan({ plan, requestedMaxViews });\n}\n\n    const token = newToken();\n\n    await sql`\n      insert into public.share_tokens (token, doc_id, to_email, expires_at, max_views, password_hash)\n      values (${token}, ${docId}::uuid, ${toEmail}, ${expiresAt}, ${maxViews}, ${passwordHash})\n    `;\n\n    // Webhook (best-effort)\n    emitWebhook(\"share.created\", {\n      token,\n      doc_id: docId,\n      alias: alias ?? null,\n      to_email: toEmail,\n      expires_at: expiresAt,\n      max_views: maxViews,\n      has_password: !!passwordHash,\n    });\n\n    const url = buildShareUrl(token);\n\n    // no recipient email → just return\n    if (!toEmail) return { ok: true, token, url };\n\n    const title = shareTitle || docRows[0]?.title || \"Document\";\n    const pretty = alias ? `/d/${alias}` : title;\n\n    const subject = `Cyang Docs: ${title}`;\n\n    const gates: string[] = [];\n    gates.push(`Email required: <b>${toEmail}</b>`);\n    if (passwordHash) gates.push(`Password required`);\n\n    const html = `\n      <div style=\"font-family: ui-sans-serif, system-ui; line-height:1.4;\">\n        <h2>${title}</h2>\n        <p>You’ve been sent a private link to view: <b>${pretty}</b></p>\n        <p>${gates.length ? `Access rules: ${gates.join(\" · \")}` : \"\"}</p>\n        <p>\n          <a href=\"${url}\" style=\"display:inline-block;padding:10px 14px;border-radius:10px;text-decoration:none;border:1px solid #ddd;\">\n            Open document\n          </a>\n        </p>\n        <p style=\"color:#777;font-size:12px;margin-top:14px;\">\n          Tip: This link will open a secure gate page first, then load the PDF.\n        </p>\n      </div>\n    `;\n\n    await trySendResendEmail({ to: toEmail, subject, html });\n    return { ok: true, token, url };\n  } catch (e: any) {\n    return { ok: false, error: \"exception\", message: \"Unable to create share.\" };\n  }\n}\n\nexport async function getShareStatsByToken(\n  token: string\n): Promise<ShareStatsResult> {\n  try {\n    const rows = (await sql`\n      select\n        token::text as token,\n        doc_id::text as doc_id,\n        to_email,\n        created_at::text as created_at,\n        expires_at::text as expires_at,\n        max_views,\n        views_count,\n        revoked_at::text as revoked_at\n      from public.share_tokens\n      where token = ${token}\n      limit 1\n    `) as unknown as Array<{\n      token: string;\n      doc_id: string;\n      to_email: string | null;\n      created_at: string;\n      expires_at: string | null;\n      max_views: number | null;\n      views_count: number | null;\n      revoked_at: string | null;\n    }>;\n\n    const r = rows[0];\n    if (!r) return { ok: false, error: \"not_found\", message: \"Token not found\" };\n\n    await requireDocWrite(r.doc_id);\n\n    const row: ShareRow = {\n      token: r.token,\n      doc_id: r.doc_id,\n      to_email: r.to_email,\n      created_at: r.created_at,\n      expires_at: r.expires_at,\n      max_views: r.max_views,\n      view_count: r.views_count ?? 0,\n      revoked_at: r.revoked_at,\n      last_viewed_at: null,\n    };\n\n    return { ok: true, row };\n  } catch (e: any) {\n    return { ok: false, error: \"exception\", message: \"Unable to load share stats.\" };\n  }\n}\n\nexport async function revokeShareToken(\n  token: string\n): Promise<RevokeShareResult> {\n  try {\n    // Lookup doc_id first so we can enforce ownership.\n    const rows = (await sql`\n      select doc_id::text as doc_id\n      from public.share_tokens\n      where token = ${token}\n      limit 1\n    `) as unknown as Array<{ doc_id: string }>;\n\n    const docId = rows?.[0]?.doc_id ?? null;\n    if (!docId) return { ok: false, error: \"not_found\", message: \"Token not found\" };\n\n    await requireDocWrite(docId);\n\n    await sql`\n      update public.share_tokens\n      set revoked_at = now()\n      where token = ${token}\n    `;\n\n    return { ok: true, token };\n  } catch (e: any) {\n    return { ok: false, error: \"exception\", message: \"Unable to revoke share.\" };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\raw\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":348,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":348,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10985,10988],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10985,10988],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/d/[alias]/raw/route.ts\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nimport type { NextRequest } from \"next/server\";\nimport { resolveDoc } from \"@/lib/resolveDoc\";\nimport { sql } from \"@/lib/db\";\nimport { aliasTrustCookieName, isAliasTrusted } from \"@/lib/deviceTrust\";\nimport { rateLimit, rateLimitHeaders, stableHash } from \"@/lib/rateLimit\";\nimport { mintAccessTicket } from \"@/lib/accessTicket\";\nimport { assertCanServeView, incrementMonthlyViews } from \"@/lib/monetization\";\nimport { enforcePlanLimitsEnabled } from \"@/lib/billingFlags\";\nimport { clientIpKey, detectAliasAccessDeniedSpike, logDbErrorEvent, logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport crypto from \"crypto\";\nimport { isAliasServingDisabled, isSecurityTestNoDbMode } from \"@/lib/securityPolicy\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nfunction normAlias(alias: string): string {\n  return decodeURIComponent(String(alias || \"\")).trim().toLowerCase();\n}\n\nfunction isExpired(expiresAt: string | null): boolean {\n  if (!expiresAt) return false;\n  const t = new Date(expiresAt).getTime();\n  return Number.isFinite(t) && t <= Date.now();\n}\n\n\nfunction hashIp(ip: string) {\n  const salt = (process.env.VIEW_SALT || \"\").trim();\n  if (!salt || !ip) return null;\n  return crypto.createHmac(\"sha256\", salt).update(ip).digest(\"hex\").slice(0, 32);\n}\n\nfunction shouldCountView(req: NextRequest): boolean {\n  // Avoid burning views on Range/chunk fetches\n  const range = req.headers.get(\"range\") || \"\";\n  return !range;\n}\n\nasync function getAliasRow(aliasInput: string): Promise<\n  | { ok: true; docId: string; revokedAt: string | null; expiresAt: string | null; passwordHash: string | null }\n  | { ok: false }\n> {\n  const alias = normAlias(aliasInput);\n  if (!alias) return { ok: false };\n\n  // Preferred: doc_aliases\n  try {\n    const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        a.revoked_at::text as revoked_at,\n        a.expires_at::text as expires_at,\n        a.password_hash::text as password_hash\n      from public.doc_aliases a\n      where lower(a.alias) = ${alias}\n        and coalesce(a.is_active, true) = true\n      limit 1\n    `) as unknown as Array<{\n      doc_id: string;\n      revoked_at: string | null;\n      expires_at: string | null;\n      password_hash: string | null;\n    }>;\n\n    if (rows?.length) {\n      const r = rows[0];\n      return {\n        ok: true,\n        docId: r.doc_id,\n        revokedAt: r.revoked_at ?? null,\n        expiresAt: r.expires_at ?? null,\n        passwordHash: r.password_hash ?? null,\n      };\n    }\n  } catch {\n    // fall through\n  }\n\n  // Some environments may not have password_hash on doc_aliases yet.\n  try {\n    const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        a.revoked_at::text as revoked_at,\n        a.expires_at::text as expires_at\n      from public.doc_aliases a\n      where lower(a.alias) = ${alias}\n        and coalesce(a.is_active, true) = true\n      limit 1\n    `) as unknown as Array<{\n      doc_id: string;\n      revoked_at: string | null;\n      expires_at: string | null;\n    }>;\n\n    if (rows?.length) {\n      const r = rows[0];\n      return {\n        ok: true,\n        docId: r.doc_id,\n        revokedAt: r.revoked_at ?? null,\n        expiresAt: r.expires_at ?? null,\n        passwordHash: null,\n      };\n    }\n  } catch {\n    // fall through\n  }\n\n  // Legacy: document_aliases\n  try {\n    const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        null::text as revoked_at,\n        a.expires_at::text as expires_at,\n        a.password_hash::text as password_hash\n      from public.document_aliases a\n      where lower(a.alias) = ${alias}\n      limit 1\n    `) as unknown as Array<{\n      doc_id: string;\n      revoked_at: string | null;\n      expires_at: string | null;\n      password_hash: string | null;\n    }>;\n\n    if (rows?.length) {\n      const r = rows[0];\n      return {\n        ok: true,\n        docId: r.doc_id,\n        revokedAt: r.revoked_at ?? null,\n        expiresAt: r.expires_at ?? null,\n        passwordHash: r.password_hash ?? null,\n      };\n    }\n  } catch {\n    // ignore\n  }\n\n  return { ok: false };\n}\n\nfunction pickFilename(title: string | null, original: string | null, fallback: string) {\n  const base = (title || original || fallback).trim() || fallback;\n  return base.replace(/[^\\w.\\- ]+/g, \"_\");\n}\n\nfunction parseDisposition(req: NextRequest): \"inline\" | \"attachment\" {\n  const url = new URL(req.url);\n  const d = (url.searchParams.get(\"disposition\") || url.searchParams.get(\"dl\") || \"\").toLowerCase();\n  if (d === \"1\" || d === \"true\" || d === \"download\" || d === \"attachment\") return \"attachment\";\n  return \"inline\";\n}\n\nexport async function GET(\n  req: NextRequest,\n  ctx: { params: Promise<{ alias: string }> }\n): Promise<Response> {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_ALIAS_RAW_MS\", 25_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"alias_raw\");\n\n        if (isSecurityTestNoDbMode()) {\n          return new Response(\"Not found\", { status: 404 });\n        }\n\n    if (await isAliasServingDisabled()) {\n      return new Response(\"Unavailable\", { status: 503 });\n    }\n\n    const { alias: rawAlias } = await ctx.params;\n    const alias = normAlias(rawAlias || \"\");\n    const ip = clientIpKey(req).ip;\n    const deny = async (reason: string, status = 404) => {\n      await logSecurityEvent({\n        type: \"alias_access_denied\",\n        severity: status === 429 ? \"medium\" : \"low\",\n        ip,\n        scope: \"alias_raw\",\n        message: \"Alias raw access denied\",\n        meta: { alias, reason, status },\n      });\n      await detectAliasAccessDeniedSpike({ ip });\n      return new Response(status === 429 ? \"Too Many Requests\" : \"Not found\", { status });\n    };\n\n    if (!alias) return new Response(\"Missing alias\", { status: 400 });\n\n    // Resolve alias row ourselves so we can enforce the device-trust cookie.\n    const row = await getAliasRow(alias);\n    if (!row.ok) return await deny(\"not_found\");\n    if (row.revokedAt) return await deny(\"revoked\");\n    if (isExpired(row.expiresAt)) return await deny(\"expired\");\n\n    if (row.passwordHash) {\n      const v = req.cookies.get(aliasTrustCookieName(alias))?.value;\n      const unlocked = isAliasTrusted(alias, v);\n      if (!unlocked) {\n        return new Response(null, {\n          status: 302,\n          headers: { Location: `/d/${encodeURIComponent(alias)}` },\n        });\n      }\n    }\n\n    // --- Rate limiting (best-effort) ---\n    const xff = req.headers.get(\"x-forwarded-for\") || \"\";\n    const ipFromXff = xff.split(\",\")[0]?.trim() || \"\";\n    const ipKey = stableHash(ipFromXff, \"VIEW_SALT\");\n    const ipRl = await rateLimit({\n      scope: \"ip:alias_raw\",\n      id: ipKey,\n      limit: Number(process.env.RATE_LIMIT_ALIAS_IP_PER_MIN || 90),\n      windowSeconds: 60,\n      failClosed: true,\n    });\n    if (!ipRl.ok) {\n      await logSecurityEvent({\n        type: \"alias_access_denied\",\n        severity: \"medium\",\n        ip,\n        scope: \"alias_raw\",\n        message: \"Alias raw rate-limited\",\n        meta: { alias, reason: \"rate_limit\", status: 429 },\n      });\n      await detectAliasAccessDeniedSpike({ ip });\n      return new Response(\"Too Many Requests\", {\n        status: 429,\n        headers: {\n          ...rateLimitHeaders(ipRl),\n          \"Retry-After\": String(ipRl.resetSeconds),\n        },\n      });\n    }\n\n    // Password-protected aliases are already validated above via device-trust cookie.\n    // Resolve by docId here so resolveDoc does not re-impose alias password gating.\n    const resolved = await resolveDoc({ docId: row.docId });\n    if (!resolved.ok) return await deny(`resolve_${resolved.error}`);\n\n    if (!resolved.bucket || !resolved.r2Key) {\n      return new Response(\"Not found\", { status: 404 });\n    }\n\n    const filename = pickFilename(resolved.title, resolved.originalFilename, alias);\n    const contentType = resolved.contentType || \"application/octet-stream\";\n    const disposition = parseDisposition(req);\n// --- Monetization / plan limits (hidden) ---\n// Enforce the document owner's monthly view quota.\nif (shouldCountView(req)) {\n  let ownerId: string | null = null;\n  try {\n    const ownerRows = (await sql`\n        select owner_id::text as owner_id\n        from public.docs\n        where id = ${row.docId}::uuid\n        limit 1\n      `) as unknown as Array<{ owner_id: string | null }>;\n    ownerId = ownerRows?.[0]?.owner_id ?? null;\n  } catch {\n    if (enforcePlanLimitsEnabled()) {\n      return new Response(\"Temporarily unavailable\", { status: 503 });\n    }\n    ownerId = null;\n  }\n\n  if (ownerId) {\n    const allowed = await assertCanServeView(ownerId);\n    if (!allowed.ok) {\n      return new Response(allowed.message || \"Plan limit reached. Upgrade required.\", { status: 402 });\n    }\n\n    try {\n      await incrementMonthlyViews(ownerId, 1);\n    } catch {\n      if (enforcePlanLimitsEnabled()) {\n        return new Response(\"Temporarily unavailable\", { status: 503 });\n      }\n    }\n  }\n\n  // Best-effort view log (analytics)\n  try {\n    const ua = req.headers.get(\"user-agent\") || null;\n    const ref = req.headers.get(\"referer\") || null;\n    const ip = (req.headers.get(\"x-forwarded-for\") || \"\").split(\",\")[0]?.trim() || \"\";\n    const ipHash = hashIp(ip);\n\n    try {\n      await sql`\n        insert into public.doc_views\n          (doc_id, alias, path, kind, user_agent, referer, ip_hash, share_token, event_type)\n        values\n          (${row.docId}::uuid, ${alias}, ${new URL(req.url).pathname}, 'alias', ${ua}, ${ref}, ${ipHash}, null, ${disposition === \"attachment\" ? \"file_download\" : \"preview_view\"})\n      `;\n    } catch {\n      await sql`\n        insert into public.doc_views\n          (doc_id, alias, path, kind, user_agent, referer, ip_hash)\n        values\n          (${row.docId}::uuid, ${alias}, ${new URL(req.url).pathname}, 'alias', ${ua}, ${ref}, ${ipHash})\n      `;\n    }\n  } catch {\n    // ignore\n  }\n}\n\n\n\n    const ticketId = await mintAccessTicket({\n      req,\n      docId: row.docId,\n      shareToken: null,\n      alias,\n      purpose: disposition === \"attachment\" ? \"file_download\" : \"preview_view\",\n      r2Bucket: resolved.bucket,\n      r2Key: resolved.r2Key,\n      responseContentType: contentType,\n      responseContentDisposition: `${disposition}; filename=\"${filename}\"`,\n    });\n\n    if (!ticketId) {\n      return new Response(\"Internal server error\", {\n        status: 500,\n        headers: { ...rateLimitHeaders(ipRl) },\n      });\n    }\n\n        return new Response(null, {\n          status: 302,\n          headers: {\n            Location: new URL(`/t/${ticketId}`, req.url).toString(),\n            ...rateLimitHeaders(ipRl),\n            \"Cache-Control\": \"private, no-store\",\n          },\n        });\n      })(),\n      timeoutMs\n    );\n  } catch (err: any) {\n    if (isRuntimeEnvError(err)) {\n      return new Response(\"Unavailable\", { status: 503 });\n    }\n    if (isRouteTimeoutError(err)) {\n      await logSecurityEvent({\n        type: \"alias_raw_timeout\",\n        severity: \"high\",\n        ip: clientIpKey(req).ip,\n        scope: \"alias_raw\",\n        message: \"Alias raw route exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return new Response(\"Gateway Timeout\", { status: 504 });\n    }\n    await logDbErrorEvent({\n      scope: \"alias_raw\",\n      message: String(err?.message || err || \"alias_raw_error\"),\n      ip: clientIpKey(req).ip,\n      meta: { route: \"/d/[alias]/raw\" },\n    });\n    console.error(\"RAW ROUTE ERROR:\", err);\n    return new Response(\"Internal server error\", { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\d\\[alias]\\unlockActions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\data-retention\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\debug-db\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\dmca\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\org\\[slug]\\auth\\[provider]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[656,659],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[656,659],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/app/org/[slug]/auth/[provider]/route.ts\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { ORG_COOKIE_NAME, ORG_INVITE_COOKIE_NAME } from \"@/lib/tenant\";\nimport { getOrgBySlug } from \"@/lib/orgs\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nconst ALLOWED = new Set([\"google\", \"enterprise-oidc\"]);\n\ntype RouteCtx = {\n  // Next.js typings changed in recent versions: `params` may be a Promise.\n  params: { slug: string; provider: string } | Promise<{ slug: string; provider: string }>;\n};\n\nexport async function GET(req: NextRequest, ctx: RouteCtx) {\n  const params = await Promise.resolve(ctx?.params as any);\n  const slug = String(params?.slug || \"\").trim().toLowerCase();\n  const provider = String(params?.provider || \"\").trim();\n\n  if (!slug) {\n    return NextResponse.redirect(new URL(\"/login\", req.url));\n  }\n\n  const org = await getOrgBySlug(slug);\n  if (!org) {\n    return NextResponse.redirect(new URL(\"/login\", req.url));\n  }\n\n  if (!ALLOWED.has(provider)) {\n    return NextResponse.redirect(new URL(`/org/${encodeURIComponent(slug)}/login`, req.url));\n  }\n\n  const inviteToken = String(new URL(req.url).searchParams.get(\"invite\") || \"\").trim();\n\n  // Bind org to this browser (httpOnly so JS can't tamper with it).\n  const res = NextResponse.redirect(\n    new URL(\n      `/api/auth/signin/${encodeURIComponent(provider)}?callbackUrl=${encodeURIComponent(\"/admin/dashboard\")}`,\n      req.url\n    )\n  );\n\n  res.cookies.set(ORG_COOKIE_NAME, slug, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    maxAge: 60 * 60 * 24 * 14, // 14 days\n  });\n\n  if (inviteToken) {\n    res.cookies.set(ORG_INVITE_COOKIE_NAME, inviteToken, {\n      httpOnly: true,\n      sameSite: \"lax\",\n      secure: process.env.NODE_ENV === \"production\",\n      path: \"/\",\n      maxAge: 60 * 30, // 30 minutes\n    });\n  }\n\n  return res;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\org\\[slug]\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\projects\\doclinks\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\projects\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\providers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\report\\ReportForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1286,1289],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1286,1289],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":66,"column":7,"nodeType":"JSXOpeningElement","endLine":66,"endColumn":71},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":67,"column":7,"nodeType":"JSXOpeningElement","endLine":74,"endColumn":9},{"ruleId":"jsx-a11y/label-has-associated-control","severity":1,"message":"A form label must be associated with a control.","line":76,"column":7,"nodeType":"JSXOpeningElement","endLine":76,"endColumn":71},{"ruleId":"jsx-a11y/control-has-associated-label","severity":1,"message":"A control must be associated with a text label.","line":77,"column":7,"nodeType":"JSXOpeningElement","endLine":82,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useMemo, useState } from \"react\";\n\ntype Props = {\n  token?: string | null;\n  alias?: string | null;\n};\n\nexport default function ReportForm({ token, alias }: Props) {\n  const [email, setEmail] = useState(\"\");\n  const [message, setMessage] = useState(\"\");\n  const [status, setStatus] = useState<\"idle\" | \"sending\" | \"sent\" | \"error\">(\"idle\");\n  const [err, setErr] = useState<string | null>(null);\n\n  const targetLabel = useMemo(() => {\n    if (token) return `Share token: ${token.slice(0, 8)}…`;\n    if (alias) return `Alias: ${alias}`;\n    return \"Unknown document\";\n  }, [token, alias]);\n\n  async function submit() {\n    setStatus(\"sending\");\n    setErr(null);\n    try {\n      const res = await fetch(\"/api/v1/abuse/report\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          token: token || null,\n          alias: alias || null,\n          reporter_email: email || null,\n          message: message || null,\n        }),\n      });\n\n      const data = await res.json().catch(() => ({}));\n      if (!res.ok || !data?.ok) {\n        setStatus(\"error\");\n        setErr(data?.message || data?.error || \"Unable to submit report.\");\n        return;\n      }\n      setStatus(\"sent\");\n    } catch (e: any) {\n      setStatus(\"error\");\n      setErr(e?.message || \"Network error.\");\n    }\n  }\n\n  if (status === \"sent\") {\n    return (\n      <div className=\"rounded-xl border border-white/10 bg-white/5 p-4\">\n        <div className=\"text-sm font-medium text-white\">Report submitted</div>\n        <div className=\"mt-1 text-sm text-white/70\">\n          Thanks — we’ll review it. If this is an emergency, contact local authorities.\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"rounded-2xl border border-white/10 bg-white/5 p-4\">\n      <div className=\"text-sm font-medium text-white\">Report abuse</div>\n      <div className=\"mt-1 text-xs text-white/60\">{targetLabel}</div>\n\n      <label className=\"mt-4 block text-xs font-medium text-white/70\">Your email (optional)</label>\n      <input\n        value={email}\n        onChange={(e) => setEmail(e.target.value)}\n        className=\"mt-1 w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/30 outline-none focus:border-white/20\"\n        placeholder=\"you@example.com\"\n        type=\"email\"\n        autoComplete=\"email\"\n      />\n\n      <label className=\"mt-4 block text-xs font-medium text-white/70\">What’s going on?</label>\n      <textarea\n        value={message}\n        onChange={(e) => setMessage(e.target.value)}\n        className=\"mt-1 min-h-[120px] w-full rounded-xl border border-white/10 bg-black/30 px-3 py-2 text-sm text-white placeholder:text-white/30 outline-none focus:border-white/20\"\n        placeholder=\"Tell us why this content should be removed…\"\n      />\n\n      {status === \"error\" && err ? (\n        <div className=\"mt-3 rounded-xl border border-red-900/40 bg-red-950/30 px-3 py-2 text-sm text-red-200\">\n          {err}\n        </div>\n      ) : null}\n\n      <div className=\"mt-4 flex items-center justify-between gap-3\">\n        <div className=\"text-xs text-white/50\">\n          By submitting, you agree to our{\" \"}\n          <a className=\"text-white/70 underline hover:text-white\" href=\"/acceptable-use\">\n            acceptable use policy\n          </a>\n          .\n        </div>\n\n        <button\n          onClick={submit}\n          disabled={status === \"sending\" || (!token && !alias) || (!message.trim() && !email.trim())}\n          className=\"rounded-xl bg-white px-4 py-2 text-sm font-medium text-black hover:bg-white/90 disabled:cursor-not-allowed disabled:opacity-50\"\n        >\n          {status === \"sending\" ? \"Sending…\" : \"Submit\"}\n        </button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\report\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\ShareShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\download\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_req' is defined but never used.","line":6,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_ctx' is defined but never used.","line":6,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":50}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\nexport async function GET(_req: NextRequest, _ctx: { params: Promise<{ token: string }> }) {\n  return new NextResponse(\"Download is disabled for this shared document.\", {\n    status: 403,\n    headers: {\n      \"Cache-Control\": \"private, no-store, max-age=0\",\n      Pragma: \"no-cache\",\n      Expires: \"0\",\n    },\n  });\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\passwordGate.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\raw\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\view\\WatermarkedViewer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\s\\[token]\\view\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\security-disclosure\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\serve\\[docId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\signin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\t\\[ticketId]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1719,1722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1719,1722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":259,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8546,8549],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8546,8549],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":311,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":311,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10184,10187],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10184,10187],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":359,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":359,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11887,11890],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11887,11890],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":360,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":360,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11961,11964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11961,11964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":364,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":364,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12210,12213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12210,12213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { GetObjectCommand } from \"@aws-sdk/client-s3\";\nimport { r2Client } from \"@/lib/r2\";\nimport { consumeAccessTicket } from \"@/lib/accessTicket\";\nimport { sql } from \"@/lib/db\";\nimport { clientIpKey, enforceGlobalApiRateLimit, logDbErrorEvent, logSecurityEvent } from \"@/lib/securityTelemetry\";\nimport { decryptAes256Gcm, unwrapDataKey } from \"@/lib/encryption\";\nimport { getMasterKeyByIdOrThrow } from \"@/lib/masterKeys\";\nimport { hashUserAgent, hashIpForTicket } from \"@/lib/accessTicket\";\nimport { Readable } from \"node:stream\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\nimport { allowUnencryptedServing, isSecurityTestNoDbMode, isTicketServingDisabled } from \"@/lib/securityPolicy\";\nimport { getRouteTimeoutMs, isRouteTimeoutError, withRouteTimeout } from \"@/lib/routeTimeout\";\nimport { assertRuntimeEnv, isRuntimeEnvError } from \"@/lib/runtimeEnv\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction isBlockedTopLevelTicketOpen(req: NextRequest): boolean {\n  const dest = (req.headers.get(\"sec-fetch-dest\") || \"\").toLowerCase();\n  const mode = (req.headers.get(\"sec-fetch-mode\") || \"\").toLowerCase();\n  const user = (req.headers.get(\"sec-fetch-user\") || \"\").toLowerCase();\n  return dest === \"document\" && mode === \"navigate\" && user === \"?1\";\n}\n\nfunction secureDocHeaders(extra?: Record<string, string>): Record<string, string> {\n  return {\n    \"Cache-Control\": \"private, no-store, max-age=0\",\n    Pragma: \"no-cache\",\n    Expires: \"0\",\n    \"X-Content-Type-Options\": \"nosniff\",\n    \"Referrer-Policy\": \"no-referrer\",\n    ...(extra || {}),\n  };\n}\n\nfunction toWebStream(body: any): ReadableStream<Uint8Array> {\n  // AWS SDK v3 in Node returns a Node.js Readable stream.\n  // NextResponse expects a web stream (or a Blob/Buffer).\n  if (!body) {\n    return new ReadableStream<Uint8Array>({\n      start(controller) {\n        controller.close();\n      },\n    });\n  }\n  // If it already looks like a web stream, return as-is.\n  if (typeof body?.getReader === \"function\") return body as ReadableStream<Uint8Array>;\n  // Convert Node Readable -> Web ReadableStream\n  try {\n    return Readable.toWeb(body) as unknown as ReadableStream<Uint8Array>;\n  } catch {\n    // Fallback: buffer the whole response (last resort)\n    const rs = new ReadableStream<Uint8Array>({\n      async start(controller) {\n        const ab = body?.transformToByteArray\n          ? await body.transformToByteArray()\n          : Buffer.from(await new Response(body).arrayBuffer());\n        controller.enqueue(new Uint8Array(ab));\n        controller.close();\n      },\n    });\n    return rs;\n  }\n}\n\nexport async function GET(\n  req: NextRequest,\n  { params }: { params: Promise<{ ticketId: string }> }\n) {\n  const timeoutMs = getRouteTimeoutMs(\"ROUTE_TIMEOUT_TICKET_SERVE_MS\", 30_000);\n  try {\n    return await withRouteTimeout(\n      (async () => {\n        assertRuntimeEnv(\"ticket_serve\");\n\n        if (isSecurityTestNoDbMode()) {\n          return new NextResponse(\"Direct open is disabled for this protected document.\", {\n            status: 403,\n            headers: secureDocHeaders(),\n          });\n        }\n\n  if (await isTicketServingDisabled()) {\n    return new NextResponse(\"Unavailable\", { status: 503, headers: secureDocHeaders() });\n  }\n\n  const { ticketId } = await params;\n\n  if (isBlockedTopLevelTicketOpen(req)) {\n    return new NextResponse(\"Direct open is disabled for this protected document.\", {\n      status: 403,\n      headers: secureDocHeaders(),\n    });\n  }\n\n  // Throttle ticket exchange (prevents hotlink storms)\n  const ticketRl = await enforceGlobalApiRateLimit({\n    req,\n    scope: \"ip:ticket\",\n    limit: Number(process.env.RATE_LIMIT_TICKET_IP_PER_MIN || 240),\n    windowSeconds: 60,\n    strict: true,\n  });\n  if (!ticketRl.ok) {\n    return new NextResponse(\"Too Many Requests\", {\n      status: ticketRl.status,\n      headers: secureDocHeaders({ \"Retry-After\": String(ticketRl.retryAfterSeconds) }),\n    });\n  }\n\n  const consumed = await consumeAccessTicket({ req, ticketId });\n  if (!consumed.ok) {\n    void logSecurityEvent({\n      type: \"ticket_consume_denied\",\n      severity: \"medium\",\n      ip: clientIpKey(req).ip,\n      scope: \"ticket_serve\",\n      message: \"Access ticket consume denied\",\n      meta: { ticketId },\n    });\n    return new NextResponse(\"Not found\", {\n      status: 404,\n      headers: secureDocHeaders(),\n    });\n  }\n\n  const t = consumed.ticket;\n  if (t.doc_id) {\n    try {\n      const rows = (await sql`\n        select\n          coalesce(moderation_status::text, 'active') as moderation_status,\n          coalesce(scan_status::text, 'unscanned') as scan_status\n        from public.docs\n        where id = ${t.doc_id}::uuid\n        limit 1\n      `) as unknown as Array<{ moderation_status: string; scan_status: string }>;\n\n      const row = rows?.[0];\n      const moderation = (row?.moderation_status || \"active\").toLowerCase();\n      const scanStatus = (row?.scan_status || \"unscanned\").toLowerCase();\n\n      if (moderation === \"deleted\" || moderation === \"disabled\") {\n        return new NextResponse(\"Unavailable\", { status: 404, headers: secureDocHeaders() });\n      }\n      if (moderation === \"quarantined\") {\n        return new NextResponse(\"Unavailable\", { status: 404, headers: secureDocHeaders() });\n      }\n      // Critical invariant: serve/download only after scan is explicitly clean.\n      if (scanStatus !== \"clean\") {\n        return new NextResponse(\"Unavailable\", { status: 404, headers: secureDocHeaders() });\n      }\n    } catch {\n      return new NextResponse(\"Unavailable\", { status: 404, headers: secureDocHeaders() });\n    }\n  }\n\n  // If the doc is encrypted, we must proxy + decrypt server-side.\n  let enc:\n    | {\n        enabled: true;\n        alg: string;\n        iv: Buffer;\n        keyVersion: string;\n        wrappedKey: Buffer;\n        wrapIv: Buffer;\n        wrapTag: Buffer;\n      }\n    | { enabled: false } = { enabled: false };\n  let encryptionMetaInvalid: { missingKeyVersion: boolean } | null = null;\n\n  if (t.doc_id) {\n    try {\n      const rows = (await sql`\n        select\n          coalesce(encryption_enabled, false) as encryption_enabled,\n          coalesce(enc_alg, '')::text as enc_alg,\n          enc_iv as enc_iv,\n          coalesce(enc_key_version, '')::text as enc_key_version,\n          enc_wrapped_key as enc_wrapped_key,\n          enc_wrap_iv as enc_wrap_iv,\n          enc_wrap_tag as enc_wrap_tag\n        from public.docs\n        where id = ${t.doc_id}::uuid\n        limit 1\n      `) as unknown as Array<{\n        encryption_enabled: boolean;\n        enc_alg: string;\n        enc_iv: Buffer | null;\n        enc_key_version: string;\n        enc_wrapped_key: Buffer | null;\n        enc_wrap_iv: Buffer | null;\n        enc_wrap_tag: Buffer | null;\n      }>;\n\n      const r = rows?.[0];\n      if (r?.encryption_enabled) {\n        const hasAllEncryptionMeta = Boolean(\n          r.enc_alg &&\n            r.enc_iv &&\n            r.enc_key_version &&\n            r.enc_wrapped_key &&\n            r.enc_wrap_iv &&\n            r.enc_wrap_tag\n        );\n        if (!hasAllEncryptionMeta) {\n          encryptionMetaInvalid = { missingKeyVersion: !r.enc_key_version };\n        } else {\n          enc = {\n            enabled: true,\n            alg: r.enc_alg,\n            iv: r.enc_iv!,\n            keyVersion: r.enc_key_version,\n            wrappedKey: r.enc_wrapped_key!,\n            wrapIv: r.enc_wrap_iv!,\n            wrapTag: r.enc_wrap_tag!,\n          };\n        }\n      }\n    } catch {\n      // ignore\n    }\n  }\n\n  if (encryptionMetaInvalid) {\n    void logSecurityEvent({\n      type: \"ticket_serve_encryption_meta_missing\",\n      severity: \"high\",\n      ip: clientIpKey(req).ip,\n      docId: t.doc_id,\n      scope: \"ticket_serve\",\n      message: \"Encrypted document is missing required key metadata\",\n      meta: {\n        missingKeyVersion: encryptionMetaInvalid.missingKeyVersion,\n      },\n    });\n    return new NextResponse(\"Unavailable\", { status: 500, headers: secureDocHeaders() });\n  }\n\n  if (enc.enabled) {\n    try {\n      const mk = await getMasterKeyByIdOrThrow(enc.keyVersion);\n      const dataKey = unwrapDataKey({\n        wrapped: enc.wrappedKey,\n        wrapIv: enc.wrapIv,\n        wrapTag: enc.wrapTag,\n        masterKey: mk.key,\n      });\n\n      const obj = await r2Client.send(\n        new GetObjectCommand({\n          Bucket: t.r2_bucket,\n          Key: t.r2_key,\n        })\n      );\n\n      const body = obj.Body as any;\n      const ab = body?.transformToByteArray\n        ? await body.transformToByteArray()\n        : Buffer.from(await new Response(body).arrayBuffer());\n\n      const decrypted = decryptAes256Gcm({ ciphertext: Buffer.from(ab), iv: enc.iv, key: dataKey });\n\n      // Audit decrypt event (best-effort)\n      const ip = clientIpKey(req).ip;\n      const ua = req.headers.get(\"user-agent\") || null;\n      try {\n        await sql`\n          insert into public.doc_decrypt_log\n            (doc_id, ticket_id, ip_hash, ua_hash, key_version)\n          values\n            (${t.doc_id}::uuid, ${t.id}::uuid, ${hashIpForTicket(ip)}, ${hashUserAgent(ua)}, ${enc.keyVersion})\n        `;\n      } catch {\n        // ignore\n      }\n\n      await appendImmutableAudit({\n        streamKey: `doc:${t.doc_id}`,\n        action: \"doc.decrypt\",\n        docId: t.doc_id,\n        subjectId: t.id,\n        ipHash: hashIpForTicket(ip),\n        payload: {\n          keyVersion: enc.keyVersion,\n          purpose: t.purpose ?? null,\n        },\n      });\n\n      void logSecurityEvent({\n        type: \"decrypt\",\n        severity: \"low\",\n        ip,\n        docId: t.doc_id,\n        scope: \"doc_decrypt\",\n        message: \"Document decrypted for serving\",\n        meta: { keyVersion: enc.keyVersion },\n      });\n\n      const responseBlob = new Blob([new Uint8Array(decrypted)]);\n\n      return new NextResponse(responseBlob, {\n        status: 200,\n        headers: secureDocHeaders({\n          \"Content-Type\": t.response_content_type || \"application/pdf\",\n          \"Content-Disposition\": t.response_content_disposition || \"inline\",\n        }),\n      });\n    } catch (e: any) {\n      void logSecurityEvent({\n        type: \"anomaly\",\n        severity: \"high\",\n        ip: clientIpKey(req).ip,\n        docId: t.doc_id,\n        scope: \"doc_decrypt_error\",\n        message: e?.message || \"Decrypt failed\",\n      });\n      return new NextResponse(\"Server error\", { status: 500, headers: secureDocHeaders() });\n    }\n  }\n\n  // Platform policy: legacy unencrypted files are blocked unless explicitly allowed.\n  if (!allowUnencryptedServing()) {\n    void logSecurityEvent({\n      type: \"unencrypted_serve_blocked\",\n      severity: \"high\",\n      ip: clientIpKey(req).ip,\n      docId: t.doc_id,\n      scope: \"ticket_serve\",\n      message: \"Serving blocked for unencrypted document by policy\",\n    });\n    return new NextResponse(\"Unavailable\", { status: 403, headers: secureDocHeaders() });\n  }\n\n  // Same-origin proxy for non-encrypted docs.\n  // This avoids CSP \"frame-src\" issues caused by redirecting the browser to the R2 bucket hostname.\n  // Also prevents leaking presigned URLs into client-side logs/telemetry.\n  const range = req.headers.get(\"range\") || undefined;\n\n  const obj = await r2Client.send(\n    new GetObjectCommand({\n      Bucket: t.r2_bucket,\n      Key: t.r2_key,\n      Range: range,\n      ResponseContentType: t.response_content_type || undefined,\n      ResponseContentDisposition: t.response_content_disposition || undefined,\n    })\n  );\n\n  const headers = secureDocHeaders({\n    \"Content-Type\": t.response_content_type || \"application/pdf\",\n    \"Content-Disposition\": t.response_content_disposition || \"inline\",\n    // PDF viewers like Range support; we forward range responses when present.\n    \"Accept-Ranges\": \"bytes\",\n  });\n\n  const contentRange = (obj as any)?.ContentRange as string | undefined;\n  const contentLength = (obj as any)?.ContentLength as number | undefined;\n  if (contentRange) headers[\"Content-Range\"] = contentRange;\n  if (typeof contentLength === \"number\") headers[\"Content-Length\"] = String(contentLength);\n\n        return new NextResponse(toWebStream((obj as any).Body), {\n          status: contentRange ? 206 : 200,\n          headers,\n        });\n      })(),\n      timeoutMs\n    );\n  } catch (e: unknown) {\n    if (isRuntimeEnvError(e)) {\n      return new NextResponse(\"Unavailable\", { status: 503, headers: secureDocHeaders() });\n    }\n    if (isRouteTimeoutError(e)) {\n      void logSecurityEvent({\n        type: \"ticket_serve_timeout\",\n        severity: \"high\",\n        ip: clientIpKey(req).ip,\n        scope: \"ticket_serve\",\n        message: \"Ticket serve exceeded timeout\",\n        meta: { timeoutMs },\n      });\n      return new NextResponse(\"Gateway Timeout\", { status: 504, headers: secureDocHeaders() });\n    }\n    if (e instanceof Error) {\n      await logDbErrorEvent({\n        scope: \"ticket_serve\",\n        message: e.message,\n        ip: clientIpKey(req).ip,\n        meta: { route: \"/t/[ticketId]\" },\n      });\n    }\n    return new NextResponse(\"Unavailable\", { status: 503, headers: secureDocHeaders() });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\app\\terms\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2871,2874],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2871,2874],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":173,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4682,4685],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4682,4685],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":185,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4928,4931],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4928,4931],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":185,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":185,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4953,4956],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4953,4956],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4990,4993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4990,4993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":192,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5190,5193],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5190,5193],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":192,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":192,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5212,5215],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5212,5215],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { NextAuthOptions } from \"next-auth\";\nimport GoogleProvider from \"next-auth/providers/google\";\nimport Credentials from \"next-auth/providers/credentials\";\n\n/**\n * Auth (NextAuth v4)\n *\n * Sign-in methods:\n * - Google OAuth (regular email accounts)\n * - Enterprise SSO (BYO OIDC) (organizational logins)\n *\n * Landing behavior:\n * - ALWAYS land on /admin/dashboard after a successful sign-in\n * - Sign-out should land on /\n *\n * Owner role:\n * - We compute `user.role` into the session so server layouts can hide/show owner-only nav.\n * - Set OWNER_EMAILS (comma-separated) or OWNER_EMAIL in Vercel to control who is \"owner\".\n *\n * Env vars (core):\n * - NEXTAUTH_URL=https://www.cyang.io\n * - NEXTAUTH_SECRET=<long random>\n *\n * Google OAuth:\n * - GOOGLE_CLIENT_ID\n * - GOOGLE_CLIENT_SECRET\n *\n * Enterprise OIDC (BYO):\n * - OIDC_ISSUER\n * - OIDC_CLIENT_ID\n * - OIDC_CLIENT_SECRET\n *\n * Owner allowlist:\n * - OWNER_EMAILS=\"a@x.com,b@y.com\"  (recommended)\n *   OR\n * - OWNER_EMAIL=\"a@x.com\"\n */\n\nconst POST_SIGN_IN_PATH = \"/admin/dashboard\";\n\nconst useSecureCookies =\n  (process.env.NEXTAUTH_URL || \"\").toLowerCase().startsWith(\"https://\") ||\n  (process.env.VERCEL || \"\").toLowerCase() === \"1\" ||\n  (process.env.VERCEL_ENV || \"\").length > 0;\n\nfunction hasEnv(...keys: string[]) {\n  return keys.every((k) => {\n    const v = process.env[k];\n    return typeof v === \"string\" && v.trim().length > 0;\n  });\n}\n\nexport const isGoogleConfigured = hasEnv(\"GOOGLE_CLIENT_ID\", \"GOOGLE_CLIENT_SECRET\");\n\nexport const isEnterpriseSsoConfigured = hasEnv(\n  \"OIDC_ISSUER\",\n  \"OIDC_CLIENT_ID\",\n  \"OIDC_CLIENT_SECRET\"\n);\n\nfunction parseOwnerEmails(): Set<string> {\n  const single = (process.env.OWNER_EMAIL ?? \"\").trim().toLowerCase();\n  const list = (process.env.OWNER_EMAILS ?? \"\").trim();\n\n  const emails = new Set<string>();\n  if (single) emails.add(single);\n\n  if (list) {\n    for (const part of list.split(\",\")) {\n      const e = part.trim().toLowerCase();\n      if (e) emails.add(e);\n    }\n  }\n  return emails;\n}\n\nconst OWNER_EMAIL_SET = parseOwnerEmails();\n\nfunction computeRole(email?: string | null): \"owner\" | \"viewer\" {\n  const e = (email ?? \"\").trim().toLowerCase();\n  if (!e) return \"viewer\";\n\n  // If no allowlist is configured, default to viewer for safety.\n  if (OWNER_EMAIL_SET.size === 0) return \"viewer\";\n\n  return OWNER_EMAIL_SET.has(e) ? \"owner\" : \"viewer\";\n}\n\nfunction enterpriseOidcProvider() {\n  const issuer = process.env.OIDC_ISSUER!;\n  const wellKnown = issuer.replace(/\\/+$/, \"\") + \"/.well-known/openid-configuration\";\n\n  return {\n    id: \"enterprise-sso\",\n    name: \"Enterprise SSO\",\n    type: \"oauth\",\n    wellKnown,\n    clientId: process.env.OIDC_CLIENT_ID!,\n    clientSecret: process.env.OIDC_CLIENT_SECRET!,\n    authorization: { params: { scope: \"openid email profile\" } },\n    idToken: true,\n    checks: [\"pkce\", \"state\"],\n    profile(profile: any) {\n      return {\n        id: profile.sub ?? profile.id ?? profile.user_id ?? profile.oid ?? profile.uid,\n        name:\n          profile.name ??\n          [profile.given_name, profile.family_name].filter(Boolean).join(\" \") ??\n          profile.preferred_username ??\n          profile.email ??\n          null,\n        email: profile.email ?? profile.upn ?? profile.preferred_username ?? null,\n        image: profile.picture ?? null,\n      };\n    },\n  } as const;\n}\n\nexport const authOptions: NextAuthOptions = {\n  // Make cookie security explicit (prod-safe defaults).\n  useSecureCookies,\n  cookies: useSecureCookies\n    ? {\n        // Note: __Host- requires Path=/, Secure, and no Domain.\n        csrfToken: {\n          name: \"__Host-next-auth.csrf-token\",\n          options: {\n            httpOnly: true,\n            sameSite: \"lax\",\n            path: \"/\",\n            secure: true,\n          },\n        },\n        sessionToken: {\n          name: \"__Secure-next-auth.session-token\",\n          options: {\n            httpOnly: true,\n            sameSite: \"lax\",\n            path: \"/\",\n            secure: true,\n          },\n        },\n        callbackUrl: {\n          name: \"__Secure-next-auth.callback-url\",\n          options: {\n            sameSite: \"lax\",\n            path: \"/\",\n            secure: true,\n          },\n        },\n      }\n    : undefined,\n\n  providers: [\n    Credentials({\n      id: \"disabled\",\n      name: \"Disabled\",\n      credentials: {},\n      async authorize() {\n        return null;\n      },\n    }),\n\n    ...(isGoogleConfigured\n      ? [\n          GoogleProvider({\n            clientId: process.env.GOOGLE_CLIENT_ID!,\n            clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n          }),\n        ]\n      : []),\n\n    ...(isEnterpriseSsoConfigured ? [enterpriseOidcProvider() as any] : []),\n  ],\n\n  pages: {\n    signIn: \"/signin\",\n  },\n\n  session: { strategy: \"jwt\" },\n\n  callbacks: {\n    async jwt({ token, user }) {\n      // On first sign-in, `user` is present. Afterwards rely on token.email.\n      const email = (user as any)?.email ?? (token as any)?.email ?? null;\n      (token as any).role = computeRole(email);\n      return token;\n    },\n\n    async session({ session, token }) {\n      // Expose role to server components (layouts) and client UI if needed.\n      (session.user as any).role = (token as any).role ?? \"viewer\";\n      return session;\n    },\n\n    async redirect({ url, baseUrl }) {\n      try {\n        const u = new URL(url, baseUrl);\n\n        // Allow explicit home redirects (used by sign-out).\n        if (u.origin === baseUrl && (u.pathname === \"/\" || u.pathname === \"\")) {\n          return baseUrl;\n        }\n\n        // Keep NextAuth system routes functioning.\n        if (u.origin === baseUrl && u.pathname.startsWith(\"/api/auth\")) {\n          return `${baseUrl}${u.pathname}${u.search}`;\n        }\n\n        // If caller explicitly redirects into /admin, honor it.\n        if (u.origin === baseUrl && u.pathname.startsWith(\"/admin\")) {\n          return `${baseUrl}${u.pathname}${u.search}`;\n        }\n      } catch {\n        // ignore parsing issues; fall through to forcing admin\n      }\n\n      // Default: always send signed-in users to the admin dashboard\n      return `${baseUrl}${POST_SIGN_IN_PATH}`;\n    },\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\components\\AuthModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\components\\DemoDocButton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\components\\HeaderAuth.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\components\\Sparkline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\accessTicket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\alias.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\analytics.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\apiAuth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\apiKeys.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\audit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\authz.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":286,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9102,9105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9102,9105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":309,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10032,10035],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10032,10035],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":352,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":352,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11632,11635],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11632,11635],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":356,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":356,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11754,11757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11754,11757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":357,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":357,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11811,11814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11811,11814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":466,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":466,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15371,15374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15371,15374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/authz.ts\nimport { getServerSession } from \"next-auth\";\nimport { cookies } from \"next/headers\";\n\nimport { authOptions } from \"@/auth\";\nimport { sql } from \"@/lib/db\";\nimport { ORG_COOKIE_NAME, ORG_INVITE_COOKIE_NAME } from \"@/lib/tenant\";\nimport { getOrgBySlug, orgAllowsEmail } from \"@/lib/orgs\";\nimport { acceptInviteForUser, getActiveMembership, orgMembershipTablesReady, upsertMembership } from \"@/lib/orgMembership\";\n\nexport type Role = \"viewer\" | \"admin\" | \"owner\";\n\nexport type AuthedUser = {\n  id: string;\n  email: string;\n  role: Role;\n  orgId: string | null;\n  orgSlug: string | null;\n};\n\nasync function orgAccessDisabled(orgIdRaw: string | null | undefined): Promise<boolean> {\n  const orgId = String(orgIdRaw || \"\").trim();\n  if (!orgId) return false;\n  if (!(await organizationsTableExists())) return false;\n\n  try {\n    const rows = (await sql`\n      select\n        coalesce(disabled, false) as disabled,\n        coalesce(is_active, true) as is_active\n      from public.organizations\n      where id = ${orgId}::uuid\n      limit 1\n    `) as unknown as Array<{ disabled: boolean; is_active: boolean }>;\n    const r = rows?.[0];\n    if (!r) return true;\n    return Boolean(r.disabled) || !Boolean(r.is_active);\n  } catch {\n    // Older schemas may not have disabled/is_active flags.\n    try {\n      const rows = (await sql`\n        select 1\n        from public.organizations\n        where id = ${orgId}::uuid\n        limit 1\n      `) as unknown as Array<{ \"?column?\": number }>;\n      return rows.length === 0;\n    } catch {\n      return false;\n    }\n  }\n}\n\nexport async function assertOrgActiveForAccess(orgIdRaw: string | null | undefined): Promise<void> {\n  if (await orgAccessDisabled(orgIdRaw)) {\n    throw new Error(\"ORG_DISABLED\");\n  }\n}\n\nfunction normEmail(email: string): string {\n  return String(email || \"\").trim().toLowerCase();\n}\n\nfunction roleRank(role: Role): number {\n  switch (role) {\n    case \"viewer\":\n      return 1;\n    case \"admin\":\n      return 2;\n    case \"owner\":\n      return 3;\n  }\n}\n\nfunction ownerEmailSetFromEnv(): Set<string> {\n  const single = normEmail(process.env.OWNER_EMAIL || \"\");\n  const list = String(process.env.OWNER_EMAILS || \"\").trim();\n  const set = new Set<string>();\n  if (single) set.add(single);\n  if (list) {\n    for (const part of list.split(\",\")) {\n      const email = normEmail(part);\n      if (email) set.add(email);\n    }\n  }\n  return set;\n}\n\n/**\n * Back-compat helper: return the configured owner email (or empty string).\n * Some older code wraps this in an async function, so this is intentionally sync.\n */\nexport function getOwnerEmail(): string {\n  const set = ownerEmailSetFromEnv();\n  return set.values().next().value ?? \"\";\n}\n\n/**\n * Back-compat helper: check if a role meets or exceeds a minimum required role.\n */\nexport function roleAtLeast(role: Role, minRole: Role): boolean {\n  return roleRank(role) >= roleRank(minRole);\n}\n\nasync function organizationsTableExists(): Promise<boolean> {\n  try {\n    const rows = (await sql`select to_regclass('public.organizations')::text as reg`) as unknown as Array<{ reg: string | null }>;\n    return !!rows?.[0]?.reg;\n  } catch {\n    return false;\n  }\n}\n\nlet _defaultOrgId: string | null | undefined = undefined;\nasync function getDefaultOrgId(): Promise<string | null> {\n  if (_defaultOrgId !== undefined) return _defaultOrgId;\n  try {\n    if (!(await organizationsTableExists())) {\n      _defaultOrgId = null;\n      return _defaultOrgId;\n    }\n    const rows = (await sql`\n      select id::text as id\n      from public.organizations\n      where slug = 'default'\n      limit 1\n    `) as unknown as Array<{ id: string }>;\n    _defaultOrgId = rows?.[0]?.id ?? null;\n    return _defaultOrgId;\n  } catch {\n    _defaultOrgId = null;\n    return _defaultOrgId;\n  }\n}\n\nexport type EnsureUserCtx = { orgId: string | null; orgSlug: string | null };\n\nasync function consumeInviteCookieToken(): Promise<string | null> {\n  try {\n    const c = await cookies();\n    const token = String(c.get(ORG_INVITE_COOKIE_NAME)?.value || \"\").trim();\n    if (!token) return null;\n    c.set(ORG_INVITE_COOKIE_NAME, \"\", {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === \"production\",\n      sameSite: \"lax\",\n      path: \"/\",\n      maxAge: 0,\n    });\n    return token;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Ensure a row exists in public.users for this email and return {id,email,role,orgId,orgSlug}.\n *\n * V3 (multi-tenant) behavior:\n * - If organizations exist and ctx.orgSlug is set, bind the user to that org.\n * - If orgId is null but orgSlug resolves, it will be set.\n * - If neither is provided and a 'default' org exists, user is bound to default.\n * - Email remains globally unique; if an existing user has a different org_id, sign-in is denied.\n *\n * Role behavior (same as V2):\n * - Default role: viewer\n * - If email matches OWNER_EMAIL: role forced to owner (never downgraded)\n */\nexport async function ensureUserByEmail(emailRaw: string, ctx: EnsureUserCtx): Promise<AuthedUser> {\n  const email = normEmail(emailRaw);\n  if (!email) throw new Error(\"UNAUTHENTICATED\");\n\n  const ownerEmails = ownerEmailSetFromEnv();\n  const desiredRole: Role = ownerEmails.has(email) ? \"owner\" : \"viewer\";\n\n  // Resolve org if possible\n  let orgId = ctx.orgId ?? null;\n  let orgSlug = ctx.orgSlug ?? null;\n\n  if (!orgId && orgSlug && (await organizationsTableExists())) {\n    const org = await getOrgBySlug(orgSlug);\n    if (!org) {\n      throw new Error(\"ORG_NOT_FOUND\");\n    }\n    if (!orgAllowsEmail(org, email)) {\n      throw new Error(\"ORG_DOMAIN_BLOCKED\");\n    }\n    orgId = org.id;\n    orgSlug = org.slug;\n  }\n\n  if (!orgId) {\n    orgId = await getDefaultOrgId();\n    if (orgId && !orgSlug) orgSlug = \"default\";\n  }\n  if (orgId) {\n    await assertOrgActiveForAccess(orgId);\n  }\n\n  try {\n    // If users table doesn't have org_id yet, keep older behavior.\n    // We'll try an insert that includes org_id, and fall back if column missing.\n    try {\n      const rows = (await sql`\n        insert into public.users (email, role, org_id)\n        values (${email}, ${desiredRole}, ${orgId}::uuid)\n        on conflict (email) do update\n        set role =\n          case\n            when public.users.role = 'owner' then 'owner'\n            when excluded.role = 'owner' then 'owner'\n            else public.users.role\n          end\n        returning id::text as id, email, role, org_id::text as org_id\n      `) as unknown as Array<{ id: string; email: string; role: Role; org_id: string | null }>;\n\n      const u = rows?.[0];\n      if (!u?.id) throw new Error(\"Failed to upsert user.\");\n\n      // Enforce org binding if org_id exists.\n      if (orgId && u.org_id && u.org_id !== orgId) {\n        throw new Error(\"ORG_MISMATCH\");\n      }\n\n      if (orgId && (await orgMembershipTablesReady())) {\n        const isOwnerByEnv = desiredRole === \"owner\";\n        const defaultOrgId = await getDefaultOrgId();\n        const isDefaultOrg = defaultOrgId && orgId === defaultOrgId;\n\n        if (isOwnerByEnv || isDefaultOrg) {\n          await upsertMembership({\n            orgId,\n            userId: u.id,\n            role: isOwnerByEnv ? \"owner\" : u.role === \"admin\" ? \"admin\" : \"viewer\",\n            invitedByUserId: null,\n          });\n        }\n\n        let membership = await getActiveMembership({ orgId, userId: u.id });\n        if (!membership) {\n          const inviteToken = await consumeInviteCookieToken();\n          if (inviteToken) {\n            await acceptInviteForUser({\n              orgId,\n              userId: u.id,\n              email,\n              token: inviteToken,\n            });\n            membership = await getActiveMembership({ orgId, userId: u.id });\n          }\n        }\n\n        if (!membership && !isOwnerByEnv && !isDefaultOrg) {\n          throw new Error(\"ORG_MEMBERSHIP_REQUIRED\");\n        }\n\n        if (membership?.role === \"admin\" && u.role === \"viewer\") {\n          const rows3 = (await sql`\n            update public.users\n            set role = 'admin'\n            where id = ${u.id}::uuid\n            returning id::text as id, email, role, org_id::text as org_id\n          `) as unknown as Array<{ id: string; email: string; role: Role; org_id: string | null }>;\n          const u3 = rows3?.[0];\n          if (u3?.id) {\n            return { id: u3.id, email: u3.email, role: u3.role, orgId: u3.org_id ?? orgId, orgSlug };\n          }\n        }\n      }\n\n      // Defensive: if OWNER_EMAIL matches, guarantee role owner.\n      if (desiredRole === \"owner\" && u.role !== \"owner\") {\n        const rows2 = (await sql`\n          update public.users\n          set role = 'owner'\n          where id = ${u.id}::uuid\n          returning id::text as id, email, role, org_id::text as org_id\n        `) as unknown as Array<{ id: string; email: string; role: Role; org_id: string | null }>;\n        const u2 = rows2?.[0];\n        if (u2?.id) {\n          return { id: u2.id, email: u2.email, role: u2.role, orgId: u2.org_id ?? orgId, orgSlug };\n        }\n      }\n\n      return { id: u.id, email: u.email, role: u.role, orgId: u.org_id ?? orgId, orgSlug };\n    } catch (e: any) {\n      const msg = String(e?.message || \"\").toLowerCase();\n      const missingOrgIdCol = msg.includes(\"column\") && msg.includes(\"org_id\") && msg.includes(\"does not exist\");\n      if (!missingOrgIdCol) throw e;\n\n      // Fall back to V2 schema without org_id\n      const rows = (await sql`\n        insert into public.users (email, role)\n        values (${email}, ${desiredRole})\n        on conflict (email) do update\n        set role =\n          case\n            when public.users.role = 'owner' then 'owner'\n            when excluded.role = 'owner' then 'owner'\n            else public.users.role\n          end\n        returning id::text as id, email, role\n      `) as unknown as Array<{ id: string; email: string; role: Role }>;\n\n      const u = rows?.[0];\n      if (!u?.id) throw new Error(\"Failed to upsert user.\");\n      return { id: u.id, email: u.email, role: u.role, orgId: null, orgSlug: null };\n    }\n  } catch (e: any) {\n    const msg = String(e?.message || \"\").toLowerCase();\n\n    if (msg.includes(\"org_mismatch\")) {\n      throw new Error(\"This email is already bound to a different organization.\");\n    }\n    if (msg.includes(\"org_not_found\")) {\n      throw new Error(\"Organization not found.\");\n    }\n    if (msg.includes(\"org_domain_blocked\")) {\n      throw new Error(\"Email domain is not allowed for this organization.\");\n    }\n    if (msg.includes(\"org_membership_required\")) {\n      throw new Error(\"Organization membership is required. Ask an owner for an invite.\");\n    }\n    if (msg.includes(\"org_disabled\")) {\n      throw new Error(\"Organization is disabled.\");\n    }\n\n    if (msg.includes(\"relation\") && msg.includes(\"users\") && msg.includes(\"does not exist\")) {\n      throw new Error(\n        \"Missing table public.users. Run scripts/sql/user_ownership_layer.sql in your database.\"\n      );\n    }\n    if (msg.includes(\"column\") && msg.includes(\"role\") && msg.includes(\"does not exist\")) {\n      throw new Error(\n        \"public.users schema is missing expected columns. Re-run scripts/sql/user_ownership_layer.sql.\"\n      );\n    }\n\n    throw e;\n  }\n}\n\n/**\n * Returns the authenticated user, or null if not signed in.\n * Safe to call from server components.\n *\n * NOTE: Server components don't have access to the incoming request directly,\n * so we rely on next/headers cookies + default authOptions.\n * The NextAuth route binds org context into the JWT (orgId/orgSlug).\n */\nexport async function getAuthedUser(): Promise<AuthedUser | null> {\n  const session = (await getServerSession(authOptions)) as any;\n  const email = normEmail(session?.user?.email || \"\");\n  if (!email) return null;\n\n  const orgId = (session?.user as any)?.orgId ?? null;\n  const orgSlug = (session?.user as any)?.orgSlug ?? null;\n\n  try {\n    return await ensureUserByEmail(email, { orgId, orgSlug });\n  } catch (e: unknown) {\n    const msg = e instanceof Error ? e.message : \"\";\n    if (\n      msg.includes(\"Organization membership is required\") ||\n      msg.includes(\"Email domain is not allowed\") ||\n      msg.includes(\"Organization not found\")\n    ) {\n      return null;\n    }\n    throw e;\n  }\n}\n\n/**\n * Throws if not signed in, otherwise returns the authed user.\n */\nexport async function requireUser(): Promise<AuthedUser> {\n  const u = await getAuthedUser();\n  if (!u) throw new Error(\"UNAUTHENTICATED\");\n  await assertOrgActiveForAccess(u.orgId);\n  return u;\n}\n\n/**\n * Require at least a given role. (owner >= admin >= viewer)\n * - requireRole(\"admin\") allows admin + owner\n * - requireRole(\"owner\") allows owner only\n */\nexport async function requireRole(minRole: Role): Promise<AuthedUser> {\n  const u = await requireUser();\n  if (!roleAtLeast(u.role, minRole)) throw new Error(\"FORBIDDEN\");\n  return u;\n}\n\n/**\n * Returns the org slug requested (cookie) if present.\n * Useful for pages that need to render /org/[slug] experiences.\n */\nexport async function getOrgSlugHint(): Promise<string | null> {\n  try {\n    // In Next.js App Router, cookies() may be async depending on version.\n    const c = await cookies();\n    const v = c.get(ORG_COOKIE_NAME)?.value ?? \"\";\n    const slug = String(v || \"\").trim().toLowerCase();\n    return slug ? slug : null;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Require permission to write/manage a doc.\n * - owner/admin can write any doc *within their org*\n * - viewer can write only docs they own (docs.owner_id)\n *\n * Back-compat: if docs.owner_id doesn't exist yet, viewers are forbidden and\n * admins/owners are allowed.\n */\nexport async function requireDocWrite(docIdRaw: string): Promise<void> {\n  const docId = String(docIdRaw || \"\").trim();\n  if (!docId) throw new Error(\"Missing docId.\");\n\n  const u = await requireUser();\n  await assertOrgActiveForAccess(u.orgId);\n  if (u.role === \"owner\") {\n    // Owner has full control across all documents.\n    return;\n  }\n  if (u.role === \"admin\") {\n    // still enforce org scope if docs.org_id exists\n    try {\n      const rows = (await sql`\n        select org_id::text as org_id\n        from public.docs\n        where id = ${docId}::uuid\n        limit 1\n      `) as unknown as Array<{ org_id: string | null }>;\n      const docOrgId = rows?.[0]?.org_id ?? null;\n      if (docOrgId && u.orgId && docOrgId !== u.orgId) throw new Error(\"FORBIDDEN\");\n    } catch {\n      // ignore if org_id doesn't exist\n    }\n    return;\n  }\n\n  try {\n    const rows = (await sql`\n      select owner_id::text as owner_id,\n             org_id::text as org_id,\n             lower(coalesce(created_by_email, ''))::text as created_by_email\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as unknown as Array<{ owner_id: string | null; org_id: string | null; created_by_email: string }>;\n\n    const ownerId = rows?.[0]?.owner_id ?? null;\n    const docOrgId = rows?.[0]?.org_id ?? null;\n    const createdByEmail = rows?.[0]?.created_by_email ?? \"\";\n\n    // Legacy fallback: before owner_id was enforced, treat created_by_email as ownership signal.\n    const ownsById = ownerId === u.id;\n    const ownsByEmail = !ownerId && createdByEmail && createdByEmail === String(u.email || \"\").toLowerCase();\n    if (!ownsById && !ownsByEmail) throw new Error(\"FORBIDDEN\");\n    if (docOrgId && u.orgId && docOrgId !== u.orgId) throw new Error(\"FORBIDDEN\");\n    return;\n  } catch (e: any) {\n    const msg = String(e?.message || \"\").toLowerCase();\n    const missingOwnerIdCol =\n      msg.includes(\"column\") && msg.includes(\"owner_id\") && msg.includes(\"does not exist\");\n    if (missingOwnerIdCol) {\n      // Before ownership layer existed.\n      throw new Error(\"FORBIDDEN\");\n    }\n    throw e;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\backupRecovery.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\billingFlags.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\billingSubscription.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":281,"column":86,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":281,"endColumn":89,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8956,8959],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8956,8959],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":286,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":286,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9235,9238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9235,9238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\n\ntype StripeSubUpsertArgs = {\n  userId: string | null;\n  stripeCustomerId: string | null;\n  stripeSubscriptionId: string;\n  status: string;\n  planId: string;\n  currentPeriodEnd: string | null;\n  cancelAtPeriodEnd: boolean;\n  graceUntil: string | null;\n  eventCreatedUnix: number | null;\n};\n\nlet billingTableExistsCache: boolean | null = null;\n\nasync function billingTableExists(): Promise<boolean> {\n  if (billingTableExistsCache != null) return billingTableExistsCache;\n  try {\n    const rows = (await sql`select to_regclass('public.billing_subscriptions')::text as reg`) as unknown as Array<{ reg: string | null }>;\n    billingTableExistsCache = Boolean(rows?.[0]?.reg);\n  } catch {\n    billingTableExistsCache = false;\n  }\n  return billingTableExistsCache;\n}\n\nexport async function billingTablesReady(): Promise<boolean> {\n  return billingTableExists();\n}\n\nexport function unixToIso(v: unknown): string | null {\n  const n = Number(v);\n  if (!Number.isFinite(n) || n <= 0) return null;\n  return new Date(n * 1000).toISOString();\n}\n\nexport async function getUserIdByStripeCustomerId(customerId: string | null): Promise<string | null> {\n  const id = String(customerId || \"\").trim();\n  if (!id) return null;\n  try {\n    const rows = (await sql`\n      select id::text as id\n      from public.users\n      where stripe_customer_id = ${id}\n      limit 1\n    `) as unknown as Array<{ id: string }>;\n    return rows?.[0]?.id ?? null;\n  } catch {\n    return null;\n  }\n}\n\nexport async function upsertStripeSubscription(args: StripeSubUpsertArgs): Promise<void> {\n  if (!(await billingTableExists())) return;\n  if (!args.userId && !args.stripeCustomerId) return;\n\n  const eventCreated = Number.isFinite(args.eventCreatedUnix as number)\n    ? Math.max(0, Math.floor(Number(args.eventCreatedUnix)))\n    : 0;\n  try {\n    await sql`\n      insert into public.billing_subscriptions (\n        user_id,\n        stripe_customer_id,\n        stripe_subscription_id,\n        status,\n        plan_id,\n        current_period_end,\n        cancel_at_period_end,\n        grace_until,\n        last_event_created,\n        updated_at\n      ) values (\n        ${args.userId}::uuid,\n        ${args.stripeCustomerId},\n        ${args.stripeSubscriptionId},\n        ${args.status},\n        ${args.planId},\n        ${args.currentPeriodEnd ? args.currentPeriodEnd : null}::timestamptz,\n        ${args.cancelAtPeriodEnd},\n        ${args.graceUntil ? args.graceUntil : null}::timestamptz,\n        ${eventCreated}::bigint,\n        now()\n      )\n      on conflict (stripe_subscription_id)\n      do update set\n        user_id = excluded.user_id,\n        stripe_customer_id = excluded.stripe_customer_id,\n        status = excluded.status,\n        plan_id = excluded.plan_id,\n        current_period_end = excluded.current_period_end,\n        cancel_at_period_end = excluded.cancel_at_period_end,\n        grace_until = excluded.grace_until,\n        last_event_created = excluded.last_event_created,\n        updated_at = now()\n      where coalesce(public.billing_subscriptions.last_event_created, 0) <= excluded.last_event_created\n    `;\n  } catch {\n    // Backward compatibility for schemas without last_event_created.\n    await sql`\n      insert into public.billing_subscriptions (\n        user_id,\n        stripe_customer_id,\n        stripe_subscription_id,\n        status,\n        plan_id,\n        current_period_end,\n        cancel_at_period_end,\n        grace_until,\n        updated_at\n      ) values (\n        ${args.userId}::uuid,\n        ${args.stripeCustomerId},\n        ${args.stripeSubscriptionId},\n        ${args.status},\n        ${args.planId},\n        ${args.currentPeriodEnd ? args.currentPeriodEnd : null}::timestamptz,\n        ${args.cancelAtPeriodEnd},\n        ${args.graceUntil ? args.graceUntil : null}::timestamptz,\n        now()\n      )\n      on conflict (stripe_subscription_id)\n      do update set\n        user_id = excluded.user_id,\n        stripe_customer_id = excluded.stripe_customer_id,\n        status = excluded.status,\n        plan_id = excluded.plan_id,\n        current_period_end = excluded.current_period_end,\n        cancel_at_period_end = excluded.cancel_at_period_end,\n        grace_until = excluded.grace_until,\n        updated_at = now()\n    `;\n  }\n\n  if (args.userId && args.stripeCustomerId) {\n    try {\n      await sql`\n        update public.users\n        set stripe_customer_id = ${args.stripeCustomerId}\n        where id = ${args.userId}::uuid\n      `;\n    } catch {\n      // optional column in older envs\n    }\n  }\n}\n\nexport async function markPaymentFailure(args: {\n  stripeSubscriptionId: string | null;\n  stripeCustomerId: string | null;\n  graceDays: number;\n  eventCreatedUnix: number | null;\n}): Promise<void> {\n  if (!(await billingTableExists())) return;\n\n  const subId = String(args.stripeSubscriptionId || \"\").trim();\n  const customerId = String(args.stripeCustomerId || \"\").trim();\n  if (!subId && !customerId) return;\n\n  const eventCreated = Number.isFinite(args.eventCreatedUnix as number)\n    ? Math.max(0, Math.floor(Number(args.eventCreatedUnix)))\n    : 0;\n  try {\n    await sql`\n      update public.billing_subscriptions\n      set\n        status = 'past_due',\n        grace_until = now() + (${Math.max(0, Math.floor(args.graceDays))}::int * interval '1 day'),\n        last_event_created = ${eventCreated}::bigint,\n        updated_at = now()\n      where (\n        (${subId} <> '' and stripe_subscription_id = ${subId})\n        or (${customerId} <> '' and stripe_customer_id = ${customerId})\n      )\n      and coalesce(last_event_created, 0) <= ${eventCreated}::bigint\n    `;\n  } catch {\n    await sql`\n      update public.billing_subscriptions\n      set\n        status = 'past_due',\n        grace_until = now() + (${Math.max(0, Math.floor(args.graceDays))}::int * interval '1 day'),\n        updated_at = now()\n      where\n        (${subId} <> '' and stripe_subscription_id = ${subId})\n        or (${customerId} <> '' and stripe_customer_id = ${customerId})\n    `;\n  }\n}\n\nexport async function markPaymentSucceeded(args: {\n  stripeSubscriptionId: string | null;\n  stripeCustomerId: string | null;\n  eventCreatedUnix: number | null;\n}): Promise<void> {\n  if (!(await billingTableExists())) return;\n\n  const subId = String(args.stripeSubscriptionId || \"\").trim();\n  const customerId = String(args.stripeCustomerId || \"\").trim();\n  if (!subId && !customerId) return;\n\n  const eventCreated = Number.isFinite(args.eventCreatedUnix as number)\n    ? Math.max(0, Math.floor(Number(args.eventCreatedUnix)))\n    : 0;\n  try {\n    await sql`\n      update public.billing_subscriptions\n      set\n        status = 'active',\n        grace_until = null,\n        last_event_created = ${eventCreated}::bigint,\n        updated_at = now()\n      where (\n        (${subId} <> '' and stripe_subscription_id = ${subId})\n        or (${customerId} <> '' and stripe_customer_id = ${customerId})\n      )\n      and coalesce(last_event_created, 0) <= ${eventCreated}::bigint\n    `;\n  } catch {\n    await sql`\n      update public.billing_subscriptions\n      set\n        status = 'active',\n        grace_until = null,\n        updated_at = now()\n      where\n        (${subId} <> '' and stripe_subscription_id = ${subId})\n        or (${customerId} <> '' and stripe_customer_id = ${customerId})\n    `;\n  }\n}\n\nexport async function syncUserPlanFromSubscription(userId: string | null): Promise<\"free\" | \"pro\" | null> {\n  const uid = String(userId || \"\").trim();\n  if (!uid) return null;\n  if (!(await billingTableExists())) return null;\n\n  const rows = (await sql`\n    select\n      plan_id::text as plan_id,\n      status::text as status,\n      current_period_end::text as current_period_end,\n      grace_until::text as grace_until\n    from public.billing_subscriptions\n    where user_id = ${uid}::uuid\n    order by updated_at desc\n    limit 1\n  `) as unknown as Array<{\n    plan_id: string | null;\n    status: string | null;\n    current_period_end: string | null;\n    grace_until: string | null;\n  }>;\n\n  const r = rows?.[0];\n  const planId = String(r?.plan_id || \"free\").toLowerCase() === \"pro\" ? \"pro\" : \"free\";\n  const status = String(r?.status || \"\").toLowerCase();\n  const now = Date.now();\n  const graceUntil = r?.grace_until ? Date.parse(r.grace_until) : Number.NaN;\n  const periodEnd = r?.current_period_end ? Date.parse(r.current_period_end) : Number.NaN;\n\n  const entitled =\n    status === \"active\" ||\n    status === \"trialing\" ||\n    ((status === \"past_due\" || status === \"grace\") && Number.isFinite(graceUntil) && graceUntil > now) ||\n    (status === \"active\" && Number.isFinite(periodEnd) && periodEnd > now);\n\n  const nextPlan: \"free\" | \"pro\" = planId === \"pro\" && entitled ? \"pro\" : \"free\";\n\n  await sql`\n    update public.users\n    set plan_id = ${nextPlan}\n    where id = ${uid}::uuid\n      and plan_id <> ${nextPlan}\n  `;\n\n  return nextPlan;\n}\n\nexport async function beginWebhookEvent(eventId: string, eventType: string, payload: any): Promise<\"new\" | \"duplicate\"> {\n  if (!(await billingTableExists())) return \"new\";\n  try {\n    const rows = (await sql`\n      insert into public.billing_webhook_events (event_id, event_type, payload, status, received_at)\n      values (${eventId}, ${eventType}, ${payload as any}::jsonb, 'processing', now())\n      on conflict (event_id) do nothing\n      returning event_id\n    `) as unknown as Array<{ event_id: string }>;\n    return rows?.length ? \"new\" : \"duplicate\";\n  } catch {\n    return \"new\";\n  }\n}\n\nexport async function completeWebhookEvent(eventId: string, status: \"processed\" | \"ignored\" | \"failed\", message: string | null): Promise<void> {\n  if (!(await billingTableExists())) return;\n  try {\n    await sql`\n      update public.billing_webhook_events\n      set status = ${status}, message = ${message}, processed_at = now()\n      where event_id = ${eventId}\n    `;\n  } catch {\n    // ignore\n  }\n}\n\nexport type BillingSubscriptionSnapshot = {\n  stripeSubscriptionId: string;\n  stripeCustomerId: string | null;\n  status: string;\n  planId: string;\n  currentPeriodEnd: string | null;\n  cancelAtPeriodEnd: boolean;\n  graceUntil: string | null;\n  updatedAt: string;\n} | null;\n\nexport type BillingWebhookEventRow = {\n  eventId: string;\n  eventType: string;\n  status: string;\n  message: string | null;\n  receivedAt: string;\n  processedAt: string | null;\n};\n\nexport type BillingEntitlementStatus = \"none\" | \"active\" | \"grace\" | \"at_risk\" | \"downgraded\";\n\nexport function classifyBillingEntitlement(sub: BillingSubscriptionSnapshot): BillingEntitlementStatus {\n  if (!sub) return \"none\";\n\n  const status = String(sub.status || \"\").toLowerCase();\n  const now = Date.now();\n  const graceUntil = sub.graceUntil ? Date.parse(sub.graceUntil) : Number.NaN;\n  const periodEnd = sub.currentPeriodEnd ? Date.parse(sub.currentPeriodEnd) : Number.NaN;\n\n  if (status === \"active\" || status === \"trialing\") return \"active\";\n  if ((status === \"past_due\" || status === \"grace\") && Number.isFinite(graceUntil) && graceUntil > now) {\n    return \"grace\";\n  }\n  if (status === \"incomplete\" || status === \"incomplete_expired\" || status === \"unpaid\") return \"at_risk\";\n  if (status === \"canceled\" || status === \"grace_expired\") return \"downgraded\";\n  if (status === \"active\" && Number.isFinite(periodEnd) && periodEnd <= now) return \"at_risk\";\n\n  return \"at_risk\";\n}\n\nexport async function getBillingSnapshotForUser(userId: string): Promise<{\n  subscription: BillingSubscriptionSnapshot;\n  events: BillingWebhookEventRow[];\n}> {\n  if (!(await billingTableExists())) return { subscription: null, events: [] };\n\n  const subRows = (await sql`\n    select\n      stripe_subscription_id::text as stripe_subscription_id,\n      stripe_customer_id::text as stripe_customer_id,\n      status::text as status,\n      plan_id::text as plan_id,\n      current_period_end::text as current_period_end,\n      cancel_at_period_end::boolean as cancel_at_period_end,\n      grace_until::text as grace_until,\n      updated_at::text as updated_at\n    from public.billing_subscriptions\n    where user_id = ${userId}::uuid\n    order by updated_at desc\n    limit 1\n  `) as unknown as Array<{\n    stripe_subscription_id: string;\n    stripe_customer_id: string | null;\n    status: string;\n    plan_id: string;\n    current_period_end: string | null;\n    cancel_at_period_end: boolean;\n    grace_until: string | null;\n    updated_at: string;\n  }>;\n\n  const sub = subRows?.[0]\n    ? {\n        stripeSubscriptionId: subRows[0].stripe_subscription_id,\n        stripeCustomerId: subRows[0].stripe_customer_id ?? null,\n        status: subRows[0].status,\n        planId: subRows[0].plan_id,\n        currentPeriodEnd: subRows[0].current_period_end ?? null,\n        cancelAtPeriodEnd: Boolean(subRows[0].cancel_at_period_end),\n        graceUntil: subRows[0].grace_until ?? null,\n        updatedAt: subRows[0].updated_at,\n      }\n    : null;\n\n  const evRows = (await sql`\n    select\n      event_id::text as event_id,\n      event_type::text as event_type,\n      status::text as status,\n      message::text as message,\n      received_at::text as received_at,\n      processed_at::text as processed_at\n    from public.billing_webhook_events\n    order by received_at desc\n    limit 20\n  `) as unknown as Array<{\n    event_id: string;\n    event_type: string;\n    status: string;\n    message: string | null;\n    received_at: string;\n    processed_at: string | null;\n  }>;\n\n  const events: BillingWebhookEventRow[] = evRows.map((r) => ({\n    eventId: r.event_id,\n    eventType: r.event_type,\n    status: r.status,\n    message: r.message ?? null,\n    receivedAt: r.received_at,\n    processedAt: r.processed_at ?? null,\n  }));\n\n  return { subscription: sub, events };\n}\n\nexport async function runBillingMaintenance(args?: { maxUsers?: number }): Promise<{\n  ok: boolean;\n  usersScanned: number;\n  downgradedToFree: number;\n  errors: number;\n}> {\n  if (!(await billingTableExists())) {\n    return { ok: false, usersScanned: 0, downgradedToFree: 0, errors: 0 };\n  }\n\n  const maxUsers = Math.max(1, Math.min(5000, Number(args?.maxUsers || process.env.BILLING_MAINTENANCE_MAX_USERS || 500)));\n\n  try {\n    // Mark expired grace windows to a terminal state so entitlement checks are deterministic.\n    await sql`\n      update public.billing_subscriptions\n      set\n        status = 'grace_expired',\n        updated_at = now()\n      where lower(coalesce(status, '')) in ('past_due', 'grace')\n        and grace_until is not null\n        and grace_until <= now()\n    `;\n  } catch {\n    // non-fatal\n  }\n\n  const userRows = (await sql`\n    select distinct user_id::text as user_id\n    from public.billing_subscriptions\n    where user_id is not null\n    order by user_id\n    limit ${maxUsers}\n  `) as unknown as Array<{ user_id: string }>;\n\n  let usersScanned = 0;\n  let downgradedToFree = 0;\n  let errors = 0;\n\n  for (const row of userRows) {\n    const uid = String(row.user_id || \"\").trim();\n    if (!uid) continue;\n    usersScanned += 1;\n    try {\n      const nextPlan = await syncUserPlanFromSubscription(uid);\n      if (nextPlan === \"free\") downgradedToFree += 1;\n    } catch {\n      errors += 1;\n    }\n  }\n\n  return { ok: true, usersScanned, downgradedToFree, errors };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\cookies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\cronAuth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\cronTelemetry.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\crypto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\cryptoSecrets.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\db.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[496,499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[496,499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[512,515],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[512,515],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[535,538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[535,538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { neon } from \"@neondatabase/serverless\";\n\nlet cachedSql: ReturnType<typeof neon> | null = null;\n\nfunction getSql(): ReturnType<typeof neon> {\n    if (cachedSql) return cachedSql;\n\n    const url = process.env.DATABASE_URL;\n    if (!url) {\n        throw new Error(\"Missing DATABASE_URL\");\n    }\n\n    cachedSql = neon(url);\n    return cachedSql;\n}\n\n// Lazy DB init prevents build-time module evaluation from failing in CI\n// when DATABASE_URL is intentionally not present.\nexport const sql: any = (...args: any[]) => (getSql() as any)(...args);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\demo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\deviceTrust.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\email.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\encryptionMigration.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\expirationAlerts.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":64,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1631,1634],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1631,1634],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2366,2369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2366,2369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/expirationAlerts.ts\n// Nightly expiration alerts (email + in-app notifications)\n\nimport { sql } from \"@/lib/db\";\nimport { sendMail } from \"@/lib/email\";\nimport { getExpirationAlertSettings } from \"@/lib/settings\";\n\nfunction getBaseUrl() {\n  const explicit = process.env.BASE_URL || process.env.NEXTAUTH_URL;\n  if (explicit) return explicit.replace(/\\/+$/, \"\");\n\n  const vercel = process.env.VERCEL_URL;\n  if (vercel) return `https://${vercel}`.replace(/\\/+$/, \"\");\n\n  return \"http://localhost:3000\";\n}\n\nexport type ExpiringAliasRow = {\n  owner_id: string;\n  owner_email: string;\n  doc_id: string;\n  title: string | null;\n  alias: string | null;\n  expires_at: string; // text\n};\n\nexport type ExpiringShareRow = {\n  owner_id: string;\n  owner_email: string;\n  token: string;\n  doc_id: string;\n  title: string | null;\n  to_email: string | null;\n  expires_at: string; // text\n};\n\nexport type ExpirationAlertsResult = {\n  ok: boolean;\n  enabled: boolean;\n  email_enabled: boolean;\n  days: number;\n  owners_processed: number;\n  sent_count: number;\n  alias_items: number;\n  share_items: number;\n  skipped_reason?: string;\n  errors?: string[];\n};\n\nfunction clampDays(days: unknown, fallback: number) {\n  const n = typeof days === \"number\" ? days : Number(String(days ?? \"\"));\n  if (!Number.isFinite(n)) return fallback;\n  return Math.max(1, Math.min(30, Math.floor(n)));\n}\n\nasync function tryUpsertNotification(p: {\n  ownerId: string;\n  kind: \"alias_expiring\" | \"share_expiring\";\n  docId: string | null;\n  alias?: string | null;\n  shareToken?: string | null;\n  title?: string | null;\n  expiresAt: string; // ISO text\n  payload?: any;\n}) {\n  const dedupeKey = [\n    p.ownerId,\n    p.kind,\n    p.docId || \"\",\n    p.alias || \"\",\n    p.shareToken || \"\",\n    // bucket by day to avoid duplicates on repeated runs\n    String(p.expiresAt || \"\").slice(0, 10),\n  ].join(\":\");\n\n  try {\n    await sql`\n      insert into public.admin_notifications (\n        owner_id,\n        kind,\n        doc_id,\n        alias,\n        share_token,\n        title,\n        expires_at,\n        payload,\n        dedupe_key\n      )\n      values (\n        ${p.ownerId}::uuid,\n        ${p.kind},\n        nullif(${p.docId ?? ''}, '')::uuid,\n        ${p.alias ?? null},\n        ${p.shareToken ?? null},\n        ${p.title ?? null},\n        ${p.expiresAt}::timestamptz,\n        ${(p.payload ?? {}) as any}::jsonb,\n        ${dedupeKey}\n      )\n      on conflict (dedupe_key) do nothing\n    `;\n  } catch {\n    // best-effort; table may not exist yet\n  }\n}\n\nexport async function sendExpirationAlerts(input?: { days?: number }): Promise<ExpirationAlertsResult> {\n  const settingsRes = await getExpirationAlertSettings();\n  const settings = settingsRes.ok ? settingsRes.settings : { enabled: true, days: 3, emailEnabled: true };\n\n  const days = clampDays(input?.days, settings.days);\n\n  if (!settings.enabled) {\n    return {\n      ok: true,\n      enabled: false,\n      email_enabled: settings.emailEnabled,\n      days,\n      owners_processed: 0,\n      sent_count: 0,\n      alias_items: 0,\n      share_items: 0,\n      skipped_reason: \"disabled\",\n    };\n  }\n\n  const base = getBaseUrl();\n  const errors: string[] = [];\n\n  // 1) Expiring aliases\n  let aliases: ExpiringAliasRow[] = [];\n  try {\n    aliases = (await sql`\n      select\n        d.owner_id::text as owner_id,\n        u.email as owner_email,\n        d.id::text as doc_id,\n        d.title,\n        a.alias,\n        a.expires_at::text as expires_at\n      from public.doc_aliases a\n      join public.docs d on d.id = a.doc_id\n      join public.users u on u.id = d.owner_id\n      where coalesce(a.is_active, true) = true\n        and a.revoked_at is null\n        and a.expires_at is not null\n        and a.expires_at > now()\n        and a.expires_at <= (now() + (${days}::int * interval '1 day'))\n      order by d.owner_id, a.expires_at asc\n      limit 500\n    `) as unknown as ExpiringAliasRow[];\n  } catch (e) {\n    errors.push(`aliases_query_failed: ${e instanceof Error ? e.message : String(e)}`);\n    aliases = [];\n  }\n\n  // 2) Expiring shares\n  let shares: ExpiringShareRow[] = [];\n  try {\n    shares = (await sql`\n      select\n        d.owner_id::text as owner_id,\n        u.email as owner_email,\n        st.token::text as token,\n        d.id::text as doc_id,\n        d.title,\n        st.to_email,\n        st.expires_at::text as expires_at\n      from public.share_tokens st\n      join public.docs d on d.id = st.doc_id\n      join public.users u on u.id = d.owner_id\n      where st.revoked_at is null\n        and st.expires_at is not null\n        and st.expires_at > now()\n        and st.expires_at <= (now() + (${days}::int * interval '1 day'))\n      order by d.owner_id, st.expires_at asc\n      limit 500\n    `) as unknown as ExpiringShareRow[];\n  } catch (e) {\n    errors.push(`shares_query_failed: ${e instanceof Error ? e.message : String(e)}`);\n    shares = [];\n  }\n\n  // Create in-app notifications (best-effort)\n  for (const r of aliases) {\n    await tryUpsertNotification({\n      ownerId: r.owner_id,\n      kind: \"alias_expiring\",\n      docId: r.doc_id,\n      alias: r.alias,\n      title: r.title,\n      expiresAt: r.expires_at,\n      payload: { doc_id: r.doc_id, alias: r.alias, expires_at: r.expires_at },\n    });\n  }\n  for (const r of shares) {\n    await tryUpsertNotification({\n      ownerId: r.owner_id,\n      kind: \"share_expiring\",\n      docId: r.doc_id,\n      shareToken: r.token,\n      title: r.title,\n      expiresAt: r.expires_at,\n      payload: { doc_id: r.doc_id, token: r.token, to_email: r.to_email, expires_at: r.expires_at },\n    });\n  }\n\n  // Group per owner\n  const owners = new Map<\n    string,\n    { email: string; aliases: ExpiringAliasRow[]; shares: ExpiringShareRow[] }\n  >();\n\n  for (const r of aliases) {\n    if (!owners.has(r.owner_id)) owners.set(r.owner_id, { email: r.owner_email, aliases: [], shares: [] });\n    owners.get(r.owner_id)!.aliases.push(r);\n  }\n  for (const r of shares) {\n    if (!owners.has(r.owner_id)) owners.set(r.owner_id, { email: r.owner_email, aliases: [], shares: [] });\n    owners.get(r.owner_id)!.shares.push(r);\n  }\n\n  let sent = 0;\n\n  if (settings.emailEnabled) {\n    for (const [ownerId, bucket] of owners.entries()) {\n      const to = (bucket.email || \"\").trim();\n      if (!to) continue;\n\n      const lines: string[] = [];\n\n      if (bucket.aliases.length) {\n        lines.push(`Aliases expiring in the next ${days} day(s):`);\n        for (const r of bucket.aliases) {\n          const name = r.title || \"Untitled\";\n          const docUrl = `${base}/admin/docs/${encodeURIComponent(r.doc_id)}`;\n          const aliasUrl = r.alias ? `${base}/d/${encodeURIComponent(r.alias)}` : \"\";\n          lines.push(\n            `- ${name} (${r.doc_id})\\n  expires: ${r.expires_at}\\n  admin: ${docUrl}${aliasUrl ? `\\n  link: ${aliasUrl}` : \"\"}`\n          );\n        }\n        lines.push(\"\");\n      }\n\n      if (bucket.shares.length) {\n        lines.push(`Shares expiring in the next ${days} day(s):`);\n        for (const r of bucket.shares) {\n          const name = r.title || \"Untitled\";\n          const docUrl = `${base}/admin/docs/${encodeURIComponent(r.doc_id)}`;\n          const shareUrl = `${base}/s/${encodeURIComponent(r.token)}`;\n          lines.push(\n            `- ${name} (${r.doc_id})\\n  expires: ${r.expires_at}\\n  token: ${r.token}${r.to_email ? `\\n  to: ${r.to_email}` : \"\"}\\n  admin: ${docUrl}\\n  link: ${shareUrl}`\n          );\n        }\n        lines.push(\"\");\n      }\n\n      const body =\n        lines.length === 0\n          ? `No items expiring in the next ${days} day(s).`\n          : lines.join(\"\\n\\n\");\n\n      try {\n        await sendMail({\n          to,\n          subject: `cyang.io: expirations in ${days} day(s)`,\n          text: body,\n        });\n        sent += 1;\n      } catch (e) {\n        errors.push(`send_failed(${ownerId}): ${e instanceof Error ? e.message : String(e)}`);\n      }\n    }\n  }\n\n  return {\n    ok: errors.length === 0,\n    enabled: settings.enabled,\n    email_enabled: settings.emailEnabled,\n    days,\n    owners_processed: owners.size,\n    sent_count: sent,\n    alias_items: aliases.length,\n    share_items: shares.length,\n    ...(errors.length ? { errors } : {}),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\geo.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":17,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[446,449],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[446,449],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[693,696],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[693,696],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[719,722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[719,722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":53,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1530,1533],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1530,1533],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":71,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2058,2061],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2058,2061],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/geo.ts\n\nimport { sql } from \"@/lib/db\";\n\nexport function getCountryFromHeaders(headers: Headers): string | null {\n  const v =\n    (headers.get(\"x-vercel-ip-country\") || \"\").trim() ||\n    (headers.get(\"cf-ipcountry\") || \"\").trim();\n  if (!v) return null;\n  const c = v.toUpperCase();\n  // Cloudflare uses \"XX\" when unknown.\n  if (c === \"XX\") return null;\n  if (!/^[A-Z]{2}$/.test(c)) return null;\n  return c;\n}\n\nfunction normList(list: any): string[] {\n  if (!Array.isArray(list)) return [];\n  return list.map((x) => String(x || \"\").trim().toUpperCase()).filter((x) => /^[A-Z]{2}$/.test(x));\n}\n\nexport function isCountryAllowed(args: {\n  country: string | null;\n  allowedCountries?: any;\n  blockedCountries?: any;\n}): boolean {\n  const country = args.country;\n  if (!country) return true; // unknown => allow (best-effort)\n\n  const allowed = normList(args.allowedCountries);\n  const blocked = normList(args.blockedCountries);\n\n  if (blocked.includes(country)) return false;\n  if (allowed.length > 0 && !allowed.includes(country)) return false;\n  return true;\n}\n\nexport async function geoDecisionForRequest(args: {\n  country: string | null;\n  docId: string;\n  token?: string | null;\n}): Promise<{ allowed: boolean; reason?: string }> {\n  const { country, docId, token } = args;\n\n  // 1) Share-level policy (if available)\n  if (token) {\n    try {\n      const rows = (await sql`\n        select allowed_countries, blocked_countries\n        from public.share_tokens\n        where token = ${token}\n        limit 1\n      `) as any[];\n      const r = rows?.[0];\n      if (r) {\n        const ok = isCountryAllowed({ country, allowedCountries: r.allowed_countries, blockedCountries: r.blocked_countries });\n        if (!ok) return { allowed: false, reason: \"SHARE_GEO_BLOCK\" };\n      }\n    } catch {\n      // columns/table may not exist yet\n    }\n  }\n\n  // 2) Doc-level policy (if available)\n  try {\n    const rows = (await sql`\n      select allowed_countries, blocked_countries\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as any[];\n    const r = rows?.[0];\n    if (r) {\n      const ok = isCountryAllowed({ country, allowedCountries: r.allowed_countries, blockedCountries: r.blocked_countries });\n      if (!ok) return { allowed: false, reason: \"DOC_GEO_BLOCK\" };\n    }\n  } catch {\n    // columns may not exist yet\n  }\n\n  return { allowed: true };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\immutableAudit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\keyRotation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\keyRotationJobs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\legal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\logAccess.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'emitWebhook' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":21,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"emitWebhook"},"fix":{"range":[56,101],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/logAccess.ts\nimport { sql } from \"@/lib/db\";\nimport { emitWebhook } from \"@/lib/webhooks\";\n\ninterface LogAccessParams {\n    docId: string;\n    alias?: string | null;\n    token?: string | null;\n    ip?: string | null;\n    userAgent?: string | null;\n}\n\nexport async function logAccess({\n    docId,\n    alias,\n    token,\n    ip,\n    userAgent,\n}: LogAccessParams) {\n    try {\n        await sql`\n      insert into public.doc_access_log (\n        doc_id,\n        alias,\n        token,\n        ip,\n        user_agent\n      )\n      values (\n        ${docId},\n        ${alias ?? null},\n        ${token ?? null},\n        ${ip ?? null},\n        ${userAgent ?? null}\n      )\n    `;\n    } catch (err) {\n        console.error(\"Failed to log access:\", err);\n        // Never throw — logging should not break file delivery\n    }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\malwareScan.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[267,270],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[267,270],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":33,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[977,980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[977,980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/malwareScan.ts\r\nimport crypto from \"crypto\";\nimport { GetObjectCommand } from \"@aws-sdk/client-s3\";\nimport { r2Client } from \"@/lib/r2\";\n\ntype HashResult = { sha256: string; sizeBytes: number; bytes: Buffer };\n\nasync function streamToBufferAndSha256(body: any, maxBytes: number): Promise<HashResult> {\n  const hash = crypto.createHash(\"sha256\");\n  let size = 0;\n  const chunks: Buffer[] = [];\n\n  // body is a ReadableStream (Node.js Readable)\n  for await (const chunk of body as AsyncIterable<Uint8Array>) {\n    size += chunk.length;\n    if (size > maxBytes) {\n      throw new Error(\"FILE_TOO_LARGE_FOR_SCAN\");\n    }\n    const b = Buffer.from(chunk);\n    hash.update(b);\n    chunks.push(b);\n  }\n\n  return { sha256: hash.digest(\"hex\"), sizeBytes: size, bytes: Buffer.concat(chunks) };\n}\n\r\nexport type MalwareScanVerdict = {\n  ok: true;\n  sha256: string;\n  verdict: \"clean\" | \"infected\" | \"unknown\";\n  riskLevel: \"low\" | \"medium\" | \"high\";\n  flags: string[];\n  meta?: any;\n};\n\nasync function scanViaExternalClam(opts: {\n  bytes: Buffer;\n  sha256: string;\n  sizeBytes: number;\n  key: string;\n}): Promise<MalwareScanVerdict> {\n  const scannerUrl = (process.env.MALWARE_SCANNER_URL || \"\").trim();\n  const scannerToken = (process.env.MALWARE_SCANNER_AUTH_TOKEN || \"\").trim();\n  const timeoutMs = Math.max(1000, Number(process.env.MALWARE_SCANNER_TIMEOUT_MS || 20000));\n  const strict = /^(1|true|yes)$/i.test(String(process.env.MALWARE_SCANNER_STRICT || \"\").trim());\n\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(\"scanner_timeout\"), timeoutMs);\n  try {\n    const headers: Record<string, string> = {\n      \"content-type\": \"application/octet-stream\",\n      \"x-file-sha256\": opts.sha256,\n      \"x-file-size\": String(opts.sizeBytes),\n      \"x-file-key\": opts.key,\n    };\n    if (scannerToken) headers.authorization = `Bearer ${scannerToken}`;\n\n    const res = await fetch(scannerUrl, {\n      method: \"POST\",\n      headers,\n      body: new Uint8Array(opts.bytes),\n      cache: \"no-store\",\n      signal: controller.signal,\n    });\n\n    const payload = (await res.json().catch(() => null)) as\n      | {\n          verdict?: \"clean\" | \"infected\" | \"unknown\";\n          flags?: string[];\n          riskLevel?: \"low\" | \"medium\" | \"high\";\n          signature?: string | null;\n          scannerVersion?: string | null;\n          meta?: unknown;\n        }\n      | null;\n\n    if (!res.ok) {\n      return {\n        ok: true,\n        sha256: opts.sha256,\n        verdict: strict ? \"infected\" : \"unknown\",\n        riskLevel: strict ? \"high\" : \"medium\",\n        flags: [`clam:http:${res.status}`, strict ? \"clam:strict_block\" : \"clam:error\", `size:${opts.sizeBytes}`],\n        meta: { source: \"clam-http\", status: res.status, body: payload, strict },\n      };\n    }\n\n    const verdict = payload?.verdict === \"infected\" || payload?.verdict === \"clean\" ? payload.verdict : \"unknown\";\n    const riskLevel =\n      payload?.riskLevel === \"high\" || payload?.riskLevel === \"medium\" || payload?.riskLevel === \"low\"\n        ? payload.riskLevel\n        : verdict === \"infected\"\n        ? \"high\"\n        : verdict === \"clean\"\n        ? \"low\"\n        : \"medium\";\n    const flags = Array.isArray(payload?.flags)\n      ? payload.flags.map((f) => String(f)).filter(Boolean)\n      : [verdict === \"infected\" ? \"clam:infected\" : verdict === \"clean\" ? \"clam:clean\" : \"clam:unknown\"];\n\n    return {\n      ok: true,\n      sha256: opts.sha256,\n      verdict,\n      riskLevel,\n      flags: [...flags, `size:${opts.sizeBytes}`],\n      meta: {\n        source: \"clam-http\",\n        scannerVersion: payload?.scannerVersion || \"clam-http\",\n        signature: payload?.signature ?? null,\n        raw: payload?.meta ?? null,\n      },\n    };\n  } catch (e: unknown) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return {\n      ok: true,\n      sha256: opts.sha256,\n      verdict: strict ? \"infected\" : \"unknown\",\n      riskLevel: strict ? \"high\" : \"medium\",\n      flags: [\"clam:exception\", strict ? \"clam:strict_block\" : \"clam:error\", `size:${opts.sizeBytes}`],\n      meta: { source: \"clam-http\", error: msg, strict },\n    };\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nexport async function scanR2Object(opts: {\n  bucket: string;\n  key: string;\n  absMaxBytes: number;\n}): Promise<MalwareScanVerdict> {\r\n  const { bucket, key, absMaxBytes } = opts;\r\n\r\n  const get = await r2Client.send(\r\n    new GetObjectCommand({\r\n      Bucket: bucket,\r\n      Key: key,\r\n    })\r\n  );\r\n\r\n  if (!get.Body) {\r\n    return {\r\n      ok: true,\r\n      sha256: \"\",\r\n      verdict: \"unknown\",\r\n      riskLevel: \"medium\",\r\n      flags: [\"r2:get:missing_body\"],\n    };\n  }\n\n  const { sha256, sizeBytes, bytes } = await streamToBufferAndSha256(get.Body, absMaxBytes);\n\n  const scannerUrl = (process.env.MALWARE_SCANNER_URL || \"\").trim();\n  if (scannerUrl) {\n    return await scanViaExternalClam({ bytes, sha256, sizeBytes, key });\n  }\n\n  // No external scanner configured: fail-safe to unknown (serve remains blocked by clean-only invariant).\n  return {\n    ok: true,\n    sha256,\n    verdict: \"unknown\",\n    riskLevel: \"medium\",\n    flags: [\"scanner:not_configured\", `size:${sizeBytes}`],\n    meta: { source: \"none\", sizeBytes },\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\masterKeys.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\monetization.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":85,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2794,2797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2794,2797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5221,5224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5221,5224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\nimport { getBillingFlags } from \"@/lib/settings\";\nimport { hasActiveViewLimitOverride } from \"@/lib/viewLimitOverride\";\n\nexport type Plan = {\n  id: \"free\" | \"pro\" | (string & {});\n  name: string;\n  maxViewsPerMonth: number | null;\n  maxActiveShares: number | null;\n  maxStorageBytes: number | null;\n  maxUploadsPerDay: number | null;\n  maxFileSizeBytes: number | null;\n  allowCustomExpiration: boolean;\n  allowAuditExport: boolean;\n};\n\nconst FREE_PLAN: Plan = {\n  id: \"free\",\n  name: \"Free\",\n  maxViewsPerMonth: 100,\n  maxActiveShares: 3,\n  maxStorageBytes: 104857600, // 100 MB\n  maxUploadsPerDay: 10,\n  maxFileSizeBytes: 10485760, // 10 MB\n  allowCustomExpiration: false,\n  allowAuditExport: false,\n};\n\nlet billingSubscriptionsTableExistsCache: boolean | null = null;\n\nasync function billingSubscriptionsTableExists(): Promise<boolean> {\n  if (billingSubscriptionsTableExistsCache != null) return billingSubscriptionsTableExistsCache;\n  try {\n    const rows = (await sql`select to_regclass('public.billing_subscriptions')::text as reg`) as unknown as Array<{ reg: string | null }>;\n    billingSubscriptionsTableExistsCache = Boolean(rows?.[0]?.reg);\n  } catch {\n    billingSubscriptionsTableExistsCache = false;\n  }\n  return billingSubscriptionsTableExistsCache;\n}\n\nasync function userHasActiveProEntitlement(userId: string): Promise<boolean> {\n  if (!(await billingSubscriptionsTableExists())) return false;\n  try {\n    const rows = (await sql`\n      select 1\n      from public.billing_subscriptions bs\n      where bs.user_id = ${userId}::uuid\n        and bs.plan_id = 'pro'\n        and (\n          lower(coalesce(bs.status, '')) in ('active', 'trialing')\n          or (\n            lower(coalesce(bs.status, '')) in ('past_due', 'grace')\n            and bs.grace_until is not null\n            and bs.grace_until > now()\n          )\n        )\n      limit 1\n    `) as unknown as Array<{ \"?column?\": number }>;\n    return rows.length > 0;\n  } catch {\n    return false;\n  }\n}\n\nexport async function getPlanForUser(userId: string): Promise<Plan> {\n  const billingRes = await getBillingFlags();\n  const billing = billingRes.flags;\n\n  const rows = (await sql`\n    select\n      p.id::text as id,\n      p.name::text as name,\n      p.max_views_per_month::int as max_views_per_month,\n      p.max_active_shares::int as max_active_shares,\n      p.max_storage_bytes::bigint as max_storage_bytes,\n      p.max_uploads_per_day::int as max_uploads_per_day,\n      p.max_file_size_bytes::bigint as max_file_size_bytes,\n      p.allow_custom_expiration::bool as allow_custom_expiration,\n      p.allow_audit_export::bool as allow_audit_export\n    from public.users u\n    join public.plans p on p.id = u.plan_id\n    where u.id = ${userId}::uuid\n    limit 1\n  `) as unknown as Array<any>;\n\n  const r = rows?.[0];\n  if (!r) {\n    // Fail closed to Free if user row exists but plan missing.\n    return FREE_PLAN;\n  }\n\n  // Free policy is a product invariant; enforce canonical values even if DB row is stale.\n  if (String(r.id) === \"free\") return FREE_PLAN;\n\n  // Hidden pricing flag: \"pro\" is present but does not grant unlimited behavior until enabled.\n  if (String(r.id) === \"pro\" && !billing.proPlanEnabled) {\n    return FREE_PLAN;\n  }\n\n  // Optional Stripe entitlement hardening:\n  // when enabled, users marked \"pro\" without active paid entitlement are treated as Free.\n  if (String(r.id) === \"pro\") {\n    const enforceStripeEntitlement = String(process.env.STRIPE_ENFORCE_ENTITLEMENT || \"1\").trim() !== \"0\";\n    if (enforceStripeEntitlement) {\n      const entitled = await userHasActiveProEntitlement(userId);\n      if (!entitled) {\n        return FREE_PLAN;\n      }\n    }\n  }\n\n  return {\n    id: r.id,\n    name: r.name,\n    maxViewsPerMonth: r.max_views_per_month ?? null,\n    maxActiveShares: r.max_active_shares ?? null,\n    maxStorageBytes: r.max_storage_bytes ?? null,\n    maxUploadsPerDay: r.max_uploads_per_day ?? null,\n    maxFileSizeBytes: r.max_file_size_bytes ?? null,\n    allowCustomExpiration: Boolean(r.allow_custom_expiration),\n    allowAuditExport: Boolean(r.allow_audit_export),\n  };\n}\n\nexport async function getOwnerIdForDoc(docId: string): Promise<string | null> {\n  const rows = (await sql`\n    select owner_id::text as owner_id\n    from public.docs\n    where id = ${docId}::uuid\n    limit 1\n  `) as unknown as Array<{ owner_id: string | null }>;\n  return rows?.[0]?.owner_id ?? null;\n}\n\nexport async function getActiveShareCountForOwner(ownerId: string): Promise<number> {\n  // Active = not revoked, not expired\n  const rows = (await sql`\n    select count(*)::int as c\n    from public.share_tokens st\n    join public.docs d on d.id = st.doc_id\n    where d.owner_id = ${ownerId}::uuid\n      and st.revoked_at is null\n      and (st.expires_at is null or st.expires_at > now())\n  `) as unknown as Array<{ c: number }>;\n  return Number(rows?.[0]?.c ?? 0);\n}\n\nexport async function getStorageBytesForOwner(ownerId: string): Promise<number> {\n  const rows = (await sql`\n    select coalesce(sum(coalesce(d.size_bytes, 0)), 0)::bigint as total\n    from public.docs d\n    where d.owner_id = ${ownerId}::uuid\n      and coalesce(d.status, 'ready') <> 'deleted'\n  `) as unknown as Array<{ total: any }>;\n  // neon returns bigint as string sometimes\n  const v = rows?.[0]?.total ?? 0;\n  return typeof v === \"string\" ? Number(v) : Number(v);\n}\n\nexport async function getMonthlyViewCount(userId: string): Promise<number> {\n  const rows = (await sql`\n    select view_count::int as v\n    from public.user_usage_monthly\n    where user_id = ${userId}::uuid\n      and month = date_trunc('month', now())::date\n    limit 1\n  `) as unknown as Array<{ v: number }>;\n  return Number(rows?.[0]?.v ?? 0);\n}\n\nexport async function incrementMonthlyViews(userId: string, delta: number = 1): Promise<void> {\n  await sql`\n    insert into public.user_usage_monthly (user_id, month, view_count, upload_count)\n    values (${userId}::uuid, date_trunc('month', now())::date, ${delta}::int, 0)\n    on conflict (user_id, month)\n    do update set view_count = public.user_usage_monthly.view_count + ${delta}::int\n  `;\n}\n\nexport async function getDailyUploadCount(userId: string): Promise<number> {\n  const rows = (await sql`\n    select upload_count::int as u\n    from public.user_usage_daily\n    where user_id = ${userId}::uuid\n      and day = (now() at time zone 'utc')::date\n    limit 1\n  `) as unknown as Array<{ u: number }>;\n  return Number(rows?.[0]?.u ?? 0);\n}\n\nexport async function incrementUploads(userId: string, delta: number = 1): Promise<void> {\n  // daily\n  await sql`\n    insert into public.user_usage_daily (user_id, day, upload_count)\n    values (${userId}::uuid, (now() at time zone 'utc')::date, ${delta}::int)\n    on conflict (user_id, day)\n    do update set upload_count = public.user_usage_daily.upload_count + ${delta}::int\n  `;\n\n  // monthly\n  await sql`\n    insert into public.user_usage_monthly (user_id, month, view_count, upload_count)\n    values (${userId}::uuid, date_trunc('month', now())::date, 0, ${delta}::int)\n    on conflict (user_id, month)\n    do update set upload_count = public.user_usage_monthly.upload_count + ${delta}::int\n  `;\n}\n\nexport type LimitResult =\n  | { ok: true }\n  | { ok: false; error: \"LIMIT_REACHED\"; message: string };\n\nexport async function assertCanUpload(args: {\n  userId: string;\n  sizeBytes: number | null;\n}): Promise<LimitResult> {\n  const billingRes = await getBillingFlags();\n  if (!billingRes.flags.enforcePlanLimits) return { ok: true };\n\n  const plan = await getPlanForUser(args.userId);\n\n  const size = args.sizeBytes ?? 0;\n\n  if (plan.maxFileSizeBytes != null && size > plan.maxFileSizeBytes) {\n    return { ok: false, error: \"LIMIT_REACHED\", message: \"File is too large for this account.\" };\n  }\n\n  if (plan.maxUploadsPerDay != null) {\n    const used = await getDailyUploadCount(args.userId);\n    if (used >= plan.maxUploadsPerDay) {\n      return { ok: false, error: \"LIMIT_REACHED\", message: \"Daily upload limit reached.\" };\n    }\n  }\n\n  if (plan.maxStorageBytes != null) {\n    const used = await getStorageBytesForOwner(args.userId);\n    if (used + size > plan.maxStorageBytes) {\n      return { ok: false, error: \"LIMIT_REACHED\", message: \"Storage limit reached.\" };\n    }\n  }\n\n  return { ok: true };\n}\n\nexport async function assertCanCreateShare(ownerId: string): Promise<LimitResult> {\n  const billingRes = await getBillingFlags();\n  if (!billingRes.flags.enforcePlanLimits) return { ok: true };\n\n  const plan = await getPlanForUser(ownerId);\n  if (plan.maxActiveShares == null) return { ok: true };\n\n  const active = await getActiveShareCountForOwner(ownerId);\n  if (active >= plan.maxActiveShares) {\n    return { ok: false, error: \"LIMIT_REACHED\", message: \"Active share limit reached.\" };\n  }\n  return { ok: true };\n}\n\nexport async function assertCanServeView(ownerId: string): Promise<LimitResult> {\n  const billingRes = await getBillingFlags();\n  if (!billingRes.flags.enforcePlanLimits) return { ok: true };\n\n  const overridden = await hasActiveViewLimitOverride(ownerId);\n  if (overridden) return { ok: true };\n\n  const plan = await getPlanForUser(ownerId);\n  if (plan.maxViewsPerMonth == null) return { ok: true };\n\n  const used = await getMonthlyViewCount(ownerId);\n  if (used >= plan.maxViewsPerMonth) {\n    return { ok: false, error: \"LIMIT_REACHED\", message: \"Monthly view limit reached.\" };\n  }\n  return { ok: true };\n}\n\n/**\n * Custom expiration is currently hidden. If the plan disallows it, we clamp expiry to a safe default.\n * Returns an ISO string or null.\n */\nexport function normalizeExpiresAtForPlan(args: {\n  plan: Plan;\n  requestedExpiresAtIso: string | null;\n  defaultDaysIfNotAllowed?: number;\n}): string | null {\n  const req = args.requestedExpiresAtIso;\n  if (!req && args.plan.allowCustomExpiration) return null;\n\n  if (args.plan.allowCustomExpiration) {\n    const t = Date.parse(String(req || \"\"));\n    if (Number.isNaN(t)) return null;\n    return new Date(t).toISOString();\n  }\n\n  // Plan disallows custom expiration (e.g. Free tier):\n  // always enforce a fixed TTL from now, ignoring caller-provided timestamps.\n  const days = Math.max(1, Math.floor(args.defaultDaysIfNotAllowed ?? Number(process.env.FREE_SHARE_TTL_DAYS || 30)));\n  const fixedT = Date.now() + days * 24 * 60 * 60 * 1000;\n  return new Date(fixedT).toISOString();\n}\n\nexport function normalizeMaxViewsForPlan(args: {\n  plan: Plan;\n  requestedMaxViews: number | null;\n}): number | null {\n  const requested = args.requestedMaxViews;\n  // Pro/unlimited plans can keep unlimited semantics.\n  if (args.plan.maxViewsPerMonth == null) {\n    return requested == null ? null : Math.max(0, Math.floor(requested));\n  }\n\n  // Finite plans (Free): disallow unlimited share view links.\n  const freeDefault = Math.max(1, Number(process.env.FREE_DEFAULT_SHARE_MAX_VIEWS || 25));\n  const normalized = requested == null ? freeDefault : Math.max(0, Math.floor(requested));\n  if (normalized <= 0) return freeDefault;\n  return Math.min(normalized, args.plan.maxViewsPerMonth);\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\oauth-google.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'alias' is defined but never used.","line":51,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/oauth-google.ts\nimport * as client from \"openid-client\";\n\nfunction requireEnv(name: \"APP_URL\" | \"GOOGLE_CLIENT_ID\" | \"GOOGLE_CLIENT_SECRET\"): string {\n  const value = (process.env[name] || \"\").trim();\n  if (!value) throw new Error(`Missing ${name}`);\n  return value;\n}\n\n/**\n * Google OIDC issuer URL (issuer identifier).\n * Discovery will fetch the OIDC metadata from the well-known endpoints.\n */\nconst GOOGLE_ISSUER = new URL(\"https://accounts.google.com\");\n\nlet _configPromise: Promise<client.Configuration> | null = null;\n\n/**\n * Lazily discover + cache OIDC configuration for Google.\n */\nexport async function getGoogleConfig(): Promise<client.Configuration> {\n  if (!_configPromise) {\n    _configPromise = client.discovery(\n      GOOGLE_ISSUER,\n      requireEnv(\"GOOGLE_CLIENT_ID\"),\n      requireEnv(\"GOOGLE_CLIENT_SECRET\")\n    );\n  }\n  return _configPromise;\n}\n\n/**\n * Where Google redirects back to your app after login.\n * Update this path if your callback route differs.\n */\nexport function googleRedirectUri(): string {\n  return `${requireEnv(\"APP_URL\")}/auth/google/callback`;\n}\n\nexport type GoogleAuthRequest = {\n  authorizationUrl: string;\n  codeVerifier: string;\n  state: string;\n  nonce: string;\n};\n\n/**\n * Create an authorization request using Authorization Code + PKCE.\n * You must persist codeVerifier/state/nonce until the callback.\n */\nexport async function createGoogleAuthRequest(alias: string): Promise<GoogleAuthRequest> {\n  const config = await getGoogleConfig();\n\n  const codeVerifier = client.randomPKCECodeVerifier();\n  const codeChallenge = await client.calculatePKCECodeChallenge(codeVerifier);\n\n  const state = client.randomState();\n  const nonce = client.randomNonce();\n\n  // Include alias in the round-trip using \"state\" or a separate cookie/db row.\n  // Here we pass alias as an extra param; you can remove if you prefer.\n  const url = client.buildAuthorizationUrl(config, {\n    redirect_uri: googleRedirectUri(),\n    scope: \"openid email profile\",\n    response_type: \"code\",\n    code_challenge: codeChallenge,\n    code_challenge_method: \"S256\",\n    state,\n    nonce,\n    // Optional: keep this if your routes expect it\n    // (Google will round-trip unknown params back to redirect_uri in some cases,\n    // but do not rely on it universally; best to store alias server-side.)\n    // alias,\n  });\n\n  return {\n    authorizationUrl: url.toString(),\n    codeVerifier,\n    state,\n    nonce,\n  };\n}\n\nexport type GoogleCallbackChecks = {\n  codeVerifier: string;\n  state: string;\n  nonce: string;\n};\n\n/**\n * Exchange the authorization code for tokens and validate state/nonce/PKCE.\n * Pass the original Request from your callback route.\n */\nexport async function exchangeGoogleCode(\n  req: Request,\n  checks: GoogleCallbackChecks\n): Promise<{\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers;\n  claims: client.IDToken | undefined;\n}> {\n  const config = await getGoogleConfig();\n\n  const tokens = await client.authorizationCodeGrant(\n    config,\n    req,\n    {\n      pkceCodeVerifier: checks.codeVerifier,\n      expectedState: checks.state,\n      expectedNonce: checks.nonce,\n    }\n  );\n\n  // Helper parses/validates ID Token and returns its claims\n  const claims = tokens.claims();\n\n  return { tokens, claims };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\observability.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\officePreview.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\orgMembership.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\orgs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\owner.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\pdfSafety.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2934,2937],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2934,2937],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2948,2951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2948,2951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3099,3102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3099,3102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":188,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6195,6198],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6195,6198],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/pdfSafety.ts\n//\n// Lightweight PDF safety validation and heuristic risk detection.\n//\n// Goals:\n//  - Validate that unencrypted uploads are really PDFs (magic bytes + basic structure checks)\n//  - Detect common \"risky\" PDF capabilities (JS, embedded files, launch actions, etc.)\n//  - Keep it serverless-friendly: bounded reads via S3 Range requests\n//\n// IMPORTANT:\n// This is NOT a full malware scanner. It is a low-cost guardrail that:\n//  - blocks obvious non-PDF uploads\n//  - flags PDFs with risky features so the UI can warn / force download-only\n//\n// For stronger scanning, integrate an async pipeline (ClamAV / commercial scanner) and\n// mark docs as pending/clean/quarantined in DB.\n\nimport { GetObjectCommand, HeadObjectCommand } from \"@aws-sdk/client-s3\";\nimport { r2Client } from \"@/lib/r2\";\n\nexport type PdfRiskLevel = \"low\" | \"medium\" | \"high\";\n\nexport type PdfSafetyResult =\n  | {\n      ok: true;\n      isPdf: true;\n      riskLevel: PdfRiskLevel;\n      flags: string[];\n      details: Record<string, unknown>;\n    }\n  | {\n      ok: false;\n      error: \"NOT_PDF\" | \"UNREADABLE\" | \"TOO_LARGE\" | \"INTERNAL\";\n      message: string;\n      details?: Record<string, unknown>;\n    };\n\nfunction bufToAscii(b: Buffer): string {\n  // loss-tolerant scan string\n  return b.toString(\"latin1\");\n}\n\nfunction hasPdfHeader(head: Buffer): boolean {\n  const s = head.toString(\"latin1\");\n  return s.startsWith(\"%PDF-\");\n}\n\nfunction findFlags(sample: string): string[] {\n  const flags: string[] = [];\n\n  // High-risk capabilities\n  if (sample.includes(\"/JavaScript\") || sample.includes(\"/JS\")) flags.push(\"pdf:javascript\");\n  if (sample.includes(\"/Launch\")) flags.push(\"pdf:launch_action\");\n  if (sample.includes(\"/EmbeddedFile\") || sample.includes(\"/Filespec\")) flags.push(\"pdf:embedded_file\");\n  if (sample.includes(\"/RichMedia\") || sample.includes(\"/Flash\")) flags.push(\"pdf:rich_media\");\n  if (sample.includes(\"/OpenAction\")) flags.push(\"pdf:open_action\");\n  if (sample.includes(\"/AA\")) flags.push(\"pdf:additional_actions\");\n\n  // Phishing-ish / link-y signals (lower severity)\n  if (sample.includes(\"/URI\")) flags.push(\"pdf:uri_links\");\n  if (sample.includes(\"/GoToR\")) flags.push(\"pdf:remote_goto\");\n\n  return Array.from(new Set(flags));\n}\n\nfunction riskFromFlags(flags: string[]): PdfRiskLevel {\n  const high = new Set([\n    \"pdf:javascript\",\n    \"pdf:embedded_file\",\n    \"pdf:launch_action\",\n    \"pdf:rich_media\",\n  ]);\n  const medium = new Set([\"pdf:open_action\", \"pdf:additional_actions\"]);\n\n  if (flags.some((f) => high.has(f))) return \"high\";\n  if (flags.some((f) => medium.has(f))) return \"medium\";\n  if (flags.length) return \"medium\";\n  return \"low\";\n}\n\nasync function readRange(args: { bucket: string; key: string; range: string }): Promise<Buffer> {\n  const res = await r2Client.send(\n    new GetObjectCommand({\n      Bucket: args.bucket,\n      Key: args.key,\n      Range: args.range,\n    })\n  );\n\n  const body: any = (res as any).Body;\n  if (!body) return Buffer.alloc(0);\n\n  // In Node.js, Body is a stream.\n  const chunks: Buffer[] = [];\n  for await (const chunk of body as any) {\n    chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk));\n  }\n  return Buffer.concat(chunks);\n}\n\nfunction countPdfPages(text: string): number {\n  // Heuristic page marker count used as a hard guardrail.\n  const matches = text.match(/\\/Type\\s*\\/Page\\b/g);\n  return matches ? matches.length : 0;\n}\n\nfunction validatePdfBufferInternal(args: {\n  bytes: Buffer;\n  absMaxBytes?: number;\n  maxPdfPages?: number;\n}): PdfSafetyResult {\n  const bytes = args.bytes;\n  const size = bytes.length;\n  const absMaxBytes = Number(args.absMaxBytes ?? 1_000_000_000);\n  const maxPdfPages = Math.max(0, Number(args.maxPdfPages ?? 0));\n\n  if (!Number.isFinite(size) || size <= 0) {\n    return { ok: false, error: \"UNREADABLE\", message: \"Object size is invalid.\" };\n  }\n  if (Number.isFinite(absMaxBytes) && absMaxBytes > 0 && size > absMaxBytes) {\n    return { ok: false, error: \"TOO_LARGE\", message: \"Object exceeds absolute max.\", details: { size, absMaxBytes } };\n  }\n  if (!hasPdfHeader(bytes.subarray(0, Math.min(bytes.length, 8)))) {\n    return { ok: false, error: \"NOT_PDF\", message: \"Missing %PDF- header (not a valid PDF).\" };\n  }\n\n  const sample = bufToAscii(bytes);\n  const flags = findFlags(sample);\n  const riskLevel = riskFromFlags(flags);\n  const pageCount = countPdfPages(sample);\n\n  if (maxPdfPages > 0 && pageCount > maxPdfPages) {\n    return {\n      ok: false,\n      error: \"INTERNAL\",\n      message: \"PDF exceeds max page count policy.\",\n      details: { pageCount, maxPdfPages },\n    };\n  }\n\n  return {\n    ok: true,\n    isPdf: true,\n    riskLevel,\n    flags,\n    details: { sampledBytes: bytes.length, size, pageCount, maxPdfPages: maxPdfPages || null },\n  };\n}\n\nexport function validatePdfBuffer(args: {\n  bytes: Buffer;\n  absMaxBytes?: number;\n  maxPdfPages?: number;\n}): PdfSafetyResult {\n  try {\n    return validatePdfBufferInternal(args);\n  } catch (e: unknown) {\n    const errName = e instanceof Error ? e.name : \"Error\";\n    const errMsg = e instanceof Error ? e.message : String(e);\n    return {\n      ok: false,\n      error: \"INTERNAL\",\n      message: \"PDF validation failed.\",\n      details: { err: errName, message: errMsg },\n    };\n  }\n}\n\nexport async function validatePdfInR2(args: {\n  bucket: string;\n  key: string;\n  // Maximum bytes to sample from the start of the file (default 256KB)\n  sampleBytes?: number;\n  // Absolute max allowed size (safety)\n  absMaxBytes?: number;\n  // Hard page count cap. 0/undefined disables.\n  maxPdfPages?: number;\n  // Max object size eligible for full page-count pass.\n  pageCountCheckMaxBytes?: number;\n}): Promise<PdfSafetyResult> {\n  const sampleBytes = Math.max(4 * 1024, Math.min(Number(args.sampleBytes ?? 256 * 1024), 1024 * 1024));\n  const absMaxBytes = Number(args.absMaxBytes ?? 1_000_000_000);\n  const maxPdfPages = Math.max(0, Number(args.maxPdfPages ?? 0));\n  const pageCountCheckMaxBytes = Math.max(1024 * 1024, Number(args.pageCountCheckMaxBytes ?? 25 * 1024 * 1024));\n\n  try {\n    const head = await r2Client.send(new HeadObjectCommand({ Bucket: args.bucket, Key: args.key }));\n    const size = Number((head as any)?.ContentLength ?? 0);\n\n    if (!Number.isFinite(size) || size <= 0) {\n      return { ok: false, error: \"UNREADABLE\", message: \"Object size is invalid.\" };\n    }\n    if (Number.isFinite(absMaxBytes) && absMaxBytes > 0 && size > absMaxBytes) {\n      return { ok: false, error: \"TOO_LARGE\", message: \"Object exceeds absolute max.\", details: { size, absMaxBytes } };\n    }\n\n    const first = await readRange({ bucket: args.bucket, key: args.key, range: `bytes=0-${sampleBytes - 1}` });\n    if (!first.length) return { ok: false, error: \"UNREADABLE\", message: \"Unable to read object bytes.\" };\n\n    if (!hasPdfHeader(first.subarray(0, Math.min(first.length, 8)))) {\n      return { ok: false, error: \"NOT_PDF\", message: \"Missing %PDF- header (not a valid PDF).\" };\n    }\n\n    const sample = bufToAscii(first);\n    const flags = findFlags(sample);\n    const riskLevel = riskFromFlags(flags);\n    let pageCount = countPdfPages(sample);\n\n    if (maxPdfPages > 0 && size <= pageCountCheckMaxBytes && size > first.length) {\n      const full = await readRange({ bucket: args.bucket, key: args.key, range: `bytes=0-${size - 1}` });\n      if (full.length) {\n        pageCount = countPdfPages(bufToAscii(full));\n      }\n    }\n\n    if (maxPdfPages > 0 && pageCount > maxPdfPages) {\n      return {\n        ok: false,\n        error: \"INTERNAL\",\n        message: \"PDF exceeds max page count policy.\",\n        details: { pageCount, maxPdfPages },\n      };\n    }\n\n    return {\n      ok: true,\n      isPdf: true,\n      riskLevel,\n      flags,\n      details: { sampledBytes: first.length, size, pageCount, maxPdfPages: maxPdfPages || null },\n    };\n  } catch (e: unknown) {\n    const errName = e instanceof Error ? e.name : \"Error\";\n    const errMsg = e instanceof Error ? e.message : String(e);\n    return {\n      ok: false,\n      error: \"INTERNAL\",\n      message: \"PDF validation failed.\",\n      details: { err: errName, message: errMsg },\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\pdfWatermark.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\quarantineOverride.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\r2.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":8,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":11,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1967,1970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1967,1970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/r2.ts\n//\n// Cloudflare R2 (S3-compatible) client + shared helpers.\n//\n// IMPORTANT:\n// Browser presigned PUT uploads are sensitive to which headers are included in the signature.\n// If the SDK injects x-amz-checksum-* (or you sign x-amz-server-side-encryption), browsers\n// won't send those headers by default and R2 returns SignatureDoesNotMatch.\n//\n// Recommended approach:\n// 1) Avoid signing SSE headers for browser presigned PUTs (handled in presign route).\n// 2) Ask AWS SDK to NOT calculate/validate checksums (if supported by your SDK version).\n//    Some @aws-sdk versions don't include the newer checksum config keys in TypeScript\n//    types yet, so we apply them behind a safe `as any` cast.\n\nimport { S3Client } from \"@aws-sdk/client-s3\";\n\nfunction requireEnv(name: \"R2_ENDPOINT\" | \"R2_ACCESS_KEY_ID\" | \"R2_SECRET_ACCESS_KEY\"): string {\n  const value = (process.env[name] || \"\").trim();\n  if (!value) throw new Error(`Missing ${name} env var`);\n  return value;\n}\n\nexport function getR2Bucket(): string {\n  const bucket = (process.env.R2_BUCKET || process.env.R2_BUCKET_NAME || \"\").trim();\n  if (!bucket) throw new Error(\"Missing R2_BUCKET env var\");\n  return bucket;\n}\n\nexport function getR2Prefix(): string {\n  const p = process.env.R2_PREFIX || \"docs/\";\n  if (p.startsWith(\"r2://\")) return \"docs/\";\n  return p.endsWith(\"/\") ? p : `${p}/`;\n}\n\nlet cachedClient: S3Client | null = null;\n\nfunction getR2Client(): S3Client {\n  if (cachedClient) return cachedClient;\n  cachedClient = new S3Client({\n    region: \"auto\",\n    endpoint: requireEnv(\"R2_ENDPOINT\"),\n    credentials: {\n      accessKeyId: requireEnv(\"R2_ACCESS_KEY_ID\"),\n      secretAccessKey: requireEnv(\"R2_SECRET_ACCESS_KEY\"),\n    },\n\n    // Prevent AWS SDK from injecting checksum requirements into presigned PUT URLs.\n    // (If unsupported by this SDK version at runtime, it will be ignored.)\n    requestChecksumCalculation: \"NEVER\",\n    responseChecksumValidation: \"NEVER\",\n  } as any);\n  return cachedClient;\n}\n\n// Keep existing import style while deferring env reads until first real client access.\nexport const r2Client = new Proxy({} as S3Client, {\n  get(_target, prop, receiver) {\n    return Reflect.get(getR2Client() as object, prop, receiver);\n  },\n});\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\rateLimit.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\rbac.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\resend.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\resolveDoc.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1573,1576],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1573,1576],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'normEmail' is defined but never used.","line":77,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":388,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":388,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11953,11956],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11953,11956],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/resolveDoc.ts\nimport { sql } from \"@/lib/db\";\nimport { getR2Bucket } from \"@/lib/r2\";\n\nexport type ResolveInput =\n    | { alias: string }\n    | { token: string }\n    | { docId: string };\n\nexport type ResolvedDocOk = {\n    ok: true;\n    source: \"alias\" | \"token\" | \"direct\";\n    docId: string;\n\n    // R2 pointer (normalized)\n    bucket: string;\n    r2Key: string;\n\n    // Metadata (nice to have for headers / filenames)\n    title: string | null;\n    originalFilename: string | null;\n    contentType: string | null;\n    sizeBytes: number | null;\n\n    // Auth/gating flags\n    requiresPassword: boolean;\n\n    // Token-specific (when source=token)\n    token?: string;\n};\n\nexport type ResolvedDocErr = {\n    ok: false;\n    error: \"NOT_FOUND\" | \"EXPIRED\" | \"REVOKED\" | \"PASSWORD_REQUIRED\" | \"MAXED\";\n};\n\nexport type ResolvedDoc = ResolvedDocOk | ResolvedDocErr;\n\nexport type ShareMeta =\n    | {\n        ok: true;\n        table: \"share_tokens\";\n\n        // token is the stable primary key in your schema\n        shareId: string;\n        token: string;\n\n        docId: string;\n\n        toEmail: string | null;\n        createdAt: string;\n        expiresAt: string | null;\n        maxViews: number | null;\n        viewCount: number;\n        revokedAt: string | null;\n\n        hasPassword: boolean;\n        passwordHash: string | null;\n\n        watermarkEnabled?: boolean;\n        watermarkText?: string | null;\n\n        // Doc moderation / safety snapshot\n        docModerationStatus?: string;\n        scanStatus?: string;\n        riskLevel?: string;\n        riskFlags?: any;\n        isActive?: boolean;\n    }\n    | { ok: false };\n\n\nfunction norm(s: string): string {\n    return decodeURIComponent(String(s || \"\")).trim().toLowerCase();\n}\n\nfunction normEmail(s: string | null | undefined): string | null {\n    const v = String(s || \"\").trim().toLowerCase();\n    return v ? v : null;\n}\n\nfunction isExpired(expiresAt: string | Date | null): boolean {\n    if (!expiresAt) return false;\n    const t =\n        typeof expiresAt === \"string\"\n            ? new Date(expiresAt).getTime()\n            : expiresAt.getTime();\n    return Number.isFinite(t) && t <= Date.now();\n}\n\nfunction isMaxed(viewCount: number, maxViews: number | null): boolean {\n    if (maxViews === null) return false;\n    if (maxViews === 0) return false; // 0 = unlimited\n    return viewCount >= maxViews;\n}\n\n// Email link tokens can be 32-hex-without-dashes while DB stores UUID w/ dashes.\n// Generate both variants and query using both.\nfunction tokenVariants(tokenInput: string): { raw: string; dashed: string | null } {\n    const raw = String(tokenInput || \"\").trim();\n    if (!raw) return { raw: \"\", dashed: null };\n\n    // Already dashed UUID?\n    const isDashedUuid = /^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/.test(\n        raw\n    );\n    if (isDashedUuid) return { raw: raw.toLowerCase(), dashed: raw.toLowerCase() };\n\n    // 32-hex => dashed UUID\n    const isHex32 = /^[a-fA-F0-9]{32}$/.test(raw);\n    if (!isHex32) return { raw, dashed: null };\n\n    const lower = raw.toLowerCase();\n    const dashed = `${lower.slice(0, 8)}-${lower.slice(8, 12)}-${lower.slice(\n        12,\n        16\n    )}-${lower.slice(16, 20)}-${lower.slice(20)}`;\n    return { raw: lower, dashed };\n}\n\nasync function getDocPointer(\n    docId: string\n): Promise<\n    | {\n        ok: true;\n        docId: string;\n        bucket: string;\n        r2Key: string;\n        title: string | null;\n        originalFilename: string | null;\n        contentType: string | null;\n        sizeBytes: number | null;\n    }\n    | { ok: false }\n> {\n    const id = String(docId || \"\").trim();\n    if (!id) return { ok: false };\n    const defaultBucket = getR2Bucket();\n\n    let rows: Array<{\n        id: string;\n        bucket: string | null;\n        r2_key: string | null;\n        title: string | null;\n        original_filename: string | null;\n        content_type: string | null;\n        size_bytes: string | number | null;\n        status: string;\n        moderation_status: string;\n        scan_status: string;\n        org_disabled?: boolean;\n        org_active?: boolean;\n    }> = [];\n\n    try {\n      rows = (await sql`\n        select\n          d.id::text as id,\n          coalesce(d.r2_bucket::text, ${defaultBucket}) as bucket,\n          d.r2_key::text as r2_key,\n          d.title::text as title,\n          d.original_filename::text as original_filename,\n          d.content_type::text as content_type,\n          d.size_bytes::bigint as size_bytes,\n          coalesce(d.status::text, '') as status,\n          coalesce(d.moderation_status::text, 'active') as moderation_status,\n          coalesce(d.scan_status::text, 'unscanned') as scan_status,\n          coalesce(o.disabled, false) as org_disabled,\n          coalesce(o.is_active, true) as org_active\n        from public.docs d\n        left join public.organizations o on o.id = d.org_id\n        where d.id = ${id}::uuid\n        limit 1\n      `) as unknown as typeof rows;\n    } catch {\n      rows = (await sql`\n        select\n          d.id::text as id,\n          coalesce(d.r2_bucket::text, ${defaultBucket}) as bucket,\n          d.r2_key::text as r2_key,\n          d.title::text as title,\n          d.original_filename::text as original_filename,\n          d.content_type::text as content_type,\n          d.size_bytes::bigint as size_bytes,\n          coalesce(d.status::text, '') as status,\n          coalesce(d.moderation_status::text, 'active') as moderation_status,\n          coalesce(d.scan_status::text, 'unscanned') as scan_status\n        from public.docs d\n        where d.id = ${id}::uuid\n        limit 1\n      `) as unknown as typeof rows;\n    }\n\n    const r = rows?.[0];\n    if (!r?.id) return { ok: false };\n\n    const lifecycle = (r.status || \"\").toLowerCase();\n    const moderation = (r.moderation_status || \"active\").toLowerCase();\n    const scanStatus = (r.scan_status || \"unscanned\").toLowerCase();\n\n    if (lifecycle === \"deleted\") return { ok: false };\n    if (r.org_disabled === true || r.org_active === false) return { ok: false };\n    if (moderation === \"deleted\" || moderation === \"disabled\") return { ok: false };\n    if (moderation === \"quarantined\") return { ok: false };\n    // Critical invariant: public serving is only allowed when scan is explicitly clean.\n    if (scanStatus !== \"clean\") return { ok: false };\n    if (!r.bucket || !r.r2_key) return { ok: false };\n\n    return {\n        ok: true,\n        docId: r.id,\n        bucket: r.bucket || defaultBucket,\n        r2Key: r.r2_key,\n        title: r.title ?? null,\n        originalFilename: r.original_filename ?? null,\n        contentType: r.content_type ?? null,\n        sizeBytes: r.size_bytes == null ? null : Number(r.size_bytes),\n    };\n}\n\nasync function resolveAliasToDocId(\n    aliasInput: string\n): Promise<\n    | {\n        ok: true;\n        docId: string;\n        revokedAt: string | null;\n        expiresAt: string | null;\n        passwordHash: string | null;\n    }\n    | { ok: false }\n> {\n    const alias = norm(aliasInput);\n    if (!alias) return { ok: false };\n\n    // Preferred: doc_aliases (case-insensitive + require is_active if present)\n    // Try with password_hash first (some envs have it, some don't)\n    try {\n        const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        a.revoked_at::text as revoked_at,\n        a.expires_at::text as expires_at,\n        a.password_hash::text as password_hash\n      from public.doc_aliases a\n      where lower(a.alias) = ${alias}\n        and coalesce(a.is_active, true) = true\n      limit 1\n    `) as unknown as Array<{\n            doc_id: string;\n            revoked_at: string | null;\n            expires_at: string | null;\n            password_hash: string | null;\n        }>;\n\n        if (rows?.length) {\n            const r = rows[0];\n            return {\n                ok: true,\n                docId: r.doc_id,\n                revokedAt: r.revoked_at ?? null,\n                expiresAt: r.expires_at ?? null,\n                passwordHash: r.password_hash ?? null,\n            };\n        }\n    } catch {\n        // fall through\n    }\n\n    // doc_aliases without password_hash\n    try {\n        const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        a.revoked_at::text as revoked_at,\n        a.expires_at::text as expires_at\n      from public.doc_aliases a\n      where lower(a.alias) = ${alias}\n        and coalesce(a.is_active, true) = true\n      limit 1\n    `) as unknown as Array<{\n            doc_id: string;\n            revoked_at: string | null;\n            expires_at: string | null;\n        }>;\n\n        if (rows?.length) {\n            const r = rows[0];\n            return {\n                ok: true,\n                docId: r.doc_id,\n                revokedAt: r.revoked_at ?? null,\n                expiresAt: r.expires_at ?? null,\n                passwordHash: null,\n            };\n        }\n    } catch {\n        // fall through\n    }\n\n    // Legacy: document_aliases (case-insensitive)\n    try {\n        const rows = (await sql`\n      select\n        a.doc_id::text as doc_id,\n        null::text as revoked_at,\n        a.expires_at::text as expires_at,\n        a.password_hash::text as password_hash\n      from public.document_aliases a\n      where lower(a.alias) = ${alias}\n      limit 1\n    `) as unknown as Array<{\n            doc_id: string;\n            revoked_at: string | null;\n            expires_at: string | null;\n            password_hash: string | null;\n        }>;\n\n        if (rows?.length) {\n            const r = rows[0];\n            return {\n                ok: true,\n                docId: r.doc_id,\n                revokedAt: r.revoked_at ?? null,\n                expiresAt: r.expires_at ?? null,\n                passwordHash: r.password_hash ?? null,\n            };\n        }\n    } catch {\n        // ignore\n    }\n\n    return { ok: false };\n}\n\n/**\n * Read-only share meta (NO increment). Used by /s/[token] page and password verify.\n *\n * Robustness goals:\n * - token in email may be 32-hex (no dashes) while DB stores UUID (dashed)\n * - share_tokens primary key column is `token` in your DB\n * - share_tokens view counter column is `views_count`\n */\nexport async function resolveShareMeta(tokenInput: string): Promise<ShareMeta> {\n    const { raw: token, dashed } = tokenVariants(tokenInput);\n    if (!token) return { ok: false };\n\n    // Try newer schema first (watermark_* columns present), then fall back.\n    try {\n        const rows = (await sql`\n      select\n        st.token::text as token,\n        st.doc_id::text as doc_id,\n        st.to_email,\n        st.created_at::text as created_at,\n        st.expires_at::text as expires_at,\n        st.max_views,\n        st.views_count,\n        st.revoked_at::text as revoked_at,\n        st.password_hash,\n        coalesce(st.watermark_enabled, false) as watermark_enabled,\n        st.watermark_text,\n        coalesce(d.moderation_status::text, 'active') as doc_moderation_status,\n        coalesce(d.scan_status::text, 'unscanned') as scan_status,\n        coalesce(d.risk_level::text, 'low') as risk_level,\n        d.risk_flags as risk_flags,\n        coalesce(st.is_active, true) as is_active\n      from public.share_tokens st\n      left join public.docs d on d.id = st.doc_id\n      where st.token = ${token}\n        ${dashed ? sql`or st.token = ${dashed}` : sql``}\n      limit 1\n    `) as unknown as Array<{\n            token: string;\n            doc_id: string;\n            to_email: string | null;\n            created_at: string;\n            expires_at: string | null;\n            max_views: number | null;\n            views_count: number | null;\n            revoked_at: string | null;\n            password_hash: string | null;\n            watermark_enabled: boolean;\n            watermark_text: string | null;\n            doc_moderation_status: string;\n            scan_status: string;\n            risk_level: string;\n            risk_flags: any;\n            is_active: boolean;\n        }>;\n\n        const r = rows?.[0];\n        if (!r?.token) return { ok: false };\n        if (!r.is_active) return { ok: false };\n\n        return {\n            ok: true,\n            table: \"share_tokens\",\n            shareId: r.token,\n            token: r.token,\n            docId: r.doc_id,\n            toEmail: r.to_email ?? null,\n            createdAt: r.created_at,\n            expiresAt: r.expires_at ?? null,\n            maxViews: r.max_views ?? null,\n            viewCount: Number(r.views_count ?? 0),\n            revokedAt: r.revoked_at ?? null,\n            hasPassword: Boolean(r.password_hash),\n            passwordHash: r.password_hash ?? null,\n            watermarkEnabled: Boolean(r.watermark_enabled),\n            watermarkText: r.watermark_text ?? null,\n            isActive: Boolean(r.is_active),\n        };\n    } catch {\n        // Fall back to older schema without watermark columns.\n        try {\n            const rows = (await sql`\n        select\n          token::text as token,\n          doc_id::text as doc_id,\n          to_email,\n          created_at::text as created_at,\n          expires_at::text as expires_at,\n          max_views,\n          views_count,\n          revoked_at::text as revoked_at,\n          password_hash\n        from public.share_tokens\n        where token = ${token}\n          ${dashed ? sql`or token = ${dashed}` : sql``}\n        limit 1\n      `) as unknown as Array<{\n                token: string;\n                doc_id: string;\n                to_email: string | null;\n                created_at: string;\n                expires_at: string | null;\n                max_views: number | null;\n                views_count: number | null;\n                revoked_at: string | null;\n                password_hash: string | null;\n            }>;\n\n            const r = rows?.[0];\n            if (!r?.token) return { ok: false };\n\n            return {\n                ok: true,\n                table: \"share_tokens\",\n                shareId: r.token,\n                token: r.token,\n                docId: r.doc_id,\n                toEmail: r.to_email ?? null,\n                createdAt: r.created_at,\n                expiresAt: r.expires_at ?? null,\n                maxViews: r.max_views ?? null,\n                viewCount: Number(r.views_count ?? 0),\n                revokedAt: r.revoked_at ?? null,\n                hasPassword: Boolean(r.password_hash),\n                passwordHash: r.password_hash ?? null,\n                watermarkEnabled: false,\n                watermarkText: null,\n                isActive: true,\n            };\n        } catch {\n            return { ok: false };\n        }\n    }\n}\n\n/**\n * Token resolution for /raw: increments views atomically while enforcing revoked/expired/max_views.\n * Keeps your current behavior: increments even if password-gated.\n */\n/**\n * Token resolution for /raw: NO increment. Used to check existence + gating state and to get doc_id.\n */\nasync function resolveTokenNoIncrement(\n    tokenInput: string\n): Promise<\n    | { ok: true; docId: string; passwordHash: string | null }\n    | { ok: false; error: \"NOT_FOUND\" | \"REVOKED\" | \"EXPIRED\" | \"MAXED\" }\n> {\n    const meta = await resolveShareMeta(tokenInput);\n    if (!meta.ok) return { ok: false, error: \"NOT_FOUND\" };\n    if (meta.revokedAt) return { ok: false, error: \"REVOKED\" };\n    if (isExpired(meta.expiresAt)) return { ok: false, error: \"EXPIRED\" };\n    if (isMaxed(meta.viewCount ?? 0, meta.maxViews)) return { ok: false, error: \"MAXED\" };\n\n    return { ok: true, docId: meta.docId, passwordHash: meta.passwordHash ?? null };\n}\n\n/**\n * Consume a view for a share token (atomic increment + enforcement).\n * Call this ONLY once you've decided the request is authorized to view.\n */\nexport async function consumeShareTokenView(\n    tokenInput: string\n): Promise<\n    | { ok: true; docId: string; viewsCount: number }\n    | { ok: false; error: \"NOT_FOUND\" | \"REVOKED\" | \"EXPIRED\" | \"MAXED\" }\n> {\n    const { raw: token, dashed } = tokenVariants(tokenInput);\n    if (!token) return { ok: false, error: \"NOT_FOUND\" };\n\n    // Atomic: only increments if still valid and below max (unless max_views is null/0)\n    try {\n        const rows = (await sql`\n      update public.share_tokens st\n      set views_count = coalesce(st.views_count, 0) + 1\n      where (st.token = ${token} ${dashed ? sql`or st.token = ${dashed}` : sql``})\n        and st.revoked_at is null\n        and (st.expires_at is null or st.expires_at > now())\n        and (\n          st.max_views is null\n          or st.max_views = 0\n          or coalesce(st.views_count, 0) < st.max_views\n        )\n      returning st.doc_id::text as doc_id, coalesce(st.views_count, 0)::int as views_count\n    `) as unknown as Array<{ doc_id: string; views_count: number }>;\n\n        const r = rows?.[0];\n        if (r?.doc_id) return { ok: true, docId: r.doc_id, viewsCount: Number(r.views_count ?? 0) };\n    } catch {\n        // fall through to read-only checks\n    }\n\n    // If update returned 0 rows, determine why (best-effort)\n    const meta = await resolveShareMeta(token);\n    if (!meta.ok && dashed) {\n        const meta2 = await resolveShareMeta(dashed);\n        if (meta2.ok) return consumeShareTokenView(meta2.token);\n    }\n    const m = meta.ok ? meta : null;\n    if (!m) return { ok: false, error: \"NOT_FOUND\" };\n    if (m.revokedAt) return { ok: false, error: \"REVOKED\" };\n    if (isExpired(m.expiresAt)) return { ok: false, error: \"EXPIRED\" };\n    if (isMaxed(m.viewCount ?? 0, m.maxViews)) return { ok: false, error: \"MAXED\" };\n\n    // Race condition fallback\n    return { ok: false, error: \"NOT_FOUND\" };\n}\n\nexport async function resolveDoc(input: ResolveInput): Promise<ResolvedDoc> {\n    // DIRECT\n    if (\"docId\" in input) {\n        const doc = await getDocPointer(String(input.docId || \"\").trim());\n        if (!doc.ok) return { ok: false, error: \"NOT_FOUND\" };\n\n        return {\n            ok: true,\n            source: \"direct\",\n            docId: doc.docId,\n            bucket: doc.bucket,\n            r2Key: doc.r2Key,\n            title: doc.title,\n            originalFilename: doc.originalFilename,\n            contentType: doc.contentType,\n            sizeBytes: doc.sizeBytes,\n            requiresPassword: false,\n        };\n    }\n\n    // ALIAS\n    if (\"alias\" in input) {\n        const alias = String(input.alias || \"\").trim();\n        if (!alias) return { ok: false, error: \"NOT_FOUND\" };\n\n        const a = await resolveAliasToDocId(alias);\n        if (!a.ok) return { ok: false, error: \"NOT_FOUND\" };\n        if (a.revokedAt) return { ok: false, error: \"REVOKED\" };\n        if (isExpired(a.expiresAt)) return { ok: false, error: \"EXPIRED\" };\n        if (a.passwordHash) return { ok: false, error: \"PASSWORD_REQUIRED\" };\n\n        const doc = await getDocPointer(a.docId);\n        if (!doc.ok) return { ok: false, error: \"NOT_FOUND\" };\n\n        return {\n            ok: true,\n            source: \"alias\",\n            docId: doc.docId,\n            bucket: doc.bucket,\n            r2Key: doc.r2Key,\n            title: doc.title,\n            originalFilename: doc.originalFilename,\n            contentType: doc.contentType,\n            sizeBytes: doc.sizeBytes,\n            requiresPassword: false,\n        };\n    }\n\n    // TOKEN\n    if (\"token\" in input) {\n        const token = String(input.token || \"\").trim();\n        if (!token) return { ok: false, error: \"NOT_FOUND\" };\n\n        const t = await resolveTokenNoIncrement(token);\n        if (!t.ok) return { ok: false, error: t.error };\n\n        const doc = await getDocPointer(t.docId);\n        if (!doc.ok) return { ok: false, error: \"NOT_FOUND\" };\n\n        return {\n            ok: true,\n            source: \"token\",\n            token,\n            docId: doc.docId,\n            bucket: doc.bucket,\n            r2Key: doc.r2Key,\n            title: doc.title,\n            originalFilename: doc.originalFilename,\n            contentType: doc.contentType,\n            sizeBytes: doc.sizeBytes,\n            requiresPassword: Boolean(t.passwordHash),\n        };\n    }\n\n    return { ok: false, error: \"NOT_FOUND\" };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\retention.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":149,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5369,5372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5369,5372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":190,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6838,6841],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6838,6841],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":215,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":215,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7666,7669],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7666,7669],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":224,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":224,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7981,7984],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7981,7984],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":260,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":260,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9198,9201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9198,9201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/retention.ts\r\n// Best-effort retention cleanup for high-volume tables.\r\n//\r\n// Defaults:\r\n// - RAW logs: 90 days\r\n// - Daily aggregates: 365 days\r\n// - Expired share tokens: delete immediately (optional)\r\n//\r\n// Configure via env:\r\n// - RETENTION_DAYS\r\n// - RETENTION_DAYS_DAILY\r\n// - RETENTION_ENABLED (true/false) [fallback only; DB toggle preferred]\r\n// - RETENTION_DELETE_EXPIRED_SHARES (true/false) [fallback only; DB toggle preferred]\r\n// - RETENTION_SHARE_GRACE_DAYS (int >= 0) [fallback only; DB toggle preferred]\r\n// - RETENTION_AUDIT_R2_ORPHANS (true/false; default true)\r\n// - RETENTION_DELETE_R2_ORPHANS (true/false; default false)\r\n// - RETENTION_R2_AUDIT_MAX_OBJECTS (int; default 5000)\r\n\r\nimport { sql } from \"@/lib/db\";\r\nimport { getRetentionSettings } from \"@/lib/settings\";\r\nimport { getR2Bucket, getR2Prefix, r2Client } from \"@/lib/r2\";\r\nimport { DeleteObjectsCommand, ListObjectsV2Command } from \"@aws-sdk/client-s3\";\r\n\r\nexport type RetentionResult = {\r\n  table: string;\r\n  ok: boolean;\r\n  deleted?: number;\r\n  scanned?: number;\r\n  note?: string;\r\n  error?: string;\r\n};\r\n\r\nexport type RetentionRun = {\r\n  enabled: boolean;\r\n  rawDays: number;\r\n  dailyDays: number;\r\n  deleteExpiredShares: boolean;\r\n  shareGraceDays: number;\r\n  results: RetentionResult[];\r\n  source: \"db\" | \"env\";\r\n};\r\n\r\nfunction envInt(name: string, fallback: number): number {\r\n  const raw = (process.env[name] || \"\").trim();\r\n  const n = Number(raw);\r\n  if (!raw || !Number.isFinite(n) || n <= 0) return fallback;\r\n  return Math.floor(n);\r\n}\r\n\r\nfunction envBool(name: string, fallback: boolean): boolean {\r\n  const raw = (process.env[name] || \"\").trim().toLowerCase();\r\n  if (!raw) return fallback;\r\n  if ([\"1\", \"true\", \"yes\", \"y\", \"on\"].includes(raw)) return true;\r\n  if ([\"0\", \"false\", \"no\", \"n\", \"off\"].includes(raw)) return false;\r\n  return fallback;\r\n}\r\n\r\nasync function deleteOlderThan(args: {\r\n  table:\r\n    | \"public.doc_views\"\r\n    | \"public.doc_audit\"\r\n    | \"public.doc_access_log\"\r\n    | \"public.doc_daily_analytics\"\r\n    | \"public.doc_view_daily\";\r\n  columnCandidates: Array<\"created_at\" | \"accessed_at\" | \"day\" | \"date\">;\r\n  days: number;\r\n}): Promise<RetentionResult> {\r\n  const { table, columnCandidates, days } = args;\r\n  const cutoffExpr = sql`(now() - (${days}::int * interval '1 day'))`;\r\n\r\n  for (const col of columnCandidates) {\r\n    try {\r\n      // We can't parameterize identifiers safely with this client, so we hardcode per-column.\r\n      if (table === \"public.doc_views\" && col === \"created_at\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_views\r\n            where created_at < ${cutoffExpr}\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n\r\n      if (table === \"public.doc_audit\" && col === \"created_at\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_audit\r\n            where created_at < ${cutoffExpr}\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n\r\n      if (table === \"public.doc_access_log\" && col === \"accessed_at\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_access_log\r\n            where accessed_at < ${cutoffExpr}\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n\r\n      if (table === \"public.doc_access_log\" && col === \"created_at\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_access_log\r\n            where created_at < ${cutoffExpr}\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n\r\n      if (table === \"public.doc_daily_analytics\" && col === \"day\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_daily_analytics\r\n            where day < (current_date - (${days}::int * interval '1 day'))\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n\r\n      if (table === \"public.doc_view_daily\" && col === \"date\") {\r\n        const res = (await sql`\r\n          with d as (\r\n            delete from public.doc_view_daily\r\n            where date < (current_date - (${days}::int * interval '1 day'))\r\n            returning 1\r\n          )\r\n          select count(*)::int as deleted from d\r\n        `) as unknown as Array<{ deleted: number }>;\r\n        return { table, ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n      }\r\n    } catch (e) {\r\n      // Try the next column candidate.\r\n      const msg = e instanceof Error ? e.message : String(e);\r\n      // If table doesn't exist, surface it immediately.\r\n      const anyErr = e as any;\r\n      if (anyErr?.code === \"42P01\") {\r\n        return { table, ok: false, error: \"Table not found (SQLSTATE 42P01).\" };\r\n      }\r\n      // Continue to next column candidate.\r\n      if (col === columnCandidates[columnCandidates.length - 1]) {\r\n        return { table, ok: false, error: msg };\r\n      }\r\n    }\r\n  }\r\n\r\n  return { table, ok: false, error: \"No matching timestamp column found.\" };\r\n}\r\n\r\nasync function deleteExpiredShareTokens(args: { graceDays: number }): Promise<RetentionResult> {\r\n  const graceDays = Math.max(0, Math.floor(args.graceDays));\r\n  try {\r\n    if (graceDays === 0) {\r\n      const res = (await sql`\r\n        with d as (\r\n          delete from public.share_tokens\r\n          where expires_at is not null\r\n            and expires_at <= now()\r\n          returning 1\r\n        )\r\n        select count(*)::int as deleted from d\r\n      `) as unknown as Array<{ deleted: number }>;\r\n      return { table: \"public.share_tokens\", ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n    }\r\n\r\n    const res = (await sql`\r\n      with d as (\r\n        delete from public.share_tokens\r\n        where expires_at is not null\r\n          and expires_at <= (now() - (${graceDays}::int * interval '1 day'))\r\n        returning 1\r\n      )\r\n      select count(*)::int as deleted from d\r\n    `) as unknown as Array<{ deleted: number }>;\r\n    return { table: \"public.share_tokens\", ok: true, deleted: res?.[0]?.deleted ?? 0 };\r\n  } catch (e) {\r\n    const anyErr = e as any;\r\n    if (anyErr?.code === \"42P01\") {\r\n      return { table: \"public.share_tokens\", ok: false, error: \"Table not found (SQLSTATE 42P01).\" };\r\n    }\r\n    const msg = e instanceof Error ? e.message : String(e);\r\n    return { table: \"public.share_tokens\", ok: false, error: msg };\r\n  }\r\n}\r\n\r\nasync function auditR2OrphanedObjects(args: {\r\n  maxObjects: number;\r\n  deleteOrphans: boolean;\r\n}): Promise<RetentionResult> {\r\n  const maxObjects = Math.max(1, Math.min(50_000, Math.floor(args.maxObjects)));\r\n  const deleteOrphans = Boolean(args.deleteOrphans);\r\n\r\n  try {\r\n    const bucket = getR2Bucket();\r\n    const prefix = getR2Prefix();\r\n\r\n    const listed: string[] = [];\r\n    let continuationToken: string | undefined = undefined;\r\n    let truncated = false;\r\n\r\n    while (listed.length < maxObjects) {\r\n      const listRes: any = await r2Client.send(\r\n        new ListObjectsV2Command({\r\n          Bucket: bucket,\r\n          Prefix: prefix,\r\n          ContinuationToken: continuationToken,\r\n          MaxKeys: Math.min(1000, maxObjects - listed.length),\r\n        })\r\n      );\r\n      const keys = (listRes.Contents || [])\r\n        .map((o: any) => String(o.Key || \"\").trim())\r\n        .filter(Boolean);\r\n      listed.push(...keys);\r\n      if (!listRes.IsTruncated || !listRes.NextContinuationToken) {\r\n        truncated = Boolean(listRes.IsTruncated);\r\n        break;\r\n      }\r\n      continuationToken = listRes.NextContinuationToken;\r\n      truncated = true;\r\n    }\r\n\r\n    if (!listed.length) {\r\n      return {\r\n        table: \"r2.orphaned_objects\",\r\n        ok: true,\r\n        scanned: 0,\r\n        deleted: 0,\r\n        note: \"No objects found under configured prefix.\",\r\n      };\r\n    }\r\n\r\n    const rows = (await sql`\r\n      select d.r2_key::text as r2_key\r\n      from public.docs d\r\n      where d.r2_bucket = ${bucket}\r\n        and d.r2_key = any(${listed}::text[])\r\n        and coalesce(d.status, 'ready') <> 'deleted'\r\n    `) as unknown as Array<{ r2_key: string }>;\r\n    const live = new Set(rows.map((r) => String(r.r2_key || \"\").trim()).filter(Boolean));\r\n    const orphans = listed.filter((k) => !live.has(k));\r\n\r\n    let removed = 0;\r\n    if (deleteOrphans && orphans.length) {\r\n      const chunkSize = 1000;\r\n      for (let i = 0; i < orphans.length; i += chunkSize) {\r\n        const chunk = orphans.slice(i, i + chunkSize);\r\n        const del: any = await r2Client.send(\r\n          new DeleteObjectsCommand({\r\n            Bucket: bucket,\r\n            Delete: {\r\n              Objects: chunk.map((k) => ({ Key: k })),\r\n              Quiet: true,\r\n            },\r\n          })\r\n        );\r\n        removed += (del.Deleted || []).length;\r\n      }\r\n    }\r\n\r\n    const noteParts: string[] = [];\r\n    if (truncated) noteParts.push(`scan capped at ${maxObjects} objects`);\r\n    if (!deleteOrphans) noteParts.push(\"audit-only mode (no deletes)\");\r\n\r\n    return {\r\n      table: \"r2.orphaned_objects\",\r\n      ok: true,\r\n      scanned: listed.length,\r\n      deleted: deleteOrphans ? removed : orphans.length,\r\n      note: noteParts.join(\"; \") || undefined,\r\n    };\r\n  } catch (e) {\r\n    const msg = e instanceof Error ? e.message : String(e);\r\n    return { table: \"r2.orphaned_objects\", ok: false, error: msg };\r\n  }\r\n}\r\n\r\nexport async function runRetention(): Promise<RetentionRun> {\r\n  const rawDays = envInt(\"RETENTION_DAYS\", 90);\r\n  const dailyDays = envInt(\"RETENTION_DAYS_DAILY\", 365);\r\n\r\n  // Prefer DB settings when available (admin toggle). Fall back to env.\r\n  const dbSettings = await getRetentionSettings();\r\n  const source = dbSettings.ok ? (\"db\" as const) : (\"env\" as const);\r\n\r\n  const enabled = dbSettings.ok ? dbSettings.settings.enabled : envBool(\"RETENTION_ENABLED\", true);\r\n  const deleteExpiredShares = dbSettings.ok\r\n    ? dbSettings.settings.deleteExpiredShares\r\n    : envBool(\"RETENTION_DELETE_EXPIRED_SHARES\", true);\r\n  const shareGraceDays = dbSettings.ok ? dbSettings.settings.shareGraceDays : envInt(\"RETENTION_SHARE_GRACE_DAYS\", 0);\r\n  const auditR2Orphans = envBool(\"RETENTION_AUDIT_R2_ORPHANS\", true);\r\n  const deleteR2Orphans = envBool(\"RETENTION_DELETE_R2_ORPHANS\", true);\r\n  const r2AuditMaxObjects = envInt(\"RETENTION_R2_AUDIT_MAX_OBJECTS\", 5000);\r\n\r\n  const results: RetentionResult[] = [];\r\n\r\n  if (!enabled) {\r\n    return {\r\n      enabled,\r\n      rawDays,\r\n      dailyDays,\r\n      deleteExpiredShares,\r\n      shareGraceDays,\r\n      results,\r\n      source,\r\n    };\r\n  }\r\n\r\n  results.push(\r\n    await deleteOlderThan({\r\n      table: \"public.doc_views\",\r\n      columnCandidates: [\"created_at\"],\r\n      days: rawDays,\r\n    })\r\n  );\r\n  results.push(\r\n    await deleteOlderThan({\r\n      table: \"public.doc_audit\",\r\n      columnCandidates: [\"created_at\"],\r\n      days: rawDays,\r\n    })\r\n  );\r\n  results.push(\r\n    await deleteOlderThan({\r\n      table: \"public.doc_access_log\",\r\n      columnCandidates: [\"accessed_at\", \"created_at\"],\r\n      days: rawDays,\r\n    })\r\n  );\r\n  results.push(\r\n    await deleteOlderThan({\r\n      table: \"public.doc_daily_analytics\",\r\n      columnCandidates: [\"day\"],\r\n      days: dailyDays,\r\n    })\r\n  );\r\n\r\n  results.push(\r\n    await deleteOlderThan({\r\n      table: \"public.doc_view_daily\",\r\n      columnCandidates: [\"date\"],\r\n      days: dailyDays,\r\n    })\r\n  );\r\n\r\n  if (deleteExpiredShares) {\r\n    results.push(await deleteExpiredShareTokens({ graceDays: shareGraceDays }));\r\n  }\r\n  if (auditR2Orphans) {\r\n    results.push(\r\n      await auditR2OrphanedObjects({\r\n        maxObjects: r2AuditMaxObjects,\r\n        deleteOrphans: deleteR2Orphans,\r\n      })\r\n    );\r\n  }\r\n\r\n  return {\r\n    enabled,\r\n    rawDays,\r\n    dailyDays,\r\n    deleteExpiredShares,\r\n    shareGraceDays,\r\n    results,\r\n    source,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\routeTimeout.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\runtimeEnv.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\scanQueue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\securityPolicy.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\securityTelemetry.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":195,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":195,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5688,5691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5688,5691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":201,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":201,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5876,5879],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5876,5879],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":235,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6563,6566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6563,6566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":236,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":236,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6617,6620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6617,6620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":237,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6671,6674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6671,6674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from \"crypto\";\nimport { sql } from \"@/lib/db\";\nimport { rateLimit } from \"@/lib/rateLimit\";\nimport { appendImmutableAudit } from \"@/lib/immutableAudit\";\n\nfunction securityTelemetryDbEnabled(): boolean {\n  const explicit = String(process.env.SECURITY_TELEMETRY_DB_ENABLED || \"\").trim().toLowerCase();\n  if (explicit === \"0\" || explicit === \"false\" || explicit === \"off\" || explicit === \"no\") return false;\n  if (explicit === \"1\" || explicit === \"true\" || explicit === \"on\" || explicit === \"yes\") return true;\n\n  const disableForTests = String(process.env.DISABLE_SECURITY_TELEMETRY_DB || \"\").trim().toLowerCase();\n  if (disableForTests === \"1\" || disableForTests === \"true\" || disableForTests === \"on\" || disableForTests === \"yes\") {\n    return false;\n  }\n\n  // Keep tests/log-only envs quiet by default unless explicitly enabled.\n  if (process.env.NODE_ENV === \"test\") return false;\n\n  return true;\n}\n\n/**\n * Hash IP address (privacy safe logging)\n */\nexport function hashIp(ip: string): string {\n  const hash = crypto.createHash(\"sha256\");\n  hash.update(ip);\n  return hash.digest(\"hex\");\n}\n\n/**\n * Extract the best-effort client IP from a Request/NextRequest.\n * We prefer edge / proxy headers (Cloudflare + Vercel) then fall back.\n */\nexport function clientIpKey(req: Request): { ip: string; ipHash: string } {\n  const h = req.headers;\n\n  // Cloudflare\n  const cf = h.get(\"cf-connecting-ip\");\n  if (cf) return { ip: cf, ipHash: hashIp(cf) };\n\n  // Common reverse-proxy headers\n  const xff = h.get(\"x-forwarded-for\");\n  if (xff) {\n    const first = xff.split(\",\")[0]?.trim();\n    if (first) return { ip: first, ipHash: hashIp(first) };\n  }\n\n  const xri = h.get(\"x-real-ip\");\n  if (xri) return { ip: xri, ipHash: hashIp(xri) };\n\n  // Vercel sometimes provides this\n  const vercel = h.get(\"x-vercel-forwarded-for\");\n  if (vercel) {\n    const first = vercel.split(\",\")[0]?.trim();\n    if (first) return { ip: first, ipHash: hashIp(first) };\n  }\n\n  // Final fallback (unknown)\n  const ip = \"0.0.0.0\";\n  return { ip, ipHash: hashIp(ip) };\n}\n\nlet abuseIpBlocksTableExistsCache: boolean | null = null;\n\nasync function abuseIpBlocksTableExists(): Promise<boolean> {\n  if (abuseIpBlocksTableExistsCache != null) return abuseIpBlocksTableExistsCache;\n  try {\n    const rows = (await sql`\n      select to_regclass('public.abuse_ip_blocks')::text as reg\n    `) as unknown as Array<{ reg: string | null }>;\n    abuseIpBlocksTableExistsCache = Boolean(rows?.[0]?.reg);\n    return abuseIpBlocksTableExistsCache;\n  } catch {\n    abuseIpBlocksTableExistsCache = false;\n    return false;\n  }\n}\n\nexport async function isIpAbuseBlocked(ip: string): Promise<boolean> {\n  if (!ip) return false;\n  if (!(await abuseIpBlocksTableExists())) return false;\n  try {\n    const rows = (await sql`\n      select 1\n      from public.abuse_ip_blocks\n      where ip_hash = ${hashIp(ip)}\n        and (expires_at is null or expires_at > now())\n      limit 1\n    `) as unknown as Array<{ \"?column?\": number }>;\n    return rows.length > 0;\n  } catch {\n    return false;\n  }\n}\n\nexport async function enforceIpAbuseBlock(args: {\n  req: Request;\n  scope: string;\n}): Promise<{ ok: true } | { ok: false; retryAfterSeconds: number }> {\n  const { ip } = clientIpKey(args.req);\n  const blocked = await isIpAbuseBlocked(ip);\n  if (!blocked) return { ok: true };\n\n  await logSecurityEvent({\n    type: \"abuse_ip_block_hit\",\n    severity: \"high\",\n    ip,\n    scope: args.scope,\n    message: \"Request denied due to abuse IP block\",\n  });\n  return { ok: false, retryAfterSeconds: 3600 };\n}\n\nexport async function maybeBlockIpOnAbuse(args: {\n  ip: string;\n  category: string;\n  scope: string;\n  threshold: number;\n  windowSeconds: number;\n  blockSeconds: number;\n  reason?: string | null;\n  meta?: Record<string, unknown>;\n}) {\n  if (!args.ip || !(await abuseIpBlocksTableExists())) return;\n  const threshold = Math.max(1, Math.floor(args.threshold));\n  const windowSeconds = Math.max(1, Math.floor(args.windowSeconds));\n  const blockSeconds = Math.max(60, Math.floor(args.blockSeconds));\n\n  const counter = await rateLimit({\n    scope: `abuse:${args.category}`,\n    id: hashIp(args.ip),\n    limit: threshold,\n    windowSeconds,\n    failClosed: true,\n  });\n\n  if (counter.count < threshold) return;\n\n  try {\n    const expiresAt = new Date(Date.now() + blockSeconds * 1000).toISOString();\n    await sql`\n      insert into public.abuse_ip_blocks (ip_hash, reason, source, expires_at, meta)\n      values (\n        ${hashIp(args.ip)},\n        ${args.reason ?? `abuse:${args.category}`},\n        ${args.scope},\n        ${expiresAt}::timestamptz,\n        ${JSON.stringify({\n          threshold,\n          windowSeconds,\n          blockSeconds,\n          ...(args.meta ?? {}),\n        })}::jsonb\n      )\n      on conflict (ip_hash)\n      do update set\n        reason = excluded.reason,\n        source = excluded.source,\n        expires_at = greatest(coalesce(public.abuse_ip_blocks.expires_at, now()), excluded.expires_at),\n        meta = excluded.meta\n    `;\n  } catch {\n    // best-effort\n  }\n\n  await logSecurityEvent({\n    type: \"abuse_ip_blocked\",\n    severity: \"high\",\n    ip: args.ip,\n    scope: args.scope,\n    message: args.reason ?? `Blocked due to abuse threshold (${args.category})`,\n    meta: {\n      category: args.category,\n      threshold,\n      windowSeconds,\n      blockSeconds,\n      ...(args.meta ?? {}),\n    },\n  });\n}\n\n/**\n * Log security event\n */\ntype SecurityEventInput = {\n  type: string;\n  severity: \"low\" | \"medium\" | \"high\";\n  ip?: string | null;\n  actorUserId?: string | null;\n  orgId?: string | null;\n  docId?: string | null;\n  scope?: string | null;\n  message?: string | null;\n  meta?: Record<string, any> | null;\n};\n\n// Back-compat overload: old signature (type, details, ip?)\nexport async function logSecurityEvent(\n  typeOrEvent: string | SecurityEventInput,\n  details?: Record<string, any>,\n  ip?: string\n) {\n  if (!securityTelemetryDbEnabled()) return;\n\n  try {\n    let ev: SecurityEventInput;\n    if (typeof typeOrEvent === \"string\") {\n      ev = {\n        type: typeOrEvent,\n        severity: \"low\",\n        ip: ip ?? null,\n        meta: details ?? null,\n      };\n    } else {\n      ev = typeOrEvent;\n    }\n\n    await sql`\n      insert into public.security_events (\n        type,\n        severity,\n        ip_hash,\n        actor_user_id,\n        org_id,\n        doc_id,\n        scope,\n        message,\n        meta\n      )\n      values (\n        ${ev.type},\n        ${ev.severity},\n        ${ev.ip ? hashIp(ev.ip) : null},\n        ${ev.actorUserId ? (ev.actorUserId as any) : null}::uuid,\n        ${ev.orgId ? (ev.orgId as any) : null}::uuid,\n        ${ev.docId ? (ev.docId as any) : null}::uuid,\n        ${ev.scope ?? null},\n        ${ev.message ?? null},\n        ${ev.meta ? JSON.stringify(ev.meta) : null}::jsonb\n      )\n    `;\n\n    await appendImmutableAudit({\n      streamKey: `security:${ev.type}`,\n      action: \"security.event\",\n      actorUserId: ev.actorUserId ?? null,\n      orgId: ev.orgId ?? null,\n      docId: ev.docId ?? null,\n      ipHash: ev.ip ? hashIp(ev.ip) : null,\n      payload: {\n        severity: ev.severity,\n        scope: ev.scope ?? null,\n        message: ev.message ?? null,\n        meta: ev.meta ?? null,\n      },\n    });\n  } catch (err) {\n    // best-effort; do not crash request paths\n    console.error(\"Failed to log security event:\", err);\n  }\n}\n\n/**\n * Global API rate limiter (DB-backed)\n */\nexport async function enforceGlobalApiRateLimit(args: {\n  req: Request;\n  scope: string;\n  limit: number;\n  windowSeconds: number;\n  actorUserId?: string | null;\n  orgId?: string | null;\n  strict?: boolean;\n}) {\n  const { req, scope, limit, windowSeconds, actorUserId, orgId, strict } = args;\n  const { ip, ipHash } = clientIpKey(req);\n\n  const rl = await rateLimit({\n    scope,\n    id: ipHash,\n    limit,\n    windowSeconds,\n    failClosed: Boolean(strict),\n  });\n\n  const retryAfterSeconds = Math.max(1, rl.resetSeconds);\n\n  if (!rl.ok) {\n    // best-effort telemetry\n    void logSecurityEvent({\n      type: \"rate_limit\",\n      severity: \"medium\",\n      ip,\n      actorUserId: actorUserId ?? null,\n      orgId: orgId ?? null,\n      scope,\n      message: \"Rate limit exceeded\",\n      meta: { count: rl.count, limit: rl.limit, windowSeconds },\n    });\n\n    return { ok: false as const, status: 429 as const, retryAfterSeconds };\n  }\n\n  return { ok: true as const, status: 200 as const, retryAfterSeconds: 0 };\n}\n\n/**\n * Log decrypt event\n */\nexport async function logDecryptEvent(docId: string, ip?: string) {\n    if (!securityTelemetryDbEnabled()) return;\n\n    try {\n        await sql`\n      insert into public.doc_decrypt_log (\n        doc_id,\n        ip_hash,\n        created_at\n      )\n      values (\n        ${docId},\n        ${ip ? hashIp(ip) : null},\n        now()\n      )\n    `\n    } catch (err) {\n        console.error(\"Failed to log decrypt event:\", err)\n    }\n}\n\n/**\n * Best-effort anomaly detection for sudden storage usage bursts.\n * This is a lightweight guardrail against automated abuse.\n */\nexport async function detectStorageSpike(args: {\n  ownerId: string;\n  sizeBytes: number;\n  ip: string;\n  orgId?: string | null;\n  docId?: string | null;\n}) {\n  const { ownerId, sizeBytes, ip, orgId, docId } = args;\n\n  // Single-upload threshold (default 100MB)\n  const singleThreshold = Number(process.env.STORAGE_SPIKE_SINGLE_BYTES || 100 * 1024 * 1024);\n  if (Number.isFinite(sizeBytes) && sizeBytes >= singleThreshold) {\n    await logSecurityEvent({\n      type: \"storage_spike\",\n      severity: \"medium\",\n      ip,\n      actorUserId: ownerId,\n      orgId: orgId ?? null,\n      docId: docId ?? null,\n      scope: \"upload_complete\",\n      message: \"Large single upload\",\n      meta: { sizeBytes, singleThreshold },\n    });\n    return;\n  }\n\n  // Burst threshold: sum of uploads over last 10 minutes (default 250MB)\n  const burstThreshold = Number(process.env.STORAGE_SPIKE_BURST_BYTES || 250 * 1024 * 1024);\n  try {\n    const rows = (await sql`\n      select coalesce(sum(size_bytes), 0)::bigint as total\n      from public.docs\n      where owner_id = ${ownerId}::uuid\n        and created_at > now() - interval '10 minutes'\n    `) as unknown as Array<{ total: number | string }>;\n\n    const total = Number(rows?.[0]?.total ?? 0);\n    if (Number.isFinite(total) && total >= burstThreshold) {\n      await logSecurityEvent({\n        type: \"storage_spike\",\n        severity: \"high\",\n        ip,\n        actorUserId: ownerId,\n        orgId: orgId ?? null,\n        docId: docId ?? null,\n        scope: \"upload_burst\",\n        message: \"High upload burst\",\n        meta: { totalLast10m: total, burstThreshold },\n      });\n    }\n  } catch {\n    // ignore\n  }\n}\n\nasync function detectEventSpike(args: {\n  eventType: string;\n  windowMinutes: number;\n  threshold: number;\n  alertType: string;\n  severity: \"low\" | \"medium\" | \"high\";\n  ip?: string | null;\n  scope: string;\n  message: string;\n  meta?: Record<string, unknown>;\n}) {\n  const { eventType, windowMinutes, threshold } = args;\n  if (!eventType || threshold <= 0 || windowMinutes <= 0) return;\n\n  try {\n    const rows = (await sql`\n      select count(*)::int as c\n      from public.security_events\n      where type = ${eventType}\n        and created_at > now() - (${windowMinutes}::text || ' minutes')::interval\n    `) as unknown as Array<{ c: number }>;\n    const count = Number(rows?.[0]?.c ?? 0);\n    if (count < threshold) return;\n\n    await logSecurityEvent({\n      type: args.alertType,\n      severity: args.severity,\n      ip: args.ip ?? null,\n      scope: args.scope,\n      message: args.message,\n      meta: {\n        sourceEvent: eventType,\n        count,\n        threshold,\n        windowMinutes,\n        ...(args.meta ?? {}),\n      },\n    });\n  } catch {\n    // ignore\n  }\n}\n\nexport async function detectAbuseReportSpike(args: { ip?: string | null }) {\n  const threshold = Math.max(1, Number(process.env.ABUSE_REPORT_SPIKE_THRESHOLD || 20));\n  const windowMinutes = Math.max(1, Number(process.env.ABUSE_REPORT_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"abuse_report_submitted\",\n    threshold,\n    windowMinutes,\n    alertType: \"abuse_report_spike\",\n    severity: \"high\",\n    ip: args.ip ?? null,\n    scope: \"abuse_report\",\n    message: \"Abuse report submission spike detected\",\n  });\n}\n\nexport async function detectPresignFailureSpike(args: { ip?: string | null }) {\n  const threshold = Math.max(1, Number(process.env.PRESIGN_FAILURE_SPIKE_THRESHOLD || 15));\n  const windowMinutes = Math.max(1, Number(process.env.PRESIGN_FAILURE_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"upload_presign_error\",\n    threshold,\n    windowMinutes,\n    alertType: \"upload_presign_failure_spike\",\n    severity: \"high\",\n    ip: args.ip ?? null,\n    scope: \"upload_presign\",\n    message: \"Upload presign failures spiked\",\n  });\n}\n\nexport async function detectScanFailureSpike() {\n  const threshold = Math.max(1, Number(process.env.SCAN_FAILURE_SPIKE_THRESHOLD || 10));\n  const windowMinutes = Math.max(1, Number(process.env.SCAN_FAILURE_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"malware_scan_job_failed\",\n    threshold,\n    windowMinutes,\n    alertType: \"malware_scan_failure_spike\",\n    severity: \"high\",\n    scope: \"scanner\",\n    message: \"Malware scan failures spiked\",\n  });\n}\n\nexport async function detectUploadCompletionSpike() {\n  const threshold = Math.max(1, Number(process.env.UPLOAD_SPIKE_THRESHOLD || 120));\n  const windowMinutes = Math.max(1, Number(process.env.UPLOAD_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"upload_complete_success\",\n    threshold,\n    windowMinutes,\n    alertType: \"upload_spike_alert\",\n    severity: \"high\",\n    scope: \"upload_complete\",\n    message: \"Upload completion volume spiked\",\n  });\n}\n\nexport async function detectDbErrorSpike() {\n  const threshold = Math.max(1, Number(process.env.DB_ERROR_SPIKE_THRESHOLD || 20));\n  const windowMinutes = Math.max(1, Number(process.env.DB_ERROR_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"db_error\",\n    threshold,\n    windowMinutes,\n    alertType: \"db_error_spike\",\n    severity: \"high\",\n    scope: \"database\",\n    message: \"Database error rate spiked\",\n  });\n}\n\nexport async function detectAliasAccessDeniedSpike(args: { ip?: string | null }) {\n  const threshold = Math.max(1, Number(process.env.ALIAS_DENIED_SPIKE_THRESHOLD || 60));\n  const windowMinutes = Math.max(1, Number(process.env.ALIAS_DENIED_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"alias_access_denied\",\n    threshold,\n    windowMinutes,\n    alertType: \"alias_guess_spike\",\n    severity: \"high\",\n    ip: args.ip ?? null,\n    scope: \"alias_raw\",\n    message: \"Alias access denials spiked\",\n  });\n}\n\nexport async function detectTokenAccessDeniedSpike(args: { ip?: string | null }) {\n  const threshold = Math.max(1, Number(process.env.TOKEN_DENIED_SPIKE_THRESHOLD || 80));\n  const windowMinutes = Math.max(1, Number(process.env.TOKEN_DENIED_SPIKE_WINDOW_MINUTES || 10));\n  await detectEventSpike({\n    eventType: \"share_access_denied\",\n    threshold,\n    windowMinutes,\n    alertType: \"token_guess_spike\",\n    severity: \"high\",\n    ip: args.ip ?? null,\n    scope: \"share_raw\",\n    message: \"Share token access denials spiked\",\n  });\n}\n\nexport async function detectViewSpike() {\n  const threshold = Math.max(1, Number(process.env.VIEW_SPIKE_THRESHOLD || 2000));\n  const windowMinutes = Math.max(1, Number(process.env.VIEW_SPIKE_WINDOW_MINUTES || 10));\n  try {\n    const rows = (await sql`\n      select count(*)::int as c\n      from public.doc_views\n      where created_at > now() - (${windowMinutes}::text || ' minutes')::interval\n    `) as unknown as Array<{ c: number }>;\n    const count = Number(rows?.[0]?.c ?? 0);\n    if (count < threshold) return;\n\n    await logSecurityEvent({\n      type: \"view_spike_alert\",\n      severity: \"high\",\n      scope: \"doc_views\",\n      message: \"Document view volume spiked\",\n      meta: { count, threshold, windowMinutes },\n    });\n  } catch {\n    // ignore\n  }\n}\n\nfunction looksLikeDbErrorMessage(message: string): boolean {\n  const msg = String(message || \"\").toLowerCase();\n  if (!msg) return false;\n  return (\n    msg.includes(\"neondberror\") ||\n    msg.includes(\"sqlstate\") ||\n    msg.includes(\"database\") ||\n    msg.includes(\"relation\") ||\n    msg.includes(\"connection\") ||\n    msg.includes(\"authentication failed\") ||\n    msg.includes(\"timeout\")\n  );\n}\n\nexport async function logDbErrorEvent(args: {\n  scope: string;\n  message: string;\n  ip?: string | null;\n  actorUserId?: string | null;\n  orgId?: string | null;\n  meta?: Record<string, unknown>;\n}) {\n  if (!looksLikeDbErrorMessage(args.message)) return;\n  await logSecurityEvent({\n    type: \"db_error\",\n    severity: \"high\",\n    ip: args.ip ?? null,\n    actorUserId: args.actorUserId ?? null,\n    orgId: args.orgId ?? null,\n    scope: args.scope,\n    message: args.message,\n    meta: args.meta ?? null,\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\settings.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":59,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1560,1563],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1560,1563],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3101,3104],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3101,3104],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3671,3674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3671,3674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":163,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":163,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5156,5159],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5156,5159],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":218,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":218,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6896,6899],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6896,6899],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":255,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8264,8267],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8264,8267],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":291,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":291,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9254,9257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9254,9257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":334,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11067,11070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11067,11070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/settings.ts\n// DB-backed runtime settings (best-effort).\n//\n// Requires: public.app_settings (see scripts/sql/app_settings.sql)\n\nimport { sql } from \"@/lib/db\";\n\nexport type RetentionSettings = {\n  enabled: boolean;\n  deleteExpiredShares: boolean;\n  shareGraceDays: number;\n};\n\nconst DEFAULT_RETENTION: RetentionSettings = {\n  enabled: true,\n  deleteExpiredShares: true,\n  shareGraceDays: 0,\n};\n\nexport type ExpirationAlertSettings = {\n  enabled: boolean;\n  days: number; // threshold days (default 3)\n  emailEnabled: boolean; // whether to send emails at all\n};\n\nconst DEFAULT_EXPIRATION_ALERTS: ExpirationAlertSettings = {\n  enabled: true,\n  days: 3,\n  emailEnabled: true,\n};\n\nfunction asBool(v: unknown, fallback: boolean) {\n  if (typeof v === \"boolean\") return v;\n  if (typeof v === \"string\") {\n    const s = v.trim().toLowerCase();\n    if (s === \"true\" || s === \"1\" || s === \"yes\" || s === \"y\") return true;\n    if (s === \"false\" || s === \"0\" || s === \"no\" || s === \"n\") return false;\n  }\n  if (typeof v === \"number\") return v !== 0;\n  return fallback;\n}\n\nfunction asInt(v: unknown, fallback: number) {\n  const n = typeof v === \"number\" ? v : Number(String(v ?? \"\"));\n  if (!Number.isFinite(n)) return fallback;\n  return Math.floor(n);\n}\n\nexport async function getRetentionSettings(): Promise<\n  | { ok: true; settings: RetentionSettings }\n  | { ok: false; error: string }\n> {\n  try {\n    const rows = (await sql`\n      select value\n      from public.app_settings\n      where key = 'retention'\n      limit 1\n    `) as unknown as Array<{ value: any }>;\n\n    const value = rows?.[0]?.value ?? null;\n    if (!value || typeof value !== \"object\") {\n      return { ok: true, settings: { ...DEFAULT_RETENTION } };\n    }\n\n    return {\n      ok: true,\n      settings: {\n        enabled: asBool(value.enabled, DEFAULT_RETENTION.enabled),\n        deleteExpiredShares: asBool(value.deleteExpiredShares, DEFAULT_RETENTION.deleteExpiredShares),\n        shareGraceDays: Math.max(0, asInt(value.shareGraceDays, DEFAULT_RETENTION.shareGraceDays)),\n      },\n    };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n\nexport async function setRetentionSettings(next: Partial<RetentionSettings>): Promise<\n  | { ok: true; settings: RetentionSettings }\n  | { ok: false; error: string }\n> {\n  // Read current (best-effort), then merge.\n  const currentRes = await getRetentionSettings();\n  const current = currentRes.ok ? currentRes.settings : { ...DEFAULT_RETENTION };\n\n  const merged: RetentionSettings = {\n    enabled: typeof next.enabled === \"boolean\" ? next.enabled : current.enabled,\n    deleteExpiredShares:\n      typeof next.deleteExpiredShares === \"boolean\" ? next.deleteExpiredShares : current.deleteExpiredShares,\n    shareGraceDays:\n      typeof next.shareGraceDays === \"number\" && Number.isFinite(next.shareGraceDays)\n        ? Math.max(0, Math.floor(next.shareGraceDays))\n        : current.shareGraceDays,\n  };\n\n  try {\n    await sql`\n      insert into public.app_settings (key, value)\n      values ('retention', ${merged as any}::jsonb)\n      on conflict (key) do update set value = excluded.value\n    `;\n    return { ok: true, settings: merged };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n\nexport async function getExpirationAlertSettings(): Promise<\n  | { ok: true; settings: ExpirationAlertSettings }\n  | { ok: false; error: string }\n> {\n  try {\n    const rows = (await sql`\n      select value\n      from public.app_settings\n      where key = 'expiration_alerts'\n      limit 1\n    `) as unknown as Array<{ value: any }>;\n\n    const value = rows?.[0]?.value ?? null;\n    if (!value || typeof value !== \"object\") {\n      return { ok: true, settings: { ...DEFAULT_EXPIRATION_ALERTS } };\n    }\n\n    const days = Math.max(1, Math.min(30, asInt(value.days, DEFAULT_EXPIRATION_ALERTS.days)));\n\n    return {\n      ok: true,\n      settings: {\n        enabled: asBool(value.enabled, DEFAULT_EXPIRATION_ALERTS.enabled),\n        days,\n        emailEnabled: asBool(value.emailEnabled, DEFAULT_EXPIRATION_ALERTS.emailEnabled),\n      },\n    };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n\nexport async function setExpirationAlertSettings(next: Partial<ExpirationAlertSettings>): Promise<\n  | { ok: true; settings: ExpirationAlertSettings }\n  | { ok: false; error: string }\n> {\n  const currentRes = await getExpirationAlertSettings();\n  const current = currentRes.ok ? currentRes.settings : { ...DEFAULT_EXPIRATION_ALERTS };\n\n  const merged: ExpirationAlertSettings = {\n    enabled: typeof next.enabled === \"boolean\" ? next.enabled : current.enabled,\n    emailEnabled: typeof next.emailEnabled === \"boolean\" ? next.emailEnabled : current.emailEnabled,\n    days:\n      typeof next.days === \"number\" && Number.isFinite(next.days)\n        ? Math.max(1, Math.min(30, Math.floor(next.days)))\n        : current.days,\n  };\n\n  try {\n    await sql`\n      insert into public.app_settings (key, value)\n      values ('expiration_alerts', ${merged as any}::jsonb)\n      on conflict (key) do update set value = excluded.value\n    `;\n    return { ok: true, settings: merged };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n\n// --- Billing / Monetization runtime flags ---\n\nexport type BillingFlags = {\n  enforcePlanLimits: boolean; // storage/views/shares limits\n  proPlanEnabled: boolean; // if false, treat 'pro' as 'free' for limits\n  pricingUiEnabled: boolean; // show upgrade/pricing UI copy\n};\n\nconst DEFAULT_BILLING_FLAGS: BillingFlags = {\n  // safest-by-default: enforce limits even if settings table is empty\n  enforcePlanLimits: true,\n  proPlanEnabled: false,\n  pricingUiEnabled: false,\n};\n\nfunction envBool(name: string): boolean | null {\n  const raw = process.env[name];\n  if (raw == null) return null;\n  return asBool(raw, false);\n}\n\n/**\n * Best-effort DB-backed billing flags.\n *\n * Precedence:\n * 1) DB value (public.app_settings key 'billing_flags')\n * 2) env vars (ENFORCE_PLAN_LIMITS / PRO_PLAN_ENABLED / PRICING_UI_ENABLED)\n * 3) defaults (fail-closed)\n */\nexport async function getBillingFlags(): Promise<\n  | { ok: true; flags: BillingFlags }\n  | { ok: false; error: string; flags: BillingFlags }\n> {\n  const envDefaults: BillingFlags = {\n    enforcePlanLimits: envBool(\"ENFORCE_PLAN_LIMITS\") ?? DEFAULT_BILLING_FLAGS.enforcePlanLimits,\n    proPlanEnabled: envBool(\"PRO_PLAN_ENABLED\") ?? DEFAULT_BILLING_FLAGS.proPlanEnabled,\n    pricingUiEnabled: envBool(\"PRICING_UI_ENABLED\") ?? DEFAULT_BILLING_FLAGS.pricingUiEnabled,\n  };\n\n  try {\n    const rows = (await sql`\n      select value\n      from public.app_settings\n      where key = 'billing_flags'\n      limit 1\n    `) as unknown as Array<{ value: any }>;\n\n    const value = rows?.[0]?.value ?? null;\n    if (!value || typeof value !== \"object\") {\n      return { ok: true, flags: { ...envDefaults } };\n    }\n\n    return {\n      ok: true,\n      flags: {\n        enforcePlanLimits: asBool(value.enforcePlanLimits, envDefaults.enforcePlanLimits),\n        proPlanEnabled: asBool(value.proPlanEnabled, envDefaults.proPlanEnabled),\n        pricingUiEnabled: asBool(value.pricingUiEnabled, envDefaults.pricingUiEnabled),\n      },\n    };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg, flags: { ...envDefaults } };\n  }\n}\n\nexport async function setBillingFlags(next: Partial<BillingFlags>): Promise<\n  | { ok: true; flags: BillingFlags }\n  | { ok: false; error: string }\n> {\n  const currentRes = await getBillingFlags();\n  const current = currentRes.flags;\n\n  const merged: BillingFlags = {\n    enforcePlanLimits: typeof next.enforcePlanLimits === \"boolean\" ? next.enforcePlanLimits : current.enforcePlanLimits,\n    proPlanEnabled: typeof next.proPlanEnabled === \"boolean\" ? next.proPlanEnabled : current.proPlanEnabled,\n    pricingUiEnabled: typeof next.pricingUiEnabled === \"boolean\" ? next.pricingUiEnabled : current.pricingUiEnabled,\n  };\n\n  try {\n    await sql`\n      insert into public.app_settings (key, value)\n      values ('billing_flags', ${merged as any}::jsonb)\n      on conflict (key) do update set value = excluded.value\n    `;\n    return { ok: true, flags: merged };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n\n// --- Security emergency freeze flags ---\n\nexport type SecurityFreezeSettings = {\n  globalServeDisabled: boolean;\n  shareServeDisabled: boolean;\n  aliasServeDisabled: boolean;\n  ticketServeDisabled: boolean;\n};\n\nconst DEFAULT_SECURITY_FREEZE: SecurityFreezeSettings = {\n  globalServeDisabled: false,\n  shareServeDisabled: false,\n  aliasServeDisabled: false,\n  ticketServeDisabled: false,\n};\n\nexport async function getSecurityFreezeSettings(): Promise<\n  | { ok: true; settings: SecurityFreezeSettings }\n  | { ok: false; error: string; settings: SecurityFreezeSettings }\n> {\n  try {\n    const rows = (await sql`\n      select value\n      from public.app_settings\n      where key = 'security_freeze'\n      limit 1\n    `) as unknown as Array<{ value: any }>;\n\n    const value = rows?.[0]?.value ?? null;\n    if (!value || typeof value !== \"object\") {\n      return { ok: true, settings: { ...DEFAULT_SECURITY_FREEZE } };\n    }\n\n    return {\n      ok: true,\n      settings: {\n        globalServeDisabled: asBool(value.globalServeDisabled, DEFAULT_SECURITY_FREEZE.globalServeDisabled),\n        shareServeDisabled: asBool(value.shareServeDisabled, DEFAULT_SECURITY_FREEZE.shareServeDisabled),\n        aliasServeDisabled: asBool(value.aliasServeDisabled, DEFAULT_SECURITY_FREEZE.aliasServeDisabled),\n        ticketServeDisabled: asBool(value.ticketServeDisabled, DEFAULT_SECURITY_FREEZE.ticketServeDisabled),\n      },\n    };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg, settings: { ...DEFAULT_SECURITY_FREEZE } };\n  }\n}\n\nexport async function setSecurityFreezeSettings(next: Partial<SecurityFreezeSettings>): Promise<\n  | { ok: true; settings: SecurityFreezeSettings }\n  | { ok: false; error: string }\n> {\n  const currentRes = await getSecurityFreezeSettings();\n  const current = currentRes.settings;\n\n  const merged: SecurityFreezeSettings = {\n    globalServeDisabled:\n      typeof next.globalServeDisabled === \"boolean\" ? next.globalServeDisabled : current.globalServeDisabled,\n    shareServeDisabled:\n      typeof next.shareServeDisabled === \"boolean\" ? next.shareServeDisabled : current.shareServeDisabled,\n    aliasServeDisabled:\n      typeof next.aliasServeDisabled === \"boolean\" ? next.aliasServeDisabled : current.aliasServeDisabled,\n    ticketServeDisabled:\n      typeof next.ticketServeDisabled === \"boolean\" ? next.ticketServeDisabled : current.ticketServeDisabled,\n  };\n\n  try {\n    await sql`\n      insert into public.app_settings (key, value)\n      values ('security_freeze', ${merged as any}::jsonb)\n      on conflict (key) do update set value = excluded.value\n    `;\n    return { ok: true, settings: merged };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return { ok: false, error: msg };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\shareAuth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\shareLifecycle.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[739,742],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[739,742],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\n\nexport async function revokeExpiredSharesBatch(limit: number = 1000): Promise<{ revoked: number }> {\n  const n = Math.max(1, Math.min(5000, Number(limit || 1000)));\n  try {\n    const rows = (await sql`\n      with targets as (\n        select st.token\n        from public.share_tokens st\n        where st.revoked_at is null\n          and st.expires_at is not null\n          and st.expires_at <= now()\n        order by st.expires_at asc\n        limit ${n}::int\n      )\n      update public.share_tokens st\n      set revoked_at = now()\n      from targets t\n      where st.token = t.token\n      returning st.token\n    `) as unknown as Array<{ token: string }>;\n    return { revoked: rows.length };\n  } catch (e: any) {\n    if (String(e?.code || \"\") === \"42P01\") return { revoked: 0 };\n    throw e;\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\slug.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\stripeClient.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[581,584],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[581,584],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1054,1057],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1054,1057],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"type StripeRequestOptions = {\n  method?: \"GET\" | \"POST\";\n  body?: Record<string, string>;\n};\n\nfunction mustGetStripeSecretKey(): string {\n  const key = String(process.env.STRIPE_SECRET_KEY || \"\").trim();\n  if (!key) throw new Error(\"STRIPE_SECRET_KEY is not configured\");\n  return key;\n}\n\nfunction encodeFormBody(body: Record<string, string>): string {\n  const params = new URLSearchParams();\n  for (const [k, v] of Object.entries(body)) {\n    params.set(k, v);\n  }\n  return params.toString();\n}\n\nexport async function stripeApi(path: string, opts?: StripeRequestOptions): Promise<any> {\n  const key = mustGetStripeSecretKey();\n  const method = opts?.method || \"POST\";\n  const body = opts?.body || {};\n\n  const r = await fetch(`https://api.stripe.com/v1/${path.replace(/^\\/+/, \"\")}`, {\n    method,\n    headers: {\n      Authorization: `Bearer ${key}`,\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    },\n    body: method === \"POST\" ? encodeFormBody(body) : undefined,\n    cache: \"no-store\",\n  });\n\n  const text = await r.text();\n  let json: any = null;\n  try {\n    json = text ? JSON.parse(text) : null;\n  } catch {\n    json = null;\n  }\n\n  if (!r.ok) {\n    const msg = String(json?.error?.message || text || `Stripe API ${path} failed`);\n    throw new Error(msg);\n  }\n\n  return json;\n}\n\nexport async function ensureStripeCustomer(args: {\n  userId: string;\n  email: string;\n  existingCustomerId: string | null;\n}): Promise<string> {\n  const existing = String(args.existingCustomerId || \"\").trim();\n  if (existing) return existing;\n\n  const created = await stripeApi(\"customers\", {\n    method: \"POST\",\n    body: {\n      email: args.email,\n      \"metadata[user_id]\": args.userId,\n    },\n  });\n\n  const customerId = String(created?.id || \"\").trim();\n  if (!customerId) throw new Error(\"Stripe customer creation returned no id\");\n  return customerId;\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\stripeWebhook.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[206,209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[206,209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2076,2079],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2076,2079],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import crypto from \"crypto\";\n\ntype VerifyArgs = {\n  rawBody: string;\n  signatureHeader: string | null;\n  secret: string | null;\n  toleranceSeconds?: number;\n};\n\ntype VerifyResult =\n  | { ok: true; payload: any; eventId: string; eventType: string }\n  | { ok: false; error: string };\n\nfunction parseSigHeader(header: string): { ts: number | null; v1: string[] } {\n  const parts = String(header || \"\")\n    .split(\",\")\n    .map((s) => s.trim())\n    .filter(Boolean);\n\n  let ts: number | null = null;\n  const v1: string[] = [];\n\n  for (const p of parts) {\n    const [k, v] = p.split(\"=\", 2);\n    if (!k || !v) continue;\n    if (k === \"t\") {\n      const n = Number(v);\n      if (Number.isFinite(n)) ts = n;\n    } else if (k === \"v1\") {\n      v1.push(v);\n    }\n  }\n\n  return { ts, v1 };\n}\n\nfunction timingSafeHexEqual(a: string, b: string): boolean {\n  try {\n    const ab = Buffer.from(a, \"hex\");\n    const bb = Buffer.from(b, \"hex\");\n    if (ab.length !== bb.length) return false;\n    return crypto.timingSafeEqual(ab, bb);\n  } catch {\n    return false;\n  }\n}\n\nexport function verifyStripeWebhookSignature(args: VerifyArgs): VerifyResult {\n  const secret = String(args.secret || \"\").trim();\n  if (!secret) return { ok: false, error: \"MISSING_WEBHOOK_SECRET\" };\n  if (!args.signatureHeader) return { ok: false, error: \"MISSING_SIGNATURE_HEADER\" };\n\n  const parsed = parseSigHeader(args.signatureHeader);\n  if (!parsed.ts || parsed.v1.length === 0) return { ok: false, error: \"INVALID_SIGNATURE_HEADER\" };\n\n  const tolerance = Number.isFinite(args.toleranceSeconds) ? Number(args.toleranceSeconds) : 300;\n  const now = Math.floor(Date.now() / 1000);\n  if (Math.abs(now - parsed.ts) > tolerance) {\n    return { ok: false, error: \"SIGNATURE_TIMESTAMP_OUT_OF_TOLERANCE\" };\n  }\n\n  const signedPayload = `${parsed.ts}.${args.rawBody}`;\n  const expected = crypto.createHmac(\"sha256\", secret).update(signedPayload).digest(\"hex\");\n  const matched = parsed.v1.some((sig) => timingSafeHexEqual(expected, sig));\n  if (!matched) return { ok: false, error: \"SIGNATURE_MISMATCH\" };\n\n  let payload: any;\n  try {\n    payload = JSON.parse(args.rawBody);\n  } catch {\n    return { ok: false, error: \"INVALID_JSON\" };\n  }\n\n  const eventId = String(payload?.id || \"\").trim();\n  const eventType = String(payload?.type || \"\").trim();\n  if (!eventId || !eventType) return { ok: false, error: \"MALFORMED_EVENT\" };\n\n  return { ok: true, payload, eventId, eventType };\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\tenant.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\uploadTypeValidation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\usageMaintenance.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1176,1179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1176,1179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { sql } from \"@/lib/db\";\n\nexport async function runUsageMaintenance(): Promise<{\n  seededCurrentMonth: number;\n  deletedOldDailyRows: number;\n}> {\n  try {\n    const seedRows = (await sql`\n      with prior as (\n        select distinct um.user_id\n        from public.user_usage_monthly um\n        where um.month = date_trunc('month', now() - interval '1 month')::date\n      ),\n      ins as (\n        insert into public.user_usage_monthly (user_id, month, view_count, upload_count)\n        select p.user_id, date_trunc('month', now())::date, 0, 0\n        from prior p\n        on conflict (user_id, month) do nothing\n        returning user_id\n      )\n      select count(*)::int as c from ins\n    `) as unknown as Array<{ c: number }>;\n\n    const dailyRows = (await sql`\n      with del as (\n        delete from public.user_usage_daily\n        where day < ((now() at time zone 'utc')::date - interval '120 day')\n        returning 1\n      )\n      select count(*)::int as c from del\n    `) as unknown as Array<{ c: number }>;\n\n    return {\n      seededCurrentMonth: Number(seedRows?.[0]?.c ?? 0),\n      deletedOldDailyRows: Number(dailyRows?.[0]?.c ?? 0),\n    };\n  } catch (e: any) {\n    if (String(e?.code || \"\") === \"42P01\") {\n      return { seededCurrentMonth: 0, deletedOldDailyRows: 0 };\n    }\n    throw e;\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\view.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\viewLimitOverride.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\lib\\webhooks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[849,852],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[849,852],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1888,1891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1888,1891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":103,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":103,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2674,2677],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2674,2677],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":108,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2842,2845],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2842,2845],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":135,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3607,3610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3607,3610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":168,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4533,4536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4533,4536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":293,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":293,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8170,8173],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8170,8173],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/lib/webhooks.ts\n// Outbound webhook delivery (queue + cron worker).\n//\n// Delivery model:\n// - Preferred: enqueue deliveries to public.webhook_deliveries and let a cron worker deliver with retry/backoff.\n// - Fallback: if the queue table doesn't exist (or insert fails), send synchronously best-effort.\n\nimport crypto from \"crypto\";\nimport { sql } from \"@/lib/db\";\n\nexport type WebhookEvent =\n  | \"doc.accessed\"\n  | \"doc.viewed\"\n  | \"share.created\"\n  | \"share.revoked\"\n  | \"alias.created\"\n  | \"alias.disabled\"\n  | \"doc.deleted\"\n  | \"webhook.test\";\n\ntype WebhookRow = {\n  id: string;\n  owner_id: string;\n  url: string;\n  secret: string | null;\n  events: string[]; // text[]\n  enabled: boolean;\n};\n\ntype DeliveryRow = {\n  id: number;\n  webhook_id: string;\n  owner_id: string;\n  url: string;\n  secret: string | null;\n  event: string;\n  payload: any;\n  attempt_count: number;\n};\n\nfunction hmac(secret: string, body: string): string {\n  return crypto.createHmac(\"sha256\", secret).update(body).digest(\"hex\");\n}\n\nfunction clamp(n: number, min: number, max: number) {\n  return Math.max(min, Math.min(max, n));\n}\n\nfunction backoffMs(attempt: number): number {\n  // Exponential backoff with jitter, capped.\n  // attempt=1 => ~5s, 2=>~15s, 3=>~45s, 4=>~2m, 5=>~6m, 6=>~18m, 7=>~54m, 8=>~2h\n  const base = 5000;\n  const exp = Math.pow(3, clamp(attempt - 1, 0, 8));\n  const raw = base * exp;\n  const capped = Math.min(raw, 2 * 60 * 60 * 1000);\n  const jitter = Math.floor(Math.random() * 0.25 * capped);\n  return capped + jitter;\n}\n\nasync function listEnabledWebhooks(): Promise<WebhookRow[]> {\n  const hooks = (await sql`\n    select\n      id::text as id,\n      owner_id::text as owner_id,\n      url,\n      secret,\n      events,\n      enabled\n    from public.webhooks\n    where enabled = true\n  `) as unknown as WebhookRow[];\n  return hooks || [];\n}\n\nfunction buildBody(event: string, payload: any): string {\n  return JSON.stringify({\n    event,\n    sent_at: new Date().toISOString(),\n    payload,\n  });\n}\n\nasync function deliverOnce(args: {\n  url: string;\n  secret: string | null;\n  event: string;\n  body: string;\n}): Promise<{ ok: boolean; status: number | null; error: string | null }> {\n  try {\n    const sig = args.secret ? hmac(args.secret, args.body) : null;\n    const res = await fetch(args.url, {\n      method: \"POST\",\n      headers: {\n        \"content-type\": \"application/json\",\n        \"x-cyang-event\": args.event,\n        ...(sig ? { \"x-cyang-signature\": sig } : {}),\n      },\n      body: args.body,\n    });\n\n    if (res.ok) return { ok: true, status: res.status, error: null };\n    return { ok: false, status: res.status, error: `HTTP ${res.status}` };\n  } catch (e: any) {\n    return { ok: false, status: null, error: String(e?.message || e || \"unknown error\") };\n  }\n}\n\nasync function enqueueDeliveries(event: WebhookEvent, payload: any): Promise<boolean> {\n  // Returns true if queued, false if queue unavailable.\n  const hooks = await listEnabledWebhooks();\n  if (!hooks.length) return true;\n\n  const selected = hooks.filter((h) => {\n    if (!h.events?.length) return true;\n    return h.events.includes(event);\n  });\n\n  if (!selected.length) return true;\n\n  try {\n    const payloadJson = JSON.stringify(payload ?? null);\n    // Bulk insert.\n    for (const h of selected) {\n      await sql`\n        insert into public.webhook_deliveries (webhook_id, owner_id, event, payload)\n        values (${h.id}::uuid, ${h.owner_id}::uuid, ${event}, ${payloadJson}::jsonb)\n      `;\n    }\n    return true;\n  } catch {\n    return false;\n  }\n}\n\nasync function deliverSyncBestEffort(event: WebhookEvent, payload: any) {\n  // Best-effort, never throws.\n  try {\n    const hooks = await listEnabledWebhooks();\n    if (!hooks.length) return;\n\n    const body = buildBody(event, payload);\n    await Promise.all(\n      hooks\n        .filter((h) => !h.events?.length || h.events.includes(event))\n        .map(async (h) => {\n          const res = await deliverOnce({ url: h.url, secret: h.secret, event, body });\n          await sql`\n            update public.webhooks\n            set\n              last_sent_at = now(),\n              last_status = ${res.status},\n              last_error = ${res.ok ? null : res.error}\n            where id = ${h.id}::uuid\n          `;\n        })\n    );\n  } catch {\n    // swallow\n  }\n}\n\n/**\n * Public entrypoint for app code.\n *\n * - Enqueues into webhook_deliveries when available.\n * - Falls back to sync best-effort if queue isn't available.\n */\nexport async function emitWebhook(event: WebhookEvent, payload: any) {\n  try {\n    const queued = await enqueueDeliveries(event, payload);\n    if (!queued) {\n      await deliverSyncBestEffort(event, payload);\n    }\n  } catch {\n    // swallow\n  }\n}\n\nexport async function processWebhookDeliveries(opts?: {\n  maxBatch?: number;\n  maxAttempts?: number;\n}): Promise<{ ok: true; processed: number; succeeded: number; dead: number; failed: number } | { ok: false; error: string }> {\n  const maxBatch = opts?.maxBatch ?? 25;\n  const maxAttempts = opts?.maxAttempts ?? 8;\n\n  try {\n    // Grab a small batch of due deliveries. Using FOR UPDATE SKIP LOCKED for concurrency.\n    const rows = (await sql`\n      with due as (\n        select d.id\n        from public.webhook_deliveries d\n        where d.status in ('pending','delivering')\n          and d.next_attempt_at <= now()\n        order by d.next_attempt_at asc, d.id asc\n        limit ${maxBatch}\n        for update skip locked\n      )\n      select\n        d.id,\n        d.webhook_id::text as webhook_id,\n        d.owner_id::text as owner_id,\n        w.url,\n        w.secret,\n        d.event,\n        d.payload,\n        d.attempt_count\n      from public.webhook_deliveries d\n      join public.webhooks w on w.id = d.webhook_id\n      join due on due.id = d.id\n    `) as unknown as DeliveryRow[];\n\n    if (!rows?.length) {\n      return { ok: true, processed: 0, succeeded: 0, dead: 0, failed: 0 };\n    }\n\n    let processed = 0;\n    let succeeded = 0;\n    let dead = 0;\n    let failed = 0;\n\n    for (const r of rows) {\n      processed += 1;\n\n      // Mark delivering\n      await sql`\n        update public.webhook_deliveries\n        set status = 'delivering', updated_at = now()\n        where id = ${r.id}\n      `;\n\n      const body = buildBody(r.event, r.payload);\n      const res = await deliverOnce({ url: r.url, secret: r.secret, event: r.event, body });\n\n      const nextAttempt = r.attempt_count + 1;\n      const shouldDead = !res.ok && nextAttempt >= maxAttempts;\n      const delayMs = res.ok ? 0 : backoffMs(nextAttempt);\n\n      if (res.ok) {\n        succeeded += 1;\n        await sql`\n          update public.webhook_deliveries\n          set\n            status = 'succeeded',\n            attempt_count = ${nextAttempt},\n            last_attempt_at = now(),\n            last_status = ${res.status},\n            last_error = null,\n            delivered_at = now(),\n            updated_at = now()\n          where id = ${r.id}\n        `;\n      } else if (shouldDead) {\n        dead += 1;\n        await sql`\n          update public.webhook_deliveries\n          set\n            status = 'dead',\n            attempt_count = ${nextAttempt},\n            last_attempt_at = now(),\n            last_status = ${res.status},\n            last_error = ${res.error},\n            updated_at = now()\n          where id = ${r.id}\n        `;\n      } else {\n        failed += 1;\n        await sql`\n          update public.webhook_deliveries\n          set\n            status = 'pending',\n            attempt_count = ${nextAttempt},\n            last_attempt_at = now(),\n            last_status = ${res.status},\n            last_error = ${res.error},\n            next_attempt_at = now() + (${delayMs}::int * interval '1 millisecond'),\n            updated_at = now()\n          where id = ${r.id}\n        `;\n      }\n\n      // Update webhook summary (best-effort)\n      await sql`\n        update public.webhooks\n        set\n          last_sent_at = now(),\n          last_status = ${res.status},\n          last_error = ${res.ok ? null : res.error}\n        where id = ${r.webhook_id}::uuid\n      `;\n    }\n\n    return { ok: true, processed, succeeded, dead, failed };\n  } catch (e: any) {\n    return { ok: false, error: String(e?.message || e || \"unknown error\") };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\src\\types\\next-auth.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\tests\\a11y.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\tests\\attack-sim.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1475,1478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1475,1478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1493,1496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1493,1496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { expect, test } from \"@playwright/test\";\nimport crypto from \"node:crypto\";\nimport { neon } from \"@neondatabase/serverless\";\n\ntype Sql = ReturnType<typeof neon<false, false>>;\n\nfunction isBlockedStatus(status: number): boolean {\n  return (\n    status === 401 ||\n    status === 403 ||\n    status === 404 ||\n    status === 410 ||\n    status === 429 ||\n    status === 500 ||\n    status === 503\n  );\n}\n\nfunction stripeSignature(payload: unknown, secret: string, timestamp?: number): string {\n  const ts = Number.isFinite(timestamp) ? Number(timestamp) : Math.floor(Date.now() / 1000);\n  const raw = JSON.stringify(payload);\n  const v1 = crypto.createHmac(\"sha256\", secret).update(`${ts}.${raw}`).digest(\"hex\");\n  return `t=${ts},v1=${v1}`;\n}\n\nfunction randSuffix(): string {\n  return `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\n}\n\nfunction authHeadersFromEnv(): Record<string, string> | null {\n  const cookie = String(process.env.ATTACK_TEST_AUTH_COOKIE || \"\").trim();\n  if (!cookie) return null;\n  return { cookie };\n}\n\nfunction encryptForUpload(plain: Buffer, keyB64: string, ivB64: string): Buffer {\n  const key = Buffer.from(keyB64, \"base64\");\n  const iv = Buffer.from(ivB64, \"base64\");\n  const cipher = crypto.createCipheriv(\"aes-256-gcm\", key, iv);\n  const out = Buffer.concat([cipher.update(plain), cipher.final()]);\n  const tag = cipher.getAuthTag();\n  return Buffer.concat([out, tag]);\n}\n\nasync function presignUpload(\n  request: { post: (...args: any[]) => Promise<any> },\n  headers: Record<string, string>,\n  args: { filename: string; sizeBytes: number }\n): Promise<{\n  doc_id: string;\n  upload_url: string;\n  r2_key: string;\n  bucket: string;\n  encryption: { enabled: true; alg: string | null; iv_b64: string | null; data_key_b64: string | null };\n}> {\n  const res = await request.post(\"/api/admin/upload/presign\", {\n    headers: { \"content-type\": \"application/json\", ...headers },\n    data: {\n      title: args.filename,\n      filename: args.filename,\n      contentType: \"application/pdf\",\n      sizeBytes: args.sizeBytes,\n      encrypt: true,\n    },\n  });\n\n  expect(res.status()).toBe(200);\n  const json = await res.json();\n  expect(json?.ok).toBeTruthy();\n  return json;\n}\n\nasync function pickDocId(sql: Sql): Promise<string | null> {\n  try {\n    const rows = (await sql`\n      select d.id::text as id\n      from public.docs d\n      where coalesce(d.status::text, 'ready') <> 'deleted'\n      order by d.created_at desc\n      limit 1\n    `) as unknown as Array<{ id: string }>;\n    return rows?.[0]?.id ?? null;\n  } catch {\n    return null;\n  }\n}\n\ntest.describe(\"attack simulation\", () => {\n  test(\"raw docId access is not a public capability\", async ({ request }) => {\n    const r = await request.get(\"/serve/00000000-0000-0000-0000-000000000000\");\n    expect([403, 404, 429, 503]).toContain(r.status());\n  });\n\n  test(\"invalid share token cannot be used for raw serving\", async ({ request }) => {\n    const r = await request.get(\"/s/not-a-real-token/raw\");\n    expect(isBlockedStatus(r.status())).toBeTruthy();\n  });\n\n  test(\"invalid alias cannot be used for raw serving\", async ({ request }) => {\n    const r = await request.get(\"/d/not-a-real-alias/raw\");\n    expect(isBlockedStatus(r.status())).toBeTruthy();\n  });\n\n  test(\"ticket endpoint blocks direct top-level open attempts\", async ({ request }) => {\n    const r = await request.get(\"/t/not-a-real-ticket\", {\n      headers: {\n        \"sec-fetch-dest\": \"document\",\n        \"sec-fetch-mode\": \"navigate\",\n        \"sec-fetch-user\": \"?1\",\n      },\n    });\n    expect([403, 503]).toContain(r.status());\n  });\n\n  test(\"high-frequency alias guesses are throttled or blocked\", async ({ request }) => {\n    const statuses: number[] = [];\n    for (let i = 0; i < 45; i += 1) {\n      const r = await request.get(`/d/guess-${i}/raw`);\n      statuses.push(r.status());\n    }\n    const sawThrottle = statuses.includes(429);\n    const allBlocked = statuses.every((s) => isBlockedStatus(s) || s === 500);\n    expect(sawThrottle || allBlocked).toBeTruthy();\n  });\n\n  test(\"high-frequency token guesses are throttled or blocked\", async ({ request }) => {\n    const statuses: number[] = [];\n    for (let i = 0; i < 45; i += 1) {\n      const r = await request.get(`/s/guess-token-${i}/raw`);\n      statuses.push(r.status());\n    }\n    const sawThrottle = statuses.includes(429);\n    const allBlocked = statuses.every((s) => isBlockedStatus(s) || s === 500);\n    expect(sawThrottle || allBlocked).toBeTruthy();\n  });\n\n  test(\"attempt serve before scan finishes is blocked\", async ({ request }) => {\n    const databaseUrl = String(process.env.DATABASE_URL || \"\").trim();\n    test.skip(!databaseUrl, \"DATABASE_URL not available\");\n    const sql = neon(databaseUrl);\n\n    const docId = await pickDocId(sql);\n    test.skip(!docId, \"No doc available for fixture setup\");\n    if (!docId) return;\n\n    const token = `tok_attack_prescan_${randSuffix()}`.slice(0, 64);\n    await sql`\n      insert into public.share_tokens (token, doc_id, max_views, views_count)\n      values (${token}, ${docId}::uuid, null, 0)\n    `;\n\n    const before = (await sql`\n      select\n        coalesce(scan_status::text, 'unscanned') as scan_status,\n        coalesce(moderation_status::text, 'active') as moderation_status,\n        coalesce(risk_level::text, 'low') as risk_level\n      from public.docs\n      where id = ${docId}::uuid\n      limit 1\n    `) as unknown as Array<{\n      scan_status: string;\n      moderation_status: string;\n      risk_level: string;\n    }>;\n\n    try {\n      await sql`update public.docs set scan_status = 'queued' where id = ${docId}::uuid`;\n      const r = await request.get(`/s/${token}/raw`);\n      expect([404, 429]).toContain(r.status());\n    } finally {\n      if (before?.[0]) {\n        await sql`\n          update public.docs\n          set\n            scan_status = ${before[0].scan_status},\n            moderation_status = ${before[0].moderation_status},\n            risk_level = ${before[0].risk_level}\n          where id = ${docId}::uuid\n        `;\n      }\n      await sql`delete from public.share_tokens where token = ${token}`;\n    }\n  });\n\n  test(\"forged tenant header does not grant raw doc access\", async ({ request }) => {\n    const fakeDocId = \"00000000-0000-0000-0000-000000000000\";\n    const r = await request.get(`/serve/${fakeDocId}`, {\n      headers: {\n        \"x-org-id\": \"00000000-0000-0000-0000-000000000001\",\n        \"x-tenant-id\": \"forged-tenant\",\n      },\n    });\n    expect([403, 404, 429, 503]).toContain(r.status());\n  });\n\n  test(\"share raw path does not expose direct object-store URL\", async ({ request }) => {\n    const databaseUrl = String(process.env.DATABASE_URL || \"\").trim();\n    test.skip(!databaseUrl, \"DATABASE_URL not available\");\n    const sql = neon(databaseUrl);\n\n    const docId = await pickDocId(sql);\n    test.skip(!docId, \"No doc available for fixture setup\");\n    if (!docId) return;\n\n    const token = `tok_attack_redirect_${randSuffix()}`.slice(0, 64);\n    await sql`\n      insert into public.share_tokens (token, doc_id, max_views, views_count)\n      values (${token}, ${docId}::uuid, null, 0)\n    `;\n\n    try {\n      const r = await request.get(`/s/${token}/raw`, {\n        maxRedirects: 0,\n      });\n      if (r.status() === 429) test.skip(true, \"Rate limited in environment\");\n      expect(r.status()).toBe(302);\n      const loc = r.headers()[\"location\"] || \"\";\n      expect(loc).toContain(\"/t/\");\n      expect(loc).not.toContain(\".r2.\");\n      expect(loc).not.toContain(\"amazonaws.com\");\n    } finally {\n      await sql`delete from public.share_tokens where token = ${token}`;\n    }\n  });\n\n  test(\"upload presign rejects absolute oversize payloads (>25MB)\", async ({ request }) => {\n    const auth = authHeadersFromEnv();\n    test.skip(!auth, \"ATTACK_TEST_AUTH_COOKIE not configured\");\n    if (!auth) return;\n\n    const absMax = Number(process.env.UPLOAD_ABSOLUTE_MAX_BYTES || 26_214_400);\n    const tooLarge = absMax + 1;\n    const res = await request.post(\"/api/admin/upload/presign\", {\n      headers: { \"content-type\": \"application/json\", ...auth },\n      data: {\n        title: \"oversize.pdf\",\n        filename: \"oversize.pdf\",\n        contentType: \"application/pdf\",\n        sizeBytes: tooLarge,\n        encrypt: true,\n      },\n    });\n\n    expect(res.status()).toBe(413);\n    const body = await res.json();\n    expect(body?.ok).toBeFalsy();\n    expect(String(body?.error || \"\")).toContain(\"FILE_TOO_LARGE\");\n  });\n\n  test(\"upload complete rejects malformed PDF after decrypt\", async ({ request }) => {\n    const auth = authHeadersFromEnv();\n    test.skip(!auth, \"ATTACK_TEST_AUTH_COOKIE not configured\");\n    if (!auth) return;\n\n    const fakePdfName = `malformed-${randSuffix()}.pdf`;\n    const badPlain = Buffer.from(\"this is not a real pdf\");\n\n    const p = await presignUpload(request, auth, {\n      filename: fakePdfName,\n      sizeBytes: badPlain.length,\n    });\n\n    expect(p?.encryption?.enabled).toBeTruthy();\n    expect(p?.encryption?.data_key_b64).toBeTruthy();\n    expect(p?.encryption?.iv_b64).toBeTruthy();\n\n    const ciphertext = encryptForUpload(\n      badPlain,\n      String(p.encryption.data_key_b64),\n      String(p.encryption.iv_b64)\n    );\n\n    const put = await request.fetch(p.upload_url, {\n      method: \"PUT\",\n      headers: {\n        \"content-type\": \"application/octet-stream\",\n        \"x-amz-meta-doc-id\": p.doc_id,\n        \"x-amz-meta-orig-content-type\": \"application/pdf\",\n      },\n      data: ciphertext,\n    });\n    expect(put.status()).toBeGreaterThanOrEqual(200);\n    expect(put.status()).toBeLessThan(300);\n\n    const complete = await request.post(\"/api/admin/upload/complete\", {\n      headers: { \"content-type\": \"application/json\", ...auth },\n      data: {\n        doc_id: p.doc_id,\n        title: fakePdfName,\n        original_filename: fakePdfName,\n        r2_bucket: p.bucket,\n        r2_key: p.r2_key,\n      },\n    });\n\n    expect(complete.status()).toBe(409);\n    const body = await complete.json();\n    expect(body?.ok).toBeFalsy();\n    expect(String(body?.error || \"\")).toContain(\"NOT_PDF\");\n  });\n\n  test(\"upload complete rejects PDFs that exceed max page policy\", async ({ request }) => {\n    const auth = authHeadersFromEnv();\n    test.skip(!auth, \"ATTACK_TEST_AUTH_COOKIE not configured\");\n    if (!auth) return;\n\n    const maxPages = Number(process.env.PDF_MAX_PAGES || 2000);\n    const overPages = maxPages + 25;\n    const fakePdfName = `too-many-pages-${randSuffix()}.pdf`;\n    const repeatedPages = new Array(overPages).fill(\"/Type /Page\").join(\"\\n\");\n    const pseudoPdf = Buffer.from(`%PDF-1.7\\n${repeatedPages}\\n%%EOF\\n`);\n\n    const p = await presignUpload(request, auth, {\n      filename: fakePdfName,\n      sizeBytes: pseudoPdf.length,\n    });\n\n    const ciphertext = encryptForUpload(\n      pseudoPdf,\n      String(p.encryption.data_key_b64),\n      String(p.encryption.iv_b64)\n    );\n\n    const put = await request.fetch(p.upload_url, {\n      method: \"PUT\",\n      headers: {\n        \"content-type\": \"application/octet-stream\",\n        \"x-amz-meta-doc-id\": p.doc_id,\n        \"x-amz-meta-orig-content-type\": \"application/pdf\",\n      },\n      data: ciphertext,\n    });\n    expect(put.status()).toBeGreaterThanOrEqual(200);\n    expect(put.status()).toBeLessThan(300);\n\n    const complete = await request.post(\"/api/admin/upload/complete\", {\n      headers: { \"content-type\": \"application/json\", ...auth },\n      data: {\n        doc_id: p.doc_id,\n        title: fakePdfName,\n        original_filename: fakePdfName,\n        r2_bucket: p.bucket,\n        r2_key: p.r2_key,\n      },\n    });\n\n    expect(complete.status()).toBe(409);\n    const body = await complete.json();\n    expect(body?.ok).toBeFalsy();\n    expect(String(body?.message || \"\").toLowerCase()).toContain(\"page\");\n  });\n\n  test(\"upload presign route throttles high-frequency abuse\", async ({ request }) => {\n    const auth = authHeadersFromEnv();\n    test.skip(!auth, \"ATTACK_TEST_AUTH_COOKIE not configured\");\n    if (!auth) return;\n\n    const statuses: number[] = [];\n    for (let i = 0; i < 45; i += 1) {\n      const r = await request.post(\"/api/admin/upload/presign\", {\n        headers: { \"content-type\": \"application/json\", ...auth },\n        data: {\n          filename: `throttle-${i}.txt`,\n          contentType: \"text/plain\",\n          sizeBytes: 1024,\n          encrypt: true,\n        },\n      });\n      statuses.push(r.status());\n    }\n    const sawThrottle = statuses.includes(429);\n    const allBlocked = statuses.every((s) => s >= 400 && s < 600);\n    expect(sawThrottle || allBlocked).toBeTruthy();\n  });\n\n  test(\"upload complete route throttles high-frequency abuse\", async ({ request }) => {\n    const statuses: number[] = [];\n    for (let i = 0; i < 45; i += 1) {\n      const r = await request.post(\"/api/admin/upload/complete\", {\n        headers: { \"content-type\": \"application/json\" },\n        data: { doc_id: \"\" },\n      });\n      statuses.push(r.status());\n    }\n    const sawThrottle = statuses.includes(429);\n    const allBlocked = statuses.every((s) => s >= 400 && s < 600);\n    expect(sawThrottle || allBlocked).toBeTruthy();\n  });\n\n  test(\"stripe webhook rejects invalid signatures\", async ({ request }) => {\n    const body = {\n      id: \"evt_attack_sim_invalid_sig\",\n      type: \"invoice.payment_failed\",\n      data: {\n        object: {\n          customer: \"cus_fake\",\n          subscription: \"sub_fake\",\n        },\n      },\n    };\n\n    const r = await request.post(\"/api/stripe/webhook\", {\n      data: body,\n      headers: {\n        \"stripe-signature\": \"t=1700000000,v1=deadbeef\",\n      },\n    });\n    expect([400, 429, 503]).toContain(r.status());\n  });\n\n  test(\"stripe webhook rejects missing signature header\", async ({ request }) => {\n    const r = await request.post(\"/api/stripe/webhook\", {\n      data: {\n        id: \"evt_attack_sim_missing_sig\",\n        type: \"invoice.payment_failed\",\n        data: { object: { customer: \"cus_fake\", subscription: \"sub_fake\" } },\n      },\n    });\n    expect([400, 429, 503]).toContain(r.status());\n  });\n\n  test(\"stripe webhook dedupes duplicate events (when secret configured)\", async ({ request }) => {\n    const webhookSecret = String(process.env.STRIPE_WEBHOOK_SECRET || \"\").trim();\n    test.skip(!webhookSecret, \"STRIPE_WEBHOOK_SECRET not available in test runtime\");\n\n    const payload = {\n      id: `evt_attack_sim_dupe_${Date.now()}`,\n      type: \"billing.test.unhandled\",\n      data: { object: {} },\n    };\n    const sig = stripeSignature(payload, webhookSecret);\n\n    const first = await request.post(\"/api/stripe/webhook\", {\n      data: payload,\n      headers: { \"stripe-signature\": sig },\n    });\n    // If billing tables are unavailable in this environment, route should be explicit and deterministic.\n    expect([200, 503]).toContain(first.status());\n\n    const second = await request.post(\"/api/stripe/webhook\", {\n      data: payload,\n      headers: { \"stripe-signature\": sig },\n    });\n\n    if (first.status() === 503) {\n      expect(second.status()).toBe(503);\n      return;\n    }\n\n    expect(second.status()).toBe(200);\n    const body = await second.json();\n    expect(body?.ok).toBeTruthy();\n    expect(body?.duplicate).toBeTruthy();\n  });\n\n  test(\"stripe webhook accepts signed invoice.payment_failed payloads\", async ({ request }) => {\n    const webhookSecret = String(process.env.STRIPE_WEBHOOK_SECRET || \"\").trim();\n    test.skip(!webhookSecret, \"STRIPE_WEBHOOK_SECRET not available in test runtime\");\n\n    const payload = {\n      id: `evt_attack_sim_payment_failed_${Date.now()}`,\n      type: \"invoice.payment_failed\",\n      data: {\n        object: {\n          customer: \"cus_attack_sim\",\n          subscription: \"sub_attack_sim\",\n        },\n      },\n    };\n    const sig = stripeSignature(payload, webhookSecret);\n\n    const r = await request.post(\"/api/stripe/webhook\", {\n      data: payload,\n      headers: { \"stripe-signature\": sig },\n    });\n    expect([200, 503]).toContain(r.status());\n    if (r.status() === 200) {\n      const body = await r.json();\n      expect(body?.ok).toBeTruthy();\n    }\n  });\n\n  test(\"stripe webhook accepts signed invoice.payment_succeeded payloads\", async ({ request }) => {\n    const webhookSecret = String(process.env.STRIPE_WEBHOOK_SECRET || \"\").trim();\n    test.skip(!webhookSecret, \"STRIPE_WEBHOOK_SECRET not available in test runtime\");\n\n    const payload = {\n      id: `evt_attack_sim_payment_succeeded_${Date.now()}`,\n      type: \"invoice.payment_succeeded\",\n      data: {\n        object: {\n          customer: \"cus_attack_sim\",\n          subscription: \"sub_attack_sim\",\n        },\n      },\n    };\n    const sig = stripeSignature(payload, webhookSecret);\n\n    const r = await request.post(\"/api/stripe/webhook\", {\n      data: payload,\n      headers: { \"stripe-signature\": sig },\n    });\n    expect([200, 503]).toContain(r.status());\n    if (r.status() === 200) {\n      const body = await r.json();\n      expect(body?.ok).toBeTruthy();\n    }\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\tests\\billing-webhook.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\tests\\security-freeze.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\tsaab\\Projects\\cyang-doclinks\\tests\\security-state.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]